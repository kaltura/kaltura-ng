/* Copyright 2013 William Summers, Metatribal Research
 * adapted from https://developer.mozilla.org/en-US/docs/JXON
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @author William Summers
 *
 */
export var XmlToJSON = (function () {
    var options = {
        mergeCDATA: true,
        grokAttr: true,
        grokText: true,
        normalize: true,
        xmlns: true,
        namespaceKey: '_ns',
        textKey: '_text',
        valueKey: '_value',
        attrKey: '_attr',
        cdataKey: '_cdata',
        attrsAsObject: true,
        stripAttrPrefix: true,
        stripElemPrefix: true,
        childrenAsArray: true // force children into arrays
    };
    var prefixMatch = new RegExp(/(?!xmlns)^.*:/);
    var trimMatch = new RegExp(/^\s+|\s+$/g);
    var grokType = function (sValue) {
        if (/^\s*$/.test(sValue)) {
            return null;
        }
        if (/^(?:true|false)$/i.test(sValue)) {
            return sValue.toLowerCase() === "true";
        }
        if (isFinite(sValue)) {
            return parseFloat(sValue);
        }
        return sValue;
    };
    var parseString = function (xmlString, opt) {
        return this.parseXML(stringToXML(xmlString), opt);
    };
    var parseXML = function (oXMLParent, opt) {
        // initialize options
        for (var key in opt) {
            options[key] = opt[key];
        }
        var vResult = {}, nLength = 0, sCollectedTxt = "";
        // parse namespace information
        if (options.xmlns && oXMLParent.namespaceURI) {
            vResult[options.namespaceKey] = oXMLParent.namespaceURI;
        }
        // parse attributes
        // using attributes property instead of hasAttributes method to support older browsers
        if (oXMLParent.attributes && oXMLParent.attributes.length > 0) {
            var vAttribs = {};
            for (nLength; nLength < oXMLParent.attributes.length; nLength++) {
                var oAttrib = oXMLParent.attributes.item(nLength);
                vContent = {};
                var attribName = '';
                if (options.stripAttrPrefix) {
                    attribName = oAttrib.name.replace(prefixMatch, '');
                }
                else {
                    attribName = oAttrib.name;
                }
                if (options.grokAttr) {
                    vContent[options.valueKey] = grokType(oAttrib.value.replace(trimMatch, ''));
                }
                else {
                    vContent[options.valueKey] = oAttrib.value.replace(trimMatch, '');
                }
                if (options.xmlns && oAttrib.namespaceURI) {
                    vContent[options.namespaceKey] = oAttrib.namespaceURI;
                }
                if (options.attrsAsObject) { // attributes with same local name must enable prefixes
                    vAttribs[attribName] = vContent;
                }
                else {
                    vResult[options.attrKey + attribName] = vContent;
                }
            }
            if (options.attrsAsObject) {
                vResult[options.attrKey] = vAttribs;
            }
            else { }
        }
        // iterate over the children
        if (oXMLParent.hasChildNodes()) {
            for (var oNode, sProp, vContent, nItem = 0; nItem < oXMLParent.childNodes.length; nItem++) {
                oNode = oXMLParent.childNodes.item(nItem);
                if (oNode.nodeType === 4) {
                    if (options.mergeCDATA) {
                        sCollectedTxt += oNode.nodeValue;
                    }
                    else {
                        if (vResult.hasOwnProperty(options.cdataKey)) {
                            if (vResult[options.cdataKey].constructor !== Array) {
                                vResult[options.cdataKey] = [vResult[options.cdataKey]];
                            }
                            vResult[options.cdataKey].push(oNode.nodeValue);
                        }
                        else {
                            if (options.childrenAsArray) {
                                vResult[options.cdataKey] = [];
                                vResult[options.cdataKey].push(oNode.nodeValue);
                            }
                            else {
                                vResult[options.cdataKey] = oNode.nodeValue;
                            }
                        }
                    }
                } /* nodeType is "CDATASection" (4) */
                else if (oNode.nodeType === 3) {
                    sCollectedTxt += oNode.nodeValue;
                } /* nodeType is "Text" (3) */
                else if (oNode.nodeType === 1) { /* nodeType is "Element" (1) */
                    if (nLength === 0) {
                        vResult = {};
                    }
                    // using nodeName to support browser (IE) implementation with no 'localName' property
                    if (options.stripElemPrefix) {
                        sProp = oNode.nodeName.replace(prefixMatch, '');
                    }
                    else {
                        sProp = oNode.nodeName;
                    }
                    vContent = parseXML(oNode);
                    if (vResult.hasOwnProperty(sProp)) {
                        if (vResult[sProp].constructor !== Array) {
                            vResult[sProp] = [vResult[sProp]];
                        }
                        vResult[sProp].push(vContent);
                    }
                    else {
                        if (options.childrenAsArray) {
                            vResult[sProp] = [];
                            vResult[sProp].push(vContent);
                        }
                        else {
                            vResult[sProp] = vContent;
                        }
                        nLength++;
                    }
                }
            }
        }
        else if (!sCollectedTxt) { // no children and no text, return null
            if (options.childrenAsArray) {
                vResult[options.textKey] = [];
                vResult[options.textKey].push(null);
            }
            else {
                vResult[options.textKey] = null;
            }
        }
        if (sCollectedTxt) {
            if (options.grokText) {
                var value = grokType(sCollectedTxt.replace(trimMatch, ''));
                if (value) {
                    vResult[options.textKey] = value;
                }
            }
            else if (options.normalize) {
                vResult[options.textKey] = sCollectedTxt.replace(trimMatch, '').replace(/\s+/g, " ");
            }
            else {
                vResult[options.textKey] = sCollectedTxt.replace(trimMatch, '');
            }
        }
        return vResult;
    };
    // Convert xmlDocument to a string
    // Returns null on failure
    var xmlToString = function (xmlDoc) {
        try {
            var xmlString = xmlDoc.xml ? xmlDoc.xml : (new XMLSerializer()).serializeToString(xmlDoc);
            return xmlString;
        }
        catch (err) {
            return null;
        }
    };
    // Convert a string to XML Node Structure
    // Returns null on failure
    var stringToXML = function (xmlString) {
        try {
            var xmlDoc = null;
            if (typeof DOMParser === 'function') {
                var parser = new DOMParser();
                xmlDoc = parser.parseFromString(xmlString, "text/xml");
                return xmlDoc;
            }
            else {
                return null;
                // TODO [kmcng] consider if to allow active x object
                // xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                // xmlDoc.async = false;
                // xmlDoc.loadXML(xmlString);
                //
                // return xmlDoc;
            }
        }
        catch (e) {
            return null;
        }
    };
    // this is the "revealed"/public part of the module
    return {
        parseXML: parseXML,
        parseString: parseString,
        xmlToString: xmlToString,
        stringToXML: stringToXML
    };
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieG1sLXRvLWpzb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Aa2FsdHVyYS1uZy9rYWx0dXJhLWNvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi94bWwtcGFyc2VyL3htbC10by1qc29uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7OztHQWNHO0FBRUg7OztHQUdHO0FBQ0gsTUFBTSxDQUFDLElBQU0sU0FBUyxHQUFHLENBQUM7SUFFdEIsSUFBSSxPQUFPLEdBQUc7UUFDVixVQUFVLEVBQUUsSUFBSTtRQUNoQixRQUFRLEVBQUUsSUFBSTtRQUNkLFFBQVEsRUFBRSxJQUFJO1FBQ2QsU0FBUyxFQUFFLElBQUk7UUFDZixLQUFLLEVBQUUsSUFBSTtRQUNYLFlBQVksRUFBRSxLQUFLO1FBQ25CLE9BQU8sRUFBRSxPQUFPO1FBQ2hCLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLE9BQU8sRUFBRSxPQUFPO1FBQ2hCLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLGFBQWEsRUFBRSxJQUFJO1FBQ25CLGVBQWUsRUFBRSxJQUFJO1FBQ3JCLGVBQWUsRUFBRSxJQUFJO1FBQ3JCLGVBQWUsRUFBRSxJQUFJLENBQUUsNkJBQTZCO0tBQ3ZELENBQUM7SUFFRixJQUFJLFdBQVcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUM5QyxJQUFJLFNBQVMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUV6QyxJQUFJLFFBQVEsR0FBRyxVQUFVLE1BQU07UUFDM0IsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3RCLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxJQUFJLG1CQUFtQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNsQyxPQUFPLE1BQU0sQ0FBQyxXQUFXLEVBQUUsS0FBSyxNQUFNLENBQUM7U0FDMUM7UUFDRCxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNsQixP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QyxNQUFNLENBQUMsQ0FBQztZQUMxRixPQUFPLFNBQVMsQ0FBQztTQUNwQjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsT0FBTyxJQUFJLENBQUM7U0FDZjtJQUNMLENBQUMsQ0FBQTtJQUVELHlDQUF5QztJQUN6QywwQkFBMEI7SUFDMUIsSUFBSSxXQUFXLEdBQUcsVUFBVSxTQUFTO1FBQ2pDLElBQUk7WUFDQSxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUM7WUFFbEIsSUFBSSxPQUFPLFNBQVMsS0FBSyxVQUFVLEVBQUU7Z0JBRWpDLElBQUksTUFBTSxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7Z0JBQzdCLE1BQU0sR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQztnQkFFdkQsT0FBTyxNQUFNLENBQUM7YUFDakI7aUJBQU07Z0JBQ0gsT0FBTyxJQUFJLENBQUM7Z0JBQ1osb0RBQW9EO2dCQUNwRCxrREFBa0Q7Z0JBQ2xELHdCQUF3QjtnQkFDeEIsNkJBQTZCO2dCQUM3QixFQUFFO2dCQUNGLGlCQUFpQjthQUNwQjtTQUNKO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDUixPQUFPLElBQUksQ0FBQztTQUNmO0lBQ0wsQ0FBQyxDQUFBO0lBRUQsbURBQW1EO0lBQ25ELE9BQU87UUFDSCxRQUFRLEVBQUUsUUFBUTtRQUNsQixXQUFXLEVBQUUsV0FBVztRQUN4QixXQUFXLEVBQUUsV0FBVztRQUN4QixXQUFXLEVBQUUsV0FBVztLQUMzQixDQUFDO0FBRU4sQ0FBQyxFQUFFLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIENvcHlyaWdodCAyMDEzIFdpbGxpYW0gU3VtbWVycywgTWV0YXRyaWJhbCBSZXNlYXJjaFxuICogYWRhcHRlZCBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvSlhPTlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKipcbiAqIEBhdXRob3IgV2lsbGlhbSBTdW1tZXJzXG4gKlxuICovXG5leHBvcnQgY29uc3QgWG1sVG9KU09OID0gKGZ1bmN0aW9uICgpIHtcblxuICAgIHZhciBvcHRpb25zID0geyAvLyBzZXQgdXAgdGhlIGRlZmF1bHQgb3B0aW9uc1xuICAgICAgICBtZXJnZUNEQVRBOiB0cnVlLFx0Ly8gZXh0cmFjdCBjZGF0YSBhbmQgbWVyZ2Ugd2l0aCB0ZXh0XG4gICAgICAgIGdyb2tBdHRyOiB0cnVlLFx0XHQvLyBjb252ZXJ0IHRydXRoeSBhdHRyaWJ1dGVzIHRvIGJvb2xlYW4sIGV0Y1xuICAgICAgICBncm9rVGV4dDogdHJ1ZSxcdFx0Ly8gY29udmVydCB0cnV0aHkgdGV4dC9hdHRyIHRvIGJvb2xlYW4sIGV0Y1xuICAgICAgICBub3JtYWxpemU6IHRydWUsXHQvLyBjb2xsYXBzZSBtdWx0aXBsZSBzcGFjZXMgdG8gc2luZ2xlIHNwYWNlXG4gICAgICAgIHhtbG5zOiB0cnVlLCBcdFx0Ly8gaW5jbHVkZSBuYW1lc3BhY2VzIGFzIGF0dHJpYnV0ZSBpbiBvdXRwdXRcbiAgICAgICAgbmFtZXNwYWNlS2V5OiAnX25zJywgXHQvLyB0YWcgbmFtZSBmb3IgbmFtZXNwYWNlIG9iamVjdHNcbiAgICAgICAgdGV4dEtleTogJ190ZXh0JywgXHQvLyB0YWcgbmFtZSBmb3IgdGV4dCBub2Rlc1xuICAgICAgICB2YWx1ZUtleTogJ192YWx1ZScsIFx0Ly8gdGFnIG5hbWUgZm9yIGF0dHJpYnV0ZSB2YWx1ZXNcbiAgICAgICAgYXR0cktleTogJ19hdHRyJywgXHQvLyB0YWcgZm9yIGF0dHIgZ3JvdXBzXG4gICAgICAgIGNkYXRhS2V5OiAnX2NkYXRhJyxcdC8vIHRhZyBmb3IgY2RhdGEgbm9kZXMgKGlnbm9yZWQgaWYgbWVyZ2VDREFUQSBpcyB0cnVlKVxuICAgICAgICBhdHRyc0FzT2JqZWN0OiB0cnVlLCBcdC8vIGlmIGZhbHNlLCBrZXkgaXMgdXNlZCBhcyBwcmVmaXggdG8gbmFtZSwgc2V0IHByZWZpeCB0byAnJyB0byBtZXJnZSBjaGlsZHJlbiBhbmQgYXR0cnMuXG4gICAgICAgIHN0cmlwQXR0clByZWZpeDogdHJ1ZSwgXHQvLyByZW1vdmUgbmFtZXNwYWNlIHByZWZpeGVzIGZyb20gYXR0cmlidXRlc1xuICAgICAgICBzdHJpcEVsZW1QcmVmaXg6IHRydWUsIFx0Ly8gZm9yIGVsZW1lbnRzIG9mIHNhbWUgbmFtZSBpbiBkaWZmIG5hbWVzcGFjZXMsIHlvdSBjYW4gZW5hYmxlIG5hbWVzcGFjZXMgYW5kIGFjY2VzcyB0aGUgbnNrZXkgcHJvcGVydHlcbiAgICAgICAgY2hpbGRyZW5Bc0FycmF5OiB0cnVlIFx0Ly8gZm9yY2UgY2hpbGRyZW4gaW50byBhcnJheXNcbiAgICB9O1xuXG4gICAgdmFyIHByZWZpeE1hdGNoID0gbmV3IFJlZ0V4cCgvKD8heG1sbnMpXi4qOi8pO1xuICAgIHZhciB0cmltTWF0Y2ggPSBuZXcgUmVnRXhwKC9eXFxzK3xcXHMrJC9nKTtcblxuICAgIHZhciBncm9rVHlwZSA9IGZ1bmN0aW9uIChzVmFsdWUpIHtcbiAgICAgICAgaWYgKC9eXFxzKiQvLnRlc3Qoc1ZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKC9eKD86dHJ1ZXxmYWxzZSkkL2kudGVzdChzVmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gc1ZhbHVlLnRvTG93ZXJDYXNlKCkgPT09IFwidHJ1ZVwiO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc0Zpbml0ZShzVmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdChzVmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzVmFsdWU7XG4gICAgfTtcblxuICAgIHZhciBwYXJzZVN0cmluZyA9IGZ1bmN0aW9uICh4bWxTdHJpbmcgOiBzdHJpbmcsIG9wdCA6IGFueSkge1xuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVhNTChzdHJpbmdUb1hNTCh4bWxTdHJpbmcpLCBvcHQpO1xuICAgIH1cblxuICAgIHZhciBwYXJzZVhNTCA9IGZ1bmN0aW9uIChvWE1MUGFyZW50LCBvcHQ/KSB7XG5cbiAgICAgICAgLy8gaW5pdGlhbGl6ZSBvcHRpb25zXG4gICAgICAgIGZvciAobGV0IGtleSBpbiBvcHQpIHtcbiAgICAgICAgICAgIG9wdGlvbnNba2V5XSA9IG9wdFtrZXldO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHZSZXN1bHQgPSB7fSwgbkxlbmd0aCA9IDAsIHNDb2xsZWN0ZWRUeHQgPSBcIlwiO1xuXG4gICAgICAgIC8vIHBhcnNlIG5hbWVzcGFjZSBpbmZvcm1hdGlvblxuICAgICAgICBpZiAob3B0aW9ucy54bWxucyAmJiBvWE1MUGFyZW50Lm5hbWVzcGFjZVVSSSkge1xuICAgICAgICAgICAgdlJlc3VsdFtvcHRpb25zLm5hbWVzcGFjZUtleV0gPSBvWE1MUGFyZW50Lm5hbWVzcGFjZVVSSTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHBhcnNlIGF0dHJpYnV0ZXNcbiAgICAgICAgLy8gdXNpbmcgYXR0cmlidXRlcyBwcm9wZXJ0eSBpbnN0ZWFkIG9mIGhhc0F0dHJpYnV0ZXMgbWV0aG9kIHRvIHN1cHBvcnQgb2xkZXIgYnJvd3NlcnNcbiAgICAgICAgaWYgKG9YTUxQYXJlbnQuYXR0cmlidXRlcyAmJiBvWE1MUGFyZW50LmF0dHJpYnV0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdmFyIHZBdHRyaWJzID0ge307XG5cbiAgICAgICAgICAgIGZvciAobkxlbmd0aDsgbkxlbmd0aCA8IG9YTUxQYXJlbnQuYXR0cmlidXRlcy5sZW5ndGg7IG5MZW5ndGgrKykge1xuICAgICAgICAgICAgICAgIGxldCBvQXR0cmliID0gb1hNTFBhcmVudC5hdHRyaWJ1dGVzLml0ZW0obkxlbmd0aCk7XG4gICAgICAgICAgICAgICAgdkNvbnRlbnQgPSB7fTtcbiAgICAgICAgICAgICAgICBsZXQgYXR0cmliTmFtZSA9ICcnO1xuXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RyaXBBdHRyUHJlZml4KSB7XG4gICAgICAgICAgICAgICAgICAgIGF0dHJpYk5hbWUgPSBvQXR0cmliLm5hbWUucmVwbGFjZShwcmVmaXhNYXRjaCwgJycpO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXR0cmliTmFtZSA9IG9BdHRyaWIubmFtZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5ncm9rQXR0cikge1xuICAgICAgICAgICAgICAgICAgICB2Q29udGVudFtvcHRpb25zLnZhbHVlS2V5XSA9IGdyb2tUeXBlKG9BdHRyaWIudmFsdWUucmVwbGFjZSh0cmltTWF0Y2gsICcnKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdkNvbnRlbnRbb3B0aW9ucy52YWx1ZUtleV0gPSBvQXR0cmliLnZhbHVlLnJlcGxhY2UodHJpbU1hdGNoLCAnJyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMueG1sbnMgJiYgb0F0dHJpYi5uYW1lc3BhY2VVUkkpIHtcbiAgICAgICAgICAgICAgICAgICAgdkNvbnRlbnRbb3B0aW9ucy5uYW1lc3BhY2VLZXldID0gb0F0dHJpYi5uYW1lc3BhY2VVUkk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cnNBc09iamVjdCkgeyAvLyBhdHRyaWJ1dGVzIHdpdGggc2FtZSBsb2NhbCBuYW1lIG11c3QgZW5hYmxlIHByZWZpeGVzXG4gICAgICAgICAgICAgICAgICAgIHZBdHRyaWJzW2F0dHJpYk5hbWVdID0gdkNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdlJlc3VsdFtvcHRpb25zLmF0dHJLZXkgKyBhdHRyaWJOYW1lXSA9IHZDb250ZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cnNBc09iamVjdCkge1xuICAgICAgICAgICAgICAgIHZSZXN1bHRbb3B0aW9ucy5hdHRyS2V5XSA9IHZBdHRyaWJzO1xuICAgICAgICAgICAgfSBlbHNlIHt9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGNoaWxkcmVuXG4gICAgICAgIGlmIChvWE1MUGFyZW50Lmhhc0NoaWxkTm9kZXMoKSkge1xuICAgICAgICAgICAgZm9yICh2YXIgb05vZGUsIHNQcm9wLCB2Q29udGVudCwgbkl0ZW0gPSAwOyBuSXRlbSA8IG9YTUxQYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGg7IG5JdGVtKyspIHtcbiAgICAgICAgICAgICAgICBvTm9kZSA9IG9YTUxQYXJlbnQuY2hpbGROb2Rlcy5pdGVtKG5JdGVtKTtcblxuICAgICAgICAgICAgICAgIGlmIChvTm9kZS5ub2RlVHlwZSA9PT0gNCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5tZXJnZUNEQVRBKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzQ29sbGVjdGVkVHh0ICs9IG9Ob2RlLm5vZGVWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2UmVzdWx0Lmhhc093blByb3BlcnR5KG9wdGlvbnMuY2RhdGFLZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZSZXN1bHRbb3B0aW9ucy5jZGF0YUtleV0uY29uc3RydWN0b3IgIT09IEFycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZSZXN1bHRbb3B0aW9ucy5jZGF0YUtleV0gPSBbdlJlc3VsdFtvcHRpb25zLmNkYXRhS2V5XV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZSZXN1bHRbb3B0aW9ucy5jZGF0YUtleV0ucHVzaChvTm9kZS5ub2RlVmFsdWUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNoaWxkcmVuQXNBcnJheSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2UmVzdWx0W29wdGlvbnMuY2RhdGFLZXldID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZSZXN1bHRbb3B0aW9ucy5jZGF0YUtleV0ucHVzaChvTm9kZS5ub2RlVmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZSZXN1bHRbb3B0aW9ucy5jZGF0YUtleV0gPSBvTm9kZS5ub2RlVmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSAvKiBub2RlVHlwZSBpcyBcIkNEQVRBU2VjdGlvblwiICg0KSAqL1xuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9Ob2RlLm5vZGVUeXBlID09PSAzKSB7XG4gICAgICAgICAgICAgICAgICAgIHNDb2xsZWN0ZWRUeHQgKz0gb05vZGUubm9kZVZhbHVlO1xuICAgICAgICAgICAgICAgIH0gLyogbm9kZVR5cGUgaXMgXCJUZXh0XCIgKDMpICovXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAob05vZGUubm9kZVR5cGUgPT09IDEpIHsgLyogbm9kZVR5cGUgaXMgXCJFbGVtZW50XCIgKDEpICovXG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG5MZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZSZXN1bHQgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIHVzaW5nIG5vZGVOYW1lIHRvIHN1cHBvcnQgYnJvd3NlciAoSUUpIGltcGxlbWVudGF0aW9uIHdpdGggbm8gJ2xvY2FsTmFtZScgcHJvcGVydHlcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RyaXBFbGVtUHJlZml4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzUHJvcCA9IG9Ob2RlLm5vZGVOYW1lLnJlcGxhY2UocHJlZml4TWF0Y2gsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNQcm9wID0gb05vZGUubm9kZU5hbWU7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB2Q29udGVudCA9IHBhcnNlWE1MKG9Ob2RlKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAodlJlc3VsdC5oYXNPd25Qcm9wZXJ0eShzUHJvcCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2UmVzdWx0W3NQcm9wXS5jb25zdHJ1Y3RvciAhPT0gQXJyYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2UmVzdWx0W3NQcm9wXSA9IFt2UmVzdWx0W3NQcm9wXV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2UmVzdWx0W3NQcm9wXS5wdXNoKHZDb250ZW50KTtcblxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2hpbGRyZW5Bc0FycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdlJlc3VsdFtzUHJvcF0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2UmVzdWx0W3NQcm9wXS5wdXNoKHZDb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdlJlc3VsdFtzUHJvcF0gPSB2Q29udGVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIG5MZW5ndGgrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICghc0NvbGxlY3RlZFR4dCl7IC8vIG5vIGNoaWxkcmVuIGFuZCBubyB0ZXh0LCByZXR1cm4gbnVsbFxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2hpbGRyZW5Bc0FycmF5KSB7XG4gICAgICAgICAgICAgICAgdlJlc3VsdFtvcHRpb25zLnRleHRLZXldID0gW107XG4gICAgICAgICAgICAgICAgdlJlc3VsdFtvcHRpb25zLnRleHRLZXldLnB1c2gobnVsbCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZSZXN1bHRbb3B0aW9ucy50ZXh0S2V5XSA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc0NvbGxlY3RlZFR4dCkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuZ3Jva1RleHQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBncm9rVHlwZShzQ29sbGVjdGVkVHh0LnJlcGxhY2UodHJpbU1hdGNoLCAnJykpO1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB2UmVzdWx0W29wdGlvbnMudGV4dEtleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMubm9ybWFsaXplKSB7XG4gICAgICAgICAgICAgICAgdlJlc3VsdFtvcHRpb25zLnRleHRLZXldID0gc0NvbGxlY3RlZFR4dC5yZXBsYWNlKHRyaW1NYXRjaCwgJycpLnJlcGxhY2UoL1xccysvZywgXCIgXCIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2UmVzdWx0W29wdGlvbnMudGV4dEtleV0gPSBzQ29sbGVjdGVkVHh0LnJlcGxhY2UodHJpbU1hdGNoLCAnJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdlJlc3VsdDtcbiAgICB9XG5cblxuICAgIC8vIENvbnZlcnQgeG1sRG9jdW1lbnQgdG8gYSBzdHJpbmdcbiAgICAvLyBSZXR1cm5zIG51bGwgb24gZmFpbHVyZVxuICAgIHZhciB4bWxUb1N0cmluZyA9IGZ1bmN0aW9uICh4bWxEb2MpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHZhciB4bWxTdHJpbmcgPSB4bWxEb2MueG1sID8geG1sRG9jLnhtbCA6IChuZXcgWE1MU2VyaWFsaXplcigpKS5zZXJpYWxpemVUb1N0cmluZyh4bWxEb2MpO1xuICAgICAgICAgICAgcmV0dXJuIHhtbFN0cmluZztcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvbnZlcnQgYSBzdHJpbmcgdG8gWE1MIE5vZGUgU3RydWN0dXJlXG4gICAgLy8gUmV0dXJucyBudWxsIG9uIGZhaWx1cmVcbiAgICB2YXIgc3RyaW5nVG9YTUwgPSBmdW5jdGlvbiAoeG1sU3RyaW5nKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB2YXIgeG1sRG9jID0gbnVsbDtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBET01QYXJzZXIgPT09ICdmdW5jdGlvbicpIHtcblxuICAgICAgICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7XG4gICAgICAgICAgICAgICAgeG1sRG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh4bWxTdHJpbmcsIFwidGV4dC94bWxcIik7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4geG1sRG9jO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICAvLyBUT0RPIFtrbWNuZ10gY29uc2lkZXIgaWYgdG8gYWxsb3cgYWN0aXZlIHggb2JqZWN0XG4gICAgICAgICAgICAgICAgLy8geG1sRG9jID0gbmV3IEFjdGl2ZVhPYmplY3QoXCJNaWNyb3NvZnQuWE1MRE9NXCIpO1xuICAgICAgICAgICAgICAgIC8vIHhtbERvYy5hc3luYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vIHhtbERvYy5sb2FkWE1MKHhtbFN0cmluZyk7XG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAvLyByZXR1cm4geG1sRG9jO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIHRoaXMgaXMgdGhlIFwicmV2ZWFsZWRcIi9wdWJsaWMgcGFydCBvZiB0aGUgbW9kdWxlXG4gICAgcmV0dXJuIHtcbiAgICAgICAgcGFyc2VYTUw6IHBhcnNlWE1MLFxuICAgICAgICBwYXJzZVN0cmluZzogcGFyc2VTdHJpbmcsXG4gICAgICAgIHhtbFRvU3RyaW5nOiB4bWxUb1N0cmluZyxcbiAgICAgICAgc3RyaW5nVG9YTUw6IHN0cmluZ1RvWE1MXG4gICAgfTtcblxufSgpKTsiXX0=