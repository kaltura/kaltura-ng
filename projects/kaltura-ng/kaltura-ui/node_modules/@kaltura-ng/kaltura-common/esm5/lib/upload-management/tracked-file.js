var TrackedFileStatuses = /** @class */ (function () {
    function TrackedFileStatuses() {
    }
    TrackedFileStatuses.added = 'added'; // one-time status, cannot be assigned twice
    TrackedFileStatuses.pendingPrepare = 'pendingPrepare';
    TrackedFileStatuses.preparing = 'preparing';
    TrackedFileStatuses.prepared = 'prepared'; // one-time status, cannot be assigned twice
    TrackedFileStatuses.pendingUpload = 'waitingUpload';
    TrackedFileStatuses.uploading = 'uploading';
    TrackedFileStatuses.uploadCompleted = 'uploadCompleted'; // one-time status, cannot be assigned twice
    TrackedFileStatuses.failure = 'failure';
    TrackedFileStatuses.cancelled = 'cancelled';
    TrackedFileStatuses.purged = 'purged'; // one-time status, cannot be assigned twice
    return TrackedFileStatuses;
}());
export { TrackedFileStatuses };
var TrackedFile = /** @class */ (function () {
    function TrackedFile(id, data) {
        this.status = TrackedFileStatuses.added;
        this.progress = 0;
        this.uploadCompleteAt = null;
        this.uploadOrder = 0;
        this._statusHistory = {
            'added': true
        };
        this._id = id;
        this.data = data;
    }
    Object.defineProperty(TrackedFile.prototype, "id", {
        get: function () {
            return this._id;
        },
        enumerable: true,
        configurable: true
    });
    TrackedFile.prototype.asData = function () {
        return {
            id: this.id,
            status: this.status,
            uploadStartAt: this.uploadStartAt,
            progress: this.progress,
            uploadCompleteAt: this.uploadCompleteAt,
            uploadOrder: this.uploadOrder,
            failureType: this.failureType,
            failureReason: this.failureReason,
            data: this.data
        };
    };
    TrackedFile.prototype.update = function (changes) {
        if (changes.status && changes.status !== this.status) {
            if (!this.canTransitionTo(changes.status)) {
                throw new Error("file " + this.id + ": cannot update status to '" + changes.status + "'");
            }
            this._statusHistory[changes.status] = true;
        }
        Object.assign(this, changes);
    };
    TrackedFile.prototype.wasInStatus = function (status) {
        return !!this._statusHistory[status];
    };
    TrackedFile.prototype.canTransitionTo = function (toStatus) {
        var result = false;
        var trackedFile = this;
        var fromStatus = trackedFile ? trackedFile.status : null;
        if (trackedFile && fromStatus && toStatus) {
            if (fromStatus === TrackedFileStatuses.purged) {
                // never allow changing status once file was purged
                result = false;
            }
            switch (toStatus) {
                case TrackedFileStatuses.added:
                    // one-time status, cannot be assigned twice
                    result = !this.wasInStatus(TrackedFileStatuses.added);
                    break;
                case TrackedFileStatuses.pendingPrepare:
                    result = !this.wasInStatus(TrackedFileStatuses.prepared);
                    break;
                case TrackedFileStatuses.preparing:
                    result = !this.wasInStatus(TrackedFileStatuses.prepared)
                        && fromStatus === TrackedFileStatuses.pendingPrepare;
                    break;
                case TrackedFileStatuses.prepared:
                    // one-time status, cannot be assigned twice
                    result = !this.wasInStatus(TrackedFileStatuses.prepared)
                        && fromStatus === TrackedFileStatuses.preparing;
                    break;
                case TrackedFileStatuses.pendingUpload:
                    result = this.wasInStatus(TrackedFileStatuses.prepared)
                        && !this.wasInStatus(TrackedFileStatuses.uploadCompleted);
                    break;
                case TrackedFileStatuses.uploading:
                    result = !this.wasInStatus(TrackedFileStatuses.uploadCompleted)
                        && fromStatus === TrackedFileStatuses.pendingUpload;
                    break;
                case TrackedFileStatuses.uploadCompleted:
                    // one-time status, cannot be assigned twice
                    result = !this.wasInStatus(TrackedFileStatuses.uploadCompleted)
                        && fromStatus === TrackedFileStatuses.uploading;
                    break;
                case TrackedFileStatuses.cancelled:
                    result = ([TrackedFileStatuses.cancelled, TrackedFileStatuses.uploadCompleted, TrackedFileStatuses.purged].indexOf(fromStatus) === -1);
                    break;
                case TrackedFileStatuses.failure:
                    // always allow changing to 'failure' status (assuming 'purge' is handled separately before)
                    result = ([TrackedFileStatuses.uploadCompleted, TrackedFileStatuses.purged].indexOf(fromStatus) === -1);
                    break;
                case TrackedFileStatuses.purged:
                    // one-time status, cannot be assigned twice
                    result = !this.wasInStatus(TrackedFileStatuses.purged);
                    break;
                default:
                    throw new Error("unknown status provided '" + toStatus + "'");
            }
        }
        return result;
    };
    return TrackedFile;
}());
export { TrackedFile };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhY2tlZC1maWxlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGthbHR1cmEtbmcva2FsdHVyYS1jb21tb24vIiwic291cmNlcyI6WyJsaWIvdXBsb2FkLW1hbmFnZW1lbnQvdHJhY2tlZC1maWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBO0lBQUE7SUFXQSxDQUFDO0lBVjBCLHlCQUFLLEdBQXNCLE9BQU8sQ0FBQyxDQUFDLDRDQUE0QztJQUNoRixrQ0FBYyxHQUFzQixnQkFBZ0IsQ0FBQztJQUNyRCw2QkFBUyxHQUFzQixXQUFXLENBQUM7SUFDM0MsNEJBQVEsR0FBc0IsVUFBVSxDQUFDLENBQUMsNENBQTRDO0lBQ3RGLGlDQUFhLEdBQXNCLGVBQWUsQ0FBQztJQUNuRCw2QkFBUyxHQUFzQixXQUFXLENBQUM7SUFDM0MsbUNBQWUsR0FBc0IsaUJBQWlCLENBQUMsQ0FBQyw0Q0FBNEM7SUFDcEcsMkJBQU8sR0FBc0IsU0FBUyxDQUFDO0lBQ3ZDLDZCQUFTLEdBQXNCLFdBQVcsQ0FBQztJQUMzQywwQkFBTSxHQUFzQixRQUFRLENBQUMsQ0FBRSw0Q0FBNEM7SUFDOUcsMEJBQUM7Q0FBQSxBQVhELElBV0M7U0FYWSxtQkFBbUI7QUFxQ2hDO0lBa0JJLHFCQUFZLEVBQVUsRUFBRSxJQUFvQjtRQWI1QyxXQUFNLEdBQXNCLG1CQUFtQixDQUFDLEtBQUssQ0FBQztRQUV0RCxhQUFRLEdBQVksQ0FBQyxDQUFDO1FBQ3RCLHFCQUFnQixHQUFTLElBQUksQ0FBQztRQUM5QixnQkFBVyxHQUFXLENBQUMsQ0FBQztRQUtoQixtQkFBYyxHQUFnQztZQUNsRCxPQUFPLEVBQUcsSUFBSTtTQUNqQixDQUFDO1FBSUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBcEJELHNCQUFXLDJCQUFFO2FBQWI7WUFDSSxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDcEIsQ0FB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Q0FBQztJQUVMLGtCQUFDO0FBQUQsQ0FBQyxBQXZIRCxJQXVIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVwbG9hZEZpbGVEYXRhIH0gZnJvbSAnLi91cGxvYWQtZmlsZS1kYXRhJztcbmltcG9ydCB7IElTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzL1N1YnNjcmlwdGlvbic7XG5cbmV4cG9ydCB0eXBlIFRyYWNrZWRGaWxlU3RhdHVzID0gc3RyaW5nXG5cbmV4cG9ydCBjbGFzcyBUcmFja2VkRmlsZVN0YXR1c2VzIHtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IGFkZGVkOiBUcmFja2VkRmlsZVN0YXR1cyA9ICdhZGRlZCc7IC8vIG9uZS10aW1lIHN0YXR1cywgY2Fubm90IGJlIGFzc2lnbmVkIHR3aWNlXG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBwZW5kaW5nUHJlcGFyZTogVHJhY2tlZEZpbGVTdGF0dXMgPSAncGVuZGluZ1ByZXBhcmUnO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgcHJlcGFyaW5nOiBUcmFja2VkRmlsZVN0YXR1cyA9ICdwcmVwYXJpbmcnO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgcHJlcGFyZWQ6IFRyYWNrZWRGaWxlU3RhdHVzID0gJ3ByZXBhcmVkJzsgLy8gb25lLXRpbWUgc3RhdHVzLCBjYW5ub3QgYmUgYXNzaWduZWQgdHdpY2VcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IHBlbmRpbmdVcGxvYWQ6IFRyYWNrZWRGaWxlU3RhdHVzID0gJ3dhaXRpbmdVcGxvYWQnO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgdXBsb2FkaW5nOiBUcmFja2VkRmlsZVN0YXR1cyA9ICd1cGxvYWRpbmcnO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgdXBsb2FkQ29tcGxldGVkOiBUcmFja2VkRmlsZVN0YXR1cyA9ICd1cGxvYWRDb21wbGV0ZWQnOyAvLyBvbmUtdGltZSBzdGF0dXMsIGNhbm5vdCBiZSBhc3NpZ25lZCB0d2ljZVxuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgZmFpbHVyZTogVHJhY2tlZEZpbGVTdGF0dXMgPSAnZmFpbHVyZSc7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBjYW5jZWxsZWQ6IFRyYWNrZWRGaWxlU3RhdHVzID0gJ2NhbmNlbGxlZCc7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBwdXJnZWQ6IFRyYWNrZWRGaWxlU3RhdHVzID0gJ3B1cmdlZCc7ICAvLyBvbmUtdGltZSBzdGF0dXMsIGNhbm5vdCBiZSBhc3NpZ25lZCB0d2ljZVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRyYWNrZWRGaWxlRGF0YVxue1xuICAgIGlkOiBzdHJpbmc7XG4gICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1cztcbiAgICB1cGxvYWRTdGFydEF0OiBEYXRlO1xuICAgIHByb2dyZXNzOiBudW1iZXI7XG4gICAgdXBsb2FkQ29tcGxldGVBdD86IERhdGU7XG4gICAgdXBsb2FkT3JkZXI6IG51bWJlcjtcbiAgICBmYWlsdXJlVHlwZT86IHN0cmluZztcbiAgICBmYWlsdXJlUmVhc29uPzogc3RyaW5nO1xuICAgIGRhdGE6IFVwbG9hZEZpbGVEYXRhO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRyYWNrZWRGaWxlQ2hhbmdlc1xue1xuICAgIHN0YXR1cz86IFRyYWNrZWRGaWxlU3RhdHVzO1xuICAgIHVwbG9hZFN0YXJ0QXQ/OiBEYXRlO1xuICAgIHByb2dyZXNzPzogbnVtYmVyO1xuICAgIHVwbG9hZENvbXBsZXRlQXQ/OiBEYXRlO1xuICAgIHVwbG9hZE9yZGVyPzogbnVtYmVyO1xuICAgIGZhaWx1cmVUeXBlPzogc3RyaW5nO1xuICAgIGZhaWx1cmVSZWFzb24/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBUcmFja2VkRmlsZSB7XG4gICAgcHJpdmF0ZSBfaWQ6IHN0cmluZztcbiAgICBwdWJsaWMgZ2V0IGlkKCk6c3RyaW5ne1xuICAgICAgICByZXR1cm4gdGhpcy5faWQ7XG4gICAgfVxuICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXMgPSBUcmFja2VkRmlsZVN0YXR1c2VzLmFkZGVkO1xuICAgIHVwbG9hZFN0YXJ0QXQ/OiBEYXRlO1xuICAgIHByb2dyZXNzOiBudW1iZXIgPSAgMDtcbiAgICB1cGxvYWRDb21wbGV0ZUF0OiBEYXRlID0gbnVsbDtcbiAgICB1cGxvYWRPcmRlcjogbnVtYmVyID0gMDtcbiAgICBmYWlsdXJlVHlwZTogc3RyaW5nO1xuICAgIGZhaWx1cmVSZWFzb246IHN0cmluZztcbiAgICBkYXRhOiBVcGxvYWRGaWxlRGF0YTtcbiAgICB1cGxvYWRTdWJzY3JpcHRpb246IElTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSBfc3RhdHVzSGlzdG9yeSA6IHsgW2tleTpzdHJpbmddIDogYm9vbGVhbiB9ID0ge1xuICAgICAgICAnYWRkZWQnIDogdHJ1ZVxuICAgIH07XG5cbiAgICBjb25zdHJ1Y3RvcihpZDogc3RyaW5nLCBkYXRhOiBVcGxvYWRGaWxlRGF0YSlcbiAgICB7XG4gICAgICAgIHRoaXMuX2lkID0gaWQ7XG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgfVxuXG4gICAgcHVibGljIGFzRGF0YSgpIDogVHJhY2tlZEZpbGVEYXRhe1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLFxuICAgICAgICAgICAgdXBsb2FkU3RhcnRBdDogdGhpcy51cGxvYWRTdGFydEF0LFxuICAgICAgICAgICAgcHJvZ3Jlc3M6IHRoaXMucHJvZ3Jlc3MsXG4gICAgICAgICAgICB1cGxvYWRDb21wbGV0ZUF0OiB0aGlzLnVwbG9hZENvbXBsZXRlQXQsXG4gICAgICAgICAgICB1cGxvYWRPcmRlcjogdGhpcy51cGxvYWRPcmRlcixcbiAgICAgICAgICAgIGZhaWx1cmVUeXBlOiB0aGlzLmZhaWx1cmVUeXBlLFxuICAgICAgICAgICAgZmFpbHVyZVJlYXNvbjogdGhpcy5mYWlsdXJlUmVhc29uLFxuICAgICAgICAgICAgZGF0YTogdGhpcy5kYXRhXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZShjaGFuZ2VzOiBUcmFja2VkRmlsZUNoYW5nZXMpOiB2b2lkXG4gICAge1xuICAgICAgICBpZiAoY2hhbmdlcy5zdGF0dXMgJiYgY2hhbmdlcy5zdGF0dXMgIT09IHRoaXMuc3RhdHVzKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuY2FuVHJhbnNpdGlvblRvKGNoYW5nZXMuc3RhdHVzKSlcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGZpbGUgJHt0aGlzLmlkfTogY2Fubm90IHVwZGF0ZSBzdGF0dXMgdG8gJyR7Y2hhbmdlcy5zdGF0dXN9J2ApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLl9zdGF0dXNIaXN0b3J5W2NoYW5nZXMuc3RhdHVzXSA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsY2hhbmdlcyk7XG4gICAgfVxuXG4gICAgcHVibGljIHdhc0luU3RhdHVzKHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXMpOiBib29sZWFuXG4gICAge1xuICAgICAgICByZXR1cm4gISF0aGlzLl9zdGF0dXNIaXN0b3J5W3N0YXR1c107XG4gICAgfVxuXG4gICAgcHVibGljIGNhblRyYW5zaXRpb25Ubyh0b1N0YXR1czogc3RyaW5nKSA6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBib29sZWFuID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHRyYWNrZWRGaWxlID0gdGhpcztcbiAgICAgICAgY29uc3QgZnJvbVN0YXR1cyA9IHRyYWNrZWRGaWxlID8gdHJhY2tlZEZpbGUuc3RhdHVzIDogbnVsbDtcblxuICAgICAgICBpZiAodHJhY2tlZEZpbGUgICYmIGZyb21TdGF0dXMgJiYgdG9TdGF0dXMpIHtcblxuICAgICAgICAgICAgaWYgKGZyb21TdGF0dXMgPT09IFRyYWNrZWRGaWxlU3RhdHVzZXMucHVyZ2VkKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIC8vIG5ldmVyIGFsbG93IGNoYW5naW5nIHN0YXR1cyBvbmNlIGZpbGUgd2FzIHB1cmdlZFxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzd2l0Y2ggKHRvU3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBUcmFja2VkRmlsZVN0YXR1c2VzLmFkZGVkOlxuICAgICAgICAgICAgICAgICAgICAvLyBvbmUtdGltZSBzdGF0dXMsIGNhbm5vdCBiZSBhc3NpZ25lZCB0d2ljZVxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAhdGhpcy53YXNJblN0YXR1cyhUcmFja2VkRmlsZVN0YXR1c2VzLmFkZGVkKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBUcmFja2VkRmlsZVN0YXR1c2VzLnBlbmRpbmdQcmVwYXJlOlxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAhdGhpcy53YXNJblN0YXR1cyhUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmVkKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmluZzpcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gIXRoaXMud2FzSW5TdGF0dXMoVHJhY2tlZEZpbGVTdGF0dXNlcy5wcmVwYXJlZClcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIGZyb21TdGF0dXMgPT09IFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1ByZXBhcmU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgVHJhY2tlZEZpbGVTdGF0dXNlcy5wcmVwYXJlZDpcbiAgICAgICAgICAgICAgICAgICAgLy8gb25lLXRpbWUgc3RhdHVzLCBjYW5ub3QgYmUgYXNzaWduZWQgdHdpY2VcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gIXRoaXMud2FzSW5TdGF0dXMoVHJhY2tlZEZpbGVTdGF0dXNlcy5wcmVwYXJlZClcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIGZyb21TdGF0dXMgPT09IFRyYWNrZWRGaWxlU3RhdHVzZXMucHJlcGFyaW5nO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1VwbG9hZDpcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy53YXNJblN0YXR1cyhUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmVkKVxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgIXRoaXMud2FzSW5TdGF0dXMoVHJhY2tlZEZpbGVTdGF0dXNlcy51cGxvYWRDb21wbGV0ZWQpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFRyYWNrZWRGaWxlU3RhdHVzZXMudXBsb2FkaW5nOlxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAhdGhpcy53YXNJblN0YXR1cyhUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZENvbXBsZXRlZClcbiAgICAgICAgICAgICAgICAgICAgICAgICYmIGZyb21TdGF0dXMgPT09IFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1VwbG9hZDtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZENvbXBsZXRlZDpcbiAgICAgICAgICAgICAgICAgICAgLy8gb25lLXRpbWUgc3RhdHVzLCBjYW5ub3QgYmUgYXNzaWduZWQgdHdpY2VcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gIXRoaXMud2FzSW5TdGF0dXMoVHJhY2tlZEZpbGVTdGF0dXNlcy51cGxvYWRDb21wbGV0ZWQpXG4gICAgICAgICAgICAgICAgICAgICAgICAmJiBmcm9tU3RhdHVzID09PSBUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZGluZztcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBUcmFja2VkRmlsZVN0YXR1c2VzLmNhbmNlbGxlZDpcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gKFtUcmFja2VkRmlsZVN0YXR1c2VzLmNhbmNlbGxlZCwgVHJhY2tlZEZpbGVTdGF0dXNlcy51cGxvYWRDb21wbGV0ZWQsIFRyYWNrZWRGaWxlU3RhdHVzZXMucHVyZ2VkXS5pbmRleE9mKGZyb21TdGF0dXMpID09PSAtMSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgVHJhY2tlZEZpbGVTdGF0dXNlcy5mYWlsdXJlOlxuICAgICAgICAgICAgICAgICAgICAvLyBhbHdheXMgYWxsb3cgY2hhbmdpbmcgdG8gJ2ZhaWx1cmUnIHN0YXR1cyAoYXNzdW1pbmcgJ3B1cmdlJyBpcyBoYW5kbGVkIHNlcGFyYXRlbHkgYmVmb3JlKVxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAoW1RyYWNrZWRGaWxlU3RhdHVzZXMudXBsb2FkQ29tcGxldGVkLCBUcmFja2VkRmlsZVN0YXR1c2VzLnB1cmdlZF0uaW5kZXhPZihmcm9tU3RhdHVzKSA9PT0gLTEpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFRyYWNrZWRGaWxlU3RhdHVzZXMucHVyZ2VkOlxuICAgICAgICAgICAgICAgICAgICAvLyBvbmUtdGltZSBzdGF0dXMsIGNhbm5vdCBiZSBhc3NpZ25lZCB0d2ljZVxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAhdGhpcy53YXNJblN0YXR1cyhUcmFja2VkRmlsZVN0YXR1c2VzLnB1cmdlZCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biBzdGF0dXMgcHJvdmlkZWQgJyR7dG9TdGF0dXN9J2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbn1cbiJdfQ==