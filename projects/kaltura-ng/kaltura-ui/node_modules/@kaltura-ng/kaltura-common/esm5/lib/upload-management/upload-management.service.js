import { __decorate, __metadata, __param, __read, __spread } from "tslib";
import { Injectable, Inject, Optional, InjectionToken } from '@angular/core';
import { Subject } from 'rxjs';
import 'rxjs/add/operator/groupBy';
import { FriendlyHashId } from '../friendly-hash-id';
import { TrackedFile, TrackedFileStatuses } from './tracked-file';
import { cancelOnDestroy } from '../rxjs/operators';
export var UploadFileAdapterToken = new InjectionToken('upload-file-adapter');
var UploadManagement = /** @class */ (function () {
    function UploadManagement(_uploadFileAdapter) {
        this._uploadFileAdapter = _uploadFileAdapter;
        this._trackedFiles = {};
        this._onTrackedFileChanged = new Subject();
        this._maxUploadRequests = null;
        this.onTrackedFileChanged$ = this._onTrackedFileChanged.asObservable();
        this._tokenGenerator = new FriendlyHashId();
    }
    UploadManagement.prototype.setMaxUploadRequests = function (maxUploads) {
        if (maxUploads === null || maxUploads > 0) {
            this._log('info', "limit max upload requests to " + maxUploads);
            this._maxUploadRequests = maxUploads;
        }
        else {
            this._log('info', "remove max upload limitation");
            this._maxUploadRequests = null;
        }
    };
    // TODO [kmcng] replace this function with log library
    UploadManagement.prototype._log = function (level, message, fileId) {
        var messageContext = fileId ? "file '" + fileId + "'" : '';
        var origin = 'upload manager';
        var formattedMessage = "log: [" + level + "] [" + origin + "] " + messageContext + ": " + message;
        switch (level) {
            case 'silly':
            case 'debug':
            case 'info':
                console.log(formattedMessage);
                break;
            case 'warn':
                console.warn(formattedMessage);
                break;
            case 'error':
                console.error(formattedMessage);
                break;
        }
    };
    UploadManagement.prototype.getTrackedFiles = function () {
        var _this = this;
        return Object.keys(this._trackedFiles).map(function (fileId) { return _this._trackedFiles[fileId].asData(); });
    };
    UploadManagement.prototype.getTrackedFile = function (fileId) {
        var relevantFile = this._trackedFiles[fileId];
        return relevantFile ? relevantFile.asData() : null;
    };
    UploadManagement.prototype.addFile = function (file) {
        var _a = __read(this.addFiles([file]), 1), newFileId = _a[0];
        return newFileId;
    };
    UploadManagement.prototype.addFiles = function (files) {
        var _this = this;
        var result = [];
        files.forEach(function (fileData) {
            var newUploadId = _this._tokenGenerator.generateUnique(Object.keys(_this._trackedFiles));
            _this._log('info', "add new file '" + fileData.getFileName() + "' to queue with unique file id", newUploadId);
            _this._createTrackedFile(newUploadId, fileData);
            result.push({ id: newUploadId, data: fileData });
        });
        if (result.length) {
            this._syncUploadQueue();
        }
        return result;
    };
    UploadManagement.prototype.cancelUploadWithError = function (id, reason) {
        this._log('info', "cancel file upload with custom reason '" + reason + "'", id);
        var trackedFile = this._trackedFiles[id];
        if (trackedFile) {
            {
                if (trackedFile.canTransitionTo(TrackedFileStatuses.cancelled)) {
                    this.cancelUpload(id, false);
                    if (trackedFile.canTransitionTo(TrackedFileStatuses.failure)) {
                        this._updateTrackedFile(trackedFile, {
                            status: TrackedFileStatuses.failure,
                            failureReason: reason || 'unknown error',
                            failureType: 'manual_error'
                        });
                    }
                }
            }
        }
        else {
            this._log('warn', 'cannot cancel upload, failed to find file with provided id', id);
        }
    };
    UploadManagement.prototype.resumeUpload = function (id) {
        this.resumeUploads([id]);
    };
    UploadManagement.prototype.resumeUploads = function (files) {
        var _this = this;
        var syncUploadQueue = false;
        files.forEach(function (id) {
            _this._log('info', "resume file upload.", id);
            var trackedFile = _this._trackedFiles[id];
            if (trackedFile) {
                if (trackedFile.wasInStatus(TrackedFileStatuses.prepared)) {
                    _this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.pendingUpload
                    });
                }
                else {
                    _this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.pendingPrepare
                    });
                }
            }
            else {
                _this._log('warn', 'cannot resume upload, failed to find file with provided id', id);
            }
        });
        this._syncUploadQueue();
    };
    UploadManagement.prototype.cancelUpload = function (id, purge) {
        if (purge === void 0) { purge = true; }
        this._log('info', "cancel file upload.", id);
        var trackedFile = this._trackedFiles[id];
        if (trackedFile) {
            if (trackedFile.status !== TrackedFileStatuses.cancelled
                && trackedFile.canTransitionTo(TrackedFileStatuses.cancelled)) {
                if (trackedFile.uploadSubscription) {
                    trackedFile.uploadSubscription.unsubscribe();
                    trackedFile.uploadSubscription = null;
                }
                this._updateTrackedFile(trackedFile, {
                    status: TrackedFileStatuses.cancelled
                });
                if (purge) {
                    this.purgeUpload(id);
                }
                this._syncUploadQueue();
            }
        }
        else {
            this._log('warn', 'cannot cancel upload, failed to find file with provided id', id);
        }
    };
    UploadManagement.prototype.purgeUpload = function (id) {
        this._log('info', "purge file from queue.", id);
        var trackedFile = this._trackedFiles[id];
        if (trackedFile) {
            if (trackedFile.canTransitionTo(TrackedFileStatuses.purged)) {
                this.cancelUpload(id, false);
                this._updateTrackedFile(trackedFile, { status: TrackedFileStatuses.purged });
                this._removeTrackedFile(trackedFile);
            }
        }
        else {
            this._log('warn', 'cannot purge upload, failed to find file with provided id', id);
        }
    };
    UploadManagement.prototype._removeTrackedFile = function (trackedFile) {
        this._log('info', "remove tracked file from queue", trackedFile.id);
        // Developer notice - this is a cleanup function just in case.
        if (trackedFile.uploadSubscription) {
            trackedFile.uploadSubscription.unsubscribe();
            trackedFile.uploadSubscription = null;
        }
        delete this._trackedFiles[trackedFile.id];
    };
    UploadManagement.prototype._syncUploadQueue = function () {
        var _this = this;
        if (this.syncUploadQueueTimeoutId) {
            clearTimeout(this.syncUploadQueueTimeoutId);
            this.syncUploadQueueTimeoutId = null;
        }
        // DEVELOPER NOTICE: This logic is delayed to the next event loop on purpose to prevent
        // collision between two sync requests
        this.syncUploadQueueTimeoutId = setTimeout(function () {
            _this._log('info', "syncing upload queue");
            _this.syncUploadQueueTimeoutId = null;
            _this._executePreparePhase();
            _this._executeUploadPhase();
        }, 200);
    };
    UploadManagement.prototype._executePreparePhase = function () {
        var _this = this;
        var files = Object.keys(this._trackedFiles).map(function (fileId) { return _this._trackedFiles[fileId]; }).filter(function (trackedFile) {
            return trackedFile.status === TrackedFileStatuses.pendingPrepare
                && trackedFile.canTransitionTo(TrackedFileStatuses.preparing);
        });
        if (files.length) {
            this._log('info', "handling " + files.length + " files, waiting to be prepared");
            var groupedFiles = files.reduce(function (acc, curr) {
                var uploadAdapter = _this._getUploadAdapter(curr.data) || null;
                var matchedItem = acc.find(function (item) { return item.adapter ? item.adapter.constructor === uploadAdapter.constructor : item.adapter === null; });
                if (matchedItem) {
                    matchedItem.files.push(curr);
                }
                else {
                    acc.push({ adapter: uploadAdapter, files: [curr] });
                }
                return acc;
            }, []);
            groupedFiles.forEach(function (item) {
                if (item.adapter) {
                    _this._log('debug', "executing prepare phase for " + item.files.length + " files with adapter '" + item.adapter.label + "'");
                    item.files.forEach(function (file) {
                        _this._updateTrackedFile(file, { status: TrackedFileStatuses.preparing });
                    });
                    item.adapter.prepare(item.files)
                        .pipe(cancelOnDestroy(_this))
                        .subscribe(function (preparedFiles) {
                        _this._log('debug', "executing prepare phase succeeded for " + item.files.length + " files with adapter '" + item.adapter.label + "'.");
                        _this._handlePrepareAdapterResponse(preparedFiles);
                        _this._syncUploadQueue();
                    }, function (reason) {
                        _this._log('error', "executing prepare phase failed for " + item.files.length + " files with adapter '" + item.adapter.label + "'. error: " + reason.message);
                        _this._handlePrepareAdapterResponse(item.files.map(function (file) { return ({ id: file.id, status: false }); }));
                        _this._syncUploadQueue();
                    });
                }
                else {
                    item.files.forEach(function (file) {
                        _this._updateTrackedFile(file, {
                            status: TrackedFileStatuses.failure,
                            failureReason: 'upload destination is not supported',
                            failureType: 'unknown_destination'
                        });
                    });
                }
            });
        }
    };
    UploadManagement.prototype._handlePrepareAdapterResponse = function (responseFiles) {
        var _this = this;
        responseFiles.forEach(function (responseFile) {
            var trackedFile = _this._trackedFiles[responseFile.id];
            if (!trackedFile) {
                _this._log('warn', "cannot handle prepare response for file '" + responseFile.id + "' since there is no tracking information for that file (did the user purge the file during the prepare execution?)");
            }
            else if (trackedFile.status !== TrackedFileStatuses.preparing) {
                _this._log('warn', "cannot handle file result from prepare action (did the user cancel the file upload during the prepare execution?)", trackedFile.id);
            }
            else if (responseFile.status) {
                var changedStatusToPrepared = _this._updateTrackedFile(trackedFile, {
                    status: TrackedFileStatuses.prepared
                });
                if (changedStatusToPrepared) {
                    _this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.pendingUpload
                    });
                }
            }
            else {
                _this._updateTrackedFile(trackedFile, {
                    status: TrackedFileStatuses.failure,
                    failureReason: 'failed to prepare upload',
                    failureType: 'preparation_failed'
                });
            }
        });
    };
    UploadManagement.prototype._executeUploadPhase = function () {
        var _this = this;
        var waitingForUploadsFiles = [];
        var activeUploadFiles = [];
        Object.keys(this._trackedFiles).forEach(function (fileId) {
            var trackedFile = _this._trackedFiles[fileId];
            if (trackedFile.status === TrackedFileStatuses.uploading) {
                activeUploadFiles.push(trackedFile);
            }
            else if (trackedFile.status === TrackedFileStatuses.pendingUpload
                && trackedFile.canTransitionTo(TrackedFileStatuses.uploading)) {
                waitingForUploadsFiles.push(trackedFile);
            }
        });
        var activeUploadsCount = activeUploadFiles.length;
        var waitingFilesCount = waitingForUploadsFiles.length;
        if (waitingFilesCount > 0) {
            var nextUploadFiles = [];
            this._log('silly', "active uploads: " + activeUploadsCount + " | pending files: " + waitingFilesCount);
            var availableUploadSlots = (this._maxUploadRequests && this._maxUploadRequests > 0) ? this._maxUploadRequests - activeUploadsCount : waitingFilesCount;
            if (availableUploadSlots > 0) {
                nextUploadFiles = __spread(waitingForUploadsFiles.sort(function (pendingFile) { return pendingFile.uploadOrder || 1000; })).slice(0, availableUploadSlots);
            }
            this._log('debug', "available upload slots to be used " + availableUploadSlots);
            nextUploadFiles.forEach(function (pendingFile) {
                _this._initiateUpload(pendingFile);
            });
        }
    };
    UploadManagement.prototype._createTrackedFile = function (id, fileData) {
        var newTrackedFile = this._trackedFiles[id] = new TrackedFile(id, fileData);
        this._onTrackedFileChanged.next(newTrackedFile.asData());
        this._updateTrackedFile(newTrackedFile, { status: TrackedFileStatuses.pendingPrepare });
    };
    UploadManagement.prototype._updateTrackedFile = function (trackedFile, changes) {
        var result = true;
        if (changes.status && changes.status !== trackedFile.status) {
            if (trackedFile.canTransitionTo(changes.status)) {
                this._log('info', "notify file status changes from '" + trackedFile.status + "' to '" + changes.status + "'", trackedFile.id);
                trackedFile.update(changes);
            }
            else {
                this._log('error', "cannot update file data from '" + trackedFile.status + "' to '" + changes.status + ". target status is not allowed. update to status 'failure' instead.", trackedFile.id);
                trackedFile.update({
                    status: TrackedFileStatuses.failure,
                    failureReason: 'cannot change status',
                    failureType: 'change_not_allowed'
                });
                result = false;
            }
        }
        else {
            //this._log('info', `notify file data changes`,trackedFile.id);
            trackedFile.update(changes);
        }
        this._onTrackedFileChanged.next(trackedFile.asData());
        return result;
    };
    UploadManagement.prototype.supportChunkUpload = function (uploadFileData) {
        var uploadAdapter = this._getUploadAdapter(uploadFileData);
        return uploadAdapter ? uploadAdapter.supportChunkUpload() : false;
    };
    UploadManagement.prototype._initiateUpload = function (trackedFile) {
        var _this = this;
        var data = trackedFile.data, id = trackedFile.id;
        var uploadAdapter = this._getUploadAdapter(data);
        this._log('info', "initiate new upload for file '" + id + "'");
        if (!uploadAdapter) {
            this._log('warn', "cannot find destination adapter for requested file, failing upload request");
            this._updateTrackedFile(trackedFile, {
                status: TrackedFileStatuses.failure,
                failureReason: 'upload destination is not supported',
                failureType: 'unknown_destination'
            });
            this._syncUploadQueue();
        }
        else if (trackedFile.canTransitionTo(TrackedFileStatuses.uploading)) {
            if (trackedFile.uploadSubscription) {
                this._log('warn', "an active upload was found while the status indicated no upload currently in progress. cancel previous upload");
                trackedFile.uploadSubscription.unsubscribe();
                trackedFile.uploadSubscription = null;
            }
            this._updateTrackedFile(trackedFile, {
                status: TrackedFileStatuses.uploading,
                progress: 0,
                uploadStartAt: new Date(),
            });
            var canHandleResponse_1 = function (id, actionDescription) {
                var result = false;
                var trackedFileStillExists = !!_this._trackedFiles[id];
                if (!trackedFileStillExists) {
                    _this._log('warn', "cannot handle file upload " + actionDescription + ". There is no tracking file with the provided id (was the file purged?)", id);
                }
                else if (trackedFile.status !== TrackedFileStatuses.uploading) {
                    _this._log('warn', "cannot handle file upload " + actionDescription + ". The file status it not 'uploading' (was the file upload cancelled?)", id);
                }
                else {
                    result = true;
                }
                return result;
            };
            trackedFile.uploadSubscription = uploadAdapter.upload(id, data)
                .subscribe(function (uploadChanges) {
                if (canHandleResponse_1(id, 'progress')) {
                    _this._updateTrackedFile(trackedFile, {
                        progress: uploadChanges.progress
                    });
                }
            }, function (error) {
                trackedFile.uploadSubscription = null;
                if (canHandleResponse_1(id, 'failure')) {
                    var failureReason = error && error.message ? error.message : '';
                    _this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.failure,
                        failureReason: failureReason,
                        failureType: 'general_error'
                    });
                }
                _this._syncUploadQueue();
            }, function () {
                trackedFile.uploadSubscription = null;
                if (canHandleResponse_1(id, 'completion')) {
                    _this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.uploadCompleted,
                        progress: 1,
                        uploadCompleteAt: new Date()
                    });
                    _this._removeTrackedFile(trackedFile);
                    _this._syncUploadQueue();
                }
            });
        }
    };
    UploadManagement.prototype._getUploadAdapter = function (fileData) {
        if (this._uploadFileAdapter) {
            return this._uploadFileAdapter.find(function (uploadFileAdapter) {
                return uploadFileAdapter.canHandle(fileData);
            });
        }
        else {
            return null;
        }
    };
    UploadManagement.prototype.ngOnDestroy = function () {
        var _this = this;
        Object.keys(this._trackedFiles).forEach(function (id) {
            _this.purgeUpload(id);
        });
    };
    UploadManagement.ctorParameters = function () { return [
        { type: Array, decorators: [{ type: Inject, args: [UploadFileAdapterToken,] }, { type: Optional }] }
    ]; };
    UploadManagement = __decorate([
        Injectable(),
        __param(0, Inject(UploadFileAdapterToken)), __param(0, Optional()),
        __metadata("design:paramtypes", [Array])
    ], UploadManagement);
    return UploadManagement;
}());
export { UploadManagement };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLW1hbmFnZW1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3VwbG9hZC1tYW5hZ2VtZW50L3VwbG9hZC1tYW5hZ2VtZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBYSxVQUFVLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHeEYsT0FBTyxFQUFFLE9BQU8sRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLDJCQUEyQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsV0FBVyxFQUF1QyxtQkFBbUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQU1wRCxNQUFNLENBQUMsSUFBTSxzQkFBc0IsR0FBRyxJQUFJLGNBQWMsQ0FBUyxxQkFBcUIsQ0FBQyxDQUFDO0FBR3hGO0lBUUksMEJBQWdFLGtCQUE0QztRQUE1Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTBCO1FBUHBHLGtCQUFhLEdBQWlCLEVBQUUsQ0FBQztRQUNqQywwQkFBcUIsR0FBRyxJQUFJLE9BQU8sRUFBbUIsQ0FBQztRQUN2RCx1QkFBa0IsR0FBVyxJQUFJLENBQUM7UUFDbkMsMEJBQXFCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2pFLG9CQUFlLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztJQUsvQyxDQUFDO0lBRU0sK0NBQW9CLEdBQTNCLFVBQTRCLFVBQW1CO1FBQzNDLElBQUksVUFBVSxLQUFLLElBQUksSUFBSSxVQUFVLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFF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QztTQTFnQlksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT25EZXN0cm95LCBJbmplY3RhYmxlLCBJbmplY3QsIE9wdGlvbmFsLCBJbmplY3Rpb25Ub2tlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVXBsb2FkRmlsZURhdGEgfSBmcm9tICcuL3VwbG9hZC1maWxlLWRhdGEnO1xuaW1wb3J0IHsgVXBsb2FkRmlsZUFkYXB0ZXIgfSBmcm9tICcuL3VwbG9hZC1maWxlLWFkYXB0ZXInO1xuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9ncm91cEJ5JztcbmltcG9ydCB7IEZyaWVuZGx5SGFzaElkIH0gZnJvbSAnLi4vZnJpZW5kbHktaGFzaC1pZCc7XG5pbXBvcnQgeyBUcmFja2VkRmlsZSwgVHJhY2tlZEZpbGVDaGFuZ2VzLCBUcmFja2VkRmlsZURhdGEsIFRyYWNrZWRGaWxlU3RhdHVzZXMgfSBmcm9tICcuL3RyYWNrZWQtZmlsZSc7XG5pbXBvcnQgeyBjYW5jZWxPbkRlc3Ryb3kgfSBmcm9tICcuLi9yeGpzL29wZXJhdG9ycyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhY2tlZEZpbGVzIHtcbiAgICBbaWQ6IHN0cmluZ106IFRyYWNrZWRGaWxlXG59XG5cbmV4cG9ydCBjb25zdCBVcGxvYWRGaWxlQWRhcHRlclRva2VuID0gbmV3IEluamVjdGlvblRva2VuPHN0cmluZz4oJ3VwbG9hZC1maWxlLWFkYXB0ZXInKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFVwbG9hZE1hbmFnZW1lbnQgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICAgIHByaXZhdGUgX3RyYWNrZWRGaWxlczogVHJhY2tlZEZpbGVzID0ge307XG4gICAgcHJpdmF0ZSBfb25UcmFja2VkRmlsZUNoYW5nZWQgPSBuZXcgU3ViamVjdDxUcmFja2VkRmlsZURhdGE+KCk7XG4gICAgcHJpdmF0ZSBfbWF4VXBsb2FkUmVxdWVzdHM6IG51bWJlciA9IG51bGw7XG4gICAgcHVibGljIG9uVHJhY2tlZEZpbGVDaGFuZ2VkJCA9IHRoaXMuX29uVHJhY2tlZEZpbGVDaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHByaXZhdGUgX3Rva2VuR2VuZXJhdG9yID0gbmV3IEZyaWVuZGx5SGFzaElkKCk7XG4gICAgc3luY1VwbG9hZFF1ZXVlVGltZW91dElkIDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoQEluamVjdChVcGxvYWRGaWxlQWRhcHRlclRva2VuKSBAT3B0aW9uYWwoKSBwcml2YXRlIF91cGxvYWRGaWxlQWRhcHRlcjogVXBsb2FkRmlsZUFkYXB0ZXI8YW55PltdKSB7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0TWF4VXBsb2FkUmVxdWVzdHMobWF4VXBsb2Fkcz86IG51bWJlcik6IHZvaWQge1xuICAgICAgICBpZiAobWF4VXBsb2FkcyA9PT0gbnVsbCB8fCBtYXhVcGxvYWRzID4gMCkge1xuICAgICAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYGxpbWl0IG1heCB1cGxvYWQgcmVxdWVzdHMgdG8gJHttYXhVcGxvYWRzfWApO1xuICAgICAgICAgICAgdGhpcy5fbWF4VXBsb2FkUmVxdWVzdHMgPSBtYXhVcGxvYWRzO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYHJlbW92ZSBtYXggdXBsb2FkIGxpbWl0YXRpb25gKTtcbiAgICAgICAgICAgIHRoaXMuX21heFVwbG9hZFJlcXVlc3RzID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIFRPRE8gW2ttY25nXSByZXBsYWNlIHRoaXMgZnVuY3Rpb24gd2l0aCBsb2cgbGlicmFyeVxuICAgIHByaXZhdGUgX2xvZyhsZXZlbDogJ3NpbGx5JyB8ICdkZWJ1ZycgfCAnaW5mbycgfCAnd2FybicgfCAnZXJyb3InLCBtZXNzYWdlOiBzdHJpbmcsIGZpbGVJZD86IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBtZXNzYWdlQ29udGV4dCA9IGZpbGVJZCA/IGBmaWxlICcke2ZpbGVJZH0nYCA6ICcnO1xuICAgICAgICBjb25zdCBvcmlnaW4gPSAndXBsb2FkIG1hbmFnZXInO1xuICAgICAgICBjb25zdCBmb3JtYXR0ZWRNZXNzYWdlID0gYGxvZzogWyR7bGV2ZWx9XSBbJHtvcmlnaW59XSAke21lc3NhZ2VDb250ZXh0fTogJHttZXNzYWdlfWA7XG4gICAgICAgIHN3aXRjaCAobGV2ZWwpIHtcbiAgICAgICAgICAgIGNhc2UgJ3NpbGx5JzpcbiAgICAgICAgICAgIGNhc2UgJ2RlYnVnJzpcbiAgICAgICAgICAgIGNhc2UgJ2luZm8nOlxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGZvcm1hdHRlZE1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnd2Fybic6XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGZvcm1hdHRlZE1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZm9ybWF0dGVkTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0VHJhY2tlZEZpbGVzKCk6IFRyYWNrZWRGaWxlRGF0YVtdXG4gICAge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fdHJhY2tlZEZpbGVzKS5tYXAoZmlsZUlkID0+IHRoaXMuX3RyYWNrZWRGaWxlc1tmaWxlSWRdLmFzRGF0YSgpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0VHJhY2tlZEZpbGUoZmlsZUlkOiBzdHJpbmcpOiBUcmFja2VkRmlsZURhdGFcbiAgICB7XG4gICAgICAgIGNvbnN0IHJlbGV2YW50RmlsZSA9IHRoaXMuX3RyYWNrZWRGaWxlc1tmaWxlSWRdO1xuICAgICAgICByZXR1cm4gcmVsZXZhbnRGaWxlPyByZWxldmFudEZpbGUuYXNEYXRhKCkgOiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRGaWxlKGZpbGU6IFVwbG9hZEZpbGVEYXRhKTogeyBpZDogc3RyaW5nIH0ge1xuICAgICAgICBjb25zdCBbbmV3RmlsZUlkXSA9IHRoaXMuYWRkRmlsZXMoW2ZpbGVdKTtcbiAgICAgICAgcmV0dXJuIG5ld0ZpbGVJZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkRmlsZXMoZmlsZXM6IFVwbG9hZEZpbGVEYXRhW10pOiB7IGlkOiBzdHJpbmcsIGRhdGE6IFVwbG9hZEZpbGVEYXRhIH1bXSB7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0OiB7IGlkOiBzdHJpbmcsIGRhdGE6IFVwbG9hZEZpbGVEYXRhIH1bXSA9IFtdO1xuXG4gICAgICAgIGZpbGVzLmZvckVhY2goKGZpbGVEYXRhKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IG5ld1VwbG9hZElkID0gdGhpcy5fdG9rZW5HZW5lcmF0b3IuZ2VuZXJhdGVVbmlxdWUoT2JqZWN0LmtleXModGhpcy5fdHJhY2tlZEZpbGVzKSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGBhZGQgbmV3IGZpbGUgJyR7ZmlsZURhdGEuZ2V0RmlsZU5hbWUoKX0nIHRvIHF1ZXVlIHdpdGggdW5pcXVlIGZpbGUgaWRgLG5ld1VwbG9hZElkKTtcbiAgICAgICAgICAgIHRoaXMuX2NyZWF0ZVRyYWNrZWRGaWxlKG5ld1VwbG9hZElkLCBmaWxlRGF0YSk7XG5cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtpZDogbmV3VXBsb2FkSWQsIGRhdGE6IGZpbGVEYXRhfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChyZXN1bHQubGVuZ3RoKVxuICAgICAgICB7XG4gICAgICAgICAgICB0aGlzLl9zeW5jVXBsb2FkUXVldWUoKTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FuY2VsVXBsb2FkV2l0aEVycm9yKGlkOiBzdHJpbmcsIHJlYXNvbjogc3RyaW5nKSA6IHZvaWQge1xuICAgICAgICB0aGlzLl9sb2coJ2luZm8nLCBgY2FuY2VsIGZpbGUgdXBsb2FkIHdpdGggY3VzdG9tIHJlYXNvbiAnJHtyZWFzb259J2AsaWQpO1xuXG4gICAgICAgIGNvbnN0IHRyYWNrZWRGaWxlID0gdGhpcy5fdHJhY2tlZEZpbGVzW2lkXTtcblxuICAgICAgICBpZiAodHJhY2tlZEZpbGUpIHtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUuY2FuVHJhbnNpdGlvblRvKFRyYWNrZWRGaWxlU3RhdHVzZXMuY2FuY2VsbGVkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbFVwbG9hZChpZCwgZmFsc2UpO1xuXG4gICAgICAgICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUuY2FuVHJhbnNpdGlvblRvKFRyYWNrZWRGaWxlU3RhdHVzZXMuZmFpbHVyZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLmZhaWx1cmUsXG4gICAgICAgICAgICAgICAgICAgICAgICBmYWlsdXJlUmVhc29uOiByZWFzb24gfHwgJ3Vua25vd24gZXJyb3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVR5cGU6ICdtYW51YWxfZXJyb3InXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfWVsc2VcbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5fbG9nKCd3YXJuJywnY2Fubm90IGNhbmNlbCB1cGxvYWQsIGZhaWxlZCB0byBmaW5kIGZpbGUgd2l0aCBwcm92aWRlZCBpZCcsaWQpO1xuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgcmVzdW1lVXBsb2FkKGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgIHRoaXMucmVzdW1lVXBsb2FkcyhbaWRdKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVzdW1lVXBsb2FkcyhmaWxlczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgbGV0IHN5bmNVcGxvYWRRdWV1ZSA9IGZhbHNlO1xuXG4gICAgICAgIGZpbGVzLmZvckVhY2goaWQgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYHJlc3VtZSBmaWxlIHVwbG9hZC5gLCBpZCk7XG4gICAgICAgICAgICBjb25zdCB0cmFja2VkRmlsZSA9IHRoaXMuX3RyYWNrZWRGaWxlc1tpZF07XG5cbiAgICAgICAgICAgIGlmICh0cmFja2VkRmlsZSkge1xuICAgICAgICAgICAgICAgIGlmICh0cmFja2VkRmlsZS53YXNJblN0YXR1cyhUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmVkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLnBlbmRpbmdVcGxvYWRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5wZW5kaW5nUHJlcGFyZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsICdjYW5ub3QgcmVzdW1lIHVwbG9hZCwgZmFpbGVkIHRvIGZpbmQgZmlsZSB3aXRoIHByb3ZpZGVkIGlkJywgaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9zeW5jVXBsb2FkUXVldWUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FuY2VsVXBsb2FkKGlkOiBzdHJpbmcsIHB1cmdlOiBib29sZWFuPSB0cnVlKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGBjYW5jZWwgZmlsZSB1cGxvYWQuYCwgaWQpO1xuXG4gICAgICAgIGNvbnN0IHRyYWNrZWRGaWxlID0gdGhpcy5fdHJhY2tlZEZpbGVzW2lkXTtcblxuICAgICAgICBpZiAodHJhY2tlZEZpbGUpIHtcbiAgICAgICAgICAgIGlmICh0cmFja2VkRmlsZS5zdGF0dXMgIT09IFRyYWNrZWRGaWxlU3RhdHVzZXMuY2FuY2VsbGVkXG4gICAgICAgICAgICAgICAgJiYgdHJhY2tlZEZpbGUuY2FuVHJhbnNpdGlvblRvKFRyYWNrZWRGaWxlU3RhdHVzZXMuY2FuY2VsbGVkKSlcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUudXBsb2FkU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMuY2FuY2VsbGVkXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKHB1cmdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHVyZ2VVcGxvYWQoaWQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMuX3N5bmNVcGxvYWRRdWV1ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ZWxzZVxuICAgICAgICB7XG4gICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCAnY2Fubm90IGNhbmNlbCB1cGxvYWQsIGZhaWxlZCB0byBmaW5kIGZpbGUgd2l0aCBwcm92aWRlZCBpZCcsIGlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBwdXJnZVVwbG9hZChpZDogc3RyaW5nKTogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYHB1cmdlIGZpbGUgZnJvbSBxdWV1ZS5gLCBpZCk7XG5cbiAgICAgICAgY29uc3QgdHJhY2tlZEZpbGUgPSB0aGlzLl90cmFja2VkRmlsZXNbaWRdO1xuXG4gICAgICAgIGlmICh0cmFja2VkRmlsZSlcbiAgICAgICAge1xuICAgICAgICAgICAgaWYgKHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhUcmFja2VkRmlsZVN0YXR1c2VzLnB1cmdlZCkpIHtcblxuICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsVXBsb2FkKGlkLCBmYWxzZSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSwge3N0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5wdXJnZWR9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfWVsc2VcbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5fbG9nKCd3YXJuJywgJ2Nhbm5vdCBwdXJnZSB1cGxvYWQsIGZhaWxlZCB0byBmaW5kIGZpbGUgd2l0aCBwcm92aWRlZCBpZCcsIGlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3JlbW92ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlOiBUcmFja2VkRmlsZSkge1xuICAgICAgICB0aGlzLl9sb2coJ2luZm8nLCBgcmVtb3ZlIHRyYWNrZWQgZmlsZSBmcm9tIHF1ZXVlYCwgdHJhY2tlZEZpbGUuaWQpO1xuXG4gICAgICAgIC8vIERldmVsb3BlciBub3RpY2UgLSB0aGlzIGlzIGEgY2xlYW51cCBmdW5jdGlvbiBqdXN0IGluIGNhc2UuXG4gICAgICAgIGlmICh0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgdHJhY2tlZEZpbGUudXBsb2FkU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLl90cmFja2VkRmlsZXNbdHJhY2tlZEZpbGUuaWRdO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3N5bmNVcGxvYWRRdWV1ZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuc3luY1VwbG9hZFF1ZXVlVGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5zeW5jVXBsb2FkUXVldWVUaW1lb3V0SWQpO1xuICAgICAgICAgICAgdGhpcy5zeW5jVXBsb2FkUXVldWVUaW1lb3V0SWQgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gREVWRUxPUEVSIE5PVElDRTogVGhpcyBsb2dpYyBpcyBkZWxheWVkIHRvIHRoZSBuZXh0IGV2ZW50IGxvb3Agb24gcHVycG9zZSB0byBwcmV2ZW50XG4gICAgICAgIC8vIGNvbGxpc2lvbiBiZXR3ZWVuIHR3byBzeW5jIHJlcXVlc3RzXG4gICAgICAgIHRoaXMuc3luY1VwbG9hZFF1ZXVlVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9sb2coJ2luZm8nLCBgc3luY2luZyB1cGxvYWQgcXVldWVgKTtcbiAgICAgICAgICAgIHRoaXMuc3luY1VwbG9hZFF1ZXVlVGltZW91dElkID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVQcmVwYXJlUGhhc2UoKTtcbiAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVVcGxvYWRQaGFzZSgpO1xuICAgICAgICB9LCAyMDApO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2V4ZWN1dGVQcmVwYXJlUGhhc2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gT2JqZWN0LmtleXModGhpcy5fdHJhY2tlZEZpbGVzKS5tYXAoZmlsZUlkID0+IHRoaXMuX3RyYWNrZWRGaWxlc1tmaWxlSWRdKS5maWx0ZXIodHJhY2tlZEZpbGUgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRyYWNrZWRGaWxlLnN0YXR1cyA9PT0gVHJhY2tlZEZpbGVTdGF0dXNlcy5wZW5kaW5nUHJlcGFyZVxuICAgICAgICAgICAgICAgICYmIHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmluZyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChmaWxlcy5sZW5ndGgpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZygnaW5mbycsYGhhbmRsaW5nICR7ZmlsZXMubGVuZ3RofSBmaWxlcywgd2FpdGluZyB0byBiZSBwcmVwYXJlZGApO1xuXG4gICAgICAgICAgICBjb25zdCBncm91cGVkRmlsZXMgPSBmaWxlcy5yZWR1Y2UoKGFjYzogeyBhZGFwdGVyOiBVcGxvYWRGaWxlQWRhcHRlcjxhbnk+LCBmaWxlczogVHJhY2tlZEZpbGVbXSB9W10sIGN1cnIgOiBUcmFja2VkRmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVwbG9hZEFkYXB0ZXIgPSB0aGlzLl9nZXRVcGxvYWRBZGFwdGVyKGN1cnIuZGF0YSkgfHwgbnVsbDtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoZWRJdGVtID0gYWNjLmZpbmQoaXRlbSA9PiBpdGVtLmFkYXB0ZXIgPyBpdGVtLmFkYXB0ZXIuY29uc3RydWN0b3IgPT09IHVwbG9hZEFkYXB0ZXIuY29uc3RydWN0b3IgOiBpdGVtLmFkYXB0ZXIgPT09IG51bGwpO1xuXG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoZWRJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZWRJdGVtLmZpbGVzLnB1c2goY3Vycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYWNjLnB1c2goe2FkYXB0ZXI6IHVwbG9hZEFkYXB0ZXIsIGZpbGVzOiBbY3Vycl19KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgICAgfSwgW10pO1xuXG4gICAgICAgICAgICBncm91cGVkRmlsZXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5hZGFwdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnZGVidWcnLCBgZXhlY3V0aW5nIHByZXBhcmUgcGhhc2UgZm9yICR7aXRlbS5maWxlcy5sZW5ndGh9IGZpbGVzIHdpdGggYWRhcHRlciAnJHtpdGVtLmFkYXB0ZXIubGFiZWx9J2ApO1xuXG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uZmlsZXMuZm9yRWFjaChmaWxlID0+XG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKGZpbGUseyBzdGF0dXMgOiBUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmluZ30pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBpdGVtLmFkYXB0ZXIucHJlcGFyZShpdGVtLmZpbGVzKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoY2FuY2VsT25EZXN0cm95KHRoaXMpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVwYXJlZEZpbGVzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nKCdkZWJ1ZycsIGBleGVjdXRpbmcgcHJlcGFyZSBwaGFzZSBzdWNjZWVkZWQgZm9yICR7aXRlbS5maWxlcy5sZW5ndGh9IGZpbGVzIHdpdGggYWRhcHRlciAnJHtpdGVtLmFkYXB0ZXIubGFiZWx9Jy5gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFuZGxlUHJlcGFyZUFkYXB0ZXJSZXNwb25zZShwcmVwYXJlZEZpbGVzKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zeW5jVXBsb2FkUXVldWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbiA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nKCdlcnJvcicsIGBleGVjdXRpbmcgcHJlcGFyZSBwaGFzZSBmYWlsZWQgZm9yICR7aXRlbS5maWxlcy5sZW5ndGh9IGZpbGVzIHdpdGggYWRhcHRlciAnJHtpdGVtLmFkYXB0ZXIubGFiZWx9Jy4gZXJyb3I6ICR7cmVhc29uLm1lc3NhZ2V9YCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGFuZGxlUHJlcGFyZUFkYXB0ZXJSZXNwb25zZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uZmlsZXMubWFwKGZpbGUgPT4oeyBpZDogZmlsZS5pZCwgc3RhdHVzOmZhbHNlfSkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3luY1VwbG9hZFF1ZXVlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKGZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMuZmFpbHVyZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVJlYXNvbjogJ3VwbG9hZCBkZXN0aW5hdGlvbiBpcyBub3Qgc3VwcG9ydGVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVR5cGU6ICd1bmtub3duX2Rlc3RpbmF0aW9uJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9oYW5kbGVQcmVwYXJlQWRhcHRlclJlc3BvbnNlKHJlc3BvbnNlRmlsZXMgOiB7IGlkOiBzdHJpbmcsIHN0YXR1czpib29sZWFufVtdKSA6IHZvaWQge1xuICAgICAgICByZXNwb25zZUZpbGVzLmZvckVhY2goXG4gICAgICAgICAgICByZXNwb25zZUZpbGUgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRyYWNrZWRGaWxlID0gdGhpcy5fdHJhY2tlZEZpbGVzW3Jlc3BvbnNlRmlsZS5pZF07XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRyYWNrZWRGaWxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsIGBjYW5ub3QgaGFuZGxlIHByZXBhcmUgcmVzcG9uc2UgZm9yIGZpbGUgJyR7cmVzcG9uc2VGaWxlLmlkfScgc2luY2UgdGhlcmUgaXMgbm8gdHJhY2tpbmcgaW5mb3JtYXRpb24gZm9yIHRoYXQgZmlsZSAoZGlkIHRoZSB1c2VyIHB1cmdlIHRoZSBmaWxlIGR1cmluZyB0aGUgcHJlcGFyZSBleGVjdXRpb24/KWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0cmFja2VkRmlsZS5zdGF0dXMgIT09IFRyYWNrZWRGaWxlU3RhdHVzZXMucHJlcGFyaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsIGBjYW5ub3QgaGFuZGxlIGZpbGUgcmVzdWx0IGZyb20gcHJlcGFyZSBhY3Rpb24gKGRpZCB0aGUgdXNlciBjYW5jZWwgdGhlIGZpbGUgdXBsb2FkIGR1cmluZyB0aGUgcHJlcGFyZSBleGVjdXRpb24/KWAsIHRyYWNrZWRGaWxlLmlkKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRmlsZS5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbmdlZFN0YXR1c1RvUHJlcGFyZWQgPSB0aGlzLl91cGRhdGVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMucHJlcGFyZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGFuZ2VkU3RhdHVzVG9QcmVwYXJlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1VwbG9hZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLmZhaWx1cmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVJlYXNvbjogJ2ZhaWxlZCB0byBwcmVwYXJlIHVwbG9hZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVR5cGU6ICdwcmVwYXJhdGlvbl9mYWlsZWQnXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9leGVjdXRlVXBsb2FkUGhhc2UoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHdhaXRpbmdGb3JVcGxvYWRzRmlsZXMgPSBbXTtcbiAgICAgICAgY29uc3QgYWN0aXZlVXBsb2FkRmlsZXMgPSBbXTtcblxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl90cmFja2VkRmlsZXMpLmZvckVhY2goZmlsZUlkID0+XG4gICAgICAgIHtcbiAgICAgICAgICAgIGNvbnN0IHRyYWNrZWRGaWxlID0gdGhpcy5fdHJhY2tlZEZpbGVzW2ZpbGVJZF07XG5cbiAgICAgICAgICAgIGlmICh0cmFja2VkRmlsZS5zdGF0dXMgPT09IFRyYWNrZWRGaWxlU3RhdHVzZXMudXBsb2FkaW5nKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGFjdGl2ZVVwbG9hZEZpbGVzLnB1c2godHJhY2tlZEZpbGUpO1xuICAgICAgICAgICAgfWVsc2UgaWYgKHRyYWNrZWRGaWxlLnN0YXR1cyA9PT0gVHJhY2tlZEZpbGVTdGF0dXNlcy5wZW5kaW5nVXBsb2FkXG4gICAgICAgICAgICAgICAgJiYgdHJhY2tlZEZpbGUuY2FuVHJhbnNpdGlvblRvKFRyYWNrZWRGaWxlU3RhdHVzZXMudXBsb2FkaW5nKSlcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB3YWl0aW5nRm9yVXBsb2Fkc0ZpbGVzLnB1c2godHJhY2tlZEZpbGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBhY3RpdmVVcGxvYWRzQ291bnQgPSBhY3RpdmVVcGxvYWRGaWxlcy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IHdhaXRpbmdGaWxlc0NvdW50ID0gd2FpdGluZ0ZvclVwbG9hZHNGaWxlcy5sZW5ndGg7XG5cbiAgICAgICAgaWYgKHdhaXRpbmdGaWxlc0NvdW50ID4gMCkge1xuICAgICAgICAgICAgbGV0IG5leHRVcGxvYWRGaWxlczogVHJhY2tlZEZpbGVbXSA9IFtdO1xuXG4gICAgICAgICAgICB0aGlzLl9sb2coJ3NpbGx5JywgYGFjdGl2ZSB1cGxvYWRzOiAke2FjdGl2ZVVwbG9hZHNDb3VudH0gfCBwZW5kaW5nIGZpbGVzOiAke3dhaXRpbmdGaWxlc0NvdW50fWApO1xuXG4gICAgICAgICAgICBjb25zdCBhdmFpbGFibGVVcGxvYWRTbG90cyA9ICh0aGlzLl9tYXhVcGxvYWRSZXF1ZXN0cyAmJiB0aGlzLl9tYXhVcGxvYWRSZXF1ZXN0cyA+IDApID8gdGhpcy5fbWF4VXBsb2FkUmVxdWVzdHMgLSBhY3RpdmVVcGxvYWRzQ291bnQgOiB3YWl0aW5nRmlsZXNDb3VudDtcblxuICAgICAgICAgICAgaWYgKGF2YWlsYWJsZVVwbG9hZFNsb3RzID4gMCkge1xuICAgICAgICAgICAgICAgIG5leHRVcGxvYWRGaWxlcyA9IFtcbiAgICAgICAgICAgICAgICAgICAgLi4ud2FpdGluZ0ZvclVwbG9hZHNGaWxlcy5zb3J0KHBlbmRpbmdGaWxlID0+IHBlbmRpbmdGaWxlLnVwbG9hZE9yZGVyIHx8IDEwMDApXG4gICAgICAgICAgICAgICAgXS5zbGljZSgwLCBhdmFpbGFibGVVcGxvYWRTbG90cyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX2xvZygnZGVidWcnLCBgYXZhaWxhYmxlIHVwbG9hZCBzbG90cyB0byBiZSB1c2VkICR7YXZhaWxhYmxlVXBsb2FkU2xvdHN9YCk7XG5cblxuICAgICAgICAgICAgbmV4dFVwbG9hZEZpbGVzLmZvckVhY2gocGVuZGluZ0ZpbGUgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2luaXRpYXRlVXBsb2FkKHBlbmRpbmdGaWxlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY3JlYXRlVHJhY2tlZEZpbGUoaWQ6IHN0cmluZywgZmlsZURhdGE6IFVwbG9hZEZpbGVEYXRhKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IG5ld1RyYWNrZWRGaWxlID0gdGhpcy5fdHJhY2tlZEZpbGVzW2lkXSA9IG5ldyBUcmFja2VkRmlsZShpZCwgZmlsZURhdGEpO1xuXG4gICAgICAgIHRoaXMuX29uVHJhY2tlZEZpbGVDaGFuZ2VkLm5leHQobmV3VHJhY2tlZEZpbGUuYXNEYXRhKCkpO1xuXG4gICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKG5ld1RyYWNrZWRGaWxlLFxuICAgICAgICAgICAge3N0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5wZW5kaW5nUHJlcGFyZX1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF91cGRhdGVUcmFja2VkRmlsZSh0cmFja2VkRmlsZTogVHJhY2tlZEZpbGUsIGNoYW5nZXM6IFRyYWNrZWRGaWxlQ2hhbmdlcyk6IGJvb2xlYW4ge1xuXG4gICAgICAgIGxldCByZXN1bHQgPSB0cnVlO1xuXG4gICAgICAgIGlmIChjaGFuZ2VzLnN0YXR1cyAmJiBjaGFuZ2VzLnN0YXR1cyAhPT0gdHJhY2tlZEZpbGUuc3RhdHVzKSB7XG5cblxuICAgICAgICAgICAgaWYgKHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhjaGFuZ2VzLnN0YXR1cykpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYG5vdGlmeSBmaWxlIHN0YXR1cyBjaGFuZ2VzIGZyb20gJyR7dHJhY2tlZEZpbGUuc3RhdHVzfScgdG8gJyR7Y2hhbmdlcy5zdGF0dXN9J2AsdHJhY2tlZEZpbGUuaWQpO1xuICAgICAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwZGF0ZShjaGFuZ2VzKTtcbiAgICAgICAgICAgIH1lbHNlXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9nKCdlcnJvcicsIGBjYW5ub3QgdXBkYXRlIGZpbGUgZGF0YSBmcm9tICcke3RyYWNrZWRGaWxlLnN0YXR1c30nIHRvICcke2NoYW5nZXMuc3RhdHVzfS4gdGFyZ2V0IHN0YXR1cyBpcyBub3QgYWxsb3dlZC4gdXBkYXRlIHRvIHN0YXR1cyAnZmFpbHVyZScgaW5zdGVhZC5gLHRyYWNrZWRGaWxlLmlkKTtcblxuICAgICAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwZGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5mYWlsdXJlLFxuICAgICAgICAgICAgICAgICAgICBmYWlsdXJlUmVhc29uOiAnY2Fubm90IGNoYW5nZSBzdGF0dXMnLFxuICAgICAgICAgICAgICAgICAgICBmYWlsdXJlVHlwZTogJ2NoYW5nZV9ub3RfYWxsb3dlZCdcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ZWxzZVxuICAgICAgICB7XG4gICAgICAgICAgICAvL3RoaXMuX2xvZygnaW5mbycsIGBub3RpZnkgZmlsZSBkYXRhIGNoYW5nZXNgLHRyYWNrZWRGaWxlLmlkKTtcbiAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwZGF0ZShjaGFuZ2VzKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fb25UcmFja2VkRmlsZUNoYW5nZWQubmV4dCh0cmFja2VkRmlsZS5hc0RhdGEoKSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3VwcG9ydENodW5rVXBsb2FkKHVwbG9hZEZpbGVEYXRhOiBVcGxvYWRGaWxlRGF0YSkgOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgdXBsb2FkQWRhcHRlcjogVXBsb2FkRmlsZUFkYXB0ZXI8YW55PiA9IHRoaXMuX2dldFVwbG9hZEFkYXB0ZXIodXBsb2FkRmlsZURhdGEpO1xuICAgICAgICByZXR1cm4gdXBsb2FkQWRhcHRlciA/IHVwbG9hZEFkYXB0ZXIuc3VwcG9ydENodW5rVXBsb2FkKCkgOiBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbml0aWF0ZVVwbG9hZCh0cmFja2VkRmlsZTogVHJhY2tlZEZpbGUpOiB2b2lkIHtcblxuICAgICAgICBjb25zdCB7ZGF0YSwgaWR9ID0gdHJhY2tlZEZpbGU7XG4gICAgICAgIGNvbnN0IHVwbG9hZEFkYXB0ZXI6IFVwbG9hZEZpbGVBZGFwdGVyPGFueT4gPSB0aGlzLl9nZXRVcGxvYWRBZGFwdGVyKGRhdGEpO1xuXG4gICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGBpbml0aWF0ZSBuZXcgdXBsb2FkIGZvciBmaWxlICcke2lkfSdgKTtcblxuICAgICAgICBpZiAoIXVwbG9hZEFkYXB0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsIGBjYW5ub3QgZmluZCBkZXN0aW5hdGlvbiBhZGFwdGVyIGZvciByZXF1ZXN0ZWQgZmlsZSwgZmFpbGluZyB1cGxvYWQgcmVxdWVzdGApO1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMuZmFpbHVyZSxcbiAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVJlYXNvbjogJ3VwbG9hZCBkZXN0aW5hdGlvbiBpcyBub3Qgc3VwcG9ydGVkJyxcbiAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVR5cGU6ICd1bmtub3duX2Rlc3RpbmF0aW9uJ1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLl9zeW5jVXBsb2FkUXVldWUoKTtcblxuICAgICAgICB9IGVsc2UgaWYgKHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZGluZykpIHtcbiAgICAgICAgICAgIGlmICh0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCBgYW4gYWN0aXZlIHVwbG9hZCB3YXMgZm91bmQgd2hpbGUgdGhlIHN0YXR1cyBpbmRpY2F0ZWQgbm8gdXBsb2FkIGN1cnJlbnRseSBpbiBwcm9ncmVzcy4gY2FuY2VsIHByZXZpb3VzIHVwbG9hZGApO1xuICAgICAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLCB7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZGluZyxcbiAgICAgICAgICAgICAgICBwcm9ncmVzczogMCxcbiAgICAgICAgICAgICAgICB1cGxvYWRTdGFydEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNhbkhhbmRsZVJlc3BvbnNlID0gKGlkOiBzdHJpbmcsIGFjdGlvbkRlc2NyaXB0aW9uOiBzdHJpbmcpIDogYm9vbGVhbiA9PlxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBjb25zdCB0cmFja2VkRmlsZVN0aWxsRXhpc3RzID0gISF0aGlzLl90cmFja2VkRmlsZXNbaWRdO1xuXG4gICAgICAgICAgICAgICAgaWYgKCF0cmFja2VkRmlsZVN0aWxsRXhpc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsIGBjYW5ub3QgaGFuZGxlIGZpbGUgdXBsb2FkICR7YWN0aW9uRGVzY3JpcHRpb259LiBUaGVyZSBpcyBubyB0cmFja2luZyBmaWxlIHdpdGggdGhlIHByb3ZpZGVkIGlkICh3YXMgdGhlIGZpbGUgcHVyZ2VkPylgLCBpZCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0cmFja2VkRmlsZS5zdGF0dXMgIT09IFRyYWNrZWRGaWxlU3RhdHVzZXMudXBsb2FkaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsIGBjYW5ub3QgaGFuZGxlIGZpbGUgdXBsb2FkICR7YWN0aW9uRGVzY3JpcHRpb259LiBUaGUgZmlsZSBzdGF0dXMgaXQgbm90ICd1cGxvYWRpbmcnICh3YXMgdGhlIGZpbGUgdXBsb2FkIGNhbmNlbGxlZD8pYCwgaWQpO1xuICAgICAgICAgICAgICAgIH1lbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdHJhY2tlZEZpbGUudXBsb2FkU3Vic2NyaXB0aW9uID0gdXBsb2FkQWRhcHRlci51cGxvYWQoaWQsIGRhdGEpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgKHVwbG9hZENoYW5nZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYW5IYW5kbGVSZXNwb25zZShpZCwgJ3Byb2dyZXNzJykpXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiB1cGxvYWRDaGFuZ2VzLnByb2dyZXNzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbiA9IG51bGw7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYW5IYW5kbGVSZXNwb25zZShpZCwgJ2ZhaWx1cmUnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhaWx1cmVSZWFzb24gPSBlcnJvciAmJiBlcnJvci5tZXNzYWdlID8gZXJyb3IubWVzc2FnZSA6ICcnO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5mYWlsdXJlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVJlYXNvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVUeXBlOiAnZ2VuZXJhbF9lcnJvcidcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3N5bmNVcGxvYWRRdWV1ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24gPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FuSGFuZGxlUmVzcG9uc2UoaWQsICdjb21wbGV0aW9uJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZENvbXBsZXRlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzOiAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkQ29tcGxldGVBdDogbmV3IERhdGUoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zeW5jVXBsb2FkUXVldWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRVcGxvYWRBZGFwdGVyKGZpbGVEYXRhOiBVcGxvYWRGaWxlRGF0YSk6IFVwbG9hZEZpbGVBZGFwdGVyPGFueT4ge1xuXG4gICAgICAgIGlmICh0aGlzLl91cGxvYWRGaWxlQWRhcHRlcikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3VwbG9hZEZpbGVBZGFwdGVyLmZpbmQodXBsb2FkRmlsZUFkYXB0ZXIgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB1cGxvYWRGaWxlQWRhcHRlci5jYW5IYW5kbGUoZmlsZURhdGEpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl90cmFja2VkRmlsZXMpLmZvckVhY2goaWQgPT5cbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5wdXJnZVVwbG9hZChpZCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==