import { Observable } from 'rxjs/Observable';
import { ReplaySubject } from 'rxjs/ReplaySubject';
import 'rxjs/add/observable/of';
import { Subject } from 'rxjs/Subject';
import 'rxjs/add/observable/of';
import 'rxjs/add/operator/catch';
import 'rxjs/add/operator/do';
import { EmptyLogger } from '@kaltura-ng/kaltura-common';
// DEVELOPER NOTE: Don't implement ngOnDestroy - the inheritor will probably override this without calling super()
export class WidgetBase {
    constructor(_key, logger) {
        this._key = _key;
        // DEVELOPER NOTE: this class cannot use 'cancelOnDestroy' operation
        // because it must assume the inheriter will override it
        this._activateSubscription = null;
        this._dataSource = new ReplaySubject(1);
        this.data$ = this._dataSource.asObservable();
        this._widgetState = { key: this.key, isValid: true, isDirty: false, isAttached: false, isBusy: false, isActive: false, wasActivated: false };
        this._widgetReset = new Subject();
        this.widgetReset$ = this._widgetReset.asObservable();
        if (!_key) {
            throw new Error(`Form widget key is required when constructing widget of type '${typeof this}`);
        }
        this._logger = logger ? logger.subLogger(`widgets.${_key}`) : new EmptyLogger();
    }
    get data() {
        return this._data;
    }
    onDataSaving(newData, request, originalData) {
    }
    get wasActivated() {
        return this._widgetState.wasActivated;
    }
    get isValid() {
        return this._widgetState.isValid;
    }
    get isDirty() {
        return this._widgetState.isDirty;
    }
    get isActive() {
        return this._widgetState.isActive;
    }
    get isAttached() {
        return this._widgetState.isAttached;
    }
    get isBusy() {
        return this._widgetState.isBusy;
    }
    get key() {
        return this._key;
    }
    get isNewData() {
        return this.form.isNewData;
    }
    onValidate(wasActivated) {
        return Observable.of({ isValid: true });
    }
    updateState(stateUpdate) {
        this._updateState(stateUpdate);
    }
    _updateState(stateUpdate) {
        this._verifyRegistered();
        const stateHasChanges = Object.keys(stateUpdate).reduce((result, propertyName) => result || this._widgetState[propertyName] !== stateUpdate[propertyName], false);
        if (stateHasChanges) {
            Object.assign(this._widgetState, stateUpdate);
            if (this.form) {
                const newWidgetState = Object.assign({}, this._widgetState);
                this.form._updateWidgetState(newWidgetState);
            }
        }
    }
    onDataLoaded(data) {
    }
    onDataLoading(dataId) {
    }
    onActivate(firstTimeActivating) {
    }
    _setForm(manager) {
        this.form = manager;
    }
    _handleDataLoading(dataId) {
        this._verifyRegistered();
        this._setData(null);
        this.onDataLoading(dataId);
    }
    _setData(data) {
        this._data = data;
        this._dataSource.next(data);
    }
    _handleDataLoaded(data) {
        this._verifyRegistered();
        this._setData(data);
        this.onDataLoaded(data);
    }
    _validate() {
        this._verifyRegistered();
        return this.onValidate(this.wasActivated)
            .do(response => {
            const updateState = (response.isValid !== this._widgetState.isValid);
            if (updateState) {
                this._logger.info(`[widget] widget '${this.key}': widget 'isValid' state doesn't match result of 'onValidate'. updating status to '${response.isValid ? 'valid' : 'invalid'}'`);
                this.updateState({ isValid: response.isValid });
            }
        });
    }
    _handleDataSaving(newData, request, originalData) {
        this._verifyRegistered();
        this.onDataSaving(newData, request, originalData);
    }
    _reset() {
        this._verifyRegistered();
        this._logger.info(`[widget] widget '${this.key}': reset widget`);
        if (this._activateSubscription) {
            this._activateSubscription.unsubscribe();
            this._activateSubscription = null;
        }
        this._widgetReset.next('');
        this._updateState({ isValid: true, isDirty: false, isActive: false, isBusy: false });
        this.onReset();
    }
    _verifyRegistered() {
        if (!this.form) {
            this._logger.error(`[widget] widget '${this.key}': cannot perform action, widget is not registered to a manager (did you forgot to register it in the main route component?)`);
            throw new Error(`[widget] cannot perform action. widget with key \''${this.key}'\' is not registered to a manager`);
        }
    }
    activate() {
        this._verifyRegistered();
        if (this.data && this.isAttached && !this.isActive) {
            this._reset();
            const previousStatus = {
                wasActivated: this.wasActivated
            };
            this._logger.info(`[widget] widget '${this.key}': activating widget (first time = ${!previousStatus.wasActivated})`);
            const activate$ = this.onActivate(!this.wasActivated);
            this._updateState({ isActive: true, wasActivated: true });
            if (activate$ instanceof Observable) {
                this._logger.info(`[widget] widget '${this.key}': widget requested for async activation operation. executing async operation.`);
                this._activateSubscription = activate$
                    .catch((error, caught) => Observable.of({ failed: true, error }))
                    .subscribe(response => {
                    if (response && response.failed) {
                        this._logger.info(`[widget] widget '${this.key}': async widget activation failed. revert state to ${JSON.stringify(previousStatus)})`);
                        this._updateState({ isActive: false, wasActivated: previousStatus.wasActivated });
                    }
                    else {
                        this._logger.info(`[widget] widget '${this.key}': async widget activation completed`);
                    }
                }, () => {
                    this._activateSubscription = null;
                }, () => {
                    this._activateSubscription = null;
                });
            }
        }
    }
    attachForm() {
        this._verifyRegistered();
        if (this.isAttached) {
            this._logger.warn(`[widget] widget with key '${this.key}' is already attached (did you attached two components to the same widget? did you forgot to detach the widget upon ngOnDestroy?)`);
        }
        else {
            this._logger.info(`[widget] widget '${this.key}': attaching widget`);
            this._updateState({ isAttached: true });
            this.activate();
        }
    }
    detachForm() {
        this._verifyRegistered();
        if (!this.isAttached) {
            this._logger.warn(`[widget] widget with key '${this.key}' is already detached (did you attached two components to the same widget? did you forgot to attach the widget upon ngOnInit?)`);
        }
        else {
            this._logger.info(`[widget] widget '${this.key}': detaching widget`);
            this._updateState({ isAttached: false });
        }
    }
    destory() {
        this._reset();
        this._widgetReset.complete();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LWJhc2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Aa2FsdHVyYS1uZy9rYWx0dXJhLXVpLyIsInNvdXJjZXMiOlsibGliL3dpZGdldHMvd2lkZ2V0LWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNuRCxPQUFPLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDdkMsT0FBTyx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLHlCQUF5QixDQUFDO0FBQ2pDLE9BQU8sc0JBQXNCLENBQUM7QUFJOUIsT0FBTyxFQUFpQixXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV4RSxrSEFBa0g7QUFDbEgsTUFBTSxPQUFnQixVQUFVO0lBZTVCLFlBQW9CLElBQWEsRUFBRSxNQUFzQjtRQUFyQyxTQUFJLEdBQUosSUFBSSxDQUFTO1FBVGpDLG9FQUFvRTtRQUNwRSx3REFBd0Q7UUFDaEQsMEJBQXFCLEdBQWtCLElBQUksQ0FBQztRQUc1QyxnQkFBVyxHQUF5QixJQUFJLGFBQWEsQ0FBUSxDQUFDLENBQUMsQ0FBQztRQUNqRSxVQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQWF2QyxpQkFBWSxHQUFpQixFQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRyxLQUFLLEVBQUUsUUFBUSxFQUFHLEtBQUssRUFBRyxZQUFZLEVBQUcsS0FBSyxFQUFDLENBQUM7UUFTeEosaUJBQVksR0FBa0IsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUNsRCxpQkFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENB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QztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcy9SZXBsYXlTdWJqZWN0JztcbmltcG9ydCAncnhqcy9hZGQvb2JzZXJ2YWJsZS9vZic7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcy9TdWJqZWN0JztcbmltcG9ydCAncnhqcy9hZGQvb2JzZXJ2YWJsZS9vZic7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL2NhdGNoJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvZG8nO1xuaW1wb3J0IHsgV2lkZ2V0c01hbmFnZXJCYXNlIH0gZnJvbSAnLi93aWRnZXRzLW1hbmFnZXItYmFzZSc7XG5pbXBvcnQgeyBJU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcy9TdWJzY3JpcHRpb24nO1xuaW1wb3J0IHsgV2lkZ2V0U3RhdGUsIFdpZGdldFN0YXRlRGF0YSB9IGZyb20gJy4vd2lkZ2V0LXN0YXRlJztcbmltcG9ydCB7IEthbHR1cmFMb2dnZXIsIEVtcHR5TG9nZ2VyIH0gZnJvbSAnQGthbHR1cmEtbmcva2FsdHVyYS1jb21tb24nO1xuXG4vLyBERVZFTE9QRVIgTk9URTogRG9uJ3QgaW1wbGVtZW50IG5nT25EZXN0cm95IC0gdGhlIGluaGVyaXRvciB3aWxsIHByb2JhYmx5IG92ZXJyaWRlIHRoaXMgd2l0aG91dCBjYWxsaW5nIHN1cGVyKClcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBXaWRnZXRCYXNlPFRGb3JtIGV4dGVuZHMgV2lkZ2V0c01hbmFnZXJCYXNlPFREYXRhLFRSZXF1ZXN0PiwgVERhdGEsIFRSZXF1ZXN0Plxue1xuICAgIHB1YmxpYyBnZXQgZGF0YSgpOiBURGF0YSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYXRhO1xuICAgIH1cblxuICAgIC8vIERFVkVMT1BFUiBOT1RFOiB0aGlzIGNsYXNzIGNhbm5vdCB1c2UgJ2NhbmNlbE9uRGVzdHJveScgb3BlcmF0aW9uXG4gICAgLy8gYmVjYXVzZSBpdCBtdXN0IGFzc3VtZSB0aGUgaW5oZXJpdGVyIHdpbGwgb3ZlcnJpZGUgaXRcbiAgICBwcml2YXRlIF9hY3RpdmF0ZVN1YnNjcmlwdGlvbjogSVN1YnNjcmlwdGlvbiA9IG51bGw7XG5cbiAgICBwcml2YXRlIF9kYXRhOiBURGF0YTtcbiAgICBwcml2YXRlIF9kYXRhU291cmNlOiBSZXBsYXlTdWJqZWN0PFREYXRhPiA9IG5ldyBSZXBsYXlTdWJqZWN0PFREYXRhPigxKTtcbiAgICBwdWJsaWMgZGF0YSQgPSB0aGlzLl9kYXRhU291cmNlLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHByb3RlY3RlZCBfbG9nZ2VyOiBLYWx0dXJhTG9nZ2VyO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfa2V5IDogc3RyaW5nLCBsb2dnZXI/OiBLYWx0dXJhTG9nZ2VyKVxuICAgIHtcbiAgICAgICAgaWYgKCFfa2V5KVxuICAgICAgICB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZvcm0gd2lkZ2V0IGtleSBpcyByZXF1aXJlZCB3aGVuIGNvbnN0cnVjdGluZyB3aWRnZXQgb2YgdHlwZSAnJHt0eXBlb2YgdGhpc31gKTtcbiAgICAgICAgfVxuXG5cdCAgICB0aGlzLl9sb2dnZXIgPSBsb2dnZXIgPyBsb2dnZXIuc3ViTG9nZ2VyKGB3aWRnZXRzLiR7X2tleX1gKSA6IG5ldyBFbXB0eUxvZ2dlcigpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3dpZGdldFN0YXRlIDogV2lkZ2V0U3RhdGUgPSB7a2V5OiB0aGlzLmtleSwgaXNWYWxpZDogdHJ1ZSwgaXNEaXJ0eTogZmFsc2UsIGlzQXR0YWNoZWQ6IGZhbHNlLCBpc0J1c3kgOiBmYWxzZSwgaXNBY3RpdmUgOiBmYWxzZSwgIHdhc0FjdGl2YXRlZCA6IGZhbHNlfTtcblxuICAgIHByb3RlY3RlZCBvbkRhdGFTYXZpbmcobmV3RGF0YTogVERhdGEsIHJlcXVlc3Q6IFRSZXF1ZXN0LCBvcmlnaW5hbERhdGE6IFREYXRhKTogdm9pZDtcbiAgICBwcm90ZWN0ZWQgb25EYXRhU2F2aW5nKG5ld0RhdGE6IFREYXRhLCByZXF1ZXN0OiBUUmVxdWVzdCk6IHZvaWQ7XG4gICAgcHJvdGVjdGVkIG9uRGF0YVNhdmluZyhuZXdEYXRhOiBURGF0YSwgcmVxdWVzdDogVFJlcXVlc3QsIG9yaWdpbmFsRGF0YT86IFREYXRhKTogdm9pZCB7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGZvcm0gOiBURm9ybTtcblxuICAgIHByaXZhdGUgX3dpZGdldFJlc2V0IDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgIHB1YmxpYyB3aWRnZXRSZXNldCQgPSB0aGlzLl93aWRnZXRSZXNldC5hc09ic2VydmFibGUoKTtcblxuICAgIHB1YmxpYyBnZXQgd2FzQWN0aXZhdGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fd2lkZ2V0U3RhdGUud2FzQWN0aXZhdGVkO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXNWYWxpZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3dpZGdldFN0YXRlLmlzVmFsaWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc0RpcnR5KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fd2lkZ2V0U3RhdGUuaXNEaXJ0eTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzQWN0aXZlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fd2lkZ2V0U3RhdGUuaXNBY3RpdmU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc0F0dGFjaGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fd2lkZ2V0U3RhdGUuaXNBdHRhY2hlZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzQnVzeSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3dpZGdldFN0YXRlLmlzQnVzeTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGtleSgpOiBzdHJpbmdcbiAgICB7XG4gICAgICAgIHJldHVybiB0aGlzLl9rZXk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc05ld0RhdGEoKTogYm9vbGVhbntcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybS5pc05ld0RhdGE7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG9uVmFsaWRhdGUod2FzQWN0aXZhdGVkOiBib29sZWFuKTogT2JzZXJ2YWJsZTx7aXNWYWxpZDogYm9vbGVhbn0+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2Yoe2lzVmFsaWQ6IHRydWV9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgdXBkYXRlU3RhdGUoc3RhdGVVcGRhdGUgOiB7aXNWYWxpZD8gOiBib29sZWFuLCBpc0RpcnR5PyA6IGJvb2xlYW4sIGlzQnVzeT8gOiBib29sZWFufSkgOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUoc3RhdGVVcGRhdGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3VwZGF0ZVN0YXRlKHN0YXRlVXBkYXRlIDogUGFydGlhbDxXaWRnZXRTdGF0ZURhdGE+KSA6IHZvaWQge1xuXG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcblxuICAgICAgICBjb25zdCBzdGF0ZUhhc0NoYW5nZXMgPSBPYmplY3Qua2V5cyhzdGF0ZVVwZGF0ZSkucmVkdWNlKChyZXN1bHQsIHByb3BlcnR5TmFtZSkgPT4gcmVzdWx0IHx8IHRoaXMuX3dpZGdldFN0YXRlW3Byb3BlcnR5TmFtZV0gIT09IHN0YXRlVXBkYXRlW3Byb3BlcnR5TmFtZV0sIGZhbHNlKTtcblxuICAgICAgICBpZiAoc3RhdGVIYXNDaGFuZ2VzKSB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuX3dpZGdldFN0YXRlLCBzdGF0ZVVwZGF0ZSk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmZvcm0pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdXaWRnZXRTdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX3dpZGdldFN0YXRlKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm0uX3VwZGF0ZVdpZGdldFN0YXRlKG5ld1dpZGdldFN0YXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBvbkRhdGFMb2FkZWQoZGF0YTogVERhdGEpOiB2b2lkIHtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25EYXRhTG9hZGluZyhkYXRhSWQ6IGFueSk6IHZvaWQge1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBvblJlc2V0KCk7XG5cbiAgICBwcm90ZWN0ZWQgb25BY3RpdmF0ZShmaXJzdFRpbWVBY3RpdmF0aW5nOiBib29sZWFuKTogT2JzZXJ2YWJsZTx7ZmFpbGVkOiBib29sZWFuLCBlcnJvcj86IEVycm9yfT4gfCB2b2lkIHtcbiAgICB9XG5cbiAgICBwdWJsaWMgX3NldEZvcm0obWFuYWdlciA6IFRGb3JtKSA6dm9pZCB7XG4gICAgICAgIHRoaXMuZm9ybSA9IG1hbmFnZXI7XG4gICAgfVxuXG4gICAgcHVibGljIF9oYW5kbGVEYXRhTG9hZGluZyhkYXRhSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLl92ZXJpZnlSZWdpc3RlcmVkKCk7XG4gICAgICAgIHRoaXMuX3NldERhdGEobnVsbCk7XG4gICAgICAgIHRoaXMub25EYXRhTG9hZGluZyhkYXRhSWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3NldERhdGEoZGF0YTogVERhdGEpOiB2b2lke1xuICAgICAgICB0aGlzLl9kYXRhID0gZGF0YTtcbiAgICAgICAgdGhpcy5fZGF0YVNvdXJjZS5uZXh0KGRhdGEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBfaGFuZGxlRGF0YUxvYWRlZChkYXRhOiBURGF0YSk6IHZvaWQge1xuICAgICAgICB0aGlzLl92ZXJpZnlSZWdpc3RlcmVkKCk7XG4gICAgICAgIHRoaXMuX3NldERhdGEoZGF0YSk7XG4gICAgICAgIHRoaXMub25EYXRhTG9hZGVkKGRhdGEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBfdmFsaWRhdGUoKTogT2JzZXJ2YWJsZTx7aXNWYWxpZDogYm9vbGVhbn0+IHtcblxuICAgICAgICB0aGlzLl92ZXJpZnlSZWdpc3RlcmVkKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25WYWxpZGF0ZSh0aGlzLndhc0FjdGl2YXRlZClcbiAgICAgICAgICAgIC5kbyhcbiAgICAgICAgICAgICAgICByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVN0YXRlID0gKHJlc3BvbnNlLmlzVmFsaWQgIT09IHRoaXMuX3dpZGdldFN0YXRlLmlzVmFsaWQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRdIHdpZGdldCAnJHt0aGlzLmtleX0nOiB3aWRnZXQgJ2lzVmFsaWQnIHN0YXRlIGRvZXNuJ3QgbWF0Y2ggcmVzdWx0IG9mICdvblZhbGlkYXRlJy4gdXBkYXRpbmcgc3RhdHVzIHRvICcke3Jlc3BvbnNlLmlzVmFsaWQgPyAndmFsaWQnIDogJ2ludmFsaWQnfSdgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe2lzVmFsaWQ6IHJlc3BvbnNlLmlzVmFsaWR9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgcHVibGljIF9oYW5kbGVEYXRhU2F2aW5nKG5ld0RhdGE6IFREYXRhLCByZXF1ZXN0OiBUUmVxdWVzdCwgb3JpZ2luYWxEYXRhOiBURGF0YSk6IHZvaWQge1xuXG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcbiAgICAgICAgdGhpcy5vbkRhdGFTYXZpbmcobmV3RGF0YSwgcmVxdWVzdCwgb3JpZ2luYWxEYXRhKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgX3Jlc2V0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLl92ZXJpZnlSZWdpc3RlcmVkKCk7XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRdIHdpZGdldCAnJHt0aGlzLmtleX0nOiByZXNldCB3aWRnZXRgKTtcblxuICAgICAgICBpZiAodGhpcy5fYWN0aXZhdGVTdWJzY3JpcHRpb24pXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB0aGlzLl9hY3RpdmF0ZVN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl93aWRnZXRSZXNldC5uZXh0KCcnKTtcbiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUoeyBpc1ZhbGlkOiB0cnVlLCBpc0RpcnR5OiBmYWxzZSwgaXNBY3RpdmUgOiBmYWxzZSwgaXNCdXN5OiBmYWxzZX0pO1xuICAgICAgICB0aGlzLm9uUmVzZXQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF92ZXJpZnlSZWdpc3RlcmVkKCk6IHZvaWR7XG4gICAgICAgIGlmKCF0aGlzLmZvcm0pXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IGNhbm5vdCBwZXJmb3JtIGFjdGlvbiwgd2lkZ2V0IGlzIG5vdCByZWdpc3RlcmVkIHRvIGEgbWFuYWdlciAoZGlkIHlvdSBmb3Jnb3QgdG8gcmVnaXN0ZXIgaXQgaW4gdGhlIG1haW4gcm91dGUgY29tcG9uZW50PylgKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgW3dpZGdldF0gY2Fubm90IHBlcmZvcm0gYWN0aW9uLiB3aWRnZXQgd2l0aCBrZXkgXFwnJyR7dGhpcy5rZXl9J1xcJyBpcyBub3QgcmVnaXN0ZXJlZCB0byBhIG1hbmFnZXJgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhY3RpdmF0ZSgpOiB2b2lkIHtcblxuICAgICAgICB0aGlzLl92ZXJpZnlSZWdpc3RlcmVkKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuZGF0YSAmJiB0aGlzLmlzQXR0YWNoZWQgJiYgIXRoaXMuaXNBY3RpdmUpIHtcblxuICAgICAgICAgICAgdGhpcy5fcmVzZXQoKTtcblxuICAgICAgICAgICAgY29uc3QgcHJldmlvdXNTdGF0dXMgPSB7XG4gICAgICAgICAgICAgIHdhc0FjdGl2YXRlZCA6IHRoaXMud2FzQWN0aXZhdGVkXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IGFjdGl2YXRpbmcgd2lkZ2V0IChmaXJzdCB0aW1lID0gJHshcHJldmlvdXNTdGF0dXMud2FzQWN0aXZhdGVkfSlgKTtcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRlJCA9IHRoaXMub25BY3RpdmF0ZSghdGhpcy53YXNBY3RpdmF0ZWQpO1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUoeyBpc0FjdGl2ZSA6IHRydWUsIHdhc0FjdGl2YXRlZCA6IHRydWV9KTtcblxuICAgICAgICAgICAgaWYgKGFjdGl2YXRlJCBpbnN0YW5jZW9mIE9ic2VydmFibGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IHdpZGdldCByZXF1ZXN0ZWQgZm9yIGFzeW5jIGFjdGl2YXRpb24gb3BlcmF0aW9uLiBleGVjdXRpbmcgYXN5bmMgb3BlcmF0aW9uLmApO1xuICAgICAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRlU3Vic2NyaXB0aW9uID0gYWN0aXZhdGUkXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IsIGNhdWdodCkgPT4gT2JzZXJ2YWJsZS5vZih7ZmFpbGVkOiB0cnVlLCBlcnJvcn0pKVxuICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZSAmJiByZXNwb25zZS5mYWlsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRdIHdpZGdldCAnJHt0aGlzLmtleX0nOiBhc3luYyB3aWRnZXQgYWN0aXZhdGlvbiBmYWlsZWQuIHJldmVydCBzdGF0ZSB0byAke0pTT04uc3RyaW5naWZ5KHByZXZpb3VzU3RhdHVzKX0pYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlKHsgaXNBY3RpdmUgOiBmYWxzZSwgd2FzQWN0aXZhdGVkIDogcHJldmlvdXNTdGF0dXMud2FzQWN0aXZhdGVkfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IGFzeW5jIHdpZGdldCBhY3RpdmF0aW9uIGNvbXBsZXRlZGApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWN0aXZhdGVTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY3RpdmF0ZVN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhdHRhY2hGb3JtKCkgOiB2b2lke1xuICAgICAgICB0aGlzLl92ZXJpZnlSZWdpc3RlcmVkKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNBdHRhY2hlZCkge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oYFt3aWRnZXRdIHdpZGdldCB3aXRoIGtleSAnJHt0aGlzLmtleX0nIGlzIGFscmVhZHkgYXR0YWNoZWQgKGRpZCB5b3UgYXR0YWNoZWQgdHdvIGNvbXBvbmVudHMgdG8gdGhlIHNhbWUgd2lkZ2V0PyBkaWQgeW91IGZvcmdvdCB0byBkZXRhY2ggdGhlIHdpZGdldCB1cG9uIG5nT25EZXN0cm95PylgKTtcbiAgICAgICAgfWVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRdIHdpZGdldCAnJHt0aGlzLmtleX0nOiBhdHRhY2hpbmcgd2lkZ2V0YCk7XG4gICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSh7aXNBdHRhY2hlZDogdHJ1ZX0pO1xuICAgICAgICAgICAgdGhpcy5hY3RpdmF0ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGRldGFjaEZvcm0oKSA6IHZvaWR7XG5cbiAgICAgICAgdGhpcy5fdmVyaWZ5UmVnaXN0ZXJlZCgpO1xuXG4gICAgICAgIGlmICghdGhpcy5pc0F0dGFjaGVkKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIud2FybihgW3dpZGdldF0gd2lkZ2V0IHdpdGgga2V5ICcke3RoaXMua2V5fScgaXMgYWxyZWFkeSBkZXRhY2hlZCAoZGlkIHlvdSBhdHRhY2hlZCB0d28gY29tcG9uZW50cyB0byB0aGUgc2FtZSB3aWRnZXQ/IGRpZCB5b3UgZm9yZ290IHRvIGF0dGFjaCB0aGUgd2lkZ2V0IHVwb24gbmdPbkluaXQ/KWApO1xuICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IGRldGFjaGluZyB3aWRnZXRgKTtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlKHtpc0F0dGFjaGVkOiBmYWxzZX0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZGVzdG9yeSgpIHtcbiAgICAgICAgdGhpcy5fcmVzZXQoKTtcbiAgICAgICAgdGhpcy5fd2lkZ2V0UmVzZXQuY29tcGxldGUoKTtcbiAgICB9XG5cbn1cbiJdfQ==