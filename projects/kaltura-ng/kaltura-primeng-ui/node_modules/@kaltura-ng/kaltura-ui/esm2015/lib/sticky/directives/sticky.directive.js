import { __decorate, __metadata } from "tslib";
import { Directive, Input, Renderer2, ElementRef, AfterViewInit, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';
import { StickyScrollService } from '../services/sticky-scroll.service';
import { cancelOnDestroy } from '@kaltura-ng/kaltura-common';
let StickyDirective = class StickyDirective {
    constructor(elementRef, renderer, _stickyScrollService) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this._stickyScrollService = _stickyScrollService;
        this.lastScroll = 0;
        this.isSticky = false;
        this._destroyed = false;
        this.onStickyEvent = new EventEmitter();
        this.onUnStickyEvent = new EventEmitter();
        this.scrollOffset = 0;
        this.stickyId = "";
        this.sticksTo = "";
        this.elementSelector = "";
        this._parentTop = null;
        this._parentOffset = null;
        this._stickyTop = null;
        this._stickyOffset = null;
    }
    _getStickyElement(elementRef) {
        return elementRef.nativeElement;
    }
    ngAfterViewInit() {
        // console.log(`[${this.stickyId}] - ngAfterViewInit`);
        this._stickyElement = this._getStickyElement(this.elementRef);
        this.update();
    }
    ngOnInit() {
        // console.log(`[${this.stickyId}] - attached`);
        if (this.stickyId) {
            this._stickyScrollService.attach(this.stickyId);
        }
        this._stickyScrollService.scrollStatus$.pipe(cancelOnDestroy(this)).subscribe(event => {
            // console.log(`[${this.stickyId}] - handle scroll`);
            this._render();
        });
        this._stickyScrollService.resizeStatus$.pipe(cancelOnDestroy(this)).subscribe(event => {
            this.onResize();
        });
        this._stickyScrollService.layoutSubject$.pipe(cancelOnDestroy(this)).subscribe(elements => {
            const data = this.sticksTo ? elements[this.sticksTo] : { height: 0, offset: 0 };
            if (data && (this._parentTop !== data.height ||
                this._parentOffset !== data.offset)) {
                this._parentTop = data.height;
                this._parentOffset = data.offset;
                this.update();
            }
        });
    }
    ngOnDestroy() {
        // console.log(`[${this.stickyId}] - destroyed`);
        this._destroyed = true;
        this._stickyScrollService.detach(this.stickyId);
    }
    update() {
        if (this._parentTop !== null
            && this._parentOffset != null) {
            // console.log(`[${this.stickyId}] - handle layout update`);
            const stickyOffset = this._parentOffset + this.scrollOffset;
            if (this._stickyTop !== this._parentTop ||
                this._stickyOffset !== stickyOffset) {
                // console.log(`[${this.stickyId}] - update cached values`);
                this._stickyTop = this._parentTop;
                this._stickyOffset = stickyOffset;
                this._render();
            }
            if (this.stickyId && this._stickyElement) {
                // console.log(`[${this.stickyId}] - update service`);
                const elementHeight = this._stickyElement.getBoundingClientRect()['height'];
                setTimeout(() => {
                    this._stickyScrollService.update(this.stickyId, elementHeight + this._stickyTop, this._stickyOffset);
                }, 0);
            }
        }
    }
    _render() {
        if (!this._destroyed && this._stickyElement) {
            // console.log(`[${this.stickyId}] - _render`);
            if (this._stickyTop !== null
                && this._stickyOffset != null) {
                const scroll = window.pageYOffset;
                if (scroll > this.lastScroll && !this.isSticky && this._stickyElement.getBoundingClientRect()['top'] <= this._stickyTop) {
                    // console.log(`[${this.stickyId}] - _render (set sticky mode)`);
                    this.setSticky();
                }
                else if (scroll < this.lastScroll && this.isSticky && scroll <= this._stickyOffset) {
                    // console.log(`[${this.stickyId}] - _render (unset sticky mode)`);
                    this.unsetSticky();
                }
                else {
                    if (this.isSticky && scroll === this.lastScroll) {
                        this.setStyle('top', this._stickyTop + 'px');
                        // console.log(`[${this.stickyId}] - _render (update sitcky values) - TODO!!!!!!`);
                    }
                }
                this.lastScroll = scroll;
            }
        }
    }
    setSticky() {
        if (!this.isSticky) {
            this.isSticky = true;
            // console.log(`[${this.stickyId}] - top = ${this._stickyElement.clientTop}`);
            this.originalCss = {
                position: this._stickyElement.style.position,
                top: this._stickyElement.clientTop,
                marginTop: this._stickyElement.style.marginTop,
                left: this._stickyElement.clientLeft
            };
            this.setStyle('position', 'fixed');
            this.setStyle('top', this._stickyTop + 'px');
            if (this.appendTo) {
                this.setStyle('left', this.appendTo.getBoundingClientRect()['left'] + 'px');
            }
            this.setClass(true);
            this.onStickyEvent.emit();
            this._onSticky();
        }
    }
    _onSticky() {
        setTimeout(() => { this.update(); }, 0);
    }
    unsetSticky() {
        if (this.isSticky) {
            this.isSticky = false;
            this.setStyle('position', this.originalCss.position);
            this.setStyle('marginTop', this.originalCss.marginTop);
            this.setStyle('top', this.originalCss.top + 'px');
            if (this.appendTo) {
                this.setStyle('left', this.originalCss.left + 'px');
            }
            this.setClass(false);
            this.onUnStickyEvent.emit();
            this._onUnsetSticky();
        }
    }
    _onUnsetSticky() {
        setTimeout(() => { this.update(); }, 0);
    }
    onResize() { }
    ; // used by primeng directive to update table layout
    setStyle(key, value) {
        this.renderer.setStyle(this._stickyElement, key, value);
    }
    setClass(add) {
        if (add) {
            this.renderer.addClass(this._stickyElement, this.stickyClass);
        }
        else {
            this.renderer.removeClass(this._stickyElement, this.stickyClass);
        }
    }
};
StickyDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: StickyScrollService }
];
__decorate([
    Output(),
    __metadata("design:type", Object)
], StickyDirective.prototype, "onStickyEvent", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], StickyDirective.prototype, "onUnStickyEvent", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], StickyDirective.prototype, "stickyClass", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], StickyDirective.prototype, "scrollOffset", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], StickyDirective.prototype, "appendTo", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], StickyDirective.prototype, "stickyId", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], StickyDirective.prototype, "sticksTo", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], StickyDirective.prototype, "elementSelector", void 0);
StickyDirective = __decorate([
    Directive({
        selector: '[kSticky]'
    }),
    __metadata("design:paramtypes", [ElementRef, Renderer2, StickyScrollService])
], StickyDirective);
export { StickyDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RpY2t5LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtdWkvIiwic291cmNlcyI6WyJsaWIvc3RpY2t5L2RpcmVjdGl2ZXMvc3RpY2t5LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hJLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxlQUFlLEVBQU8sTUFBTSw0QkFBNEIsQ0FBQztBQU1sRSxJQUFhLGVBQWUsR0FBNUIsTUFBYSxlQUFlO0lBdUJ4QixZQUFvQixVQUFzQixFQUFVLFFBQW1CLEVBQVUsb0JBQXlDO1FBQXRHLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQVUseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFxQjtRQXRCbEgsZUFBVSxHQUFXLENBQUMsQ0FBQztRQUN4QixhQUFRLEdBQVksS0FBSyxDQUFDO1FBRXpCLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFFakIsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBQ3hDLG9CQUFlLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUczQyxpQkFBWSxHQUFXLENBQUMsQ0FBQztRQUV6QixhQUFRLEdBQVcsRUFBRSxDQUFDO1FBQ3RCLGFBQVEsR0FBVyxFQUFFLENBQUM7UUFDdEIsb0JBQWUsR0FBVyxFQUFFLENBQUM7UUFFOUIsZUFBVSxHQUFXLElBQUksQ0FBQztRQUMxQixrQkFBYSxHQUFXLElBQUksQ0FBQztRQUM3QixlQUFVLEdBQVcsSUFBSSxDQUFDO1FBQzFCLGtCQUFhLEdBQVcsSUFBSSxDQUFDO0lBTXJD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LENBQUMsQ0FBQztTQUMvRDthQUFNO1lBQ0wsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDbEU7SUFDSCxDQUFDO0NBRUosQ0FBQTs7WUFyS21DLFVBQVU7WUFBb0IsU0FBUztZQUFnQyxtQkFBbUI7O0FBakJoSDtJQUFULE1BQU0sRUFBRTs7c0RBQXlDO0FBQ3hDO0lBQVQsTUFBTSxFQUFFOzt3REFBMkM7QUFFM0M7SUFBUixLQUFLLEVBQUU7O29EQUFxQjtBQUNwQjtJQUFSLEtBQUssRUFBRTs7cURBQTBCO0FBQ3pCO0lBQVIsS0FBSyxFQUFFOztpREFBZTtBQUNkO0lBQVIsS0FBSyxFQUFFOztpREFBdUI7QUFDdEI7SUFBUixLQUFLLEVBQUU7O2lEQUF1QjtBQUN0QjtJQUFSLEtBQUssRUFBRTs7d0RBQThCO0FBZDdCLGVBQWU7SUFKM0IsU0FBUyxDQUFDO1FBQ1AsUUFBUSxFQUFFLFdBQVc7S0FDeEIsQ0FBQztxQ0F5QmtDLFVBQVUsRUFBb0IsU0FBUyxFQUFnQyxtQkFBbUI7R0F2QmpILGVBQWUsQ0E0TDNCO1NBNUxZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIElucHV0LCBSZW5kZXJlcjIsIEVsZW1lbnRSZWYsIEFmdGVyVmlld0luaXQsIE9uSW5pdCwgT25EZXN0cm95LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RpY2t5U2Nyb2xsU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3N0aWNreS1zY3JvbGwuc2VydmljZSc7XG5pbXBvcnQgeyBjYW5jZWxPbkRlc3Ryb3ksIHRhZyB9IGZyb20gJ0BrYWx0dXJhLW5nL2thbHR1cmEtY29tbW9uJztcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdba1N0aWNreV0nXG59KVxuXG5leHBvcnQgY2xhc3MgU3RpY2t5RGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQge1xuICAgIHByaXZhdGUgbGFzdFNjcm9sbDogbnVtYmVyID0gMDtcbiAgICBwdWJsaWMgaXNTdGlja3k6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwcml2YXRlIG9yaWdpbmFsQ3NzOiBhbnk7XG4gICAgcHJpdmF0ZSBfZGVzdHJveWVkID0gZmFsc2U7XG5cbiAgICBAT3V0cHV0KCkgb25TdGlja3lFdmVudCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICAgIEBPdXRwdXQoKSBvblVuU3RpY2t5RXZlbnQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIEBJbnB1dCgpIHN0aWNreUNsYXNzOiBzdHJpbmc7XG4gICAgQElucHV0KCkgc2Nyb2xsT2Zmc2V0OiBudW1iZXIgPSAwO1xuICAgIEBJbnB1dCgpIGFwcGVuZFRvOiBhbnk7XG4gICAgQElucHV0KCkgc3RpY2t5SWQ6IHN0cmluZyA9IFwiXCI7XG4gICAgQElucHV0KCkgc3RpY2tzVG86IHN0cmluZyA9IFwiXCI7XG4gICAgQElucHV0KCkgZWxlbWVudFNlbGVjdG9yOiBzdHJpbmcgPSBcIlwiO1xuXG4gICAgcHJpdmF0ZSBfcGFyZW50VG9wOiBudW1iZXIgPSBudWxsO1xuICAgIHByaXZhdGUgX3BhcmVudE9mZnNldDogbnVtYmVyID0gbnVsbDtcbiAgICBwcml2YXRlIF9zdGlja3lUb3A6IG51bWJlciA9IG51bGw7XG4gICAgcHJpdmF0ZSBfc3RpY2t5T2Zmc2V0OiBudW1iZXIgPSBudWxsO1xuXG4gICAgcHJvdGVjdGVkIF9zdGlja3lFbGVtZW50OiBhbnk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBfc3RpY2t5U2Nyb2xsU2VydmljZTogU3RpY2t5U2Nyb2xsU2VydmljZSkge1xuXG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9nZXRTdGlja3lFbGVtZW50KGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIDphbnl7XG4gICAgICAgIHJldHVybiBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgfVxuXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhgWyR7dGhpcy5zdGlja3lJZH1dIC0gbmdBZnRlclZpZXdJbml0YCk7XG4gICAgICAgIHRoaXMuX3N0aWNreUVsZW1lbnQgPSB0aGlzLl9nZXRTdGlja3lFbGVtZW50KHRoaXMuZWxlbWVudFJlZik7XG4gICAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKXtcbiAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIGF0dGFjaGVkYCk7XG4gICAgICAgIGlmICh0aGlzLnN0aWNreUlkKSB7XG4gICAgICAgICAgICB0aGlzLl9zdGlja3lTY3JvbGxTZXJ2aWNlLmF0dGFjaCh0aGlzLnN0aWNreUlkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3N0aWNreVNjcm9sbFNlcnZpY2Uuc2Nyb2xsU3RhdHVzJC5waXBlKGNhbmNlbE9uRGVzdHJveSh0aGlzKSkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSBoYW5kbGUgc2Nyb2xsYCk7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5fc3RpY2t5U2Nyb2xsU2VydmljZS5yZXNpemVTdGF0dXMkLnBpcGUoY2FuY2VsT25EZXN0cm95KHRoaXMpKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uUmVzaXplKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICB0aGlzLl9zdGlja3lTY3JvbGxTZXJ2aWNlLmxheW91dFN1YmplY3QkLnBpcGUoY2FuY2VsT25EZXN0cm95KHRoaXMpKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICBlbGVtZW50cyA9PntcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5zdGlja3NUbyA/IGVsZW1lbnRzW3RoaXMuc3RpY2tzVG9dIDoge2hlaWdodDogMCwgb2Zmc2V0OiAwfTtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiAoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJlbnRUb3AgIT09IGRhdGEuaGVpZ2h0IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJlbnRPZmZzZXQgIT09IGRhdGEub2Zmc2V0XG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJlbnRUb3AgPSBkYXRhLmhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50T2Zmc2V0ID0gZGF0YS5vZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCl7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSBkZXN0cm95ZWRgKTtcbiAgICAgICAgdGhpcy5fZGVzdHJveWVkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5fc3RpY2t5U2Nyb2xsU2VydmljZS5kZXRhY2godGhpcy5zdGlja3lJZCk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZSgpIDogdm9pZHtcbiAgICAgICAgaWYgKHRoaXMuX3BhcmVudFRvcCAhPT0gbnVsbFxuICAgICAgICAgICAgJiYgdGhpcy5fcGFyZW50T2Zmc2V0ICE9IG51bGwpXG4gICAgICAgIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSBoYW5kbGUgbGF5b3V0IHVwZGF0ZWApO1xuICAgICAgICAgICAgY29uc3Qgc3RpY2t5T2Zmc2V0ID0gdGhpcy5fcGFyZW50T2Zmc2V0ICsgdGhpcy5zY3JvbGxPZmZzZXQ7XG4gICAgICAgICAgICBpZiAodGhpcy5fc3RpY2t5VG9wICE9PSB0aGlzLl9wYXJlbnRUb3AgfHxcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGlja3lPZmZzZXQgIT09IHN0aWNreU9mZnNldClcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgWyR7dGhpcy5zdGlja3lJZH1dIC0gdXBkYXRlIGNhY2hlZCB2YWx1ZXNgKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGlja3lUb3AgPSB0aGlzLl9wYXJlbnRUb3A7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3RpY2t5T2Zmc2V0ID0gc3RpY2t5T2Zmc2V0O1xuICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcigpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy5zdGlja3lJZCAmJiB0aGlzLl9zdGlja3lFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIHVwZGF0ZSBzZXJ2aWNlYCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudEhlaWdodCA9IHRoaXMuX3N0aWNreUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClbJ2hlaWdodCddO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgdGhpcy5fc3RpY2t5U2Nyb2xsU2VydmljZS51cGRhdGUodGhpcy5zdGlja3lJZCwgZWxlbWVudEhlaWdodCArIHRoaXMuX3N0aWNreVRvcCwgdGhpcy5fc3RpY2t5T2Zmc2V0KTtcbiAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3JlbmRlcigpIDogdm9pZFxuICAgIHtcbiAgICAgICAgaWYgKCF0aGlzLl9kZXN0cm95ZWQgJiYgdGhpcy5fc3RpY2t5RWxlbWVudCkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIF9yZW5kZXJgKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuX3N0aWNreVRvcCAhPT0gbnVsbFxuICAgICAgICAgICAgICAgICYmIHRoaXMuX3N0aWNreU9mZnNldCAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2Nyb2xsID0gd2luZG93LnBhZ2VZT2Zmc2V0O1xuICAgICAgICAgICAgICAgIGlmIChzY3JvbGwgPiB0aGlzLmxhc3RTY3JvbGwgJiYgIXRoaXMuaXNTdGlja3kgJiYgdGhpcy5fc3RpY2t5RWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVsndG9wJ10gPD0gdGhpcy5fc3RpY2t5VG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSBfcmVuZGVyIChzZXQgc3RpY2t5IG1vZGUpYCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RpY2t5KCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY3JvbGwgPCB0aGlzLmxhc3RTY3JvbGwgJiYgdGhpcy5pc1N0aWNreSAmJiBzY3JvbGwgPD0gdGhpcy5fc3RpY2t5T2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSBfcmVuZGVyICh1bnNldCBzdGlja3kgbW9kZSlgKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51bnNldFN0aWNreSgpO1xuICAgICAgICAgICAgICAgIH1lbHNlXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1N0aWNreSAmJiBzY3JvbGwgPT09IHRoaXMubGFzdFNjcm9sbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdHlsZSgndG9wJywgdGhpcy5fc3RpY2t5VG9wICsgJ3B4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgWyR7dGhpcy5zdGlja3lJZH1dIC0gX3JlbmRlciAodXBkYXRlIHNpdGNreSB2YWx1ZXMpIC0gVE9ETyEhISEhIWApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMubGFzdFNjcm9sbCA9IHNjcm9sbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBzZXRTdGlja3koKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5pc1N0aWNreSkge1xuICAgICAgICAgICAgdGhpcy5pc1N0aWNreSA9IHRydWU7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgWyR7dGhpcy5zdGlja3lJZH1dIC0gdG9wID0gJHt0aGlzLl9zdGlja3lFbGVtZW50LmNsaWVudFRvcH1gKTtcbiAgICAgICAgICAgIHRoaXMub3JpZ2luYWxDc3MgPSB7XG4gICAgICAgICAgICAgICAgcG9zaXRpb246IHRoaXMuX3N0aWNreUVsZW1lbnQuc3R5bGUucG9zaXRpb24sXG4gICAgICAgICAgICAgICAgdG9wOiB0aGlzLl9zdGlja3lFbGVtZW50LmNsaWVudFRvcCxcbiAgICAgICAgICAgICAgICBtYXJnaW5Ub3A6IHRoaXMuX3N0aWNreUVsZW1lbnQuc3R5bGUubWFyZ2luVG9wLFxuICAgICAgICAgICAgICAgIGxlZnQ6IHRoaXMuX3N0aWNreUVsZW1lbnQuY2xpZW50TGVmdFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoJ3Bvc2l0aW9uJywgJ2ZpeGVkJyk7XG4gICAgICAgICAgICB0aGlzLnNldFN0eWxlKCd0b3AnLCB0aGlzLl9zdGlja3lUb3AgKyAncHgnKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmFwcGVuZFRvKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdHlsZSgnbGVmdCcsIHRoaXMuYXBwZW5kVG8uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClbJ2xlZnQnXSArICdweCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXRDbGFzcyh0cnVlKTtcbiAgICAgICAgICAgIHRoaXMub25TdGlja3lFdmVudC5lbWl0KCk7XG4gICAgICAgICAgICB0aGlzLl9vblN0aWNreSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9vblN0aWNreSgpOnZvaWR7XG4gICAgICAgIHNldFRpbWVvdXQoKCk9PiB7dGhpcy51cGRhdGUoKX0sMCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1bnNldFN0aWNreSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaXNTdGlja3kpIHtcbiAgICAgICAgICAgIHRoaXMuaXNTdGlja3kgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoJ3Bvc2l0aW9uJywgdGhpcy5vcmlnaW5hbENzcy5wb3NpdGlvbik7XG4gICAgICAgICAgICB0aGlzLnNldFN0eWxlKCdtYXJnaW5Ub3AnLCB0aGlzLm9yaWdpbmFsQ3NzLm1hcmdpblRvcCk7XG4gICAgICAgICAgICB0aGlzLnNldFN0eWxlKCd0b3AnLCB0aGlzLm9yaWdpbmFsQ3NzLnRvcCArICdweCcpO1xuICAgICAgICAgICAgaWYgKHRoaXMuYXBwZW5kVG8pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0eWxlKCdsZWZ0JywgdGhpcy5vcmlnaW5hbENzcy5sZWZ0ICsgJ3B4Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldENsYXNzKGZhbHNlKTtcbiAgICAgICAgICAgIHRoaXMub25VblN0aWNreUV2ZW50LmVtaXQoKTtcbiAgICAgICAgICAgIHRoaXMuX29uVW5zZXRTdGlja3koKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBfb25VbnNldFN0aWNreSgpOnZvaWR7XG4gICAgICAgIHNldFRpbWVvdXQoKCk9PiB7dGhpcy51cGRhdGUoKX0sMCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG9uUmVzaXplKCk6dm9pZHt9OyAvLyB1c2VkIGJ5IHByaW1lbmcgZGlyZWN0aXZlIHRvIHVwZGF0ZSB0YWJsZSBsYXlvdXRcblxuICAgIHByaXZhdGUgc2V0U3R5bGUoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLl9zdGlja3lFbGVtZW50LCBrZXksIHZhbHVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldENsYXNzKGFkZDogYm9vbGVhbik6IHZvaWQge1xuICAgICAgaWYgKGFkZCkge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuX3N0aWNreUVsZW1lbnQsIHRoaXMuc3RpY2t5Q2xhc3MpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLl9zdGlja3lFbGVtZW50LCB0aGlzLnN0aWNreUNsYXNzKTtcbiAgICAgIH1cbiAgICB9XG5cbn1cbiJdfQ==