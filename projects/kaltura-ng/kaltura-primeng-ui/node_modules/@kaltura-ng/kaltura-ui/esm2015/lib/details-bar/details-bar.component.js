import { __decorate, __metadata } from "tslib";
import { Component, ElementRef, Input, QueryList, ContentChildren, ViewChild, HostListener } from '@angular/core';
import { DetailInfoComponent } from './detail-info.component';
let DetailsBarComponent = class DetailsBarComponent {
    constructor() {
        this.basicDetailsLabel = "Basic Details";
        this.moreDetailsLabel = "More Details";
        this._shouldUpdateItems = false;
        this._showMore = false;
        this._showBasic = false;
        this.lineScroll = 0;
        this.disableScroll = false;
    }
    set data(dataObj) {
        this._data = dataObj;
        this._shouldUpdateItems = true;
        this.reset();
    }
    onWindowResize() {
        this.reset();
    }
    ngAfterViewChecked() {
        if (this._shouldUpdateItems) {
            this._shouldUpdateItems = false;
            setTimeout(() => {
                this.items.forEach(item => {
                    item._setData(this._data);
                });
            }, 0);
        }
    }
    ngAfterContentInit() {
        this.updateLayout();
        this._itemsChangesSubscription = this.items.changes.subscribe(changes => {
            this._shouldUpdateItems = true;
        });
    }
    _updateItems() {
        if (this.items) {
            this.items.forEach(item => item._setData(this._data));
        }
    }
    updateLayout() {
        //we use a cancelable interval to improve performances on window resize
        if (this.showMoreCheckIntervalID) {
            clearInterval(this.showMoreCheckIntervalID);
            this.showMoreCheckIntervalID = null;
        }
        this.showMoreCheckIntervalID = setTimeout(() => {
            this.items.forEach(item => {
                item.isLastItem = false;
            });
            this.items.last.isLastItem = true;
            const marginTop = parseInt(window.getComputedStyle(this.dataWrapper.nativeElement).top);
            const elementHeight = this.dataWrapper.nativeElement.children.length ? this.dataWrapper.nativeElement.children[0].clientHeight : 0;
            this._showMore = this.dataWrapper.nativeElement.clientHeight > this.dataPanel.nativeElement.getBoundingClientRect().height && Math.abs(marginTop) < (this.dataWrapper.nativeElement.clientHeight + marginTop);
            this._showBasic = this.dataWrapper.nativeElement.clientHeight > this.dataPanel.nativeElement.getBoundingClientRect().height && marginTop < 0;
            // code to remove last separators in each line
            let topArr = [];
            if (this.dataWrapper.nativeElement.children.length) {
                for (let i = 0; i < this.dataWrapper.nativeElement.children.length; i++) {
                    const elm = this.dataWrapper.nativeElement.children[i];
                    const top = elm.getBoundingClientRect().top;
                    topArr.push(top);
                }
                for (let i = 0; i < topArr.length - 1; i++) {
                    if (topArr[i] < topArr[i + 1] && this.items.length >= i) {
                        this.items.forEach((item, index) => {
                            if (i === index) {
                                item.isLastItem = true;
                            }
                        });
                    }
                }
            }
            this.showMoreCheckIntervalID = null;
        }, 100);
    }
    show(direction) {
        if (!this.disableScroll) {
            this.disableScroll = true;
            if (direction === "more") {
                this.lineScroll++;
            }
            else {
                this.lineScroll--;
            }
            this.dataWrapper.nativeElement.style.top = this.dataWrapper.nativeElement.children[0].clientHeight * (-1) * this.lineScroll + "px";
            setTimeout(() => {
                this.updateLayout(); // allow animation to finish before recalculating
                this.disableScroll = false;
            }, 350);
        }
    }
    reset() {
        this.lineScroll = 0;
        this.dataWrapper.nativeElement.style.top = "0px";
        setTimeout(() => {
            this.updateLayout(); // allow animation to finish before recalculating
        }, 350);
    }
    ngOnDestroy() {
        if (this._itemsChangesSubscription) {
            this._itemsChangesSubscription.unsubscribe();
            this._itemsChangesSubscription = null;
        }
    }
};
__decorate([
    ContentChildren(DetailInfoComponent),
    __metadata("design:type", QueryList)
], DetailsBarComponent.prototype, "items", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], DetailsBarComponent.prototype, "basicDetailsLabel", void 0);
__decorate([
    Input(),
    __metadata("design:type", String)
], DetailsBarComponent.prototype, "moreDetailsLabel", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], DetailsBarComponent.prototype, "data", null);
__decorate([
    ViewChild('dataPanel', { static: true }),
    __metadata("design:type", ElementRef)
], DetailsBarComponent.prototype, "dataPanel", void 0);
__decorate([
    ViewChild('dataWrapper', { static: true }),
    __metadata("design:type", ElementRef)
], DetailsBarComponent.prototype, "dataWrapper", void 0);
__decorate([
    HostListener("window:resize", []),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], DetailsBarComponent.prototype, "onWindowResize", null);
DetailsBarComponent = __decorate([
    Component({
        selector: 'k-details-bar',
        template: "<div class=\"kContent kDetailsBar\" #dataPanel>\n    <i class=\"kLink kIcondropdown_arrow_bottom\" [class.disabled]=\"!_showMore\" [class.hidden]=\"!_showMore && !_showBasic\" (click)=\"show('more')\"></i>\n    <i class=\"kLink kIcondropdown_arrow_top\" [class.disabled]=\"!_showBasic\" [class.hidden]=\"!_showMore && !_showBasic\" (click)=\"show('basic')\"></i>\n    <div class=\"kItemsWrapper\" #dataWrapper>\n        <ng-content *ngIf=\"_data\" ></ng-content>\n    </div>\n</div>",
        styles: [".kDetailsBar{display:block;height:26px;line-height:26px;overflow-y:hidden;font-size:14px;color:#666}.kDetailsBar .kLink{font-size:14px;float:right;margin-left:8px;border:0;cursor:pointer;margin-top:5px}.kDetailsBar .kLink.disabled{opacity:.4;pointer-events:none}.kDetailsBar .kLink.hidden{opacity:0;pointer-events:none}.kDetailsBar .kItemsWrapper{position:relative;flex:1 1 auto;height:auto;display:flex;flex-flow:wrap;transition:top .3s}"]
    }),
    __metadata("design:paramtypes", [])
], DetailsBarComponent);
export { DetailsBarComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWlscy1iYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGthbHR1cmEtbmcva2FsdHVyYS11aS8iLCJzb3VyY2VzIjpbImxpYi9kZXRhaWxzLWJhci9kZXRhaWxzLWJhci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFvQixTQUFTLEVBQUUsWUFBWSxFQUErQixNQUFNLGVBQWUsQ0FBQztBQUNqSyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQVE5RCxJQUFhLG1CQUFtQixHQUFoQyxNQUFhLG1CQUFtQjtJQXlCOUI7UUFyQlMsc0JBQWlCLEdBQVcsZUFBZSxDQUFDO1FBQzVDLHFCQUFnQixHQUFXLGNBQWMsQ0FBQztRQUUzQyx1QkFBa0IsR0FBRyxLQUFLLENBQUM7UUFXNUIsY0FBUyxHQUFZLEtBQUssQ0FBQztRQUMzQixlQUFVLEdBQVksS0FBSyxDQUFDO1FBRTNCLGVBQVUsR0FBRyxDQUFDLENBQUM7UUFDZixrQkFBYSxHQUFZLEtBQUssQ0FBQztJQUl2QyxDQUFDO0lBaEJRLElBQUksSUFBSSxDQUFDLE9BQVk7UUFDNUIsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUM7UUFDckIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUMvQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBZUQsY0FBYztRQUNaLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQzNCO1lBQ0UsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQztZQUNoQyxVQUFVLENBQUMsR0FBRSxFQUFFO2dCQUNiLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDNUIsQ0FBQyxDQUFDLENBQUE7WUFDSixDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUM7U0FDTjtJQUNILENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRXBCLElBQUksQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQ3pELE9BQU8sQ0FBQyxFQUFFO1lBQ1IsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUNqQyxDQUFDLENBQ0osQ0FBQztJQUNKLENBQUM7SUFFTyxZQUFZO1FBRWxCLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNkLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUN2RDtJQUNILENBQUM7SUFDRCxZQUFZO1FBQ1YsdUVBQXVFO1FBQ3ZFLElBQUksSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQ2hDLGFBQWEsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQztZQUM1QyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1NBQ3JDO1FBQ0QsSUFBSSxDQUFDLHVCQUF1QixHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBQzFCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztZQUNsQyxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDeEYsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25JLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLENBQUM7WUFDOU0sSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxNQUFNLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBRTtZQUU5SSw4Q0FBOEM7WUFDOUMsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO1lBQ2hCLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBQztnQkFDakQsS0FBSyxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUM7b0JBQ2xFLE1BQU0sR0FBRyxHQUFRLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDNUQsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLHFCQUFxQixFQUFFLENBQUMsR0FBRyxDQUFDO29CQUM1QyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNsQjtnQkFDRCxLQUFLLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEdBQUMsTUFBTSxDQUFDLE1BQU0sR0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUM7b0JBQ25DLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFDO3dCQUNwRCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsRUFBRTs0QkFDaEMsSUFBSSxDQUFDLEtBQUcsS0FBSyxFQUFDO2dDQUNaLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDOzZCQUN4Qjt3QkFDSCxDQUFDLENBQUMsQ0FBQztxQkFDSjtpQkFDRjthQUNGO1lBRUQsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQztRQUN0QyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRUQsSUFBSSxDQUFDLFNBQWlCO1FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFDO1lBQ3RCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBQzFCLElBQUksU0FBUyxLQUFLLE1BQU0sRUFBRTtnQkFDeEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2FBQ25CO2lCQUNJO2dCQUNILElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUNuQjtZQUNELElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDbkksVUFBVSxDQUFDLEdBQUUsRUFBRTtnQkFDYixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxpREFBaUQ7Z0JBQ3RFLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1lBQzdCLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FBQztTQUNSO0lBRUgsQ0FBQztJQUVELEtBQUs7UUFDSCxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQztRQUNwQixJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQztRQUNqRCxVQUFVLENBQUMsR0FBRSxFQUFFO1lBQ2IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsaURBQWlEO1FBQ3hFLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FBQztJQUNULENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxJQUFJLENBQUMseUJBQXlCLEVBQUM7WUFDakMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzdDLElBQUksQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLENBQUM7U0FDdkM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQWxJdUM7SUFBckMsZUFBZSxDQUFDLG1CQUFtQixDQUFDOzhCQUFRLFNBQVM7a0RBQXNCO0FBRW5FO0lBQVIsS0FBSyxFQUFFOzs4REFBNkM7QUFDNUM7SUFBUixLQUFLLEVBQUU7OzZEQUEyQztBQUsxQztJQUFSLEtBQUssRUFBRTs7OytDQUlQO0FBRXlDO0lBQXpDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7OEJBQVksVUFBVTtzREFBQztBQUNwQjtJQUEzQyxTQUFTLENBQUMsYUFBYSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDOzhCQUFjLFVBQVU7d0RBQUM7QUFZcEU7SUFEQyxZQUFZLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQzs7Ozt5REFHakM7QUEvQlUsbUJBQW1CO0lBTC9CLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxlQUFlO1FBQ3pCLDhlQUEyQzs7S0FFNUMsQ0FBQzs7R0FDVyxtQkFBbUIsQ0FvSS9CO1NBcElZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIFF1ZXJ5TGlzdCwgQ29udGVudENoaWxkcmVuLCBBZnRlckNvbnRlbnRJbml0LCBWaWV3Q2hpbGQsIEhvc3RMaXN0ZW5lciwgT25EZXN0cm95LCBBZnRlclZpZXdDaGVja2VkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEZXRhaWxJbmZvQ29tcG9uZW50IH0gZnJvbSAnLi9kZXRhaWwtaW5mby5jb21wb25lbnQnO1xuaW1wb3J0IHsgSVN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMvU3Vic2NyaXB0aW9uJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnay1kZXRhaWxzLWJhcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9kZXRhaWxzLWJhci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2RldGFpbHMtYmFyLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgRGV0YWlsc0JhckNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyQ29udGVudEluaXQsQWZ0ZXJWaWV3Q2hlY2tlZCwgT25EZXN0cm95IHtcblxuICBAQ29udGVudENoaWxkcmVuKERldGFpbEluZm9Db21wb25lbnQpIGl0ZW1zOiBRdWVyeUxpc3Q8RGV0YWlsSW5mb0NvbXBvbmVudD47XG5cbiAgQElucHV0KCkgYmFzaWNEZXRhaWxzTGFiZWw6IHN0cmluZyA9IFwiQmFzaWMgRGV0YWlsc1wiO1xuICBASW5wdXQoKSBtb3JlRGV0YWlsc0xhYmVsOiBzdHJpbmcgPSBcIk1vcmUgRGV0YWlsc1wiO1xuXG4gIHByaXZhdGUgX3Nob3VsZFVwZGF0ZUl0ZW1zID0gZmFsc2U7XG5cbiAgcHVibGljIF9kYXRhOiBhbnk7XG4gIEBJbnB1dCgpIHNldCBkYXRhKGRhdGFPYmo6IGFueSkge1xuICAgIHRoaXMuX2RhdGEgPSBkYXRhT2JqO1xuICAgIHRoaXMuX3Nob3VsZFVwZGF0ZUl0ZW1zID0gdHJ1ZTtcbiAgICB0aGlzLnJlc2V0KCk7XG4gIH1cblxuICBAVmlld0NoaWxkKCdkYXRhUGFuZWwnLCB7IHN0YXRpYzogdHJ1ZSB9KSBkYXRhUGFuZWw6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ2RhdGFXcmFwcGVyJywgeyBzdGF0aWM6IHRydWUgfSkgZGF0YVdyYXBwZXI6IEVsZW1lbnRSZWY7XG4gIHB1YmxpYyBfc2hvd01vcmU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHVibGljIF9zaG93QmFzaWM6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBzaG93TW9yZUNoZWNrSW50ZXJ2YWxJRDogYW55O1xuICBwcml2YXRlIGxpbmVTY3JvbGwgPSAwO1xuICBwcml2YXRlIGRpc2FibGVTY3JvbGw6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfaXRlbXNDaGFuZ2VzU3Vic2NyaXB0aW9uOiBJU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcihcIndpbmRvdzpyZXNpemVcIiwgW10pXG4gIG9uV2luZG93UmVzaXplKCkge1xuICAgIHRoaXMucmVzZXQoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3Q2hlY2tlZCgpe1xuICAgIGlmICh0aGlzLl9zaG91bGRVcGRhdGVJdGVtcylcbiAgICB7XG4gICAgICB0aGlzLl9zaG91bGRVcGRhdGVJdGVtcyA9IGZhbHNlO1xuICAgICAgc2V0VGltZW91dCgoKT0+e1xuICAgICAgICB0aGlzLml0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgaXRlbS5fc2V0RGF0YSh0aGlzLl9kYXRhKTtcbiAgICAgICAgfSlcbiAgICAgIH0sMCk7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgIHRoaXMudXBkYXRlTGF5b3V0KCk7XG5cbiAgICB0aGlzLl9pdGVtc0NoYW5nZXNTdWJzY3JpcHRpb24gPSB0aGlzLml0ZW1zLmNoYW5nZXMuc3Vic2NyaWJlKFxuICAgICAgICBjaGFuZ2VzID0+IHtcbiAgICAgICAgICB0aGlzLl9zaG91bGRVcGRhdGVJdGVtcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlSXRlbXMoKTogdm9pZHtcblxuICAgIGlmICh0aGlzLml0ZW1zKSB7XG4gICAgICB0aGlzLml0ZW1zLmZvckVhY2goaXRlbSA9PiBpdGVtLl9zZXREYXRhKHRoaXMuX2RhdGEpKTtcbiAgICB9XG4gIH1cbiAgdXBkYXRlTGF5b3V0KCkge1xuICAgIC8vd2UgdXNlIGEgY2FuY2VsYWJsZSBpbnRlcnZhbCB0byBpbXByb3ZlIHBlcmZvcm1hbmNlcyBvbiB3aW5kb3cgcmVzaXplXG4gICAgaWYgKHRoaXMuc2hvd01vcmVDaGVja0ludGVydmFsSUQpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5zaG93TW9yZUNoZWNrSW50ZXJ2YWxJRCk7XG4gICAgICB0aGlzLnNob3dNb3JlQ2hlY2tJbnRlcnZhbElEID0gbnVsbDtcbiAgICB9XG4gICAgdGhpcy5zaG93TW9yZUNoZWNrSW50ZXJ2YWxJRCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBpdGVtLmlzTGFzdEl0ZW0gPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5pdGVtcy5sYXN0LmlzTGFzdEl0ZW0gPSB0cnVlO1xuICAgICAgY29uc3QgbWFyZ2luVG9wID0gcGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUodGhpcy5kYXRhV3JhcHBlci5uYXRpdmVFbGVtZW50KS50b3ApO1xuICAgICAgY29uc3QgZWxlbWVudEhlaWdodCA9IHRoaXMuZGF0YVdyYXBwZXIubmF0aXZlRWxlbWVudC5jaGlsZHJlbi5sZW5ndGggPyB0aGlzLmRhdGFXcmFwcGVyLm5hdGl2ZUVsZW1lbnQuY2hpbGRyZW5bMF0uY2xpZW50SGVpZ2h0IDogMDtcbiAgICAgIHRoaXMuX3Nob3dNb3JlID0gdGhpcy5kYXRhV3JhcHBlci5uYXRpdmVFbGVtZW50LmNsaWVudEhlaWdodCA+IHRoaXMuZGF0YVBhbmVsLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuaGVpZ2h0ICYmIE1hdGguYWJzKG1hcmdpblRvcCkgPCAodGhpcy5kYXRhV3JhcHBlci5uYXRpdmVFbGVtZW50LmNsaWVudEhlaWdodCArIG1hcmdpblRvcCk7XG4gICAgICB0aGlzLl9zaG93QmFzaWMgPSB0aGlzLmRhdGFXcmFwcGVyLm5hdGl2ZUVsZW1lbnQuY2xpZW50SGVpZ2h0ID4gdGhpcy5kYXRhUGFuZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5oZWlnaHQgJiYgbWFyZ2luVG9wIDwgMCA7XG5cbiAgICAgIC8vIGNvZGUgdG8gcmVtb3ZlIGxhc3Qgc2VwYXJhdG9ycyBpbiBlYWNoIGxpbmVcbiAgICAgIGxldCB0b3BBcnIgPSBbXTtcbiAgICAgIGlmICh0aGlzLmRhdGFXcmFwcGVyLm5hdGl2ZUVsZW1lbnQuY2hpbGRyZW4ubGVuZ3RoKXtcbiAgICAgICAgZm9yIChsZXQgaT0wOyBpPHRoaXMuZGF0YVdyYXBwZXIubmF0aXZlRWxlbWVudC5jaGlsZHJlbi5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgY29uc3QgZWxtOiBhbnkgPSB0aGlzLmRhdGFXcmFwcGVyLm5hdGl2ZUVsZW1lbnQuY2hpbGRyZW5baV07XG4gICAgICAgICAgY29uc3QgdG9wID0gZWxtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcbiAgICAgICAgICB0b3BBcnIucHVzaCh0b3ApO1xuICAgICAgICB9XG4gICAgICAgIGZvciAobGV0IGk9MDsgaTx0b3BBcnIubGVuZ3RoLTE7IGkrKyl7XG4gICAgICAgICAgaWYgKHRvcEFycltpXSA8IHRvcEFycltpKzFdICYmIHRoaXMuaXRlbXMubGVuZ3RoID49IGkpe1xuICAgICAgICAgICAgdGhpcy5pdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCk9PntcbiAgICAgICAgICAgICAgaWYgKGk9PT1pbmRleCl7XG4gICAgICAgICAgICAgICAgaXRlbS5pc0xhc3RJdGVtID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2hvd01vcmVDaGVja0ludGVydmFsSUQgPSBudWxsO1xuICAgIH0sIDEwMCk7XG4gIH1cblxuICBzaG93KGRpcmVjdGlvbjogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLmRpc2FibGVTY3JvbGwpe1xuICAgICAgdGhpcy5kaXNhYmxlU2Nyb2xsID0gdHJ1ZTtcbiAgICAgIGlmIChkaXJlY3Rpb24gPT09IFwibW9yZVwiKSB7XG4gICAgICAgIHRoaXMubGluZVNjcm9sbCsrO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHRoaXMubGluZVNjcm9sbC0tO1xuICAgICAgfVxuICAgICAgdGhpcy5kYXRhV3JhcHBlci5uYXRpdmVFbGVtZW50LnN0eWxlLnRvcCA9IHRoaXMuZGF0YVdyYXBwZXIubmF0aXZlRWxlbWVudC5jaGlsZHJlblswXS5jbGllbnRIZWlnaHQgKiAoLTEpICogdGhpcy5saW5lU2Nyb2xsICsgXCJweFwiO1xuICAgICAgc2V0VGltZW91dCgoKT0+e1xuICAgICAgICB0aGlzLnVwZGF0ZUxheW91dCgpOyAvLyBhbGxvdyBhbmltYXRpb24gdG8gZmluaXNoIGJlZm9yZSByZWNhbGN1bGF0aW5nXG4gICAgICAgIHRoaXMuZGlzYWJsZVNjcm9sbCA9IGZhbHNlO1xuICAgICAgfSwzNTApO1xuICAgIH1cblxuICB9XG5cbiAgcmVzZXQoKXtcbiAgICB0aGlzLmxpbmVTY3JvbGwgPSAwO1xuICAgIHRoaXMuZGF0YVdyYXBwZXIubmF0aXZlRWxlbWVudC5zdHlsZS50b3AgPSBcIjBweFwiO1xuICAgIHNldFRpbWVvdXQoKCk9PntcbiAgICAgIHRoaXMudXBkYXRlTGF5b3V0KCk7IC8vIGFsbG93IGFuaW1hdGlvbiB0byBmaW5pc2ggYmVmb3JlIHJlY2FsY3VsYXRpbmdcbiAgICB9LDM1MCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpe1xuICAgIGlmICh0aGlzLl9pdGVtc0NoYW5nZXNTdWJzY3JpcHRpb24pe1xuICAgICAgdGhpcy5faXRlbXNDaGFuZ2VzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB0aGlzLl9pdGVtc0NoYW5nZXNTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgIH1cbiAgfVxufVxuXG4iXX0=