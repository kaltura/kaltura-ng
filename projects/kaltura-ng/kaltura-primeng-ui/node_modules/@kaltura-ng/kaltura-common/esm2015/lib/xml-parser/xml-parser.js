import { XmlToJSON } from './xml-to-json';
import { KalturaUtils } from '../utils/kaltura-utils';
function convertAttributes(attributes) {
    let parsedAttributes = '';
    if (attributes) {
        Object.keys(attributes).forEach(attributeName => {
            const value = KalturaUtils.escapeXml(attributes[attributeName]);
            parsedAttributes += ` ${attributeName}="${value}"`;
        });
    }
    return parsedAttributes;
}
function convertObjectToXml(prefix, propertyName, propertyValue) {
    let result = ``;
    const noPrefixPropertyName = (propertyName || '').indexOf('noprefix:') !== -1;
    if (noPrefixPropertyName) {
        propertyName = propertyName.replace('noprefix:', '');
        prefix = '';
    }
    if (Array.isArray(propertyValue)) {
        propertyValue.forEach(innerItem => {
            result += convertObjectToXml(prefix, propertyName, innerItem);
        });
    }
    else if (propertyValue && typeof propertyValue === 'object') {
        const parsedAttributes = convertAttributes(propertyValue['attr']);
        let parsedValue = '';
        if (propertyValue['text']) {
            parsedValue = KalturaUtils.escapeXml(propertyValue['text']);
        }
        else {
            Object.keys(propertyValue).forEach(innerProperty => {
                if (innerProperty !== 'attr') {
                    parsedValue += convertObjectToXml(prefix, innerProperty, propertyValue[innerProperty]);
                }
            });
        }
        result += `<${prefix}${propertyName}`;
        if (parsedAttributes) {
            result += `${parsedAttributes}>`;
        }
        else {
            result += '>';
        }
        result += `${parsedValue}</${prefix}${propertyName}>`;
    }
    return result;
}
export class XmlParser {
    static toJson(xml) {
        return XmlToJSON.parseString(xml, {
            textKey: 'text',
            valueKey: 'value',
            attrKey: 'attr',
            cdataKey: 'cdata',
            childrenAsArray: false,
            grokText: false,
            grokAttr: false,
            normalize: false,
        });
    }
    static toXml(data, root, prefix = '') {
        const parsedPrefix = prefix ? `${prefix}:` : '';
        let parsedObject = '';
        let parsedAttributes = '';
        if (data) {
            parsedAttributes = convertAttributes(data['attr']);
            Object.keys(data).forEach(property => {
                if (property !== 'attr') {
                    parsedObject += convertObjectToXml(parsedPrefix, property, data[property]);
                }
            });
        }
        return `<${parsedPrefix}${root}${parsedAttributes}>${parsedObject}</${parsedPrefix}${root}>`;
    }
    static toSimpleXml(data, config = {}) {
        let result = '';
        const _parseValueToXml = (value) => {
            let result;
            if (typeof value === 'object') {
                result = XmlParser.toSimpleXml(value, config);
            }
            else {
                result = KalturaUtils.escapeXml(value);
            }
            return result;
        };
        if (data) {
            Object.keys(data).forEach(function (key) {
                const propertyValue = data[key];
                const isEmptyValue = (propertyValue === null || typeof propertyValue === 'undefined' || propertyValue === '');
                if (!config.removeEmpty || (config.removeEmpty && !isEmptyValue)) {
                    if (propertyValue instanceof Array) {
                        propertyValue.map(arrayItem => {
                            const valueAsXml = _parseValueToXml(arrayItem);
                            const isEmptyValue = (valueAsXml === null || typeof valueAsXml === 'undefined' || valueAsXml === '');
                            if (!config.removeEmpty || (config.removeEmpty && !isEmptyValue)) {
                                result += `<${key}>${valueAsXml}</${key}>`;
                            }
                        });
                    }
                    else if (typeof propertyValue === 'object') {
                        const valueAsXml = _parseValueToXml(propertyValue);
                        const isEmptyValue = (valueAsXml === null || typeof valueAsXml === 'undefined' || valueAsXml === '');
                        if (!config.removeEmpty || (config.removeEmpty && !isEmptyValue)) {
                            result += `<${key}>${valueAsXml}</${key}>`;
                        }
                    }
                    else {
                        const value = KalturaUtils.escapeXml(propertyValue);
                        result += `<${key}>${value}</${key}>`;
                    }
                }
            });
        }
        return result;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieG1sLXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3htbC1wYXJzZXIveG1sLXBhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUl0RCxTQUFTLGlCQUFpQixDQUFDLFVBQWtCO0lBQzNDLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0lBQzFCLElBQUksVUFBVSxFQUFFO1FBQ2QsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDOUMsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUNoRSxnQkFBZ0IsSUFBSSxJQUFJLGFBQWEsS0FBSyxLQUFLLEdBQUcsQ0FBQztRQUNyRCxDQUFDLENBQUMsQ0FBQztLQUNKO0lBRUQsT0FBTyxnQkFBZ0IsQ0FBQztBQUMxQixDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxNQUFjLEVBQUUsWUFBb0IsRUFBRSxhQUFrQjtJQUNoRixJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFFaEIsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDOUUsSUFBSSxvQkFBb0IsRUFBRTtRQUN4QixZQUFZLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDckQsTUFBTSxHQUFHLEVBQUUsQ0FBQztLQUNiO0lBRUQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUFFO1FBQzlCLGFB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QUM5Qzt3QkFDTCxDQUFDLENBQUMsQ0FBQTtxQkFDTDt5QkFBTSxJQUFJLE9BQU8sYUFBYSxLQUFLLFFBQVEsRUFBRTt3QkFDMUMsTUFBTSxVQUFVLEdBQUcsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLENBQUM7d0JBQ25ELE1BQU0sWUFBWSxHQUFHLENBQUMsVUFBVSxLQUFLLElBQUksSUFBSSxPQUFPLFVBQVUsS0FBSyxXQUFXLElBQUksVUFBVSxLQUFLLEVBQUUsQ0FBQyxDQUFDO3dCQUVyRyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRTs0QkFDOUQsTUFBTSxJQUFJLElBQUksR0FBRyxJQUFJLFVBQVUsS0FBSyxHQUFHLEdBQUcsQ0FBQzt5QkFDOUM7cUJBQ0o7eUJBQ0k7d0JBQ0QsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQzt3QkFDcEQsTUFBTSxJQUFJLElBQUksR0FBRyxJQUFJLEtBQUssS0FBSyxHQUFHLEdBQUcsQ0FBQztxQkFDekM7aUJBQ0o7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNOO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgWG1sVG9KU09OIH0gZnJvbSAnLi94bWwtdG8tanNvbic7XG5pbXBvcnQgeyBLYWx0dXJhVXRpbHMgfSBmcm9tICcuLi91dGlscy9rYWx0dXJhLXV0aWxzJztcblxuXG5cbmZ1bmN0aW9uIGNvbnZlcnRBdHRyaWJ1dGVzKGF0dHJpYnV0ZXM6IG9iamVjdCk6IHN0cmluZyB7XG4gIGxldCBwYXJzZWRBdHRyaWJ1dGVzID0gJyc7XG4gIGlmIChhdHRyaWJ1dGVzKSB7XG4gICAgT2JqZWN0LmtleXMoYXR0cmlidXRlcykuZm9yRWFjaChhdHRyaWJ1dGVOYW1lID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gS2FsdHVyYVV0aWxzLmVzY2FwZVhtbChhdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdKTtcbiAgICAgIHBhcnNlZEF0dHJpYnV0ZXMgKz0gYCAke2F0dHJpYnV0ZU5hbWV9PVwiJHt2YWx1ZX1cImA7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcGFyc2VkQXR0cmlidXRlcztcbn1cblxuZnVuY3Rpb24gY29udmVydE9iamVjdFRvWG1sKHByZWZpeDogc3RyaW5nLCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgcHJvcGVydHlWYWx1ZTogYW55KTogc3RyaW5nIHtcbiAgICBsZXQgcmVzdWx0ID0gYGA7XG5cbiAgICBjb25zdCBub1ByZWZpeFByb3BlcnR5TmFtZSA9IChwcm9wZXJ0eU5hbWUgfHwgJycpLmluZGV4T2YoJ25vcHJlZml4OicpICE9PSAtMTtcbiAgICBpZiAobm9QcmVmaXhQcm9wZXJ0eU5hbWUpIHtcbiAgICAgIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5TmFtZS5yZXBsYWNlKCdub3ByZWZpeDonLCAnJyk7XG4gICAgICBwcmVmaXggPSAnJztcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShwcm9wZXJ0eVZhbHVlKSkge1xuICAgICAgICBwcm9wZXJ0eVZhbHVlLmZvckVhY2goaW5uZXJJdGVtID0+XG4gICAgICAgIHtcbiAgICAgICAgICAgIHJlc3VsdCArPSBjb252ZXJ0T2JqZWN0VG9YbWwocHJlZml4LCBwcm9wZXJ0eU5hbWUsIGlubmVySXRlbSk7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAocHJvcGVydHlWYWx1ZSAmJiB0eXBlb2YgcHJvcGVydHlWYWx1ZSA9PT0gJ29iamVjdCcpIHtcblxuICAgICAgICBjb25zdCBwYXJzZWRBdHRyaWJ1dGVzID0gY29udmVydEF0dHJpYnV0ZXMocHJvcGVydHlWYWx1ZVsnYXR0ciddKTtcbiAgICAgICAgbGV0IHBhcnNlZFZhbHVlOiBhbnkgPSAnJztcblxuICAgICAgICBpZiAocHJvcGVydHlWYWx1ZVsndGV4dCddKSB7XG4gICAgICAgICAgICBwYXJzZWRWYWx1ZSA9IEthbHR1cmFVdGlscy5lc2NhcGVYbWwocHJvcGVydHlWYWx1ZVsndGV4dCddKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHByb3BlcnR5VmFsdWUpLmZvckVhY2goaW5uZXJQcm9wZXJ0eSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcGVydHkgIT09ICdhdHRyJykge1xuICAgICAgICAgICAgICAgICAgICBwYXJzZWRWYWx1ZSArPSBjb252ZXJ0T2JqZWN0VG9YbWwocHJlZml4LCBpbm5lclByb3BlcnR5LCBwcm9wZXJ0eVZhbHVlW2lubmVyUHJvcGVydHldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc3VsdCArPSBgPCR7cHJlZml4fSR7cHJvcGVydHlOYW1lfWA7XG5cbiAgICAgICAgaWYgKHBhcnNlZEF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgIHJlc3VsdCArPSBgJHtwYXJzZWRBdHRyaWJ1dGVzfT5gO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0ICs9ICc+JztcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc3VsdCArPSBgJHtwYXJzZWRWYWx1ZX08LyR7cHJlZml4fSR7cHJvcGVydHlOYW1lfT5gO1xuICAgIH1cblxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGNsYXNzIFhtbFBhcnNlclxue1xuICAgIHN0YXRpYyB0b0pzb24oeG1sIDogc3RyaW5nKSA6IHt9XG4gICAge1xuICAgICAgICByZXR1cm4gWG1sVG9KU09OLnBhcnNlU3RyaW5nKHhtbCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0ZXh0S2V5OiAndGV4dCcsIFx0Ly8gdGFnIG5hbWUgZm9yIHRleHQgbm9kZXNcbiAgICAgICAgICAgICAgICB2YWx1ZUtleTogJ3ZhbHVlJywgXHQvLyB0YWcgbmFtZSBmb3IgYXR0cmlidXRlIHZhbHVlc1xuICAgICAgICAgICAgICAgIGF0dHJLZXk6ICdhdHRyJywgXHQvLyB0YWcgZm9yIGF0dHIgZ3JvdXBzXG4gICAgICAgICAgICAgICAgY2RhdGFLZXk6ICdjZGF0YScsXHQvLyB0YWcgZm9yIGNkYXRhIG5vZGVzIChpZ25vcmVkIGlmIG1lcmdlQ0RBVEEgaXMgdHJ1ZSlcbiAgICAgICAgICAgICAgICBjaGlsZHJlbkFzQXJyYXk6IGZhbHNlLCBcdC8vIGZvcmNlIGNoaWxkcmVuIGludG8gYXJyYXlzXG5cdCAgICAgICAgICAgIGdyb2tUZXh0OiBmYWxzZSxcblx0ICAgICAgICAgICAgZ3Jva0F0dHI6IGZhbHNlLFxuICAgICAgICAgICAgICBub3JtYWxpemU6IGZhbHNlLFxuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIHRvWG1sKGRhdGE6IG9iamVjdCwgcm9vdDogc3RyaW5nLCBwcmVmaXg6IHN0cmluZyA9ICcnKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcGFyc2VkUHJlZml4ID0gcHJlZml4ID8gYCR7cHJlZml4fTpgIDogJyc7XG4gICAgICAgIGxldCBwYXJzZWRPYmplY3QgPSAnJztcbiAgICAgICAgbGV0IHBhcnNlZEF0dHJpYnV0ZXMgPSAnJztcblxuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgcGFyc2VkQXR0cmlidXRlcyA9IGNvbnZlcnRBdHRyaWJ1dGVzKGRhdGFbJ2F0dHInXSk7XG5cbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eSAhPT0gJ2F0dHInKSB7XG4gICAgICAgICAgICAgICAgICAgcGFyc2VkT2JqZWN0ICs9IGNvbnZlcnRPYmplY3RUb1htbChwYXJzZWRQcmVmaXgsIHByb3BlcnR5LCBkYXRhW3Byb3BlcnR5XSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBgPCR7cGFyc2VkUHJlZml4fSR7cm9vdH0ke3BhcnNlZEF0dHJpYnV0ZXN9PiR7cGFyc2VkT2JqZWN0fTwvJHtwYXJzZWRQcmVmaXh9JHtyb290fT5gO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b1NpbXBsZVhtbChkYXRhIDoge30sIGNvbmZpZyA6IHtyZW1vdmVFbXB0eT8gOiBib29sZWFufSA9IHt9KSA6IHN0cmluZ3tcbiAgICAgICAgbGV0IHJlc3VsdCA9ICcnO1xuICAgICAgICBjb25zdCBfcGFyc2VWYWx1ZVRvWG1sID0gKHZhbHVlIDogYW55KSA9PlxuICAgICAgICB7XG4gICAgICAgICAgICBsZXQgcmVzdWx0IDogc3RyaW5nO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IFhtbFBhcnNlci50b1NpbXBsZVhtbCh2YWx1ZSwgY29uZmlnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IEthbHR1cmFVdGlscy5lc2NhcGVYbWwodmFsdWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlID0gZGF0YVtrZXldO1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzRW1wdHlWYWx1ZSA9IChwcm9wZXJ0eVZhbHVlID09PSBudWxsIHx8IHR5cGVvZiBwcm9wZXJ0eVZhbHVlID09PSAndW5kZWZpbmVkJyB8fCBwcm9wZXJ0eVZhbHVlID09PSAnJyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5yZW1vdmVFbXB0eSB8fCAoY29uZmlnLnJlbW92ZUVtcHR5ICYmICFpc0VtcHR5VmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eVZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnR5VmFsdWUubWFwKGFycmF5SXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVBc1htbCA9IF9wYXJzZVZhbHVlVG9YbWwoYXJyYXlJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0VtcHR5VmFsdWUgPSAodmFsdWVBc1htbCA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWVBc1htbCA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWVBc1htbCA9PT0gJycpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maWcucmVtb3ZlRW1wdHkgfHwgKGNvbmZpZy5yZW1vdmVFbXB0eSAmJiAhaXNFbXB0eVZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gYDwke2tleX0+JHt2YWx1ZUFzWG1sfTwvJHtrZXl9PmA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvcGVydHlWYWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlQXNYbWwgPSBfcGFyc2VWYWx1ZVRvWG1sKHByb3BlcnR5VmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNFbXB0eVZhbHVlID0gKHZhbHVlQXNYbWwgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlQXNYbWwgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlQXNYbWwgPT09ICcnKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maWcucmVtb3ZlRW1wdHkgfHwgKGNvbmZpZy5yZW1vdmVFbXB0eSAmJiAhaXNFbXB0eVZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSBgPCR7a2V5fT4ke3ZhbHVlQXNYbWx9PC8ke2tleX0+YDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gS2FsdHVyYVV0aWxzLmVzY2FwZVhtbChwcm9wZXJ0eVZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSBgPCR7a2V5fT4ke3ZhbHVlfTwvJHtrZXl9PmA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxufVxuIl19