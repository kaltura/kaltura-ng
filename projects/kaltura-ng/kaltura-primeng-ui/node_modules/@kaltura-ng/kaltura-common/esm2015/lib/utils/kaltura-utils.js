import { Download } from './download';
const _xmlCharMap = {
    '<': '&lt;',
    '>': '&gt;',
    '&': '&amp;'
};
export class KalturaUtils {
    static escapeXml(value) {
        let parsedValue = value;
        switch (typeof value) {
            case 'string':
            case 'number':
            case 'boolean':
                parsedValue = value;
                break;
            default:
                parsedValue = value || '';
                break;
        }
        return String(parsedValue).replace(/[&<>]/g, char => _xmlCharMap[char]);
    }
    static getStartDateValue(value) {
        if (value) {
            const newValue = new Date(value.getTime());
            newValue.setHours(0);
            newValue.setMinutes(0);
            newValue.setSeconds(0);
            return newValue;
        }
        else {
            return null;
        }
    }
    static getEndDateValue(value) {
        if (value) {
            const newValue = new Date(value.getTime());
            newValue.setHours(23);
            newValue.setMinutes(59);
            newValue.setSeconds(59);
            return newValue;
        }
        else {
            return null;
        }
    }
    static removeEmptyProperties(value) {
        Object.keys(value).forEach(function (key) {
            if (value[key] && typeof value[key] === 'object') {
                KalturaUtils.removeEmptyProperties(value[key]);
            }
            else if (value[key] === null) {
                delete value[key];
            }
        });
        return value;
    }
    static moveUpItems(list, selectedItems) {
        if (list && list.length && selectedItems && selectedItems.length) {
            const relevantItems = selectedItems.map(item => ({ selectedItem: item, index: list.indexOf(item) }))
                .filter(item => item.index !== -1)
                .sort((a, b) => a.index - b.index);
            if (relevantItems.length) {
                const minIndexInSelected = relevantItems[0].index;
                const nextIndex = Math.max(0, minIndexInSelected - 1);
                relevantItems.forEach((item, i) => {
                    list.splice(item.index - i, 1);
                });
                list.splice(nextIndex, 0, ...relevantItems.map(item => item.selectedItem));
                return true;
            }
        }
        return false;
    }
    static moveDownItems(list, selectedItems) {
        if (selectedItems && selectedItems.length && list && list.length) {
            const relevantItems = selectedItems.map(item => ({ selectedItem: item, index: list.indexOf(item) }))
                .filter(item => item.index !== -1)
                .sort((a, b) => a.index - b.index);
            if (relevantItems.length) {
                const maxIndexInSelected = relevantItems[relevantItems.length - 1].index;
                const nextIndex = Math.min(list.length - 1, maxIndexInSelected + 1);
                relevantItems.forEach((item, i) => {
                    list.splice(item.index - i, 1);
                });
                const correctedIndex = nextIndex - relevantItems.length;
                list.splice(correctedIndex + 1, 0, ...relevantItems.map(item => item.selectedItem));
                return true;
            }
        }
        return false;
    }
    static formatTime(value, addTimeChars = false) {
        let hours = Math.floor(Math.round(value) / 3600) % 24;
        let minutes = Math.floor((Math.round(value) / 60) % 60);
        let seconds = Math.round(value) % 60;
        let hoursStr = hours === 0 ? '' : addTimeChars ? hours.toString() + "h:" : hours.toString() + ":";
        let minutesStr = minutes === 0 && hours === 0 ? '00' : minutes < 10 ? '0' + minutes.toString() : minutes.toString();
        let secondsStr = seconds < 10 ? '0' + seconds.toString() : seconds.toString();
        if (addTimeChars) {
            minutesStr = minutesStr + "m";
            secondsStr = secondsStr + "s";
        }
        return hoursStr + minutesStr + ":" + secondsStr;
    }
    static fromServerDate(value) {
        return (value ? new Date(value * 1000) : null);
    }
    static toServerDate(value) {
        return value ? Math.round(value.getTime() / 1000) : null;
    }
    static download(data, strFileName, strMimeType) {
        return Download(data, strFileName, strMimeType);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2FsdHVyYS11dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3V0aWxzL2thbHR1cmEtdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUV0QyxNQUFNLFdBQVcsR0FBRztJQUNoQixHQUFHLEVBQUUsTUFBTTtJQUNYLEdBQUcsRUFBRSxNQUFNO0lBQ1gsR0FBRyxFQUFFLE9BQU87Q0FDZixDQUFDO0FBRUYsTUFBTSxPQUFPLFlBQVk7SUFFckIsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFVO1FBQ3ZCLElBQUksV0FBVyxHQUFHLEtBQUssQ0FBQztRQUN4QixRQUFPLE9BQU8sS0FBSyxFQUNuQjtZQUNJLEtBQUssUUFBUSxDQUFDO1lBQ2QsS0FBSyxRQUFRLENBQUM7WUFDZCxLQUFLLFNBQVM7Z0JBQ1YsV0FBVyxHQUFHLEtBQUssQ0FBQztnQkFDcEIsTUFBTTtZQUNWO2dCQUNBLFdBQVcsR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO2dCQUN0QixNQUFNO1NBQ2I7UUFFRCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVKLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxLQUFZO1FBRTlCLElBQUksS0FBSyxFQUFFO1lBQ1AsTUFBTSxRQUFRLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDM0MsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQixRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7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QUFHLENBQUM7U0FDakM7UUFDRCxPQUFPLFFBQVEsR0FBRyxVQUFVLEdBQUcsR0FBRyxHQUFHLFVBQVUsQ0FBQztJQUNwRCxDQUFDO0lBRUQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxLQUFjO1FBRWhDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBWTtRQUU1QixPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUM3RCxDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFTLEVBQUUsV0FBbUIsRUFBRSxXQUFtQjtRQUUvRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3BELENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERvd25sb2FkIH0gZnJvbSAnLi9kb3dubG9hZCc7XG5cbmNvbnN0IF94bWxDaGFyTWFwID0ge1xuICAgICc8JzogJyZsdDsnLFxuICAgICc+JzogJyZndDsnLFxuICAgICcmJzogJyZhbXA7J1xufTtcblxuZXhwb3J0IGNsYXNzIEthbHR1cmFVdGlsc1xue1xuICAgIHN0YXRpYyBlc2NhcGVYbWwodmFsdWU6IGFueSkgOiBzdHJpbmcge1xuICAgICAgICBsZXQgcGFyc2VkVmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgc3dpdGNoKHR5cGVvZiB2YWx1ZSlcbiAgICAgICAge1xuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgICAgICBjYXNlICdib29sZWFuJzpcbiAgICAgICAgICAgICAgICBwYXJzZWRWYWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHBhcnNlZFZhbHVlID0gdmFsdWUgfHwgJyc7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gU3RyaW5nKHBhcnNlZFZhbHVlKS5yZXBsYWNlKC9bJjw+XS9nLCBjaGFyID0+IF94bWxDaGFyTWFwW2NoYXJdKTtcbiAgICB9XG5cblx0c3RhdGljIGdldFN0YXJ0RGF0ZVZhbHVlKHZhbHVlIDogRGF0ZSkgOiBEYXRlXG4gICAge1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gbmV3IERhdGUodmFsdWUuZ2V0VGltZSgpKTtcbiAgICAgICAgICAgIG5ld1ZhbHVlLnNldEhvdXJzKDApO1xuICAgICAgICAgICAgbmV3VmFsdWUuc2V0TWludXRlcygwKTtcbiAgICAgICAgICAgIG5ld1ZhbHVlLnNldFNlY29uZHMoMCk7XG4gICAgICAgICAgICByZXR1cm4gbmV3VmFsdWU7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0RW5kRGF0ZVZhbHVlKHZhbHVlIDogRGF0ZSkgOiBEYXRlXG4gICAge1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gbmV3IERhdGUodmFsdWUuZ2V0VGltZSgpKTtcbiAgICAgICAgICAgIG5ld1ZhbHVlLnNldEhvdXJzKDIzKTtcbiAgICAgICAgICAgIG5ld1ZhbHVlLnNldE1pbnV0ZXMoNTkpO1xuICAgICAgICAgICAgbmV3VmFsdWUuc2V0U2Vjb25kcyg1OSk7XG4gICAgICAgICAgICByZXR1cm4gbmV3VmFsdWU7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9c3RhdGljIHJlbW92ZUVtcHR5UHJvcGVydGllcyh2YWx1ZSA6IHt9KVxuXHR7XG5cdFx0T2JqZWN0LmtleXModmFsdWUpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7XG5cdFx0XHRpZiAodmFsdWVba2V5XSAmJiB0eXBlb2YgdmFsdWVba2V5XSA9PT0gJ29iamVjdCcpIHtcblx0XHRcdFx0S2FsdHVyYVV0aWxzLnJlbW92ZUVtcHR5UHJvcGVydGllcyh2YWx1ZVtrZXldKTtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKHZhbHVlW2tleV0gPT09IG51bGwpIHtcblx0XHRcdFx0ZGVsZXRlIHZhbHVlW2tleV1cblx0XHRcdH1cblx0XHR9KTtcblx0XHRyZXR1cm4gdmFsdWU7XG5cdH1cblxuICAgIHN0YXRpYyBtb3ZlVXBJdGVtczxUPihsaXN0OiBUW10sIHNlbGVjdGVkSXRlbXMgOiBUW10pOiBib29sZWFuIHtcbiAgICAgICAgaWYgKGxpc3QgJiYgbGlzdC5sZW5ndGggJiYgc2VsZWN0ZWRJdGVtcyAmJiBzZWxlY3RlZEl0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc3QgcmVsZXZhbnRJdGVtcyA9IHNlbGVjdGVkSXRlbXMubWFwKGl0ZW0gPT4gKHsgc2VsZWN0ZWRJdGVtOiBpdGVtLCBpbmRleDogbGlzdC5pbmRleE9mKGl0ZW0pIH0pKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLmluZGV4ICE9PSAtMSlcbiAgICAgICAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYS5pbmRleCAtIGIuaW5kZXgpO1xuICAgICAgICAgICAgaWYgKHJlbGV2YW50SXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWluSW5kZXhJblNlbGVjdGVkID0gcmVsZXZhbnRJdGVtc1swXS5pbmRleDtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXh0SW5kZXggPSBNYXRoLm1heCgwLCBtaW5JbmRleEluU2VsZWN0ZWQgLSAxKTtcbiAgICAgICAgICAgICAgICByZWxldmFudEl0ZW1zLmZvckVhY2goKGl0ZW0sIGkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoaXRlbS5pbmRleCAtIGksIDEpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgbGlzdC5zcGxpY2UobmV4dEluZGV4LCAwLCAuLi5yZWxldmFudEl0ZW1zLm1hcChpdGVtID0+IGl0ZW0uc2VsZWN0ZWRJdGVtKSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgbW92ZURvd25JdGVtczxUPihsaXN0OiBUW10sIHNlbGVjdGVkSXRlbXMgOiBUW10pOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHNlbGVjdGVkSXRlbXMgJiYgc2VsZWN0ZWRJdGVtcy5sZW5ndGggJiYgbGlzdCAmJiBsaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc3QgcmVsZXZhbnRJdGVtcyA9IHNlbGVjdGVkSXRlbXMubWFwKGl0ZW0gPT4gKHsgc2VsZWN0ZWRJdGVtOiBpdGVtLCBpbmRleDogbGlzdC5pbmRleE9mKGl0ZW0pIH0pKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLmluZGV4ICE9PSAtMSlcbiAgICAgICAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYS5pbmRleCAtIGIuaW5kZXgpO1xuICAgICAgICAgICAgaWYgKHJlbGV2YW50SXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWF4SW5kZXhJblNlbGVjdGVkID0gcmVsZXZhbnRJdGVtc1tyZWxldmFudEl0ZW1zLmxlbmd0aCAtIDFdLmluZGV4O1xuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRJbmRleCA9IE1hdGgubWluKGxpc3QubGVuZ3RoIC0gMSwgbWF4SW5kZXhJblNlbGVjdGVkICsgMSk7XG4gICAgICAgICAgICAgICAgcmVsZXZhbnRJdGVtcy5mb3JFYWNoKChpdGVtLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3Quc3BsaWNlKGl0ZW0uaW5kZXggLSBpLCAxKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBjb3JyZWN0ZWRJbmRleCA9IG5leHRJbmRleCAtIHJlbGV2YW50SXRlbXMubGVuZ3RoO1xuXG4gICAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoY29ycmVjdGVkSW5kZXggKyAxLCAwLCAuLi5yZWxldmFudEl0ZW1zLm1hcChpdGVtID0+IGl0ZW0uc2VsZWN0ZWRJdGVtKSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZm9ybWF0VGltZSh2YWx1ZTogbnVtYmVyLCBhZGRUaW1lQ2hhcnM6IGJvb2xlYW4gPSBmYWxzZSk6IHN0cmluZyB7XG5cbiAgICAgICAgbGV0IGhvdXJzOiBudW1iZXIgPSBNYXRoLmZsb29yKCBNYXRoLnJvdW5kKCB2YWx1ZSApIC8gMzYwMCApICUgMjQ7XG4gICAgICAgIGxldCBtaW51dGVzOiBudW1iZXIgPSBNYXRoLmZsb29yKCAoIE1hdGgucm91bmQoIHZhbHVlICkgLyA2MCApICUgNjAgKTtcbiAgICAgICAgbGV0IHNlY29uZHM6IG51bWJlciA9IE1hdGgucm91bmQodmFsdWUpICUgNjA7XG5cbiAgICAgICAgbGV0IGhvdXJzU3RyOiBzdHJpbmcgPSBob3VycyA9PT0gMCA/ICcnIDogYWRkVGltZUNoYXJzID8gaG91cnMudG9TdHJpbmcoKSArIFwiaDpcIiA6IGhvdXJzLnRvU3RyaW5nKCkgKyBcIjpcIjtcbiAgICAgICAgbGV0IG1pbnV0ZXNTdHI6IHN0cmluZyA9IG1pbnV0ZXMgPT09IDAgJiYgaG91cnMgPT09IDAgPyAnMDAnIDogbWludXRlcyA8IDEwICA/ICcwJyArIG1pbnV0ZXMudG9TdHJpbmcoKSA6IG1pbnV0ZXMudG9TdHJpbmcoKTtcbiAgICAgICAgbGV0IHNlY29uZHNTdHI6IHN0cmluZyA9IHNlY29uZHMgPCAxMCAgPyAnMCcgKyBzZWNvbmRzLnRvU3RyaW5nKCkgOiBzZWNvbmRzLnRvU3RyaW5nKCk7XG4gICAgICAgIGlmIChhZGRUaW1lQ2hhcnMpe1xuICAgICAgICAgICAgbWludXRlc1N0ciA9IG1pbnV0ZXNTdHIgKyBcIm1cIjtcbiAgICAgICAgICAgIHNlY29uZHNTdHIgPSBzZWNvbmRzU3RyICsgXCJzXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhvdXJzU3RyICsgbWludXRlc1N0ciArIFwiOlwiICsgc2Vjb25kc1N0cjtcbiAgICB9XG5cbiAgICBzdGF0aWMgZnJvbVNlcnZlckRhdGUodmFsdWUgOiBudW1iZXIpIDogRGF0ZVxuICAgIHtcbiAgICAgICAgcmV0dXJuICh2YWx1ZSA/IG5ldyBEYXRlKHZhbHVlICogMTAwMCkgOiBudWxsKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgdG9TZXJ2ZXJEYXRlKHZhbHVlIDogRGF0ZSkgOiBudW1iZXJcbiAgICB7XG4gICAgICAgIHJldHVybiB2YWx1ZSA/IE1hdGgucm91bmQodmFsdWUuZ2V0VGltZSgpIC8gMTAwMCkgOiBudWxsO1xuICAgIH1cblxuICAgIHN0YXRpYyBkb3dubG9hZChkYXRhOiBhbnksIHN0ckZpbGVOYW1lOiBzdHJpbmcsIHN0ck1pbWVUeXBlOiBzdHJpbmcpIDogQm9vbGVhblxuICAgIHtcbiAgICAgICAgcmV0dXJuIERvd25sb2FkKGRhdGEsIHN0ckZpbGVOYW1lLCBzdHJNaW1lVHlwZSk7XG4gICAgfVxufVxuIl19