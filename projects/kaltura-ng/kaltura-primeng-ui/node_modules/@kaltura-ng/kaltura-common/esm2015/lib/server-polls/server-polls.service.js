import { Observable } from 'rxjs';
import { FriendlyHashId } from '../friendly-hash-id';
import { BehaviorSubject } from 'rxjs/BehaviorSubject';
import { EmptyLogger } from '../kaltura-logger';
export class ServerPolls {
    constructor(kalturaLogger) {
        this._pollQueue = {};
        this._tokenGenerator = new FriendlyHashId();
        this._missingDestoryHandling = false;
        this._subscriptions = [];
        this._state = new BehaviorSubject({ busy: false });
        this.state$ = this._state.asObservable();
        this._queueInterval = null;
        if (kalturaLogger) {
            this._logger = kalturaLogger;
        }
        else {
            this._logger = new EmptyLogger();
        }
        this._initialize();
    }
    _warnAboutMissingDestory() {
        // NOTICE: showing a warning every time since this is an implementation issue that must be addressed during development.
        const error = `calling method '_getOnDestroy$()' didn't return valid observable (did you remember to provide 'Observable' that will be invoked from ngOnDestroy method?)`;
        this._logger.error(error);
    }
    _initialize() {
        this._logger.trace('_initialize()');
        setTimeout(() => {
            const onDestroy$ = this._getOnDestroy$();
            if (!onDestroy$) {
                this._missingDestoryHandling = true;
                this._warnAboutMissingDestory();
            }
            else {
                onDestroy$.subscribe(() => {
                    this._logger.trace('onDestroy$.subscribe()');
                    this._cancelQueueInterval();
                    this._subscriptions.forEach(item => {
                        item.unsubscribe();
                    });
                    this._subscriptions = [];
                });
            }
        });
    }
    _cancelQueueInterval() {
        clearTimeout(this._queueTimeout);
    }
    _getPollQueueList() {
        return Object.keys(this._pollQueue).map(key => this._pollQueue[key]);
    }
    _setupQueueTimer() {
        this._cancelQueueInterval();
        const pollQueueList = this._getPollQueueList();
        if (this._missingDestoryHandling) {
            // NOTICE: showing a warning every time since this is an implementation issue that must be addressed during development.
            this._warnAboutMissingDestory();
        }
        if (!pollQueueList.length) {
            this._logger.info('no actions found in the queue. suspending interval until an action will be added');
            return;
        }
        let newInterval = null;
        const hasNewPolls = pollQueueList.some(({ lastExecution }) => !!lastExecution);
        if (!hasNewPolls) {
            newInterval = Math.min(...pollQueueList.map(({ interval }) => interval)) / 2;
        }
        newInterval = newInterval && newInterval > 10 ? newInterval : 10; // default to ten seconds (minimum value)
        if (this._queueInterval !== newInterval) {
            this._logger.info(`updating queue interval to poll server every ${newInterval} seconds`);
            this._queueInterval = newInterval;
        }
        this._queueTimeout = setTimeout(() => {
            this._onQueueTimerTick();
        }, this._queueInterval * 1000);
    }
    forcePolling() {
        this._logger.info('force server polling requested');
        // cancel active requests
        this._cancelQueueInterval();
        this._subscriptions.forEach(subscription => {
            subscription.unsubscribe();
        });
        this._subscriptions = [];
        // enable all requests
        this._getPollQueueList().forEach(item => item.queryEnabled = true);
        // send poll request for all requests
        const subscription = this._queryPollItems(this._getPollQueueList())
            .subscribe(() => this._setupQueueTimer(), () => this._setupQueueTimer());
    }
    _queryPollItems(items) {
        return Observable.create(observer => {
            this._logger.debug(`execute server polling`);
            if (!this._canExecute() || !items || items.length === 0) {
                this._logger.debug(`execute server polling ignored, cannot execute request or no items provided to query`);
                observer.next(undefined);
                return;
            }
            const requests = items.map(item => {
                let ItemRequest;
                let error;
                try {
                    ItemRequest = item.requestFactory.create();
                }
                catch (err) {
                    this._logger.error(`failed to create a request for '${item.id}'. got the following error : '${err.message}'`);
                    ItemRequest = null;
                    error = this._createGlobalError(err);
                }
                if (error) {
                    this._propagateServerResponse(item, { error: error, result: null });
                }
                return ItemRequest ? { pollItem: item, request: ItemRequest } : null;
            }).filter(Boolean);
            this._logger.info(`executing server poll for ${requests.length} items`);
            if (!requests.length) {
                observer.next(undefined);
            }
            else {
                const subscription = this._executeRequests(requests.map(item => item.request))
                    .subscribe(response => {
                    this._removeSubscription(subscription);
                    this._logger.info(`got ${response.length} responses. propagate responses to relevant actions`);
                    requests.forEach(({ pollItem }, index) => {
                        let result = response[index];
                        if (Array.isArray(result)) {
                            result = { result, error: null };
                        }
                        this._propagateServerResponse(pollItem, result);
                    });
                    observer.next(undefined);
                }, (error) => {
                    this._logger.error(`failed to query the server. got the following error : '${error.message}'`);
                    this._removeSubscription(subscription);
                    const errorResponse = { error: this._createGlobalError(error), result: null };
                    requests.forEach(({ pollItem }) => {
                        this._propagateServerResponse(pollItem, errorResponse);
                    });
                    observer.next(undefined);
                });
                this._subscriptions.push(subscription);
                return () => {
                    this._removeSubscription(subscription);
                };
            }
        });
    }
    _removeSubscription(subscription) {
        if (subscription) {
            const subscriptionIndex = this._subscriptions.indexOf(subscription);
            if (subscriptionIndex > -1) {
                this._subscriptions.splice(subscriptionIndex, 1);
            }
        }
    }
    _onQueueTimerTick() {
        if (!this._canExecute()) {
            this._setupQueueTimer();
            this._logger.trace('_onQueueTimerTick(): canExecute() check failed. ignore current execution');
            return;
        }
        this._logger.debug('prepare server poll request');
        const now = Number(new Date());
        const itemsToBeExecuted = this._getPollQueueList()
            .filter(item => item.queryEnabled && (!item.lastExecution || (Number(item.lastExecution) + (item.interval * 1000) <= now)));
        if (!itemsToBeExecuted.length) {
            this._logger.debug('nothing to run. Waiting next tick...');
            this._setupQueueTimer();
            return;
        }
        this._logger.info(`set busy mode to true`);
        this._state.next({ busy: true });
        this._queryPollItems(itemsToBeExecuted)
            .subscribe(() => {
            this._state.next({ busy: false });
            this._setupQueueTimer();
        }, (error) => {
            this._state.next({ busy: false });
        });
    }
    _propagateServerResponse(item, response) {
        try {
            if (this._pollQueue[item.id]) {
                this._logger.debug(`propagating response for ${item.id}`);
                item.lastExecution = new Date();
                item.observer.next(response);
            }
            else {
                this._logger.info(`cannot find registered action for '${item.id} (it might indicate that this action was unsubscribed while a request to the server was executed)`);
            }
        }
        catch (err) {
            this._logger.warn(`error happened while propagating response of '${item.id}'.ignoring error. got the following error: ${err.message}`);
        }
    }
    isBusy() {
        return this._state.getValue().busy;
    }
    register(intervalInSeconds, requestFactory) {
        return Observable.create(observer => {
            const newPollId = this._tokenGenerator.generateUnique(Object.keys(this._pollQueue));
            this._logger.info(`register new poll request ${newPollId} (interval = ${intervalInSeconds} seconds)`);
            const newPollItem = this._pollQueue[newPollId] = {
                id: newPollId,
                interval: intervalInSeconds,
                lastExecution: null,
                queryEnabled: false,
                requestFactory: requestFactory,
                observer: observer
            };
            this._logger.info(`execute the added request '${newPollId}'`);
            let initialRequest = this._queryPollItems([newPollItem])
                .subscribe(() => {
                initialRequest = null;
                newPollItem.queryEnabled = true;
                this._setupQueueTimer();
            }, () => {
                initialRequest = null;
                newPollItem.queryEnabled = true;
                this._setupQueueTimer();
            });
            return () => {
                this._logger.info(`stop polling for ${newPollId}`);
                if (initialRequest) {
                    initialRequest.unsubscribe();
                }
                delete this._pollQueue[newPollId];
            };
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLXBvbGxzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Aa2FsdHVyYS1uZy9rYWx0dXJhLWNvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2ZXItcG9sbHMvc2VydmVyLXBvbGxzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVsQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxXQUFXLEVBQWlCLE1BQU0sbUJBQW1CLENBQUM7QUFrQi9ELE1BQU0sT0FBZ0IsV0FBVztJQW1CL0IsWUFBWSxhQUE0QjtRQWxCaEMsZUFBVSxHQUF3QyxFQUFFLENBQUM7UUFDckQsb0JBQWUsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBRXZDLDRCQUF1QixHQUFHLEtBQUssQ0FBQztRQUNoQyxtQkFBYyxHQUFvQixFQUFFLENBQUM7UUFDckMsV0FBTSxHQUFHLElBQUksZUFBZSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFL0MsV0FBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDbkMsbUJBQWMsR0FBVyxJQUFJLENBQUM7UUFZckMsSUFBSSxhQUFhLEVBQUU7WUFDbEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUM7U0FDN0I7YUFBTTtZQUNOLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztTQUNqQztRQUNELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNwQixDQUFDO0lBRU8sd0JBQXdCO1FBQzVCLHdIQUF3SDtRQUN4SCxNQUFNLEtBQUssR0FBRywySkFBMkosQ0FBQztRQUMxSyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRU8sV0FBVztRQUNmLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3BDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDWixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFFekMsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDYixJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO2dCQUNwQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQzthQUNuQztpQkFBTTtnQkFDSCxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtvQkFDdEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztvQkFDN0MsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7b0JBQzVCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO3dCQUMvQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7b0JBQ3ZCLENBQUMsQ0FBQyxDQUFDO29CQUNILElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO2dCQUM3QixDQUFDLENBQUMsQ0FBQzthQUNOO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sb0JBQW9CO1FBQzFCLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRU8sZ0JBQWdCO1FBQ3BCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRTVCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRS9DLElBQUksSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQzlCLHdIQUF3SDtZQUN4SCxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztTQUNuQztRQUdELElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGtGQUFrRixDQUFDLENBQUM7WUFDdEcsT0FBTztTQUNWO1FBRUQsSUFBSSxXQUFXLEdBQVcsSUFBSSxDQUFDO1FBQy9CLE1BQU0sV0FBVyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFDLGFBQWEsRUFBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNkLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUMsUUFBUSxFQUFDLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzlFO1FBQ0QsV0FBVyxHQUFHLFdBQVcsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLHlDQUF5QztRQUMzRyxJQUFJLElBQUksQ0FBQyxjQUFjLEtBQUssV0FBVyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFFLGdEQUFnRCxXQUFXLFVBQVUsQ0FBQyxDQUFDO1lBQzFGLElBQUksQ0FBQyxjQUFjLEdBQUcsV0FBVyxDQUFDO1NBQ3JDO1FBRUQsSUFBSSxDQUFDLGFBQWEsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzdCLENBQUMsRUFBRSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFTSxZQUFZO1FBQ2YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUNwRCx5QkFBeUI7UUFDekIsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDdkMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQy9CLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFFekIsc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFbkUscUNBQXFDO1FBQ3JDLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7YUFDOUQsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7SUFDakYsQ0FBQztJQUVTLGVBQWUsQ0FBQyxLQUF5QjtRQUM3QyxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUU3QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNyRCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxzRkFBc0YsQ0FBQyxDQUFDO2dCQUMzRyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN6QixPQUFPO2FBQ1Y7WUFFRCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM5QixJQUFJLFdBQXFCLENBQUM7Z0JBQzFCLElBQUksS0FBYSxDQUFDO2dCQUNsQixJQUFJO29CQUNBLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxDQUFDO2lCQUM5QztnQkFBQyxPQUFPLEdBQUcsRUFBRTtvQkFDVixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsSUFBSSxDQUFDLEVBQUUsaUNBQWlDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO29CQUU5RyxXQUFXLEdBQUcsSUFBSSxDQUFDO29CQUNuQixLQUFLLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUN4QztnQkFFRCxJQUFJLEtBQUssRUFBRTtvQkFDUCxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxFQUFFLEVBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztpQkFDckU7Z0JBQ0QsT0FBTyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUN2RSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsNkJBQTZCLFFBQVEsQ0FBQyxNQUFNLFFBQVEsQ0FBQyxDQUFDO1lBRXhFLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUNwQjtnQkFDSSxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzVCO2lCQUFLO2dCQUNGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO3FCQUN6RSxTQUFTLENBQ04sUUFBUSxDQUFDLEVBQUU7b0JBQ1AsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUV2QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLFFBQVEsQ0FBQyxNQUFNLHFEQUFxRCxDQUFDLENBQUM7b0JBQy9GLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFDLFFBQVEsRUFBQyxFQUFFLEtBQUssRUFBRSxFQUFFO3dCQUNuQyxJQUFJLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQzdCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTs0QkFDdkIsTUFBTSxHQUFHLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQTt5QkFDbkM7d0JBQ0QsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztvQkFDcEQsQ0FBQyxDQUFDLENBQUM7b0JBRUgsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDN0IsQ0FBQyxFQUNELENBQUMsS0FBSyxFQUFFLEVBQUU7b0JBRU4sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsMERBQTBELEtBQUssQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO29CQUMvRixJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBRXZDLE1BQU0sYUFBYSxHQUFHLEVBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUM7b0JBQzVFLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFDLFFBQVEsRUFBQyxFQUFFLEVBQUU7d0JBQzVCLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDLENBQUM7b0JBQzNELENBQUMsQ0FBQyxDQUFDO29CQUVILFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzdCLENBQUMsQ0FDSixDQUFDO2dCQUNOLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUV2QyxPQUFPLEdBQUcsRUFBRTtvQkFDUixJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQzNDLENBQUMsQ0FBQzthQUNMO1FBR0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsWUFBMkI7UUFDbkQsSUFBSSxZQUFZLEVBQUU7WUFDZCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXBFLElBQUksaUJBQWlCLEdBQUcsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3hCLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUN0QixpQkFBaUIsRUFDakIsQ0FBQyxDQUNKLENBQUE7YUFDSjtTQUNKO0lBQ0wsQ0FBQztJQUVPLGlCQUFpQjtRQUVyQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLDBFQUEwRSxDQUFDLENBQUM7WUFDL0YsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUVsRCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFO2FBQzdDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFHaEksSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRTtZQUMzQixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO1lBQzNELElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLE9BQU87U0FDVjtRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDO2FBQ2xDLFNBQVMsQ0FDTixHQUFHLEVBQUU7WUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzVCLENBQUMsRUFDRCxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ04sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQ0osQ0FBQztJQUNWLENBQUM7SUFFSyx3QkFBd0IsQ0FBQyxJQUFzQixFQUFFLFFBQXdDO1FBQzdGLElBQUk7WUFDQSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQzFELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDaEM7aUJBQ0Q7Z0JBQ0ksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsc0NBQXNDLElBQUksQ0FBQyxFQUFFLG1HQUFtRyxDQUFDLENBQUM7YUFDdks7U0FDSjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUUsaURBQWlELElBQUksQ0FBQyxFQUFFLDhDQUE4QyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUMzSTtJQUNMLENBQUM7SUFFTSxNQUFNO1FBQ1QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQztJQUN2QyxDQUFDO0lBRU0sUUFBUSxDQUFZLGlCQUErQixFQUFFLGNBQW1EO1FBQzdHLE9BQU8sVUFBVSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNsQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ2xGLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFFLDZCQUE2QixTQUFTLGdCQUFnQixpQkFBaUIsV0FBVyxDQUFDLENBQUM7WUFDekcsTUFBTSxXQUFXLEdBQXFCLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUc7Z0JBQ2pFLEVBQUUsRUFBRSxTQUFTO2dCQUNiLFFBQVEsRUFBRSxpQkFBaUI7Z0JBQzNCLGFBQWEsRUFBRSxJQUFJO2dCQUNqQixZQUFZLEVBQUUsS0FBSztnQkFDckIsY0FBYyxFQUFFLGNBQWM7Z0JBQzlCLFFBQVEsRUFBRSxRQUFRO2FBQ25CLENBQUM7WUFFRixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBRSw4QkFBOEIsU0FBUyxHQUFHLENBQUMsQ0FBQztZQUMvRCxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7aUJBQ25ELFNBQVMsQ0FDTixHQUFHLEVBQUU7Z0JBRUQsY0FBYyxHQUFHLElBQUksQ0FBQztnQkFDdEIsV0FBVyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Z0JBQ2hDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzVCLENBQUMsRUFDRCxHQUFHLEVBQUU7Z0JBRUQsY0FBYyxHQUFHLElBQUksQ0FBQztnQkFDdEIsV0FBVyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Z0JBQ2hDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzVCLENBQUMsQ0FDSixDQUFDO1lBRU4sT0FBTyxHQUFHLEVBQUU7Z0JBQ1IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLFNBQVMsRUFBRSxDQUFDLENBQUM7Z0JBQ25ELElBQUksY0FBYyxFQUFFO29CQUNoQixjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7aUJBQ2hDO2dCQUNELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN0QyxDQUFDLENBQUE7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFN1YnNjcmliZXIgfSBmcm9tICdyeGpzL1N1YnNjcmliZXInO1xuaW1wb3J0IHsgRnJpZW5kbHlIYXNoSWQgfSBmcm9tICcuLi9mcmllbmRseS1oYXNoLWlkJztcbmltcG9ydCB7IElTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzL1N1YnNjcmlwdGlvbic7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzL0JlaGF2aW9yU3ViamVjdCc7XG5pbXBvcnQgeyBFbXB0eUxvZ2dlciwgS2FsdHVyYUxvZ2dlciB9IGZyb20gJy4uL2thbHR1cmEtbG9nZ2VyJztcbmltcG9ydCB7IE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmV4cG9ydCB0eXBlIFBvbGxJbnRlcnZhbCA9IDEwIHwgMzAgfCA2MCB8IDMwMDtcblxuZXhwb3J0IGludGVyZmFjZSBSZXF1ZXN0RmFjdG9yeTxUUmVxdWVzdCwgVFJlc3BvbnNlPiB7XG4gIGNyZWF0ZSgpOiBUUmVxdWVzdDtcbn1cblxuaW50ZXJmYWNlIFBvbGxJdGVtPFRFcnJvcj4ge1xuICBpZDogc3RyaW5nO1xuICBpbnRlcnZhbDogUG9sbEludGVydmFsO1xuICBsYXN0RXhlY3V0aW9uOiBEYXRlLFxuICBxdWVyeUVuYWJsZWQ6IGJvb2xlYW4sXG4gIHJlcXVlc3RGYWN0b3J5OiBSZXF1ZXN0RmFjdG9yeTxhbnksIGFueT4sXG4gIG9ic2VydmVyOiBTdWJzY3JpYmVyPHtyZXN1bHQ6IGFueSwgZXJyb3I6IFRFcnJvcn0+XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTZXJ2ZXJQb2xsczxUUmVxdWVzdCwgVEVycm9yPiB7XG4gIHByaXZhdGUgX3BvbGxRdWV1ZTogeyBba2V5OiBzdHJpbmddOiBQb2xsSXRlbTxURXJyb3I+IH0gPSB7fTtcbiAgcHJpdmF0ZSBfdG9rZW5HZW5lcmF0b3IgPSBuZXcgRnJpZW5kbHlIYXNoSWQoKTtcbiAgcHJpdmF0ZSBfcXVldWVUaW1lb3V0OiBudW1iZXI7XG4gIHByaXZhdGUgX21pc3NpbmdEZXN0b3J5SGFuZGxpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfc3Vic2NyaXB0aW9uczogSVN1YnNjcmlwdGlvbltdID0gW107XG4gIHByaXZhdGUgX3N0YXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdCh7IGJ1c3k6IGZhbHNlIH0pO1xuICAgIHByaXZhdGUgX2xvZ2dlcjogS2FsdHVyYUxvZ2dlcjtcbiAgcHVibGljIHN0YXRlJCA9IHRoaXMuX3N0YXRlLmFzT2JzZXJ2YWJsZSgpO1xuICBwcml2YXRlIF9xdWV1ZUludGVydmFsOiBudW1iZXIgPSBudWxsO1xuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBfZXhlY3V0ZVJlcXVlc3RzKHJlcXVlc3RzOiBUUmVxdWVzdFtdKTogT2JzZXJ2YWJsZTx7IGVycm9yOiBURXJyb3IsIHJlc3VsdDogYW55IH1bXT47XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IF9jcmVhdGVHbG9iYWxFcnJvcihlcnJvcj86IEVycm9yKTogVEVycm9yO1xuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBfZ2V0T25EZXN0cm95JCgpOiBPYnNlcnZhYmxlPHZvaWQ+O1xuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBfY2FuRXhlY3V0ZSgpOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKGthbHR1cmFMb2dnZXI6IEthbHR1cmFMb2dnZXIpIHtcblxuXHQgIGlmIChrYWx0dXJhTG9nZ2VyKSB7XG5cdFx0ICB0aGlzLl9sb2dnZXIgPSBrYWx0dXJhTG9nZ2VyO1xuXHQgIH0gZWxzZSB7XG5cdFx0ICB0aGlzLl9sb2dnZXIgPSBuZXcgRW1wdHlMb2dnZXIoKTtcblx0ICB9XG5cdCAgdGhpcy5faW5pdGlhbGl6ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfd2FybkFib3V0TWlzc2luZ0Rlc3RvcnkoKTogdm9pZCB7XG4gICAgICAvLyBOT1RJQ0U6IHNob3dpbmcgYSB3YXJuaW5nIGV2ZXJ5IHRpbWUgc2luY2UgdGhpcyBpcyBhbiBpbXBsZW1lbnRhdGlvbiBpc3N1ZSB0aGF0IG11c3QgYmUgYWRkcmVzc2VkIGR1cmluZyBkZXZlbG9wbWVudC5cbiAgICAgIGNvbnN0IGVycm9yID0gYGNhbGxpbmcgbWV0aG9kICdfZ2V0T25EZXN0cm95JCgpJyBkaWRuJ3QgcmV0dXJuIHZhbGlkIG9ic2VydmFibGUgKGRpZCB5b3UgcmVtZW1iZXIgdG8gcHJvdmlkZSAnT2JzZXJ2YWJsZScgdGhhdCB3aWxsIGJlIGludm9rZWQgZnJvbSBuZ09uRGVzdHJveSBtZXRob2Q/KWA7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoZXJyb3IpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaW5pdGlhbGl6ZSgpOiB2b2lkIHtcbiAgICAgIHRoaXMuX2xvZ2dlci50cmFjZSgnX2luaXRpYWxpemUoKScpO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgY29uc3Qgb25EZXN0cm95JCA9IHRoaXMuX2dldE9uRGVzdHJveSQoKTtcblxuICAgICAgICAgIGlmICghb25EZXN0cm95JCkge1xuICAgICAgICAgICAgICB0aGlzLl9taXNzaW5nRGVzdG9yeUhhbmRsaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5fd2FybkFib3V0TWlzc2luZ0Rlc3RvcnkoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBvbkRlc3Ryb3kkLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIudHJhY2UoJ29uRGVzdHJveSQuc3Vic2NyaWJlKCknKTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuX2NhbmNlbFF1ZXVlSW50ZXJ2YWwoKTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBpdGVtLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBbXTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9jYW5jZWxRdWV1ZUludGVydmFsKCk6IHZvaWQge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLl9xdWV1ZVRpbWVvdXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0UG9sbFF1ZXVlTGlzdCgpOiBQb2xsSXRlbTxURXJyb3I+W10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLl9wb2xsUXVldWUpLm1hcChrZXkgPT4gdGhpcy5fcG9sbFF1ZXVlW2tleV0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0dXBRdWV1ZVRpbWVyKCk6IHZvaWQge1xuICAgICAgdGhpcy5fY2FuY2VsUXVldWVJbnRlcnZhbCgpO1xuXG4gICAgICBjb25zdCBwb2xsUXVldWVMaXN0ID0gdGhpcy5fZ2V0UG9sbFF1ZXVlTGlzdCgpO1xuXG4gICAgICBpZiAodGhpcy5fbWlzc2luZ0Rlc3RvcnlIYW5kbGluZykge1xuICAgICAgICAgIC8vIE5PVElDRTogc2hvd2luZyBhIHdhcm5pbmcgZXZlcnkgdGltZSBzaW5jZSB0aGlzIGlzIGFuIGltcGxlbWVudGF0aW9uIGlzc3VlIHRoYXQgbXVzdCBiZSBhZGRyZXNzZWQgZHVyaW5nIGRldmVsb3BtZW50LlxuICAgICAgICAgIHRoaXMuX3dhcm5BYm91dE1pc3NpbmdEZXN0b3J5KCk7XG4gICAgICB9XG5cblxuICAgICAgaWYgKCFwb2xsUXVldWVMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKCdubyBhY3Rpb25zIGZvdW5kIGluIHRoZSBxdWV1ZS4gc3VzcGVuZGluZyBpbnRlcnZhbCB1bnRpbCBhbiBhY3Rpb24gd2lsbCBiZSBhZGRlZCcpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbGV0IG5ld0ludGVydmFsOiBudW1iZXIgPSBudWxsO1xuICAgICAgY29uc3QgaGFzTmV3UG9sbHMgPSBwb2xsUXVldWVMaXN0LnNvbWUoKHtsYXN0RXhlY3V0aW9ufSkgPT4gISFsYXN0RXhlY3V0aW9uKTtcbiAgICAgIGlmICghaGFzTmV3UG9sbHMpIHtcbiAgICAgICAgICBuZXdJbnRlcnZhbCA9IE1hdGgubWluKC4uLnBvbGxRdWV1ZUxpc3QubWFwKCh7aW50ZXJ2YWx9KSA9PiBpbnRlcnZhbCkpIC8gMjtcbiAgICAgIH1cbiAgICAgIG5ld0ludGVydmFsID0gbmV3SW50ZXJ2YWwgJiYgbmV3SW50ZXJ2YWwgPiAxMCA/IG5ld0ludGVydmFsIDogMTA7IC8vIGRlZmF1bHQgdG8gdGVuIHNlY29uZHMgKG1pbmltdW0gdmFsdWUpXG4gICAgICBpZiAodGhpcy5fcXVldWVJbnRlcnZhbCAhPT0gbmV3SW50ZXJ2YWwpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyggYHVwZGF0aW5nIHF1ZXVlIGludGVydmFsIHRvIHBvbGwgc2VydmVyIGV2ZXJ5ICR7bmV3SW50ZXJ2YWx9IHNlY29uZHNgKTtcbiAgICAgICAgICB0aGlzLl9xdWV1ZUludGVydmFsID0gbmV3SW50ZXJ2YWw7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX3F1ZXVlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX29uUXVldWVUaW1lclRpY2soKTtcbiAgICAgIH0sIHRoaXMuX3F1ZXVlSW50ZXJ2YWwgKiAxMDAwKTtcbiAgfVxuXG4gIHB1YmxpYyBmb3JjZVBvbGxpbmcoKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuaW5mbygnZm9yY2Ugc2VydmVyIHBvbGxpbmcgcmVxdWVzdGVkJyk7XG4gICAgICAvLyBjYW5jZWwgYWN0aXZlIHJlcXVlc3RzXG4gICAgICB0aGlzLl9jYW5jZWxRdWV1ZUludGVydmFsKCk7XG4gICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmZvckVhY2goc3Vic2NyaXB0aW9uID0+IHtcbiAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IFtdO1xuXG4gICAgICAvLyBlbmFibGUgYWxsIHJlcXVlc3RzXG4gICAgICB0aGlzLl9nZXRQb2xsUXVldWVMaXN0KCkuZm9yRWFjaChpdGVtID0+IGl0ZW0ucXVlcnlFbmFibGVkID0gdHJ1ZSk7XG5cbiAgICAgIC8vIHNlbmQgcG9sbCByZXF1ZXN0IGZvciBhbGwgcmVxdWVzdHNcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuX3F1ZXJ5UG9sbEl0ZW1zKHRoaXMuX2dldFBvbGxRdWV1ZUxpc3QoKSlcbiAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMuX3NldHVwUXVldWVUaW1lcigpLCAoKSA9PiB0aGlzLl9zZXR1cFF1ZXVlVGltZXIoKSk7XG4gIH1cblxuICAgIHByaXZhdGUgX3F1ZXJ5UG9sbEl0ZW1zKGl0ZW1zOiBQb2xsSXRlbTxURXJyb3I+W10pOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgZXhlY3V0ZSBzZXJ2ZXIgcG9sbGluZ2ApO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMuX2NhbkV4ZWN1dGUoKSB8fCAhaXRlbXMgfHwgaXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBleGVjdXRlIHNlcnZlciBwb2xsaW5nIGlnbm9yZWQsIGNhbm5vdCBleGVjdXRlIHJlcXVlc3Qgb3Igbm8gaXRlbXMgcHJvdmlkZWQgdG8gcXVlcnlgKTtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0cyA9IGl0ZW1zLm1hcChpdGVtID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgSXRlbVJlcXVlc3Q6IFRSZXF1ZXN0O1xuICAgICAgICAgICAgICAgIGxldCBlcnJvcjogVEVycm9yO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIEl0ZW1SZXF1ZXN0ID0gaXRlbS5yZXF1ZXN0RmFjdG9yeS5jcmVhdGUoKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBmYWlsZWQgdG8gY3JlYXRlIGEgcmVxdWVzdCBmb3IgJyR7aXRlbS5pZH0nLiBnb3QgdGhlIGZvbGxvd2luZyBlcnJvciA6ICcke2Vyci5tZXNzYWdlfSdgKTtcblxuICAgICAgICAgICAgICAgICAgICBJdGVtUmVxdWVzdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGVycm9yID0gdGhpcy5fY3JlYXRlR2xvYmFsRXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJvcGFnYXRlU2VydmVyUmVzcG9uc2UoaXRlbSwge2Vycm9yOiBlcnJvciwgcmVzdWx0OiBudWxsfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBJdGVtUmVxdWVzdCA/IHtwb2xsSXRlbTogaXRlbSwgcmVxdWVzdDogSXRlbVJlcXVlc3R9IDogbnVsbDtcbiAgICAgICAgICAgIH0pLmZpbHRlcihCb29sZWFuKTtcblxuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYGV4ZWN1dGluZyBzZXJ2ZXIgcG9sbCBmb3IgJHtyZXF1ZXN0cy5sZW5ndGh9IGl0ZW1zYCk7XG5cbiAgICAgICAgICAgIGlmICghcmVxdWVzdHMubGVuZ3RoKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQodW5kZWZpbmVkKTtcbiAgICAgICAgICAgIH1lbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLl9leGVjdXRlUmVxdWVzdHMocmVxdWVzdHMubWFwKGl0ZW0gPT4gaXRlbS5yZXF1ZXN0KSlcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBnb3QgJHtyZXNwb25zZS5sZW5ndGh9IHJlc3BvbnNlcy4gcHJvcGFnYXRlIHJlc3BvbnNlcyB0byByZWxldmFudCBhY3Rpb25zYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdHMuZm9yRWFjaCgoe3BvbGxJdGVtfSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHJlc3BvbnNlW2luZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0geyByZXN1bHQsIGVycm9yOiBudWxsIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9wYWdhdGVTZXJ2ZXJSZXNwb25zZShwb2xsSXRlbSwgcmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQodW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgZmFpbGVkIHRvIHF1ZXJ5IHRoZSBzZXJ2ZXIuIGdvdCB0aGUgZm9sbG93aW5nIGVycm9yIDogJyR7ZXJyb3IubWVzc2FnZX0nYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvclJlc3BvbnNlID0ge2Vycm9yOiB0aGlzLl9jcmVhdGVHbG9iYWxFcnJvcihlcnJvciksIHJlc3VsdDogbnVsbH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdHMuZm9yRWFjaCgoe3BvbGxJdGVtfSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9wYWdhdGVTZXJ2ZXJSZXNwb25zZShwb2xsSXRlbSwgZXJyb3JSZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKHN1YnNjcmlwdGlvbik7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVtb3ZlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbjogSVN1YnNjcmlwdGlvbik6IHZvaWQge1xuICAgICAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25JbmRleCA9IHRoaXMuX3N1YnNjcmlwdGlvbnMuaW5kZXhPZihzdWJzY3JpcHRpb24pO1xuXG4gICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uSW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMuc3BsaWNlKFxuICAgICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25JbmRleCxcbiAgICAgICAgICAgICAgICAgICAgMVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX29uUXVldWVUaW1lclRpY2soKTogdm9pZCB7XG5cbiAgICAgICAgaWYgKCF0aGlzLl9jYW5FeGVjdXRlKCkpIHtcbiAgICAgICAgICAgIHRoaXMuX3NldHVwUXVldWVUaW1lcigpO1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLnRyYWNlKCdfb25RdWV1ZVRpbWVyVGljaygpOiBjYW5FeGVjdXRlKCkgY2hlY2sgZmFpbGVkLiBpZ25vcmUgY3VycmVudCBleGVjdXRpb24nKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZygncHJlcGFyZSBzZXJ2ZXIgcG9sbCByZXF1ZXN0Jyk7XG5cbiAgICAgICAgY29uc3Qgbm93ID0gTnVtYmVyKG5ldyBEYXRlKCkpO1xuICAgICAgICBjb25zdCBpdGVtc1RvQmVFeGVjdXRlZCA9IHRoaXMuX2dldFBvbGxRdWV1ZUxpc3QoKVxuICAgICAgICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0ucXVlcnlFbmFibGVkICYmICghaXRlbS5sYXN0RXhlY3V0aW9uIHx8IChOdW1iZXIoaXRlbS5sYXN0RXhlY3V0aW9uKSArIChpdGVtLmludGVydmFsICogMTAwMCkgPD0gbm93KSkpO1xuXG5cbiAgICAgICAgaWYgKCFpdGVtc1RvQmVFeGVjdXRlZC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1Zygnbm90aGluZyB0byBydW4uIFdhaXRpbmcgbmV4dCB0aWNrLi4uJyk7XG4gICAgICAgICAgICB0aGlzLl9zZXR1cFF1ZXVlVGltZXIoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBzZXQgYnVzeSBtb2RlIHRvIHRydWVgKTtcbiAgICAgICAgdGhpcy5fc3RhdGUubmV4dCh7YnVzeTogdHJ1ZX0pO1xuICAgICAgICB0aGlzLl9xdWVyeVBvbGxJdGVtcyhpdGVtc1RvQmVFeGVjdXRlZClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZS5uZXh0KHtidXN5OiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFF1ZXVlVGltZXIoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZS5uZXh0KHtidXN5OiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gIHByaXZhdGUgX3Byb3BhZ2F0ZVNlcnZlclJlc3BvbnNlKGl0ZW06IFBvbGxJdGVtPFRFcnJvcj4sIHJlc3BvbnNlOiB7IGVycm9yOiBURXJyb3IsIHJlc3VsdDogYW55IH0pOiB2b2lke1xuICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAodGhpcy5fcG9sbFF1ZXVlW2l0ZW0uaWRdKSB7XG4gICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgcHJvcGFnYXRpbmcgcmVzcG9uc2UgZm9yICR7aXRlbS5pZH1gKTtcbiAgICAgICAgICAgICAgaXRlbS5sYXN0RXhlY3V0aW9uID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgICAgaXRlbS5vYnNlcnZlci5uZXh0KHJlc3BvbnNlKTtcbiAgICAgICAgICB9ZWxzZVxuICAgICAgICAgIHtcbiAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYGNhbm5vdCBmaW5kIHJlZ2lzdGVyZWQgYWN0aW9uIGZvciAnJHtpdGVtLmlkfSAoaXQgbWlnaHQgaW5kaWNhdGUgdGhhdCB0aGlzIGFjdGlvbiB3YXMgdW5zdWJzY3JpYmVkIHdoaWxlIGEgcmVxdWVzdCB0byB0aGUgc2VydmVyIHdhcyBleGVjdXRlZClgKTtcbiAgICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIud2FybiggYGVycm9yIGhhcHBlbmVkIHdoaWxlIHByb3BhZ2F0aW5nIHJlc3BvbnNlIG9mICcke2l0ZW0uaWR9Jy5pZ25vcmluZyBlcnJvci4gZ290IHRoZSBmb2xsb3dpbmcgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gIH1cblxuICBwdWJsaWMgaXNCdXN5KCk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLmdldFZhbHVlKCkuYnVzeTtcbiAgfVxuXG4gIHB1YmxpYyByZWdpc3RlcjxUUmVzcG9uc2U+KGludGVydmFsSW5TZWNvbmRzOiBQb2xsSW50ZXJ2YWwsIHJlcXVlc3RGYWN0b3J5OiBSZXF1ZXN0RmFjdG9yeTxUUmVxdWVzdCwgVFJlc3BvbnNlPik6IE9ic2VydmFibGU8eyBlcnJvcjogVEVycm9yLCByZXN1bHQ6IFRSZXNwb25zZSB9PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKG9ic2VydmVyID0+IHtcbiAgICAgIGNvbnN0IG5ld1BvbGxJZCA9IHRoaXMuX3Rva2VuR2VuZXJhdG9yLmdlbmVyYXRlVW5pcXVlKE9iamVjdC5rZXlzKHRoaXMuX3BvbGxRdWV1ZSkpO1xuICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyggYHJlZ2lzdGVyIG5ldyBwb2xsIHJlcXVlc3QgJHtuZXdQb2xsSWR9IChpbnRlcnZhbCA9ICR7aW50ZXJ2YWxJblNlY29uZHN9IHNlY29uZHMpYCk7XG4gICAgICBjb25zdCBuZXdQb2xsSXRlbTogUG9sbEl0ZW08VEVycm9yPiA9IHRoaXMuX3BvbGxRdWV1ZVtuZXdQb2xsSWRdID0ge1xuICAgICAgICBpZDogbmV3UG9sbElkLFxuICAgICAgICBpbnRlcnZhbDogaW50ZXJ2YWxJblNlY29uZHMsXG4gICAgICAgIGxhc3RFeGVjdXRpb246IG51bGwsXG4gICAgICAgICAgcXVlcnlFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgcmVxdWVzdEZhY3Rvcnk6IHJlcXVlc3RGYWN0b3J5LFxuICAgICAgICBvYnNlcnZlcjogb2JzZXJ2ZXJcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKCBgZXhlY3V0ZSB0aGUgYWRkZWQgcmVxdWVzdCAnJHtuZXdQb2xsSWR9J2ApO1xuICAgICAgbGV0IGluaXRpYWxSZXF1ZXN0ID0gdGhpcy5fcXVlcnlQb2xsSXRlbXMoW25ld1BvbGxJdGVtXSlcbiAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAoKSA9PlxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBpbml0aWFsUmVxdWVzdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBuZXdQb2xsSXRlbS5xdWVyeUVuYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0dXBRdWV1ZVRpbWVyKCk7XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICgpID0+XG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIGluaXRpYWxSZXF1ZXN0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgIG5ld1BvbGxJdGVtLnF1ZXJ5RW5hYmxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9zZXR1cFF1ZXVlVGltZXIoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG5cbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYHN0b3AgcG9sbGluZyBmb3IgJHtuZXdQb2xsSWR9YCk7XG4gICAgICAgICAgaWYgKGluaXRpYWxSZXF1ZXN0KSB7XG4gICAgICAgICAgICAgIGluaXRpYWxSZXF1ZXN0LnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGRlbGV0ZSB0aGlzLl9wb2xsUXVldWVbbmV3UG9sbElkXTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19