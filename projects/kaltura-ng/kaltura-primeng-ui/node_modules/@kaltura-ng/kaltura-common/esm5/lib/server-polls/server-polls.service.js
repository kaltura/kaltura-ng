import { __read, __spread } from "tslib";
import { Observable } from 'rxjs';
import { FriendlyHashId } from '../friendly-hash-id';
import { BehaviorSubject } from 'rxjs/BehaviorSubject';
import { EmptyLogger } from '../kaltura-logger';
var ServerPolls = /** @class */ (function () {
    function ServerPolls(kalturaLogger) {
        this._pollQueue = {};
        this._tokenGenerator = new FriendlyHashId();
        this._missingDestoryHandling = false;
        this._subscriptions = [];
        this._state = new BehaviorSubject({ busy: false });
        this.state$ = this._state.asObservable();
        this._queueInterval = null;
        if (kalturaLogger) {
            this._logger = kalturaLogger;
        }
        else {
            this._logger = new EmptyLogger();
        }
        this._initialize();
    }
    ServerPolls.prototype._warnAboutMissingDestory = function () {
        // NOTICE: showing a warning every time since this is an implementation issue that must be addressed during development.
        var error = "calling method '_getOnDestroy$()' didn't return valid observable (did you remember to provide 'Observable' that will be invoked from ngOnDestroy method?)";
        this._logger.error(error);
    };
    ServerPolls.prototype._initialize = function () {
        var _this = this;
        this._logger.trace('_initialize()');
        setTimeout(function () {
            var onDestroy$ = _this._getOnDestroy$();
            if (!onDestroy$) {
                _this._missingDestoryHandling = true;
                _this._warnAboutMissingDestory();
            }
            else {
                onDestroy$.subscribe(function () {
                    _this._logger.trace('onDestroy$.subscribe()');
                    _this._cancelQueueInterval();
                    _this._subscriptions.forEach(function (item) {
                        item.unsubscribe();
                    });
                    _this._subscriptions = [];
                });
            }
        });
    };
    ServerPolls.prototype._cancelQueueInterval = function () {
        clearTimeout(this._queueTimeout);
    };
    ServerPolls.prototype._getPollQueueList = function () {
        var _this = this;
        return Object.keys(this._pollQueue).map(function (key) { return _this._pollQueue[key]; });
    };
    ServerPolls.prototype._setupQueueTimer = function () {
        var _this = this;
        this._cancelQueueInterval();
        var pollQueueList = this._getPollQueueList();
        if (this._missingDestoryHandling) {
            // NOTICE: showing a warning every time since this is an implementation issue that must be addressed during development.
            this._warnAboutMissingDestory();
        }
        if (!pollQueueList.length) {
            this._logger.info('no actions found in the queue. suspending interval until an action will be added');
            return;
        }
        var newInterval = null;
        var hasNewPolls = pollQueueList.some(function (_a) {
            var lastExecution = _a.lastExecution;
            return !!lastExecution;
        });
        if (!hasNewPolls) {
            newInterval = Math.min.apply(Math, __spread(pollQueueList.map(function (_a) {
                var interval = _a.interval;
                return interval;
            }))) / 2;
        }
        newInterval = newInterval && newInterval > 10 ? newInterval : 10; // default to ten seconds (minimum value)
        if (this._queueInterval !== newInterval) {
            this._logger.info("updating queue interval to poll server every " + newInterval + " seconds");
            this._queueInterval = newInterval;
        }
        this._queueTimeout = setTimeout(function () {
            _this._onQueueTimerTick();
        }, this._queueInterval * 1000);
    };
    ServerPolls.prototype.forcePolling = function () {
        var _this = this;
        this._logger.info('force server polling requested');
        // cancel active requests
        this._cancelQueueInterval();
        this._subscriptions.forEach(function (subscription) {
            subscription.unsubscribe();
        });
        this._subscriptions = [];
        // enable all requests
        this._getPollQueueList().forEach(function (item) { return item.queryEnabled = true; });
        // send poll request for all requests
        var subscription = this._queryPollItems(this._getPollQueueList())
            .subscribe(function () { return _this._setupQueueTimer(); }, function () { return _this._setupQueueTimer(); });
    };
    ServerPolls.prototype._queryPollItems = function (items) {
        var _this = this;
        return Observable.create(function (observer) {
            _this._logger.debug("execute server polling");
            if (!_this._canExecute() || !items || items.length === 0) {
                _this._logger.debug("execute server polling ignored, cannot execute request or no items provided to query");
                observer.next(undefined);
                return;
            }
            var requests = items.map(function (item) {
                var ItemRequest;
                var error;
                try {
                    ItemRequest = item.requestFactory.create();
                }
                catch (err) {
                    _this._logger.error("failed to create a request for '" + item.id + "'. got the following error : '" + err.message + "'");
                    ItemRequest = null;
                    error = _this._createGlobalError(err);
                }
                if (error) {
                    _this._propagateServerResponse(item, { error: error, result: null });
                }
                return ItemRequest ? { pollItem: item, request: ItemRequest } : null;
            }).filter(Boolean);
            _this._logger.info("executing server poll for " + requests.length + " items");
            if (!requests.length) {
                observer.next(undefined);
            }
            else {
                var subscription_1 = _this._executeRequests(requests.map(function (item) { return item.request; }))
                    .subscribe(function (response) {
                    _this._removeSubscription(subscription_1);
                    _this._logger.info("got " + response.length + " responses. propagate responses to relevant actions");
                    requests.forEach(function (_a, index) {
                        var pollItem = _a.pollItem;
                        var result = response[index];
                        if (Array.isArray(result)) {
                            result = { result: result, error: null };
                        }
                        _this._propagateServerResponse(pollItem, result);
                    });
                    observer.next(undefined);
                }, function (error) {
                    _this._logger.error("failed to query the server. got the following error : '" + error.message + "'");
                    _this._removeSubscription(subscription_1);
                    var errorResponse = { error: _this._createGlobalError(error), result: null };
                    requests.forEach(function (_a) {
                        var pollItem = _a.pollItem;
                        _this._propagateServerResponse(pollItem, errorResponse);
                    });
                    observer.next(undefined);
                });
                _this._subscriptions.push(subscription_1);
                return function () {
                    _this._removeSubscription(subscription_1);
                };
            }
        });
    };
    ServerPolls.prototype._removeSubscription = function (subscription) {
        if (subscription) {
            var subscriptionIndex = this._subscriptions.indexOf(subscription);
            if (subscriptionIndex > -1) {
                this._subscriptions.splice(subscriptionIndex, 1);
            }
        }
    };
    ServerPolls.prototype._onQueueTimerTick = function () {
        var _this = this;
        if (!this._canExecute()) {
            this._setupQueueTimer();
            this._logger.trace('_onQueueTimerTick(): canExecute() check failed. ignore current execution');
            return;
        }
        this._logger.debug('prepare server poll request');
        var now = Number(new Date());
        var itemsToBeExecuted = this._getPollQueueList()
            .filter(function (item) { return item.queryEnabled && (!item.lastExecution || (Number(item.lastExecution) + (item.interval * 1000) <= now)); });
        if (!itemsToBeExecuted.length) {
            this._logger.debug('nothing to run. Waiting next tick...');
            this._setupQueueTimer();
            return;
        }
        this._logger.info("set busy mode to true");
        this._state.next({ busy: true });
        this._queryPollItems(itemsToBeExecuted)
            .subscribe(function () {
            _this._state.next({ busy: false });
            _this._setupQueueTimer();
        }, function (error) {
            _this._state.next({ busy: false });
        });
    };
    ServerPolls.prototype._propagateServerResponse = function (item, response) {
        try {
            if (this._pollQueue[item.id]) {
                this._logger.debug("propagating response for " + item.id);
                item.lastExecution = new Date();
                item.observer.next(response);
            }
            else {
                this._logger.info("cannot find registered action for '" + item.id + " (it might indicate that this action was unsubscribed while a request to the server was executed)");
            }
        }
        catch (err) {
            this._logger.warn("error happened while propagating response of '" + item.id + "'.ignoring error. got the following error: " + err.message);
        }
    };
    ServerPolls.prototype.isBusy = function () {
        return this._state.getValue().busy;
    };
    ServerPolls.prototype.register = function (intervalInSeconds, requestFactory) {
        var _this = this;
        return Observable.create(function (observer) {
            var newPollId = _this._tokenGenerator.generateUnique(Object.keys(_this._pollQueue));
            _this._logger.info("register new poll request " + newPollId + " (interval = " + intervalInSeconds + " seconds)");
            var newPollItem = _this._pollQueue[newPollId] = {
                id: newPollId,
                interval: intervalInSeconds,
                lastExecution: null,
                queryEnabled: false,
                requestFactory: requestFactory,
                observer: observer
            };
            _this._logger.info("execute the added request '" + newPollId + "'");
            var initialRequest = _this._queryPollItems([newPollItem])
                .subscribe(function () {
                initialRequest = null;
                newPollItem.queryEnabled = true;
                _this._setupQueueTimer();
            }, function () {
                initialRequest = null;
                newPollItem.queryEnabled = true;
                _this._setupQueueTimer();
            });
            return function () {
                _this._logger.info("stop polling for " + newPollId);
                if (initialRequest) {
                    initialRequest.unsubscribe();
                }
                delete _this._pollQueue[newPollId];
            };
        });
    };
    return ServerPolls;
}());
export { ServerPolls };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLXBvbGxzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Aa2FsdHVyYS1uZy9rYWx0dXJhLWNvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2ZXItcG9sbHMvc2VydmVyLXBvbGxzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXJELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsV0FBVyxFQUFpQixNQUFNLG1CQUFtQixDQUFDO0FBa0IvRDtJQW1CRSxxQkFBWSxhQUE0QjtRQWxCaEMsZUFBVSxHQUF3QyxFQUFFLENBQUM7UUFDckQsb0JBQWUsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBRXZDLDRCQUF1QixHQUFHLEtBQUssQ0FBQztRQUNoQyxtQkFBYyxHQUFvQixFQUFFLENBQUM7UUFDckMsV0FBTSxHQUFHLElBQUksZUFBZSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFL0MsV0FBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDbkMsbUJBQWMsR0FBVyxJQUFJLENBQUM7UUFZckMsSUFBSSxhQUFhLEVBQUU7WUFDbEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUM7U0FDN0I7YUFBTTtZQUNOLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztTQUNqQztRQUNELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNwQixDQUFDO0lBRU8sOENBQXdCLEdBQWhDO1FBQ0ksd0hBQXdIO1FBQ3hILElBQU0sS0FBSyxHQUFHLDJKQUEySixDQUFDO1FBQzFLLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FB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LENBQUMsQ0FBQztpQkFDbkQsU0FBUyxDQUNOO2dCQUVJLGNBQWMsR0FBRyxJQUFJLENBQUM7Z0JBQ3RCLFdBQVcsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO2dCQUNoQyxLQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUM1QixDQUFDLEVBQ0Q7Z0JBRUksY0FBYyxHQUFHLElBQUksQ0FBQztnQkFDdEIsV0FBVyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Z0JBQ2hDLEtBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzVCLENBQUMsQ0FDSixDQUFDO1lBRU4sT0FBTztnQkFDSCxLQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxzQkFBb0IsU0FBVyxDQUFDLENBQUM7Z0JBQ25ELElBQUksY0FBYyxFQUFFO29CQUNoQixjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7aUJBQ2hDO2dCQUNELE9BQU8sS0FBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN0QyxDQUFDLENBQUE7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDSCxrQkFBQztBQUFELENBQUMsQUFyU0QsSUFxU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBTdWJzY3JpYmVyIH0gZnJvbSAncnhqcy9TdWJzY3JpYmVyJztcbmltcG9ydCB7IEZyaWVuZGx5SGFzaElkIH0gZnJvbSAnLi4vZnJpZW5kbHktaGFzaC1pZCc7XG5pbXBvcnQgeyBJU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcy9TdWJzY3JpcHRpb24nO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcy9CZWhhdmlvclN1YmplY3QnO1xuaW1wb3J0IHsgRW1wdHlMb2dnZXIsIEthbHR1cmFMb2dnZXIgfSBmcm9tICcuLi9rYWx0dXJhLWxvZ2dlcic7XG5pbXBvcnQgeyBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5leHBvcnQgdHlwZSBQb2xsSW50ZXJ2YWwgPSAxMCB8IDMwIHwgNjAgfCAzMDA7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdEZhY3Rvcnk8VFJlcXVlc3QsIFRSZXNwb25zZT4ge1xuICBjcmVhdGUoKTogVFJlcXVlc3Q7XG59XG5cbmludGVyZmFjZSBQb2xsSXRlbTxURXJyb3I+IHtcbiAgaWQ6IHN0cmluZztcbiAgaW50ZXJ2YWw6IFBvbGxJbnRlcnZhbDtcbiAgbGFzdEV4ZWN1dGlvbjogRGF0ZSxcbiAgcXVlcnlFbmFibGVkOiBib29sZWFuLFxuICByZXF1ZXN0RmFjdG9yeTogUmVxdWVzdEZhY3Rvcnk8YW55LCBhbnk+LFxuICBvYnNlcnZlcjogU3Vic2NyaWJlcjx7cmVzdWx0OiBhbnksIGVycm9yOiBURXJyb3J9PlxufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2VydmVyUG9sbHM8VFJlcXVlc3QsIFRFcnJvcj4ge1xuICBwcml2YXRlIF9wb2xsUXVldWU6IHsgW2tleTogc3RyaW5nXTogUG9sbEl0ZW08VEVycm9yPiB9ID0ge307XG4gIHByaXZhdGUgX3Rva2VuR2VuZXJhdG9yID0gbmV3IEZyaWVuZGx5SGFzaElkKCk7XG4gIHByaXZhdGUgX3F1ZXVlVGltZW91dDogbnVtYmVyO1xuICBwcml2YXRlIF9taXNzaW5nRGVzdG9yeUhhbmRsaW5nID0gZmFsc2U7XG4gIHByaXZhdGUgX3N1YnNjcmlwdGlvbnM6IElTdWJzY3JpcHRpb25bXSA9IFtdO1xuICBwcml2YXRlIF9zdGF0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3QoeyBidXN5OiBmYWxzZSB9KTtcbiAgICBwcml2YXRlIF9sb2dnZXI6IEthbHR1cmFMb2dnZXI7XG4gIHB1YmxpYyBzdGF0ZSQgPSB0aGlzLl9zdGF0ZS5hc09ic2VydmFibGUoKTtcbiAgcHJpdmF0ZSBfcXVldWVJbnRlcnZhbDogbnVtYmVyID0gbnVsbDtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgX2V4ZWN1dGVSZXF1ZXN0cyhyZXF1ZXN0czogVFJlcXVlc3RbXSk6IE9ic2VydmFibGU8eyBlcnJvcjogVEVycm9yLCByZXN1bHQ6IGFueSB9W10+O1xuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBfY3JlYXRlR2xvYmFsRXJyb3IoZXJyb3I/OiBFcnJvcik6IFRFcnJvcjtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgX2dldE9uRGVzdHJveSQoKTogT2JzZXJ2YWJsZTx2b2lkPjtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgX2NhbkV4ZWN1dGUoKTogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihrYWx0dXJhTG9nZ2VyOiBLYWx0dXJhTG9nZ2VyKSB7XG5cblx0ICBpZiAoa2FsdHVyYUxvZ2dlcikge1xuXHRcdCAgdGhpcy5fbG9nZ2VyID0ga2FsdHVyYUxvZ2dlcjtcblx0ICB9IGVsc2Uge1xuXHRcdCAgdGhpcy5fbG9nZ2VyID0gbmV3IEVtcHR5TG9nZ2VyKCk7XG5cdCAgfVxuXHQgIHRoaXMuX2luaXRpYWxpemUoKTtcbiAgfVxuXG4gIHByaXZhdGUgX3dhcm5BYm91dE1pc3NpbmdEZXN0b3J5KCk6IHZvaWQge1xuICAgICAgLy8gTk9USUNFOiBzaG93aW5nIGEgd2FybmluZyBldmVyeSB0aW1lIHNpbmNlIHRoaXMgaXMgYW4gaW1wbGVtZW50YXRpb24gaXNzdWUgdGhhdCBtdXN0IGJlIGFkZHJlc3NlZCBkdXJpbmcgZGV2ZWxvcG1lbnQuXG4gICAgICBjb25zdCBlcnJvciA9IGBjYWxsaW5nIG1ldGhvZCAnX2dldE9uRGVzdHJveSQoKScgZGlkbid0IHJldHVybiB2YWxpZCBvYnNlcnZhYmxlIChkaWQgeW91IHJlbWVtYmVyIHRvIHByb3ZpZGUgJ09ic2VydmFibGUnIHRoYXQgd2lsbCBiZSBpbnZva2VkIGZyb20gbmdPbkRlc3Ryb3kgbWV0aG9kPylgO1xuICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGVycm9yKTtcbiAgfVxuXG4gIHByaXZhdGUgX2luaXRpYWxpemUoKTogdm9pZCB7XG4gICAgICB0aGlzLl9sb2dnZXIudHJhY2UoJ19pbml0aWFsaXplKCknKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IG9uRGVzdHJveSQgPSB0aGlzLl9nZXRPbkRlc3Ryb3kkKCk7XG5cbiAgICAgICAgICBpZiAoIW9uRGVzdHJveSQpIHtcbiAgICAgICAgICAgICAgdGhpcy5fbWlzc2luZ0Rlc3RvcnlIYW5kbGluZyA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMuX3dhcm5BYm91dE1pc3NpbmdEZXN0b3J5KCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgb25EZXN0cm95JC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLnRyYWNlKCdvbkRlc3Ryb3kkLnN1YnNjcmliZSgpJyk7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9jYW5jZWxRdWV1ZUludGVydmFsKCk7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgaXRlbS51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gW107XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2FuY2VsUXVldWVJbnRlcnZhbCgpOiB2b2lkIHtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5fcXVldWVUaW1lb3V0KTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldFBvbGxRdWV1ZUxpc3QoKTogUG9sbEl0ZW08VEVycm9yPltdIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fcG9sbFF1ZXVlKS5tYXAoa2V5ID0+IHRoaXMuX3BvbGxRdWV1ZVtrZXldKTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldHVwUXVldWVUaW1lcigpOiB2b2lkIHtcbiAgICAgIHRoaXMuX2NhbmNlbFF1ZXVlSW50ZXJ2YWwoKTtcblxuICAgICAgY29uc3QgcG9sbFF1ZXVlTGlzdCA9IHRoaXMuX2dldFBvbGxRdWV1ZUxpc3QoKTtcblxuICAgICAgaWYgKHRoaXMuX21pc3NpbmdEZXN0b3J5SGFuZGxpbmcpIHtcbiAgICAgICAgICAvLyBOT1RJQ0U6IHNob3dpbmcgYSB3YXJuaW5nIGV2ZXJ5IHRpbWUgc2luY2UgdGhpcyBpcyBhbiBpbXBsZW1lbnRhdGlvbiBpc3N1ZSB0aGF0IG11c3QgYmUgYWRkcmVzc2VkIGR1cmluZyBkZXZlbG9wbWVudC5cbiAgICAgICAgICB0aGlzLl93YXJuQWJvdXRNaXNzaW5nRGVzdG9yeSgpO1xuICAgICAgfVxuXG5cbiAgICAgIGlmICghcG9sbFF1ZXVlTGlzdC5sZW5ndGgpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbygnbm8gYWN0aW9ucyBmb3VuZCBpbiB0aGUgcXVldWUuIHN1c3BlbmRpbmcgaW50ZXJ2YWwgdW50aWwgYW4gYWN0aW9uIHdpbGwgYmUgYWRkZWQnKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxldCBuZXdJbnRlcnZhbDogbnVtYmVyID0gbnVsbDtcbiAgICAgIGNvbnN0IGhhc05ld1BvbGxzID0gcG9sbFF1ZXVlTGlzdC5zb21lKCh7bGFzdEV4ZWN1dGlvbn0pID0+ICEhbGFzdEV4ZWN1dGlvbik7XG4gICAgICBpZiAoIWhhc05ld1BvbGxzKSB7XG4gICAgICAgICAgbmV3SW50ZXJ2YWwgPSBNYXRoLm1pbiguLi5wb2xsUXVldWVMaXN0Lm1hcCgoe2ludGVydmFsfSkgPT4gaW50ZXJ2YWwpKSAvIDI7XG4gICAgICB9XG4gICAgICBuZXdJbnRlcnZhbCA9IG5ld0ludGVydmFsICYmIG5ld0ludGVydmFsID4gMTAgPyBuZXdJbnRlcnZhbCA6IDEwOyAvLyBkZWZhdWx0IHRvIHRlbiBzZWNvbmRzIChtaW5pbXVtIHZhbHVlKVxuICAgICAgaWYgKHRoaXMuX3F1ZXVlSW50ZXJ2YWwgIT09IG5ld0ludGVydmFsKSB7XG4gICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oIGB1cGRhdGluZyBxdWV1ZSBpbnRlcnZhbCB0byBwb2xsIHNlcnZlciBldmVyeSAke25ld0ludGVydmFsfSBzZWNvbmRzYCk7XG4gICAgICAgICAgdGhpcy5fcXVldWVJbnRlcnZhbCA9IG5ld0ludGVydmFsO1xuICAgICAgfVxuXG4gICAgICB0aGlzLl9xdWV1ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLl9vblF1ZXVlVGltZXJUaWNrKCk7XG4gICAgICB9LCB0aGlzLl9xdWV1ZUludGVydmFsICogMTAwMCk7XG4gIH1cblxuICBwdWJsaWMgZm9yY2VQb2xsaW5nKCkge1xuICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oJ2ZvcmNlIHNlcnZlciBwb2xsaW5nIHJlcXVlc3RlZCcpO1xuICAgICAgLy8gY2FuY2VsIGFjdGl2ZSByZXF1ZXN0c1xuICAgICAgdGhpcy5fY2FuY2VsUXVldWVJbnRlcnZhbCgpO1xuICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHN1YnNjcmlwdGlvbiA9PiB7XG4gICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBbXTtcblxuICAgICAgLy8gZW5hYmxlIGFsbCByZXF1ZXN0c1xuICAgICAgdGhpcy5fZ2V0UG9sbFF1ZXVlTGlzdCgpLmZvckVhY2goaXRlbSA9PiBpdGVtLnF1ZXJ5RW5hYmxlZCA9IHRydWUpO1xuXG4gICAgICAvLyBzZW5kIHBvbGwgcmVxdWVzdCBmb3IgYWxsIHJlcXVlc3RzXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLl9xdWVyeVBvbGxJdGVtcyh0aGlzLl9nZXRQb2xsUXVldWVMaXN0KCkpXG4gICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLl9zZXR1cFF1ZXVlVGltZXIoKSwgKCkgPT4gdGhpcy5fc2V0dXBRdWV1ZVRpbWVyKCkpO1xuICB9XG5cbiAgICBwcml2YXRlIF9xdWVyeVBvbGxJdGVtcyhpdGVtczogUG9sbEl0ZW08VEVycm9yPltdKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZShvYnNlcnZlciA9PiB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYGV4ZWN1dGUgc2VydmVyIHBvbGxpbmdgKTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLl9jYW5FeGVjdXRlKCkgfHwgIWl0ZW1zIHx8IGl0ZW1zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgZXhlY3V0ZSBzZXJ2ZXIgcG9sbGluZyBpZ25vcmVkLCBjYW5ub3QgZXhlY3V0ZSByZXF1ZXN0IG9yIG5vIGl0ZW1zIHByb3ZpZGVkIHRvIHF1ZXJ5YCk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcmVxdWVzdHMgPSBpdGVtcy5tYXAoaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IEl0ZW1SZXF1ZXN0OiBUUmVxdWVzdDtcbiAgICAgICAgICAgICAgICBsZXQgZXJyb3I6IFRFcnJvcjtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBJdGVtUmVxdWVzdCA9IGl0ZW0ucmVxdWVzdEZhY3RvcnkuY3JlYXRlKCk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgZmFpbGVkIHRvIGNyZWF0ZSBhIHJlcXVlc3QgZm9yICcke2l0ZW0uaWR9Jy4gZ290IHRoZSBmb2xsb3dpbmcgZXJyb3IgOiAnJHtlcnIubWVzc2FnZX0nYCk7XG5cbiAgICAgICAgICAgICAgICAgICAgSXRlbVJlcXVlc3QgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBlcnJvciA9IHRoaXMuX2NyZWF0ZUdsb2JhbEVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3Byb3BhZ2F0ZVNlcnZlclJlc3BvbnNlKGl0ZW0sIHtlcnJvcjogZXJyb3IsIHJlc3VsdDogbnVsbH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gSXRlbVJlcXVlc3QgPyB7cG9sbEl0ZW06IGl0ZW0sIHJlcXVlc3Q6IEl0ZW1SZXF1ZXN0fSA6IG51bGw7XG4gICAgICAgICAgICB9KS5maWx0ZXIoQm9vbGVhbik7XG5cbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBleGVjdXRpbmcgc2VydmVyIHBvbGwgZm9yICR7cmVxdWVzdHMubGVuZ3RofSBpdGVtc2ApO1xuXG4gICAgICAgICAgICBpZiAoIXJlcXVlc3RzLmxlbmd0aClcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5fZXhlY3V0ZVJlcXVlc3RzKHJlcXVlc3RzLm1hcChpdGVtID0+IGl0ZW0ucmVxdWVzdCkpXG4gICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgZ290ICR7cmVzcG9uc2UubGVuZ3RofSByZXNwb25zZXMuIHByb3BhZ2F0ZSByZXNwb25zZXMgdG8gcmVsZXZhbnQgYWN0aW9uc2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzLmZvckVhY2goKHtwb2xsSXRlbX0sIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSByZXNwb25zZVtpbmRleF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHsgcmVzdWx0LCBlcnJvcjogbnVsbCB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJvcGFnYXRlU2VydmVyUmVzcG9uc2UocG9sbEl0ZW0sIHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYGZhaWxlZCB0byBxdWVyeSB0aGUgc2VydmVyLiBnb3QgdGhlIGZvbGxvd2luZyBlcnJvciA6ICcke2Vycm9yLm1lc3NhZ2V9J2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbW92ZVN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3JSZXNwb25zZSA9IHtlcnJvcjogdGhpcy5fY3JlYXRlR2xvYmFsRXJyb3IoZXJyb3IpLCByZXN1bHQ6IG51bGx9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzLmZvckVhY2goKHtwb2xsSXRlbX0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJvcGFnYXRlU2VydmVyUmVzcG9uc2UocG9sbEl0ZW0sIGVycm9yUmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh1bmRlZmluZWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaChzdWJzY3JpcHRpb24pO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVtb3ZlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbik7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3JlbW92ZVN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb246IElTdWJzY3JpcHRpb24pOiB2b2lkIHtcbiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uSW5kZXggPSB0aGlzLl9zdWJzY3JpcHRpb25zLmluZGV4T2Yoc3Vic2NyaXB0aW9uKTtcblxuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbkluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLnNwbGljZShcbiAgICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIDFcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9vblF1ZXVlVGltZXJUaWNrKCk6IHZvaWQge1xuXG4gICAgICAgIGlmICghdGhpcy5fY2FuRXhlY3V0ZSgpKSB7XG4gICAgICAgICAgICB0aGlzLl9zZXR1cFF1ZXVlVGltZXIoKTtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci50cmFjZSgnX29uUXVldWVUaW1lclRpY2soKTogY2FuRXhlY3V0ZSgpIGNoZWNrIGZhaWxlZC4gaWdub3JlIGN1cnJlbnQgZXhlY3V0aW9uJyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoJ3ByZXBhcmUgc2VydmVyIHBvbGwgcmVxdWVzdCcpO1xuXG4gICAgICAgIGNvbnN0IG5vdyA9IE51bWJlcihuZXcgRGF0ZSgpKTtcbiAgICAgICAgY29uc3QgaXRlbXNUb0JlRXhlY3V0ZWQgPSB0aGlzLl9nZXRQb2xsUXVldWVMaXN0KClcbiAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLnF1ZXJ5RW5hYmxlZCAmJiAoIWl0ZW0ubGFzdEV4ZWN1dGlvbiB8fCAoTnVtYmVyKGl0ZW0ubGFzdEV4ZWN1dGlvbikgKyAoaXRlbS5pbnRlcnZhbCAqIDEwMDApIDw9IG5vdykpKTtcblxuXG4gICAgICAgIGlmICghaXRlbXNUb0JlRXhlY3V0ZWQubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoJ25vdGhpbmcgdG8gcnVuLiBXYWl0aW5nIG5leHQgdGljay4uLicpO1xuICAgICAgICAgICAgdGhpcy5fc2V0dXBRdWV1ZVRpbWVyKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgc2V0IGJ1c3kgbW9kZSB0byB0cnVlYCk7XG4gICAgICAgIHRoaXMuX3N0YXRlLm5leHQoe2J1c3k6IHRydWV9KTtcbiAgICAgICAgdGhpcy5fcXVlcnlQb2xsSXRlbXMoaXRlbXNUb0JlRXhlY3V0ZWQpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3RhdGUubmV4dCh7YnVzeTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0dXBRdWV1ZVRpbWVyKCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3RhdGUubmV4dCh7YnVzeTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgIH1cblxuICBwcml2YXRlIF9wcm9wYWdhdGVTZXJ2ZXJSZXNwb25zZShpdGVtOiBQb2xsSXRlbTxURXJyb3I+LCByZXNwb25zZTogeyBlcnJvcjogVEVycm9yLCByZXN1bHQ6IGFueSB9KTogdm9pZHtcbiAgICAgIHRyeSB7XG4gICAgICAgICAgaWYgKHRoaXMuX3BvbGxRdWV1ZVtpdGVtLmlkXSkge1xuICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYHByb3BhZ2F0aW5nIHJlc3BvbnNlIGZvciAke2l0ZW0uaWR9YCk7XG4gICAgICAgICAgICAgIGl0ZW0ubGFzdEV4ZWN1dGlvbiA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAgIGl0ZW0ub2JzZXJ2ZXIubmV4dChyZXNwb25zZSk7XG4gICAgICAgICAgfWVsc2VcbiAgICAgICAgICB7XG4gICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBjYW5ub3QgZmluZCByZWdpc3RlcmVkIGFjdGlvbiBmb3IgJyR7aXRlbS5pZH0gKGl0IG1pZ2h0IGluZGljYXRlIHRoYXQgdGhpcyBhY3Rpb24gd2FzIHVuc3Vic2NyaWJlZCB3aGlsZSBhIHJlcXVlc3QgdG8gdGhlIHNlcnZlciB3YXMgZXhlY3V0ZWQpYCk7XG4gICAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oIGBlcnJvciBoYXBwZW5lZCB3aGlsZSBwcm9wYWdhdGluZyByZXNwb25zZSBvZiAnJHtpdGVtLmlkfScuaWdub3JpbmcgZXJyb3IuIGdvdCB0aGUgZm9sbG93aW5nIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfVxuICB9XG5cbiAgcHVibGljIGlzQnVzeSgpOiBib29sZWFuIHtcbiAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5nZXRWYWx1ZSgpLmJ1c3k7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXI8VFJlc3BvbnNlPihpbnRlcnZhbEluU2Vjb25kczogUG9sbEludGVydmFsLCByZXF1ZXN0RmFjdG9yeTogUmVxdWVzdEZhY3Rvcnk8VFJlcXVlc3QsIFRSZXNwb25zZT4pOiBPYnNlcnZhYmxlPHsgZXJyb3I6IFRFcnJvciwgcmVzdWx0OiBUUmVzcG9uc2UgfT4ge1xuICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZShvYnNlcnZlciA9PiB7XG4gICAgICBjb25zdCBuZXdQb2xsSWQgPSB0aGlzLl90b2tlbkdlbmVyYXRvci5nZW5lcmF0ZVVuaXF1ZShPYmplY3Qua2V5cyh0aGlzLl9wb2xsUXVldWUpKTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oIGByZWdpc3RlciBuZXcgcG9sbCByZXF1ZXN0ICR7bmV3UG9sbElkfSAoaW50ZXJ2YWwgPSAke2ludGVydmFsSW5TZWNvbmRzfSBzZWNvbmRzKWApO1xuICAgICAgY29uc3QgbmV3UG9sbEl0ZW06IFBvbGxJdGVtPFRFcnJvcj4gPSB0aGlzLl9wb2xsUXVldWVbbmV3UG9sbElkXSA9IHtcbiAgICAgICAgaWQ6IG5ld1BvbGxJZCxcbiAgICAgICAgaW50ZXJ2YWw6IGludGVydmFsSW5TZWNvbmRzLFxuICAgICAgICBsYXN0RXhlY3V0aW9uOiBudWxsLFxuICAgICAgICAgIHF1ZXJ5RW5hYmxlZDogZmFsc2UsXG4gICAgICAgIHJlcXVlc3RGYWN0b3J5OiByZXF1ZXN0RmFjdG9yeSxcbiAgICAgICAgb2JzZXJ2ZXI6IG9ic2VydmVyXG4gICAgICB9O1xuXG4gICAgICB0aGlzLl9sb2dnZXIuaW5mbyggYGV4ZWN1dGUgdGhlIGFkZGVkIHJlcXVlc3QgJyR7bmV3UG9sbElkfSdgKTtcbiAgICAgIGxldCBpbml0aWFsUmVxdWVzdCA9IHRoaXMuX3F1ZXJ5UG9sbEl0ZW1zKFtuZXdQb2xsSXRlbV0pXG4gICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgKCkgPT5cbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgaW5pdGlhbFJlcXVlc3QgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgbmV3UG9sbEl0ZW0ucXVlcnlFbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuX3NldHVwUXVldWVUaW1lcigpO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAoKSA9PlxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBpbml0aWFsUmVxdWVzdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBuZXdQb2xsSXRlbS5xdWVyeUVuYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0dXBRdWV1ZVRpbWVyKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBzdG9wIHBvbGxpbmcgZm9yICR7bmV3UG9sbElkfWApO1xuICAgICAgICAgIGlmIChpbml0aWFsUmVxdWVzdCkge1xuICAgICAgICAgICAgICBpbml0aWFsUmVxdWVzdC51bnN1YnNjcmliZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBkZWxldGUgdGhpcy5fcG9sbFF1ZXVlW25ld1BvbGxJZF07XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==