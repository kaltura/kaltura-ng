import { XmlToJSON } from './xml-to-json';
import { KalturaUtils } from '../utils/kaltura-utils';
function convertAttributes(attributes) {
    var parsedAttributes = '';
    if (attributes) {
        Object.keys(attributes).forEach(function (attributeName) {
            var value = KalturaUtils.escapeXml(attributes[attributeName]);
            parsedAttributes += " " + attributeName + "=\"" + value + "\"";
        });
    }
    return parsedAttributes;
}
function convertObjectToXml(prefix, propertyName, propertyValue) {
    var result = "";
    var noPrefixPropertyName = (propertyName || '').indexOf('noprefix:') !== -1;
    if (noPrefixPropertyName) {
        propertyName = propertyName.replace('noprefix:', '');
        prefix = '';
    }
    if (Array.isArray(propertyValue)) {
        propertyValue.forEach(function (innerItem) {
            result += convertObjectToXml(prefix, propertyName, innerItem);
        });
    }
    else if (propertyValue && typeof propertyValue === 'object') {
        var parsedAttributes = convertAttributes(propertyValue['attr']);
        var parsedValue_1 = '';
        if (propertyValue['text']) {
            parsedValue_1 = KalturaUtils.escapeXml(propertyValue['text']);
        }
        else {
            Object.keys(propertyValue).forEach(function (innerProperty) {
                if (innerProperty !== 'attr') {
                    parsedValue_1 += convertObjectToXml(prefix, innerProperty, propertyValue[innerProperty]);
                }
            });
        }
        result += "<" + prefix + propertyName;
        if (parsedAttributes) {
            result += parsedAttributes + ">";
        }
        else {
            result += '>';
        }
        result += parsedValue_1 + "</" + prefix + propertyName + ">";
    }
    return result;
}
var XmlParser = /** @class */ (function () {
    function XmlParser() {
    }
    XmlParser.toJson = function (xml) {
        return XmlToJSON.parseString(xml, {
            textKey: 'text',
            valueKey: 'value',
            attrKey: 'attr',
            cdataKey: 'cdata',
            childrenAsArray: false,
            grokText: false,
            grokAttr: false,
            normalize: false,
        });
    };
    XmlParser.toXml = function (data, root, prefix) {
        if (prefix === void 0) { prefix = ''; }
        var parsedPrefix = prefix ? prefix + ":" : '';
        var parsedObject = '';
        var parsedAttributes = '';
        if (data) {
            parsedAttributes = convertAttributes(data['attr']);
            Object.keys(data).forEach(function (property) {
                if (property !== 'attr') {
                    parsedObject += convertObjectToXml(parsedPrefix, property, data[property]);
                }
            });
        }
        return "<" + parsedPrefix + root + parsedAttributes + ">" + parsedObject + "</" + parsedPrefix + root + ">";
    };
    XmlParser.toSimpleXml = function (data, config) {
        if (config === void 0) { config = {}; }
        var result = '';
        var _parseValueToXml = function (value) {
            var result;
            if (typeof value === 'object') {
                result = XmlParser.toSimpleXml(value, config);
            }
            else {
                result = KalturaUtils.escapeXml(value);
            }
            return result;
        };
        if (data) {
            Object.keys(data).forEach(function (key) {
                var propertyValue = data[key];
                var isEmptyValue = (propertyValue === null || typeof propertyValue === 'undefined' || propertyValue === '');
                if (!config.removeEmpty || (config.removeEmpty && !isEmptyValue)) {
                    if (propertyValue instanceof Array) {
                        propertyValue.map(function (arrayItem) {
                            var valueAsXml = _parseValueToXml(arrayItem);
                            var isEmptyValue = (valueAsXml === null || typeof valueAsXml === 'undefined' || valueAsXml === '');
                            if (!config.removeEmpty || (config.removeEmpty && !isEmptyValue)) {
                                result += "<" + key + ">" + valueAsXml + "</" + key + ">";
                            }
                        });
                    }
                    else if (typeof propertyValue === 'object') {
                        var valueAsXml = _parseValueToXml(propertyValue);
                        var isEmptyValue_1 = (valueAsXml === null || typeof valueAsXml === 'undefined' || valueAsXml === '');
                        if (!config.removeEmpty || (config.removeEmpty && !isEmptyValue_1)) {
                            result += "<" + key + ">" + valueAsXml + "</" + key + ">";
                        }
                    }
                    else {
                        var value = KalturaUtils.escapeXml(propertyValue);
                        result += "<" + key + ">" + value + "</" + key + ">";
                    }
                }
            });
        }
        return result;
    };
    return XmlParser;
}());
export { XmlParser };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieG1sLXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3htbC1wYXJzZXIveG1sLXBhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUl0RCxTQUFTLGlCQUFpQixDQUFDLFVBQWtCO0lBQzNDLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0lBQzFCLElBQUksVUFBVSxFQUFFO1FBQ2QsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxhQUFhO1lBQzNDLElBQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7WUFDaEUsZ0JBQWdCLElBQUksTUFBSSxhQUFhLFdBQUssS0FBSyxPQUFHLENBQUM7UUFDckQsQ0FBQyxDQUFDLENBQUM7S0FDSjtJQUVELE9BQU8sZ0JBQWdCLENBQUM7QUFDMUIsQ0FBQztBQUVELFNBQVMsa0JBQWtCLENBQUMsTUFBYyxFQUFFLFlBQW9CLEVBQUUsYUFBa0I7SUFDaEYsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO0lBRWhCLElBQU0sb0JBQW9CLEdBQUcsQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQzlFLElBQUksb0JBQW9CLEVBQUU7UUFDeEIsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3JELE1BQU0sR0FBRyxFQUFFLENBQUM7S0FDYjtJQUVELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsRUFBRTtRQUM5QixhQUFhLENB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Q0w7eUJBQU0sSUFBSSxPQUFPLGFBQWEsS0FBSyxRQUFRLEVBQUU7d0JBQzFDLElBQU0sVUFBVSxHQUFHLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxDQUFDO3dCQUNuRCxJQUFNLGNBQVksR0FBRyxDQUFDLFVBQVUsS0FBSyxJQUFJLElBQUksT0FBTyxVQUFVLEtBQUssV0FBVyxJQUFJLFVBQVUsS0FBSyxFQUFFLENBQUMsQ0FBQzt3QkFFckcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxJQUFJLENBQUMsY0FBWSxDQUFDLEVBQUU7NEJBQzlELE1BQU0sSUFBSSxNQUFJLEdBQUcsU0FBSSxVQUFVLFVBQUssR0FBRyxNQUFHLENBQUM7eUJBQzlDO3FCQUNKO3lCQUNJO3dCQUNELElBQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7d0JBQ3BELE1BQU0sSUFBSSxNQUFJLEdBQUcsU0FBSSxLQUFLLFVBQUssR0FBRyxNQUFHLENBQUM7cUJBQ3pDO2lCQUNKO1lBQ0wsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFDTCxnQkFBQztBQUFELENBQUMsQUFwRkQsSUFvRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBYbWxUb0pTT04gfSBmcm9tICcuL3htbC10by1qc29uJztcbmltcG9ydCB7IEthbHR1cmFVdGlscyB9IGZyb20gJy4uL3V0aWxzL2thbHR1cmEtdXRpbHMnO1xuXG5cblxuZnVuY3Rpb24gY29udmVydEF0dHJpYnV0ZXMoYXR0cmlidXRlczogb2JqZWN0KTogc3RyaW5nIHtcbiAgbGV0IHBhcnNlZEF0dHJpYnV0ZXMgPSAnJztcbiAgaWYgKGF0dHJpYnV0ZXMpIHtcbiAgICBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKS5mb3JFYWNoKGF0dHJpYnV0ZU5hbWUgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBLYWx0dXJhVXRpbHMuZXNjYXBlWG1sKGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pO1xuICAgICAgcGFyc2VkQXR0cmlidXRlcyArPSBgICR7YXR0cmlidXRlTmFtZX09XCIke3ZhbHVlfVwiYDtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBwYXJzZWRBdHRyaWJ1dGVzO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0T2JqZWN0VG9YbWwocHJlZml4OiBzdHJpbmcsIHByb3BlcnR5TmFtZTogc3RyaW5nLCBwcm9wZXJ0eVZhbHVlOiBhbnkpOiBzdHJpbmcge1xuICAgIGxldCByZXN1bHQgPSBgYDtcblxuICAgIGNvbnN0IG5vUHJlZml4UHJvcGVydHlOYW1lID0gKHByb3BlcnR5TmFtZSB8fCAnJykuaW5kZXhPZignbm9wcmVmaXg6JykgIT09IC0xO1xuICAgIGlmIChub1ByZWZpeFByb3BlcnR5TmFtZSkge1xuICAgICAgcHJvcGVydHlOYW1lID0gcHJvcGVydHlOYW1lLnJlcGxhY2UoJ25vcHJlZml4OicsICcnKTtcbiAgICAgIHByZWZpeCA9ICcnO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHByb3BlcnR5VmFsdWUpKSB7XG4gICAgICAgIHByb3BlcnR5VmFsdWUuZm9yRWFjaChpbm5lckl0ZW0gPT5cbiAgICAgICAge1xuICAgICAgICAgICAgcmVzdWx0ICs9IGNvbnZlcnRPYmplY3RUb1htbChwcmVmaXgsIHByb3BlcnR5TmFtZSwgaW5uZXJJdGVtKTtcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChwcm9wZXJ0eVZhbHVlICYmIHR5cGVvZiBwcm9wZXJ0eVZhbHVlID09PSAnb2JqZWN0Jykge1xuXG4gICAgICAgIGNvbnN0IHBhcnNlZEF0dHJpYnV0ZXMgPSBjb252ZXJ0QXR0cmlidXRlcyhwcm9wZXJ0eVZhbHVlWydhdHRyJ10pO1xuICAgICAgICBsZXQgcGFyc2VkVmFsdWU6IGFueSA9ICcnO1xuXG4gICAgICAgIGlmIChwcm9wZXJ0eVZhbHVlWyd0ZXh0J10pIHtcbiAgICAgICAgICAgIHBhcnNlZFZhbHVlID0gS2FsdHVyYVV0aWxzLmVzY2FwZVhtbChwcm9wZXJ0eVZhbHVlWyd0ZXh0J10pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgT2JqZWN0LmtleXMocHJvcGVydHlWYWx1ZSkuZm9yRWFjaChpbm5lclByb3BlcnR5ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wZXJ0eSAhPT0gJ2F0dHInKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZFZhbHVlICs9IGNvbnZlcnRPYmplY3RUb1htbChwcmVmaXgsIGlubmVyUHJvcGVydHksIHByb3BlcnR5VmFsdWVbaW5uZXJQcm9wZXJ0eV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVzdWx0ICs9IGA8JHtwcmVmaXh9JHtwcm9wZXJ0eU5hbWV9YDtcblxuICAgICAgICBpZiAocGFyc2VkQXR0cmlidXRlcykge1xuICAgICAgICAgICAgcmVzdWx0ICs9IGAke3BhcnNlZEF0dHJpYnV0ZXN9PmA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQgKz0gJz4nO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVzdWx0ICs9IGAke3BhcnNlZFZhbHVlfTwvJHtwcmVmaXh9JHtwcm9wZXJ0eU5hbWV9PmA7XG4gICAgfVxuXG5cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgY2xhc3MgWG1sUGFyc2VyXG57XG4gICAgc3RhdGljIHRvSnNvbih4bWwgOiBzdHJpbmcpIDoge31cbiAgICB7XG4gICAgICAgIHJldHVybiBYbWxUb0pTT04ucGFyc2VTdHJpbmcoeG1sLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRleHRLZXk6ICd0ZXh0JywgXHQvLyB0YWcgbmFtZSBmb3IgdGV4dCBub2Rlc1xuICAgICAgICAgICAgICAgIHZhbHVlS2V5OiAndmFsdWUnLCBcdC8vIHRhZyBuYW1lIGZvciBhdHRyaWJ1dGUgdmFsdWVzXG4gICAgICAgICAgICAgICAgYXR0cktleTogJ2F0dHInLCBcdC8vIHRhZyBmb3IgYXR0ciBncm91cHNcbiAgICAgICAgICAgICAgICBjZGF0YUtleTogJ2NkYXRhJyxcdC8vIHRhZyBmb3IgY2RhdGEgbm9kZXMgKGlnbm9yZWQgaWYgbWVyZ2VDREFUQSBpcyB0cnVlKVxuICAgICAgICAgICAgICAgIGNoaWxkcmVuQXNBcnJheTogZmFsc2UsIFx0Ly8gZm9yY2UgY2hpbGRyZW4gaW50byBhcnJheXNcblx0ICAgICAgICAgICAgZ3Jva1RleHQ6IGZhbHNlLFxuXHQgICAgICAgICAgICBncm9rQXR0cjogZmFsc2UsXG4gICAgICAgICAgICAgIG5vcm1hbGl6ZTogZmFsc2UsXG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgdG9YbWwoZGF0YTogb2JqZWN0LCByb290OiBzdHJpbmcsIHByZWZpeDogc3RyaW5nID0gJycpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBwYXJzZWRQcmVmaXggPSBwcmVmaXggPyBgJHtwcmVmaXh9OmAgOiAnJztcbiAgICAgICAgbGV0IHBhcnNlZE9iamVjdCA9ICcnO1xuICAgICAgICBsZXQgcGFyc2VkQXR0cmlidXRlcyA9ICcnO1xuXG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBwYXJzZWRBdHRyaWJ1dGVzID0gY29udmVydEF0dHJpYnV0ZXMoZGF0YVsnYXR0ciddKTtcblxuICAgICAgICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChwcm9wZXJ0eSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5ICE9PSAnYXR0cicpIHtcbiAgICAgICAgICAgICAgICAgICBwYXJzZWRPYmplY3QgKz0gY29udmVydE9iamVjdFRvWG1sKHBhcnNlZFByZWZpeCwgcHJvcGVydHksIGRhdGFbcHJvcGVydHldKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGA8JHtwYXJzZWRQcmVmaXh9JHtyb290fSR7cGFyc2VkQXR0cmlidXRlc30+JHtwYXJzZWRPYmplY3R9PC8ke3BhcnNlZFByZWZpeH0ke3Jvb3R9PmA7XG4gICAgfVxuXG4gICAgc3RhdGljIHRvU2ltcGxlWG1sKGRhdGEgOiB7fSwgY29uZmlnIDoge3JlbW92ZUVtcHR5PyA6IGJvb2xlYW59ID0ge30pIDogc3RyaW5ne1xuICAgICAgICBsZXQgcmVzdWx0ID0gJyc7XG4gICAgICAgIGNvbnN0IF9wYXJzZVZhbHVlVG9YbWwgPSAodmFsdWUgOiBhbnkpID0+XG4gICAgICAgIHtcbiAgICAgICAgICAgIGxldCByZXN1bHQgOiBzdHJpbmc7XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gWG1sUGFyc2VyLnRvU2ltcGxlWG1sKHZhbHVlLCBjb25maWcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gS2FsdHVyYVV0aWxzLmVzY2FwZVhtbCh2YWx1ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb3BlcnR5VmFsdWUgPSBkYXRhW2tleV07XG4gICAgICAgICAgICAgICAgY29uc3QgaXNFbXB0eVZhbHVlID0gKHByb3BlcnR5VmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHByb3BlcnR5VmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHByb3BlcnR5VmFsdWUgPT09ICcnKTtcblxuICAgICAgICAgICAgICAgIGlmICghY29uZmlnLnJlbW92ZUVtcHR5IHx8IChjb25maWcucmVtb3ZlRW1wdHkgJiYgIWlzRW1wdHlWYWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5VmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlWYWx1ZS5tYXAoYXJyYXlJdGVtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUFzWG1sID0gX3BhcnNlVmFsdWVUb1htbChhcnJheUl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzRW1wdHlWYWx1ZSA9ICh2YWx1ZUFzWG1sID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZUFzWG1sID09PSAndW5kZWZpbmVkJyB8fCB2YWx1ZUFzWG1sID09PSAnJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5yZW1vdmVFbXB0eSB8fCAoY29uZmlnLnJlbW92ZUVtcHR5ICYmICFpc0VtcHR5VmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSBgPCR7a2V5fT4ke3ZhbHVlQXNYbWx9PC8ke2tleX0+YDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm9wZXJ0eVZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVBc1htbCA9IF9wYXJzZVZhbHVlVG9YbWwocHJvcGVydHlWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0VtcHR5VmFsdWUgPSAodmFsdWVBc1htbCA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWVBc1htbCA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWVBc1htbCA9PT0gJycpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5yZW1vdmVFbXB0eSB8fCAoY29uZmlnLnJlbW92ZUVtcHR5ICYmICFpc0VtcHR5VmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IGA8JHtrZXl9PiR7dmFsdWVBc1htbH08LyR7a2V5fT5gO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBLYWx0dXJhVXRpbHMuZXNjYXBlWG1sKHByb3BlcnR5VmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IGA8JHtrZXl9PiR7dmFsdWV9PC8ke2tleX0+YDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG59XG4iXX0=