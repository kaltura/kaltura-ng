!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs/BehaviorSubject"),require("rxjs"),require("rxjs/add/operator/groupBy"),require("@angular/common")):"function"==typeof define&&define.amd?define("@kaltura-ng/kaltura-common",["exports","@angular/core","rxjs/BehaviorSubject","rxjs","rxjs/add/operator/groupBy","@angular/common"],t):t(((e=e||self)["kaltura-ng"]=e["kaltura-ng"]||{},e["kaltura-ng"]["kaltura-common"]={}),e.ng.core,e.rxjs.BehaviorSubject,e.rxjs,e.rxjs["add/operator/groupBy"],e.ng.common)}(this,(function(e,t,r,n,a,o){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function s(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function u(e,t,r,n){var a,o=arguments.length,i=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(a=e[s])&&(i=(o<3?a(i):o>3?a(t,r,i):a(t,r))||i);return o>3&&i&&Object.defineProperty(t,r,i),i}function l(e,t){return function(r,n){t(r,n,e)}}function c(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function p(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,o=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return i}function d(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}var f=function(){function e(){}return e.register=function(e){this._operationsTagManager=e},e.increase=function(e){this._operationsTagManager&&this._operationsTagManager.increase(e)},e.decrease=function(e){this._operationsTagManager&&this._operationsTagManager.decrease(e)},e._operationsTagManager=null,e}(),g=function(){function e(){this._tagStatus=new r.BehaviorSubject({}),this.tagStatus$=this._tagStatus.asObservable()}return e.prototype.increase=function(e){var t=this._tagStatus.getValue();t[e]||(t[e]=0),t[e]++,this._tagStatus.next(t)},e.prototype.decrease=function(e){var t=this._tagStatus.getValue();t[e]>0?(t[e]--,this._tagStatus.next(t)):(t[e]=0,this._tagStatus.next(t))},e=u([t.Injectable(),c("design:paramtypes",[])],e)}(),h=function(){function e(e){e&&f.register(e)}var r;return r=e,e.forRoot=function(){return{ngModule:r,providers:[g]}},e.ctorParameters=function(){return[{type:g,decorators:[{type:t.Self},{type:t.Optional}]}]},e=r=u([t.NgModule({imports:[],declarations:[],exports:[],providers:[]}),l(0,t.Self()),l(0,t.Optional()),c("design:paramtypes",[g])],e)}(),_=function(){function e(){}return e.generate=function(t){return e.defaultInstance||(e.defaultInstance=new e),e.defaultInstance.generate(t)},e.prototype.generate=function(e){for(var t=e||{},r=t.alphabet||"23456789abdegjkmnpqrvwxyz",n=t.idLength||5,a="",o=0;o<n;o++)a+=r.charAt(Math.floor(Math.random()*r.length));return a},e.prototype.generateUnique=function(e){e=e||[];for(var t,r=0;!t&&r<9999;)t=this.generate(),-1!==e.indexOf(t)&&(t=null,r++);return t},e.defaultInstance=null,e}(),y=new t.InjectionToken("kaltura-logger"),m=function(){function e(){}return e.prototype.trace=function(e,t){},e.prototype.debug=function(e,t){},e.prototype.info=function(e,t){},e.prototype.warn=function(e,t){},e.prototype.error=function(e,t){},e.prototype.fatal=function(e,t){},e.prototype.subLogger=function(t){return new e},e}(),v=function(){function e(e){this._pollQueue={},this._tokenGenerator=new _,this._missingDestoryHandling=!1,this._subscriptions=[],this._state=new r.BehaviorSubject({busy:!1}),this.state$=this._state.asObservable(),this._queueInterval=null,this._logger=e||new m,this._initialize()}return e.prototype._warnAboutMissingDestory=function(){this._logger.error("calling method '_getOnDestroy$()' didn't return valid observable (did you remember to provide 'Observable' that will be invoked from ngOnDestroy method?)")},e.prototype._initialize=function(){var e=this;this._logger.trace("_initialize()"),setTimeout((function(){var t=e._getOnDestroy$();t?t.subscribe((function(){e._logger.trace("onDestroy$.subscribe()"),e._cancelQueueInterval(),e._subscriptions.forEach((function(e){e.unsubscribe()})),e._subscriptions=[]})):(e._missingDestoryHandling=!0,e._warnAboutMissingDestory())}))},e.prototype._cancelQueueInterval=function(){clearTimeout(this._queueTimeout)},e.prototype._getPollQueueList=function(){var e=this;return Object.keys(this._pollQueue).map((function(t){return e._pollQueue[t]}))},e.prototype._setupQueueTimer=function(){var e=this;this._cancelQueueInterval();var t=this._getPollQueueList();if(this._missingDestoryHandling&&this._warnAboutMissingDestory(),t.length){var r=null;t.some((function(e){return!!e.lastExecution}))||(r=Math.min.apply(Math,d(t.map((function(e){return e.interval}))))/2),r=r&&r>10?r:10,this._queueInterval!==r&&(this._logger.info("updating queue interval to poll server every "+r+" seconds"),this._queueInterval=r),this._queueTimeout=setTimeout((function(){e._onQueueTimerTick()}),1e3*this._queueInterval)}else this._logger.info("no actions found in the queue. suspending interval until an action will be added")},e.prototype.forcePolling=function(){var e=this;this._logger.info("force server polling requested"),this._cancelQueueInterval(),this._subscriptions.forEach((function(e){e.unsubscribe()})),this._subscriptions=[],this._getPollQueueList().forEach((function(e){return e.queryEnabled=!0}));this._queryPollItems(this._getPollQueueList()).subscribe((function(){return e._setupQueueTimer()}),(function(){return e._setupQueueTimer()}))},e.prototype._queryPollItems=function(e){var t=this;return n.Observable.create((function(r){if(t._logger.debug("execute server polling"),!t._canExecute()||!e||0===e.length)return t._logger.debug("execute server polling ignored, cannot execute request or no items provided to query"),void r.next(void 0);var n=e.map((function(e){var r,n;try{r=e.requestFactory.create()}catch(a){t._logger.error("failed to create a request for '"+e.id+"'. got the following error : '"+a.message+"'"),r=null,n=t._createGlobalError(a)}return n&&t._propagateServerResponse(e,{error:n,result:null}),r?{pollItem:e,request:r}:null})).filter(Boolean);if(t._logger.info("executing server poll for "+n.length+" items"),n.length){var a=t._executeRequests(n.map((function(e){return e.request}))).subscribe((function(e){t._removeSubscription(a),t._logger.info("got "+e.length+" responses. propagate responses to relevant actions"),n.forEach((function(r,n){var a=r.pollItem,o=e[n];Array.isArray(o)&&(o={result:o,error:null}),t._propagateServerResponse(a,o)})),r.next(void 0)}),(function(e){t._logger.error("failed to query the server. got the following error : '"+e.message+"'"),t._removeSubscription(a);var o={error:t._createGlobalError(e),result:null};n.forEach((function(e){var r=e.pollItem;t._propagateServerResponse(r,o)})),r.next(void 0)}));return t._subscriptions.push(a),function(){t._removeSubscription(a)}}r.next(void 0)}))},e.prototype._removeSubscription=function(e){if(e){var t=this._subscriptions.indexOf(e);t>-1&&this._subscriptions.splice(t,1)}},e.prototype._onQueueTimerTick=function(){var e=this;if(!this._canExecute())return this._setupQueueTimer(),void this._logger.trace("_onQueueTimerTick(): canExecute() check failed. ignore current execution");this._logger.debug("prepare server poll request");var t=Number(new Date),r=this._getPollQueueList().filter((function(e){return e.queryEnabled&&(!e.lastExecution||Number(e.lastExecution)+1e3*e.interval<=t)}));if(!r.length)return this._logger.debug("nothing to run. Waiting next tick..."),void this._setupQueueTimer();this._logger.info("set busy mode to true"),this._state.next({busy:!0}),this._queryPollItems(r).subscribe((function(){e._state.next({busy:!1}),e._setupQueueTimer()}),(function(t){e._state.next({busy:!1})}))},e.prototype._propagateServerResponse=function(e,t){try{this._pollQueue[e.id]?(this._logger.debug("propagating response for "+e.id),e.lastExecution=new Date,e.observer.next(t)):this._logger.info("cannot find registered action for '"+e.id+" (it might indicate that this action was unsubscribed while a request to the server was executed)")}catch(t){this._logger.warn("error happened while propagating response of '"+e.id+"'.ignoring error. got the following error: "+t.message)}},e.prototype.isBusy=function(){return this._state.getValue().busy},e.prototype.register=function(e,t){var r=this;return n.Observable.create((function(n){var a=r._tokenGenerator.generateUnique(Object.keys(r._pollQueue));r._logger.info("register new poll request "+a+" (interval = "+e+" seconds)");var o=r._pollQueue[a]={id:a,interval:e,lastExecution:null,queryEnabled:!1,requestFactory:t,observer:n};r._logger.info("execute the added request '"+a+"'");var i=r._queryPollItems([o]).subscribe((function(){i=null,o.queryEnabled=!0,r._setupQueueTimer()}),(function(){i=null,o.queryEnabled=!0,r._setupQueueTimer()}));return function(){r._logger.info("stop polling for "+a),i&&i.unsubscribe(),delete r._pollQueue[a]}}))},e}(),b=function(){function e(){}return e.added="added",e.pendingPrepare="pendingPrepare",e.preparing="preparing",e.prepared="prepared",e.pendingUpload="waitingUpload",e.uploading="uploading",e.uploadCompleted="uploadCompleted",e.failure="failure",e.cancelled="cancelled",e.purged="purged",e}(),w=function(){function e(e,t){this.status=b.added,this.progress=0,this.uploadCompleteAt=null,this.uploadOrder=0,this._statusHistory={added:!0},this._id=e,this.data=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),e.prototype.asData=function(){return{id:this.id,status:this.status,uploadStartAt:this.uploadStartAt,progress:this.progress,uploadCompleteAt:this.uploadCompleteAt,uploadOrder:this.uploadOrder,failureType:this.failureType,failureReason:this.failureReason,data:this.data}},e.prototype.update=function(e){if(e.status&&e.status!==this.status){if(!this.canTransitionTo(e.status))throw new Error("file "+this.id+": cannot update status to '"+e.status+"'");this._statusHistory[e.status]=!0}Object.assign(this,e)},e.prototype.wasInStatus=function(e){return!!this._statusHistory[e]},e.prototype.canTransitionTo=function(e){var t=!1,r=this?this.status:null;if(this&&r&&e)switch(r===b.purged&&(t=!1),e){case b.added:t=!this.wasInStatus(b.added);break;case b.pendingPrepare:t=!this.wasInStatus(b.prepared);break;case b.preparing:t=!this.wasInStatus(b.prepared)&&r===b.pendingPrepare;break;case b.prepared:t=!this.wasInStatus(b.prepared)&&r===b.preparing;break;case b.pendingUpload:t=this.wasInStatus(b.prepared)&&!this.wasInStatus(b.uploadCompleted);break;case b.uploading:t=!this.wasInStatus(b.uploadCompleted)&&r===b.pendingUpload;break;case b.uploadCompleted:t=!this.wasInStatus(b.uploadCompleted)&&r===b.uploading;break;case b.cancelled:t=-1===[b.cancelled,b.uploadCompleted,b.purged].indexOf(r);break;case b.failure:t=-1===[b.uploadCompleted,b.purged].indexOf(r);break;case b.purged:t=!this.wasInStatus(b.purged);break;default:throw new Error("unknown status provided '"+e+"'")}return t},e}(),T=Symbol("__ngOnDestroySource__"),x=Symbol("__ngOnDestroy__");function k(e,t){return function(r){return r.lift(new S(e,t))}}var S=function(){function e(e,t){this.instance=e,this.manualDestroy=t,e.ngOnDestroy&&(e[T]||(e[T]=new n.Subject,e[x]=e.ngOnDestroy,e.ngOnDestroy=function(){this[x].apply(this,arguments),this[T].next(),this[T].complete()}))}return e.prototype.call=function(e,t){return t.subscribe(new U(e,this.instance,this.manualDestroy))},e}(),U=function(e){function t(t,r,a){var o=e.call(this,t)||this;o._instance=r,o.manualDestroy=a;var i=a?n.merge(a,r[T]):r[T].asObservable();return o.add(i.subscribe((function(){t.unsubscribe()}))),o}return s(t,e),t}(n.Subscriber);var F,O,A,E,I,j,q=function(){function e(e){this._tag=e}return e.prototype.call=function(e,t){return t.subscribe(new D(e,this._tag))},e}(),D=function(e){function t(t,r){var n=e.call(this,t)||this;return n._tag=r,n._isDecreased=!1,f.increase(n._tag),n}return s(t,e),t.prototype._error=function(t){this._tag&&!this._isDecreased&&(this._isDecreased=!0,f.decrease(this._tag)),e.prototype._error.call(this,t)},t.prototype._complete=function(){this._tag&&!this._isDecreased&&(this._isDecreased=!0,f.decrease(this._tag)),e.prototype._complete.call(this)},t.prototype.unsubscribe=function(){this.closed||!this._tag||this._isDecreased||(this._isDecreased=!0,f.decrease(this._tag)),e.prototype.unsubscribe.call(this)},t}(n.Subscriber),P=new t.InjectionToken("upload-file-adapter"),R=function(){function e(e){this._uploadFileAdapter=e,this._trackedFiles={},this._onTrackedFileChanged=new n.Subject,this._maxUploadRequests=null,this.onTrackedFileChanged$=this._onTrackedFileChanged.asObservable(),this._tokenGenerator=new _}return e.prototype.setMaxUploadRequests=function(e){null===e||e>0?(this._log("info","limit max upload requests to "+e),this._maxUploadRequests=e):(this._log("info","remove max upload limitation"),this._maxUploadRequests=null)},e.prototype._log=function(e,t,r){var n="log: ["+e+"] [upload manager] "+(r?"file '"+r+"'":"")+": "+t;switch(e){case"silly":case"debug":case"info":console.log(n);break;case"warn":console.warn(n);break;case"error":console.error(n)}},e.prototype.getTrackedFiles=function(){var e=this;return Object.keys(this._trackedFiles).map((function(t){return e._trackedFiles[t].asData()}))},e.prototype.getTrackedFile=function(e){var t=this._trackedFiles[e];return t?t.asData():null},e.prototype.addFile=function(e){return p(this.addFiles([e]),1)[0]},e.prototype.addFiles=function(e){var t=this,r=[];return e.forEach((function(e){var n=t._tokenGenerator.generateUnique(Object.keys(t._trackedFiles));t._log("info","add new file '"+e.getFileName()+"' to queue with unique file id",n),t._createTrackedFile(n,e),r.push({id:n,data:e})})),r.length&&this._syncUploadQueue(),r},e.prototype.cancelUploadWithError=function(e,t){this._log("info","cancel file upload with custom reason '"+t+"'",e);var r=this._trackedFiles[e];r?r.canTransitionTo(b.cancelled)&&(this.cancelUpload(e,!1),r.canTransitionTo(b.failure)&&this._updateTrackedFile(r,{status:b.failure,failureReason:t||"unknown error",failureType:"manual_error"})):this._log("warn","cannot cancel upload, failed to find file with provided id",e)},e.prototype.resumeUpload=function(e){this.resumeUploads([e])},e.prototype.resumeUploads=function(e){var t=this;e.forEach((function(e){t._log("info","resume file upload.",e);var r=t._trackedFiles[e];r?r.wasInStatus(b.prepared)?t._updateTrackedFile(r,{status:b.pendingUpload}):t._updateTrackedFile(r,{status:b.pendingPrepare}):t._log("warn","cannot resume upload, failed to find file with provided id",e)})),this._syncUploadQueue()},e.prototype.cancelUpload=function(e,t){void 0===t&&(t=!0),this._log("info","cancel file upload.",e);var r=this._trackedFiles[e];r?r.status!==b.cancelled&&r.canTransitionTo(b.cancelled)&&(r.uploadSubscription&&(r.uploadSubscription.unsubscribe(),r.uploadSubscription=null),this._updateTrackedFile(r,{status:b.cancelled}),t&&this.purgeUpload(e),this._syncUploadQueue()):this._log("warn","cannot cancel upload, failed to find file with provided id",e)},e.prototype.purgeUpload=function(e){this._log("info","purge file from queue.",e);var t=this._trackedFiles[e];t?t.canTransitionTo(b.purged)&&(this.cancelUpload(e,!1),this._updateTrackedFile(t,{status:b.purged}),this._removeTrackedFile(t)):this._log("warn","cannot purge upload, failed to find file with provided id",e)},e.prototype._removeTrackedFile=function(e){this._log("info","remove tracked file from queue",e.id),e.uploadSubscription&&(e.uploadSubscription.unsubscribe(),e.uploadSubscription=null),delete this._trackedFiles[e.id]},e.prototype._syncUploadQueue=function(){var e=this;this.syncUploadQueueTimeoutId&&(clearTimeout(this.syncUploadQueueTimeoutId),this.syncUploadQueueTimeoutId=null),this.syncUploadQueueTimeoutId=setTimeout((function(){e._log("info","syncing upload queue"),e.syncUploadQueueTimeoutId=null,e._executePreparePhase(),e._executeUploadPhase()}),200)},e.prototype._executePreparePhase=function(){var e=this,t=Object.keys(this._trackedFiles).map((function(t){return e._trackedFiles[t]})).filter((function(e){return e.status===b.pendingPrepare&&e.canTransitionTo(b.preparing)}));t.length&&(this._log("info","handling "+t.length+" files, waiting to be prepared"),t.reduce((function(t,r){var n=e._getUploadAdapter(r.data)||null,a=t.find((function(e){return e.adapter?e.adapter.constructor===n.constructor:null===e.adapter}));return a?a.files.push(r):t.push({adapter:n,files:[r]}),t}),[]).forEach((function(t){t.adapter?(e._log("debug","executing prepare phase for "+t.files.length+" files with adapter '"+t.adapter.label+"'"),t.files.forEach((function(t){e._updateTrackedFile(t,{status:b.preparing})})),t.adapter.prepare(t.files).pipe(k(e)).subscribe((function(r){e._log("debug","executing prepare phase succeeded for "+t.files.length+" files with adapter '"+t.adapter.label+"'."),e._handlePrepareAdapterResponse(r),e._syncUploadQueue()}),(function(r){e._log("error","executing prepare phase failed for "+t.files.length+" files with adapter '"+t.adapter.label+"'. error: "+r.message),e._handlePrepareAdapterResponse(t.files.map((function(e){return{id:e.id,status:!1}}))),e._syncUploadQueue()}))):t.files.forEach((function(t){e._updateTrackedFile(t,{status:b.failure,failureReason:"upload destination is not supported",failureType:"unknown_destination"})}))})))},e.prototype._handlePrepareAdapterResponse=function(e){var t=this;e.forEach((function(e){var r=t._trackedFiles[e.id];if(r)if(r.status!==b.preparing)t._log("warn","cannot handle file result from prepare action (did the user cancel the file upload during the prepare execution?)",r.id);else if(e.status){t._updateTrackedFile(r,{status:b.prepared})&&t._updateTrackedFile(r,{status:b.pendingUpload})}else t._updateTrackedFile(r,{status:b.failure,failureReason:"failed to prepare upload",failureType:"preparation_failed"});else t._log("warn","cannot handle prepare response for file '"+e.id+"' since there is no tracking information for that file (did the user purge the file during the prepare execution?)")}))},e.prototype._executeUploadPhase=function(){var e=this,t=[],r=[];Object.keys(this._trackedFiles).forEach((function(n){var a=e._trackedFiles[n];a.status===b.uploading?r.push(a):a.status===b.pendingUpload&&a.canTransitionTo(b.uploading)&&t.push(a)}));var n=r.length,a=t.length;if(a>0){var o=[];this._log("silly","active uploads: "+n+" | pending files: "+a);var i=this._maxUploadRequests&&this._maxUploadRequests>0?this._maxUploadRequests-n:a;i>0&&(o=d(t.sort((function(e){return e.uploadOrder||1e3}))).slice(0,i)),this._log("debug","available upload slots to be used "+i),o.forEach((function(t){e._initiateUpload(t)}))}},e.prototype._createTrackedFile=function(e,t){var r=this._trackedFiles[e]=new w(e,t);this._onTrackedFileChanged.next(r.asData()),this._updateTrackedFile(r,{status:b.pendingPrepare})},e.prototype._updateTrackedFile=function(e,t){var r=!0;return t.status&&t.status!==e.status?e.canTransitionTo(t.status)?(this._log("info","notify file status changes from '"+e.status+"' to '"+t.status+"'",e.id),e.update(t)):(this._log("error","cannot update file data from '"+e.status+"' to '"+t.status+". target status is not allowed. update to status 'failure' instead.",e.id),e.update({status:b.failure,failureReason:"cannot change status",failureType:"change_not_allowed"}),r=!1):e.update(t),this._onTrackedFileChanged.next(e.asData()),r},e.prototype.supportChunkUpload=function(e){var t=this._getUploadAdapter(e);return!!t&&t.supportChunkUpload()},e.prototype._initiateUpload=function(e){var t=this,r=e.data,n=e.id,a=this._getUploadAdapter(r);if(this._log("info","initiate new upload for file '"+n+"'"),a){if(e.canTransitionTo(b.uploading)){e.uploadSubscription&&(this._log("warn","an active upload was found while the status indicated no upload currently in progress. cancel previous upload"),e.uploadSubscription.unsubscribe(),e.uploadSubscription=null),this._updateTrackedFile(e,{status:b.uploading,progress:0,uploadStartAt:new Date});var o=function(r,n){var a=!1;return!!t._trackedFiles[r]?e.status!==b.uploading?t._log("warn","cannot handle file upload "+n+". The file status it not 'uploading' (was the file upload cancelled?)",r):a=!0:t._log("warn","cannot handle file upload "+n+". There is no tracking file with the provided id (was the file purged?)",r),a};e.uploadSubscription=a.upload(n,r).subscribe((function(r){o(n,"progress")&&t._updateTrackedFile(e,{progress:r.progress})}),(function(r){if(e.uploadSubscription=null,o(n,"failure")){var a=r&&r.message?r.message:"";t._updateTrackedFile(e,{status:b.failure,failureReason:a,failureType:"general_error"})}t._syncUploadQueue()}),(function(){e.uploadSubscription=null,o(n,"completion")&&(t._updateTrackedFile(e,{status:b.uploadCompleted,progress:1,uploadCompleteAt:new Date}),t._removeTrackedFile(e),t._syncUploadQueue())}))}}else this._log("warn","cannot find destination adapter for requested file, failing upload request"),this._updateTrackedFile(e,{status:b.failure,failureReason:"upload destination is not supported",failureType:"unknown_destination"}),this._syncUploadQueue()},e.prototype._getUploadAdapter=function(e){return this._uploadFileAdapter?this._uploadFileAdapter.find((function(t){return t.canHandle(e)})):null},e.prototype.ngOnDestroy=function(){var e=this;Object.keys(this._trackedFiles).forEach((function(t){e.purgeUpload(t)}))},e.ctorParameters=function(){return[{type:Array,decorators:[{type:t.Inject,args:[P]},{type:t.Optional}]}]},e=u([t.Injectable(),l(0,t.Inject(P)),l(0,t.Optional()),c("design:paramtypes",[Array])],e)}(),M=function(){function e(){}return e=u([t.NgModule({imports:[],declarations:[],exports:[],providers:[R]})],e)}(),Q=function(){},C=function(e,t,r){var n,a,o=window,i="application/octet-stream",s=r||i,u=e,l=document.createElement("a"),c=function(e){return String(e)},p=o.Blob||o.MozBlob||o.WebKitBlob||c,d=t||"download";if(p=p.call?p.bind(o):Blob,"true"===String(this)&&(s=(u=[u,s])[0],u=u[1]),/^data\:[\w+\-]+\/[\w+\-]+[,;]/.test(u)){if(!(u.length>2096103.424&&p!==c))return navigator.msSaveBlob?navigator.msSaveBlob(f(u),d):g(u,!1);s=(u=f(u)).type||i}function f(e){for(var t=e.split(/[:;,]/),r=t[1],n=("base64"==t[2]?atob:decodeURIComponent)(t.pop()),a=n.length,o=0,i=new Uint8Array(a);o<a;++o)i[o]=n.charCodeAt(o);return new p([i],{type:r})}function g(e,t){if("download"in l)return l.href=e,l.setAttribute("download",d),l.className="download-js-link",l.innerHTML="downloading...",l.style.display="none",document.body.appendChild(l),setTimeout((function(){l.click(),document.body.removeChild(l),!0===t&&setTimeout((function(){o.URL.revokeObjectURL(l.href)}),250)}),66),!0;if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent))return e=e.replace(/^data:([\w\/\-\+]+)/,i),window.open(e)||confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")&&(location.href=e),!0;var r=document.createElement("iframe");document.body.appendChild(r),t||(e="data:"+e.replace(/^data:([\w\/\-\+]+)/,i)),r.src=e,setTimeout((function(){document.body.removeChild(r)}),333)}if(n=u instanceof p?u:new p([u],{type:s}),navigator.msSaveBlob)return navigator.msSaveBlob(n,d);if(o.URL)g(o.URL.createObjectURL(n),!0);else{if("string"==typeof n||n.constructor===c)try{return g("data:"+s+";base64,"+o.btoa(n),!1)}catch(e){return g("data:"+s+","+encodeURIComponent(n),!1)}(a=new FileReader).onload=function(e){g(this.result,!1)},a.readAsDataURL(n)}return!0},K={"<":"&lt;",">":"&gt;","&":"&amp;"},L=function(){function e(){}return e.escapeXml=function(e){var t=e;switch(typeof e){case"string":case"number":case"boolean":t=e;break;default:t=e||""}return String(t).replace(/[&<>]/g,(function(e){return K[e]}))},e.getStartDateValue=function(e){if(e){var t=new Date(e.getTime());return t.setHours(0),t.setMinutes(0),t.setSeconds(0),t}return null},e.getEndDateValue=function(e){if(e){var t=new Date(e.getTime());return t.setHours(23),t.setMinutes(59),t.setSeconds(59),t}return null},e.removeEmptyProperties=function(t){return Object.keys(t).forEach((function(r){t[r]&&"object"==typeof t[r]?e.removeEmptyProperties(t[r]):null===t[r]&&delete t[r]})),t},e.moveUpItems=function(e,t){if(e&&e.length&&t&&t.length){var r=t.map((function(t){return{selectedItem:t,index:e.indexOf(t)}})).filter((function(e){return-1!==e.index})).sort((function(e,t){return e.index-t.index}));if(r.length){var n=r[0].index,a=Math.max(0,n-1);return r.forEach((function(t,r){e.splice(t.index-r,1)})),e.splice.apply(e,d([a,0],r.map((function(e){return e.selectedItem})))),!0}}return!1},e.moveDownItems=function(e,t){if(t&&t.length&&e&&e.length){var r=t.map((function(t){return{selectedItem:t,index:e.indexOf(t)}})).filter((function(e){return-1!==e.index})).sort((function(e,t){return e.index-t.index}));if(r.length){var n=r[r.length-1].index,a=Math.min(e.length-1,n+1);r.forEach((function(t,r){e.splice(t.index-r,1)}));var o=a-r.length;return e.splice.apply(e,d([o+1,0],r.map((function(e){return e.selectedItem})))),!0}}return!1},e.formatTime=function(e,t){void 0===t&&(t=!1);var r=Math.floor(Math.round(e)/3600)%24,n=Math.floor(Math.round(e)/60%60),a=Math.round(e)%60,o=0===r?"":t?r.toString()+"h:":r.toString()+":",i=0===n&&0===r?"00":n<10?"0"+n.toString():n.toString(),s=a<10?"0"+a.toString():a.toString();return t&&(i+="m",s+="s"),o+i+":"+s},e.fromServerDate=function(e){return e?new Date(1e3*e):null},e.toServerDate=function(e){return e?Math.round(e.getTime()/1e3):null},e.download=function(e,t,r){return C(e,t,r)},e}(),B=(F={mergeCDATA:!0,grokAttr:!0,grokText:!0,normalize:!0,xmlns:!0,namespaceKey:"_ns",textKey:"_text",valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!0,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!0},O=new RegExp(/(?!xmlns)^.*:/),A=new RegExp(/^\s+|\s+$/g),E=function(e){return/^\s*$/.test(e)?null:/^(?:true|false)$/i.test(e)?"true"===e.toLowerCase():isFinite(e)?parseFloat(e):e},{parseXML:I=function(e,t){for(var r in t)F[r]=t[r];var n={},a=0,o="";if(F.xmlns&&e.namespaceURI&&(n[F.namespaceKey]=e.namespaceURI),e.attributes&&e.attributes.length>0){for(var i={};a<e.attributes.length;a++){var s=e.attributes.item(a);p={};var u="";u=F.stripAttrPrefix?s.name.replace(O,""):s.name,F.grokAttr?p[F.valueKey]=E(s.value.replace(A,"")):p[F.valueKey]=s.value.replace(A,""),F.xmlns&&s.namespaceURI&&(p[F.namespaceKey]=s.namespaceURI),F.attrsAsObject?i[u]=p:n[F.attrKey+u]=p}F.attrsAsObject&&(n[F.attrKey]=i)}if(e.hasChildNodes())for(var l,c,p,d=0;d<e.childNodes.length;d++)4===(l=e.childNodes.item(d)).nodeType?F.mergeCDATA?o+=l.nodeValue:n.hasOwnProperty(F.cdataKey)?(n[F.cdataKey].constructor!==Array&&(n[F.cdataKey]=[n[F.cdataKey]]),n[F.cdataKey].push(l.nodeValue)):F.childrenAsArray?(n[F.cdataKey]=[],n[F.cdataKey].push(l.nodeValue)):n[F.cdataKey]=l.nodeValue:3===l.nodeType?o+=l.nodeValue:1===l.nodeType&&(0===a&&(n={}),c=F.stripElemPrefix?l.nodeName.replace(O,""):l.nodeName,p=I(l),n.hasOwnProperty(c)?(n[c].constructor!==Array&&(n[c]=[n[c]]),n[c].push(p)):(F.childrenAsArray?(n[c]=[],n[c].push(p)):n[c]=p,a++));else o||(F.childrenAsArray?(n[F.textKey]=[],n[F.textKey].push(null)):n[F.textKey]=null);if(o)if(F.grokText){var f=E(o.replace(A,""));f&&(n[F.textKey]=f)}else F.normalize?n[F.textKey]=o.replace(A,"").replace(/\s+/g," "):n[F.textKey]=o.replace(A,"");return n},parseString:function(e,t){return this.parseXML(j(e),t)},xmlToString:function(e){try{return e.xml?e.xml:(new XMLSerializer).serializeToString(e)}catch(e){return null}},stringToXML:j=function(e){try{return"function"==typeof DOMParser?(new DOMParser).parseFromString(e,"text/xml"):null}catch(e){return null}}});function N(e){var t="";return e&&Object.keys(e).forEach((function(r){var n=L.escapeXml(e[r]);t+=" "+r+'="'+n+'"'})),t}var X=function(){function e(){}return e.toJson=function(e){return B.parseString(e,{textKey:"text",valueKey:"value",attrKey:"attr",cdataKey:"cdata",childrenAsArray:!1,grokText:!1,grokAttr:!1,normalize:!1})},e.toXml=function(e,t,r){void 0===r&&(r="");var n=r?r+":":"",a="",o="";return e&&(o=N(e.attr),Object.keys(e).forEach((function(t){"attr"!==t&&(a+=function e(t,r,n){var a="";if(-1!==(r||"").indexOf("noprefix:")&&(r=r.replace("noprefix:",""),t=""),Array.isArray(n))n.forEach((function(n){a+=e(t,r,n)}));else if(n&&"object"==typeof n){var o=N(n.attr),i="";n.text?i=L.escapeXml(n.text):Object.keys(n).forEach((function(r){"attr"!==r&&(i+=e(t,r,n[r]))})),a+="<"+t+r,a+=o?o+">":">",a+=i+"</"+t+r+">"}return a}(n,t,e[t]))}))),"<"+n+t+o+">"+a+"</"+n+t+">"},e.toSimpleXml=function(t,r){void 0===r&&(r={});var n="",a=function(t){return"object"==typeof t?e.toSimpleXml(t,r):L.escapeXml(t)};return t&&Object.keys(t).forEach((function(e){var o=t[e],i=null==o||""===o;if(!r.removeEmpty||r.removeEmpty&&!i)if(o instanceof Array)o.map((function(t){var o=a(t),i=null==o||""===o;(!r.removeEmpty||r.removeEmpty&&!i)&&(n+="<"+e+">"+o+"</"+e+">")}));else if("object"==typeof o){var s=a(o),u=null==s||""===s;(!r.removeEmpty||r.removeEmpty&&!u)&&(n+="<"+e+">"+s+"</"+e+">")}else{var l=L.escapeXml(o);n+="<"+e+">"+l+"</"+e+">"}})),n},e}(),H=new t.InjectionToken("APP_STORAGE_TOKEN"),V=function(){function e(){this.storage={}}return e.prototype.setInLocalStorage=function(e,t){this.storage[e]=t},e.prototype.getFromLocalStorage=function(e){return this.storage[e]},e.prototype.removeFromLocalStorage=function(e){delete this.storage[e]},e.prototype.setInSessionStorage=function(e,t){this.storage[e]=t},e.prototype.getFromSessionStorage=function(e){return this.storage[e]},e.prototype.removeFromSessionStorage=function(e){delete this.storage[e]},e}(),z=function(){function e(){}var r;return r=e,e.forRoot=function(){return{ngModule:r,providers:[{provide:H,useClass:V},L,{provide:y,useClass:m}]}},e=r=u([t.NgModule({imports:[o.CommonModule],declarations:[],exports:[],providers:[]})],e)}();e.APP_STORAGE_TOKEN=H,e.AppStorage=V,e.Download=C,e.EmptyLogger=m,e.FriendlyHashId=_,e.KalturaCommonModule=z,e.KalturaLoggerInjectionToken=y,e.KalturaUtils=L,e.OperationTagManagerService=g,e.OperationTagModule=h,e.ServerPolls=v,e.TrackedFile=w,e.TrackedFileStatuses=b,e.UploadFileAdapter=Q,e.UploadFileAdapterToken=P,e.UploadManagement=R,e.UploadManagementModule=M,e.XmlParser=X,e.cancelOnDestroy=k,e.tag=function(e){return function(t){return t.lift(new q(e))}},e.ɵa=B,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=kaltura-ng-kaltura-common.umd.min.js.map