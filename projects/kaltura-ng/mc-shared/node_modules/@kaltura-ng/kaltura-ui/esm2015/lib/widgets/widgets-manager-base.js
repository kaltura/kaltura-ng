import { Observable } from 'rxjs/Observable';
import 'rxjs/add/observable/forkJoin';
import 'rxjs/add/operator/mergeMap';
import 'rxjs/add/operator/share';
import 'rxjs/add/operator/map';
import { BehaviorSubject } from 'rxjs/BehaviorSubject';
import { EmptyLogger } from '@kaltura-ng/kaltura-common';
import { cancelOnDestroy } from '@kaltura-ng/kaltura-common';
export var OnDataSavingReasons;
(function (OnDataSavingReasons) {
    OnDataSavingReasons[OnDataSavingReasons["attachedWidgetBusy"] = 0] = "attachedWidgetBusy";
    OnDataSavingReasons[OnDataSavingReasons["validationErrors"] = 1] = "validationErrors";
    OnDataSavingReasons[OnDataSavingReasons["buildRequestFailure"] = 2] = "buildRequestFailure";
})(OnDataSavingReasons || (OnDataSavingReasons = {}));
export class WidgetsManagerBase {
    constructor(logger) {
        this._widgets = [];
        this._widgetsState = new BehaviorSubject({});
        this._isNewData = false;
        this.widgetsState$ = this._widgetsState.asObservable();
        this._logger = logger ? logger.subLogger(`widgetsManager`) : new EmptyLogger();
    }
    get widgetsState() {
        return this._widgetsState.getValue();
    }
    get isNewData() {
        return this._isNewData;
    }
    _updateWidgetState(newWidgetState) {
        const currentWidgetsState = this._widgetsState.getValue();
        if (!newWidgetState || !newWidgetState.key) {
            this._logger.warn('[widgets manager] cannot update widget state, missing widget key');
        }
        else {
            this._logger.info(`[widgets manager] widget '${newWidgetState.key}': update widget state`, newWidgetState);
            currentWidgetsState[newWidgetState.key] = newWidgetState;
            this._widgetsState.next(currentWidgetsState);
        }
    }
    registerWidgets(widgets) {
        if (widgets) {
            widgets.forEach(widget => {
                const existingRegisteredWidget = this._widgets.find(registeredWidget => registeredWidget === widget || registeredWidget.key === widget.key);
                if (existingRegisteredWidget) {
                    throw new Error(`a widget with key '${widget.key}' is already registered (did you registered the same widget twice?)`);
                }
                else {
                    this._logger.info(`[widgets manager] widget '${widget.key}': registered to a form widgets manager`);
                    widget._setForm(this);
                    this._widgets.push(widget);
                }
            });
        }
    }
    notifyDataLoading(dataId) {
        this._logger.info(`[widgets manager] notify data loading. data identifier '${dataId}'`);
        this._widgets.filter(widget => widget.isActive).forEach(widget => {
            widget._reset();
        });
        this._widgets.forEach(widget => {
            widget._handleDataLoading(dataId);
        });
    }
    notifyDataLoaded(data, settings) {
        this._logger.info(`[widgets manager] notify data loaded.`);
        const errors = [];
        this._isNewData = settings.isNewData;
        this._logger.info(`[widgets manager] treat data as '${this._isNewData ? 'new' : 'existing'} data'.`);
        this._widgets.forEach(widget => {
            try {
                widget._handleDataLoaded(data);
                widget.activate();
            }
            catch (e) {
                errors.push(e);
            }
        });
        return { errors };
    }
    _widgetsOnDataSaving(newData, request, originalData) {
        const errors = [];
        const widgets = this._isNewData ? this._widgets : this._widgets.filter(widget => widget.isActive);
        widgets.forEach(widget => {
            try {
                this._logger.info(`[widgets manager] widget '${widget.key}': build save request content`);
                widget._handleDataSaving(newData, request, originalData);
            }
            catch (err) {
                this._logger.error(`[widgets manager] widget '${widget.key}': failed to prepare data for save. Save operation aborted.`, err); // keep error
                errors.push(err);
            }
        });
        return { errors };
    }
    notifyDataSaving(newData, request, originalData) {
        this._logger.info(`[widgets manager] notify data saving.`);
        const isAttachedWidgetBusy = !!this._widgets.find(widget => widget.isAttached && widget.isBusy);
        return Observable.of(isAttachedWidgetBusy ?
            {
                ready: false,
                reason: OnDataSavingReasons.attachedWidgetBusy
            } : { ready: true })
            .pipe(cancelOnDestroy(this))
            .flatMap(response => {
            if (response.ready) {
                return this._validateWidgets()
                    .catch((error, caught) => Observable.of({ isValid: false }))
                    .map(response => response.isValid ? { ready: true } : {
                    ready: false,
                    reason: OnDataSavingReasons.validationErrors
                });
            }
            else {
                return Observable.of(response);
            }
        })
            .map(response => {
            if (response.ready) {
                const saveContent = this._widgetsOnDataSaving(newData, request, originalData);
                if (saveContent.errors.length === 0) {
                    return { ready: true, reason: null };
                }
                else {
                    return {
                        ready: false,
                        reason: OnDataSavingReasons.buildRequestFailure,
                        errors: saveContent.errors
                    };
                }
            }
            else {
                return response;
            }
        });
    }
    _validateWidgets() {
        const widgets = this._isNewData ? this._widgets : this._widgets.filter(widget => widget.isActive);
        const widgetsResults = widgets.map(widget => {
            return widget._validate()
                .pipe(cancelOnDestroy(this))
                .catch((err, caught) => Observable.of({ isValid: false }));
        });
        if (widgetsResults.length) {
            return Observable.forkJoin(...widgetsResults).map(responses => {
                return responses.find(response => !response.isValid) || { isValid: true };
            });
        }
        else {
            return Observable.of({ isValid: true });
        }
    }
    ngOnDestroy() {
        this._widgets.forEach(widget => {
            widget.destory();
        });
        this._logger.warn('[widgets manager] form widgets manager ngOnDestroy');
        this._widgetsState.complete();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy1tYW5hZ2VyLWJhc2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Aa2FsdHVyYS1uZy9rYWx0dXJhLXVpLyIsInNvdXJjZXMiOlsibGliL3dpZGdldHMvd2lkZ2V0cy1tYW5hZ2VyLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sOEJBQThCLENBQUM7QUFDdEMsT0FBTyw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLHlCQUF5QixDQUFDO0FBQ2pDLE9BQU8sdUJBQXVCLENBQUM7QUFFL0IsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR3ZELE9BQU8sRUFBaUIsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDeEUsT0FBTyxFQUFFLGVBQWUsRUFBTyxNQUFNLDRCQUE0QixDQUFDO0FBTWxFLE1BQU0sQ0FBTixJQUFZLG1CQUtYO0FBTEQsV0FBWSxtQkFBbUI7SUFFM0IseUZBQWtCLENBQUE7SUFDbEIscUZBQWdCLENBQUE7SUFDaEIsMkZBQW1CLENBQUE7QUFDdkIsQ0FBQyxFQUxXLG1CQUFtQixLQUFuQixtQkFBbUIsUUFLOUI7QUFFRCxNQUFNLE9BQWdCLGtCQUFrQjtJQU92QyxZQUFZLE1BQXNCO1FBTnZCLGFBQVEsR0FBd0MsRUFBRSxDQUFDO1FBQ25ELGtCQUFhLEdBQXNDLElBQUksZUFBZSxDQUFtQixFQUFFLENBQUMsQ0FBQztRQUM3RixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLGtCQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUkzRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ2hGLENBQUM7SUFFRSxJQUFXLFlBQVk7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QkFDMUQsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUM7WUFDNUUsQ0FBQyxDQUFDLENBQUM7U0FDTjthQUFNO1lBQ0gsT0FBTyxVQUFVLENBQUMsRUFBRSxDQUFDLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7U0FDekM7SUFDTCxDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBRTNCLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLG9EQUFvRCxDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0NBSUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xuaW1wb3J0ICdyeGpzL2FkZC9vYnNlcnZhYmxlL2ZvcmtKb2luJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvbWVyZ2VNYXAnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9zaGFyZSc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL21hcCc7XG5cbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMvQmVoYXZpb3JTdWJqZWN0JztcbmltcG9ydCB7IFdpZGdldEJhc2UgfSBmcm9tICcuL3dpZGdldC1iYXNlJztcbmltcG9ydCB7IFdpZGdldFN0YXRlIH0gZnJvbSAnLi93aWRnZXQtc3RhdGUnO1xuaW1wb3J0IHsgS2FsdHVyYUxvZ2dlciwgRW1wdHlMb2dnZXIgfSBmcm9tICdAa2FsdHVyYS1uZy9rYWx0dXJhLWNvbW1vbic7XG5pbXBvcnQgeyBjYW5jZWxPbkRlc3Ryb3ksIHRhZyB9IGZyb20gJ0BrYWx0dXJhLW5nL2thbHR1cmEtY29tbW9uJztcblxuZXhwb3J0IGRlY2xhcmUgdHlwZSBGb3JtV2lkZ2V0c1N0YXRlID0ge1xuICAgIFtrZXkgOiBudW1iZXJdIDogV2lkZ2V0U3RhdGVcbn1cblxuZXhwb3J0IGVudW0gT25EYXRhU2F2aW5nUmVhc29uc1xue1xuICAgIGF0dGFjaGVkV2lkZ2V0QnVzeSxcbiAgICB2YWxpZGF0aW9uRXJyb3JzLFxuICAgIGJ1aWxkUmVxdWVzdEZhaWx1cmVcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFdpZGdldHNNYW5hZ2VyQmFzZTxURGF0YSwgVFJlcXVlc3Q+IGltcGxlbWVudHMgV2lkZ2V0c01hbmFnZXJCYXNlPFREYXRhLCBUUmVxdWVzdD4sIE9uRGVzdHJveSB7XG4gICAgcHJpdmF0ZSBfd2lkZ2V0czogV2lkZ2V0QmFzZTx0aGlzLCBURGF0YSwgVFJlcXVlc3Q+W10gPSBbXTtcbiAgICBwcml2YXRlIF93aWRnZXRzU3RhdGU6IEJlaGF2aW9yU3ViamVjdDxGb3JtV2lkZ2V0c1N0YXRlPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Rm9ybVdpZGdldHNTdGF0ZT4oe30pO1xuICAgIHByaXZhdGUgX2lzTmV3RGF0YSA9IGZhbHNlO1xuICAgIHB1YmxpYyB3aWRnZXRzU3RhdGUkID0gdGhpcy5fd2lkZ2V0c1N0YXRlLmFzT2JzZXJ2YWJsZSgpO1xuXHRwcm90ZWN0ZWQgX2xvZ2dlcjogS2FsdHVyYUxvZ2dlcjtcblxuXHRjb25zdHJ1Y3Rvcihsb2dnZXI/OiBLYWx0dXJhTG9nZ2VyKSB7XG5cdFx0dGhpcy5fbG9nZ2VyID0gbG9nZ2VyID8gbG9nZ2VyLnN1YkxvZ2dlcihgd2lkZ2V0c01hbmFnZXJgKSA6IG5ldyBFbXB0eUxvZ2dlcigpO1xuXHR9XG5cbiAgICBwdWJsaWMgZ2V0IHdpZGdldHNTdGF0ZSgpOiBGb3JtV2lkZ2V0c1N0YXRlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3dpZGdldHNTdGF0ZS5nZXRWYWx1ZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXNOZXdEYXRhKCk6IGJvb2xlYW57XG4gICAgICAgIHJldHVybiB0aGlzLl9pc05ld0RhdGE7XG4gICAgfVxuXG4gICAgcHVibGljIF91cGRhdGVXaWRnZXRTdGF0ZShuZXdXaWRnZXRTdGF0ZSA6IFdpZGdldFN0YXRlKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRXaWRnZXRzU3RhdGUgPSB0aGlzLl93aWRnZXRzU3RhdGUuZ2V0VmFsdWUoKTtcblxuICAgICAgICBpZiAoIW5ld1dpZGdldFN0YXRlIHx8ICFuZXdXaWRnZXRTdGF0ZS5rZXkpIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci53YXJuKCdbd2lkZ2V0cyBtYW5hZ2VyXSBjYW5ub3QgdXBkYXRlIHdpZGdldCBzdGF0ZSwgbWlzc2luZyB3aWRnZXQga2V5Jyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldHMgbWFuYWdlcl0gd2lkZ2V0ICcke25ld1dpZGdldFN0YXRlLmtleX0nOiB1cGRhdGUgd2lkZ2V0IHN0YXRlYCwgbmV3V2lkZ2V0U3RhdGUpO1xuICAgICAgICAgICAgY3VycmVudFdpZGdldHNTdGF0ZVtuZXdXaWRnZXRTdGF0ZS5rZXldID0gbmV3V2lkZ2V0U3RhdGU7XG4gICAgICAgICAgICB0aGlzLl93aWRnZXRzU3RhdGUubmV4dChjdXJyZW50V2lkZ2V0c1N0YXRlKTtcblxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHJlZ2lzdGVyV2lkZ2V0cyh3aWRnZXRzIDogV2lkZ2V0QmFzZTx0aGlzLCBURGF0YSxUUmVxdWVzdD5bXSlcbiAgICB7XG4gICAgICAgIGlmICh3aWRnZXRzKVxuICAgICAgICB7XG4gICAgICAgICAgICB3aWRnZXRzLmZvckVhY2god2lkZ2V0ID0+XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdSZWdpc3RlcmVkV2lkZ2V0ID0gdGhpcy5fd2lkZ2V0cy5maW5kKHJlZ2lzdGVyZWRXaWRnZXQgPT4gcmVnaXN0ZXJlZFdpZGdldCA9PT0gd2lkZ2V0IHx8IHJlZ2lzdGVyZWRXaWRnZXQua2V5ID09PSB3aWRnZXQua2V5KTtcblxuICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1JlZ2lzdGVyZWRXaWRnZXQpXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGEgd2lkZ2V0IHdpdGgga2V5ICcke3dpZGdldC5rZXl9JyBpcyBhbHJlYWR5IHJlZ2lzdGVyZWQgKGRpZCB5b3UgcmVnaXN0ZXJlZCB0aGUgc2FtZSB3aWRnZXQgdHdpY2U/KWApO1xuICAgICAgICAgICAgICAgIH1lbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRzIG1hbmFnZXJdIHdpZGdldCAnJHt3aWRnZXQua2V5fSc6IHJlZ2lzdGVyZWQgdG8gYSBmb3JtIHdpZGdldHMgbWFuYWdlcmApO1xuICAgICAgICAgICAgICAgICAgICB3aWRnZXQuX3NldEZvcm0odGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3dpZGdldHMucHVzaCh3aWRnZXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBub3RpZnlEYXRhTG9hZGluZyhkYXRhSWQ6IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldHMgbWFuYWdlcl0gbm90aWZ5IGRhdGEgbG9hZGluZy4gZGF0YSBpZGVudGlmaWVyICcke2RhdGFJZH0nYCk7XG5cbiAgICAgICAgdGhpcy5fd2lkZ2V0cy5maWx0ZXIod2lkZ2V0ID0+IHdpZGdldC5pc0FjdGl2ZSkuZm9yRWFjaCh3aWRnZXQgPT4ge1xuICAgICAgICAgICAgd2lkZ2V0Ll9yZXNldCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl93aWRnZXRzLmZvckVhY2god2lkZ2V0ID0+IHtcbiAgICAgICAgICAgIHdpZGdldC5faGFuZGxlRGF0YUxvYWRpbmcoZGF0YUlkKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIG5vdGlmeURhdGFMb2FkZWQoZGF0YTogVERhdGEsIHNldHRpbmdzOiB7IGlzTmV3RGF0YTogYm9vbGVhbiB9KSA6IHsgZXJyb3JzPzogRXJyb3JbXSB9IHtcblxuICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldHMgbWFuYWdlcl0gbm90aWZ5IGRhdGEgbG9hZGVkLmApO1xuICAgICAgICBjb25zdCBlcnJvcnMgOiBFcnJvcltdID0gW107XG4gICAgICAgIHRoaXMuX2lzTmV3RGF0YSA9IHNldHRpbmdzLmlzTmV3RGF0YTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRzIG1hbmFnZXJdIHRyZWF0IGRhdGEgYXMgJyR7dGhpcy5faXNOZXdEYXRhID8gJ25ldycgOiAnZXhpc3RpbmcnfSBkYXRhJy5gKTtcbiAgICAgICAgdGhpcy5fd2lkZ2V0cy5mb3JFYWNoKHdpZGdldCA9PiB7XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgd2lkZ2V0Ll9oYW5kbGVEYXRhTG9hZGVkKGRhdGEpO1xuICAgICAgICAgICAgICAgIHdpZGdldC5hY3RpdmF0ZSgpO1xuICAgICAgICAgICAgfWNhdGNoKGUpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB7IGVycm9ycyB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX3dpZGdldHNPbkRhdGFTYXZpbmcobmV3RGF0YTogVERhdGEsIHJlcXVlc3Q6IFRSZXF1ZXN0LCBvcmlnaW5hbERhdGE6IFREYXRhKTogeyBlcnJvcnM/OiBFcnJvcltdIH0ge1xuICAgICAgICBjb25zdCBlcnJvcnM6IEVycm9yW10gPSBbXTtcbiAgICAgICAgY29uc3Qgd2lkZ2V0cyA9IHRoaXMuX2lzTmV3RGF0YSA/IHRoaXMuX3dpZGdldHMgOiB0aGlzLl93aWRnZXRzLmZpbHRlcih3aWRnZXQgPT4gd2lkZ2V0LmlzQWN0aXZlKTtcbiAgICAgICAgd2lkZ2V0cy5mb3JFYWNoKHdpZGdldCA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBbd2lkZ2V0cyBtYW5hZ2VyXSB3aWRnZXQgJyR7d2lkZ2V0LmtleX0nOiBidWlsZCBzYXZlIHJlcXVlc3QgY29udGVudGApO1xuICAgICAgICAgICAgICAgIHdpZGdldC5faGFuZGxlRGF0YVNhdmluZyhuZXdEYXRhLCByZXF1ZXN0LCBvcmlnaW5hbERhdGEpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBbd2lkZ2V0cyBtYW5hZ2VyXSB3aWRnZXQgJyR7d2lkZ2V0LmtleX0nOiBmYWlsZWQgdG8gcHJlcGFyZSBkYXRhIGZvciBzYXZlLiBTYXZlIG9wZXJhdGlvbiBhYm9ydGVkLmAsIGVycik7IC8vIGtlZXAgZXJyb3JcbiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4ge2Vycm9yc307XG4gICAgfVxuXG4gICAgcHVibGljIG5vdGlmeURhdGFTYXZpbmcobmV3RGF0YTogVERhdGEsIHJlcXVlc3Q6IFRSZXF1ZXN0LCBvcmlnaW5hbERhdGE6IFREYXRhKTogT2JzZXJ2YWJsZTx7IHJlYWR5OiBib29sZWFuLCByZWFzb24/OiBPbkRhdGFTYXZpbmdSZWFzb25zLCBlcnJvcnM/OiBFcnJvcltdIH0+IHtcblxuICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldHMgbWFuYWdlcl0gbm90aWZ5IGRhdGEgc2F2aW5nLmApO1xuXG4gICAgICAgIGNvbnN0IGlzQXR0YWNoZWRXaWRnZXRCdXN5ID0gISF0aGlzLl93aWRnZXRzLmZpbmQod2lkZ2V0ID0+IHdpZGdldC5pc0F0dGFjaGVkICYmIHdpZGdldC5pc0J1c3kpO1xuXG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKGlzQXR0YWNoZWRXaWRnZXRCdXN5ID9cbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICByZWFkeTogZmFsc2UsXG4gICAgICAgICAgICAgICAgcmVhc29uOiBPbkRhdGFTYXZpbmdSZWFzb25zLmF0dGFjaGVkV2lkZ2V0QnVzeVxuICAgICAgICAgICAgfSA6IHtyZWFkeTogdHJ1ZX0gKVxuICAgICAgICAgICAgLnBpcGUoY2FuY2VsT25EZXN0cm95KHRoaXMpKVxuICAgICAgICAgICAgLmZsYXRNYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5yZWFkeSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGVXaWRnZXRzKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IsIGNhdWdodCkgPT4gT2JzZXJ2YWJsZS5vZih7aXNWYWxpZDogZmFsc2V9KSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAocmVzcG9uc2UgPT4gcmVzcG9uc2UuaXNWYWxpZCA/IHtyZWFkeTogdHJ1ZX0gOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZHk6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbjogT25EYXRhU2F2aW5nUmVhc29ucy52YWxpZGF0aW9uRXJyb3JzXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZihyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5tYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5yZWFkeSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzYXZlQ29udGVudCA9IHRoaXMuX3dpZGdldHNPbkRhdGFTYXZpbmcobmV3RGF0YSwgcmVxdWVzdCwgb3JpZ2luYWxEYXRhKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc2F2ZUNvbnRlbnQuZXJyb3JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtyZWFkeTogdHJ1ZSwgcmVhc29uOiBudWxsfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhZHk6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbjogT25EYXRhU2F2aW5nUmVhc29ucy5idWlsZFJlcXVlc3RGYWlsdXJlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yczogc2F2ZUNvbnRlbnQuZXJyb3JzXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3ZhbGlkYXRlV2lkZ2V0cygpOiBPYnNlcnZhYmxlPHsgaXNWYWxpZDogYm9vbGVhbiB9PiB7XG4gICAgICAgIGNvbnN0IHdpZGdldHMgPSB0aGlzLl9pc05ld0RhdGEgPyB0aGlzLl93aWRnZXRzIDogdGhpcy5fd2lkZ2V0cy5maWx0ZXIod2lkZ2V0ID0+IHdpZGdldC5pc0FjdGl2ZSk7XG4gICAgICAgIGNvbnN0IHdpZGdldHNSZXN1bHRzID0gd2lkZ2V0cy5tYXAod2lkZ2V0ID0+IHtcbiAgICAgICAgICAgIHJldHVybiB3aWRnZXQuX3ZhbGlkYXRlKClcbiAgICAgICAgICAgICAgICAucGlwZShjYW5jZWxPbkRlc3Ryb3kodGhpcykpXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIsIGNhdWdodCkgPT4gT2JzZXJ2YWJsZS5vZih7aXNWYWxpZDogZmFsc2V9KSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh3aWRnZXRzUmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZvcmtKb2luKC4uLndpZGdldHNSZXN1bHRzKS5tYXAocmVzcG9uc2VzID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VzLmZpbmQocmVzcG9uc2UgPT4gIXJlc3BvbnNlLmlzVmFsaWQpIHx8IHtpc1ZhbGlkOiB0cnVlfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2Yoe2lzVmFsaWQ6IHRydWV9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLl93aWRnZXRzLmZvckVhY2god2lkZ2V0ID0+XG4gICAgICAgIHtcbiAgICAgICAgICAgIHdpZGdldC5kZXN0b3J5KCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX2xvZ2dlci53YXJuKCdbd2lkZ2V0cyBtYW5hZ2VyXSBmb3JtIHdpZGdldHMgbWFuYWdlciBuZ09uRGVzdHJveScpO1xuICAgICAgICB0aGlzLl93aWRnZXRzU3RhdGUuY29tcGxldGUoKTtcbiAgICB9XG5zXG5cblxufVxuIl19