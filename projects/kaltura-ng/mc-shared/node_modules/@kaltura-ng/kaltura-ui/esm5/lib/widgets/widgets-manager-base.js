import { __read, __spread } from "tslib";
import { Observable } from 'rxjs/Observable';
import 'rxjs/add/observable/forkJoin';
import 'rxjs/add/operator/mergeMap';
import 'rxjs/add/operator/share';
import 'rxjs/add/operator/map';
import { BehaviorSubject } from 'rxjs/BehaviorSubject';
import { EmptyLogger } from '@kaltura-ng/kaltura-common';
import { cancelOnDestroy } from '@kaltura-ng/kaltura-common';
export var OnDataSavingReasons;
(function (OnDataSavingReasons) {
    OnDataSavingReasons[OnDataSavingReasons["attachedWidgetBusy"] = 0] = "attachedWidgetBusy";
    OnDataSavingReasons[OnDataSavingReasons["validationErrors"] = 1] = "validationErrors";
    OnDataSavingReasons[OnDataSavingReasons["buildRequestFailure"] = 2] = "buildRequestFailure";
})(OnDataSavingReasons || (OnDataSavingReasons = {}));
var WidgetsManagerBase = /** @class */ (function () {
    function WidgetsManagerBase(logger) {
        this._widgets = [];
        this._widgetsState = new BehaviorSubject({});
        this._isNewData = false;
        this.widgetsState$ = this._widgetsState.asObservable();
        this._logger = logger ? logger.subLogger("widgetsManager") : new EmptyLogger();
    }
    Object.defineProperty(WidgetsManagerBase.prototype, "widgetsState", {
        get: function () {
            return this._widgetsState.getValue();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetsManagerBase.prototype, "isNewData", {
        get: function () {
            return this._isNewData;
        },
        enumerable: true,
        configurable: true
    });
    WidgetsManagerBase.prototype._updateWidgetState = function (newWidgetState) {
        var currentWidgetsState = this._widgetsState.getValue();
        if (!newWidgetState || !newWidgetState.key) {
            this._logger.warn('[widgets manager] cannot update widget state, missing widget key');
        }
        else {
            this._logger.info("[widgets manager] widget '" + newWidgetState.key + "': update widget state", newWidgetState);
            currentWidgetsState[newWidgetState.key] = newWidgetState;
            this._widgetsState.next(currentWidgetsState);
        }
    };
    WidgetsManagerBase.prototype.registerWidgets = function (widgets) {
        var _this = this;
        if (widgets) {
            widgets.forEach(function (widget) {
                var existingRegisteredWidget = _this._widgets.find(function (registeredWidget) { return registeredWidget === widget || registeredWidget.key === widget.key; });
                if (existingRegisteredWidget) {
                    throw new Error("a widget with key '" + widget.key + "' is already registered (did you registered the same widget twice?)");
                }
                else {
                    _this._logger.info("[widgets manager] widget '" + widget.key + "': registered to a form widgets manager");
                    widget._setForm(_this);
                    _this._widgets.push(widget);
                }
            });
        }
    };
    WidgetsManagerBase.prototype.notifyDataLoading = function (dataId) {
        this._logger.info("[widgets manager] notify data loading. data identifier '" + dataId + "'");
        this._widgets.filter(function (widget) { return widget.isActive; }).forEach(function (widget) {
            widget._reset();
        });
        this._widgets.forEach(function (widget) {
            widget._handleDataLoading(dataId);
        });
    };
    WidgetsManagerBase.prototype.notifyDataLoaded = function (data, settings) {
        this._logger.info("[widgets manager] notify data loaded.");
        var errors = [];
        this._isNewData = settings.isNewData;
        this._logger.info("[widgets manager] treat data as '" + (this._isNewData ? 'new' : 'existing') + " data'.");
        this._widgets.forEach(function (widget) {
            try {
                widget._handleDataLoaded(data);
                widget.activate();
            }
            catch (e) {
                errors.push(e);
            }
        });
        return { errors: errors };
    };
    WidgetsManagerBase.prototype._widgetsOnDataSaving = function (newData, request, originalData) {
        var _this = this;
        var errors = [];
        var widgets = this._isNewData ? this._widgets : this._widgets.filter(function (widget) { return widget.isActive; });
        widgets.forEach(function (widget) {
            try {
                _this._logger.info("[widgets manager] widget '" + widget.key + "': build save request content");
                widget._handleDataSaving(newData, request, originalData);
            }
            catch (err) {
                _this._logger.error("[widgets manager] widget '" + widget.key + "': failed to prepare data for save. Save operation aborted.", err); // keep error
                errors.push(err);
            }
        });
        return { errors: errors };
    };
    WidgetsManagerBase.prototype.notifyDataSaving = function (newData, request, originalData) {
        var _this = this;
        this._logger.info("[widgets manager] notify data saving.");
        var isAttachedWidgetBusy = !!this._widgets.find(function (widget) { return widget.isAttached && widget.isBusy; });
        return Observable.of(isAttachedWidgetBusy ?
            {
                ready: false,
                reason: OnDataSavingReasons.attachedWidgetBusy
            } : { ready: true })
            .pipe(cancelOnDestroy(this))
            .flatMap(function (response) {
            if (response.ready) {
                return _this._validateWidgets()
                    .catch(function (error, caught) { return Observable.of({ isValid: false }); })
                    .map(function (response) { return response.isValid ? { ready: true } : {
                    ready: false,
                    reason: OnDataSavingReasons.validationErrors
                }; });
            }
            else {
                return Observable.of(response);
            }
        })
            .map(function (response) {
            if (response.ready) {
                var saveContent = _this._widgetsOnDataSaving(newData, request, originalData);
                if (saveContent.errors.length === 0) {
                    return { ready: true, reason: null };
                }
                else {
                    return {
                        ready: false,
                        reason: OnDataSavingReasons.buildRequestFailure,
                        errors: saveContent.errors
                    };
                }
            }
            else {
                return response;
            }
        });
    };
    WidgetsManagerBase.prototype._validateWidgets = function () {
        var _this = this;
        var widgets = this._isNewData ? this._widgets : this._widgets.filter(function (widget) { return widget.isActive; });
        var widgetsResults = widgets.map(function (widget) {
            return widget._validate()
                .pipe(cancelOnDestroy(_this))
                .catch(function (err, caught) { return Observable.of({ isValid: false }); });
        });
        if (widgetsResults.length) {
            return Observable.forkJoin.apply(Observable, __spread(widgetsResults)).map(function (responses) {
                return responses.find(function (response) { return !response.isValid; }) || { isValid: true };
            });
        }
        else {
            return Observable.of({ isValid: true });
        }
    };
    WidgetsManagerBase.prototype.ngOnDestroy = function () {
        this._widgets.forEach(function (widget) {
            widget.destory();
        });
        this._logger.warn('[widgets manager] form widgets manager ngOnDestroy');
        this._widgetsState.complete();
    };
    return WidgetsManagerBase;
}());
export { WidgetsManagerBase };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy1tYW5hZ2VyLWJhc2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Aa2FsdHVyYS1uZy9rYWx0dXJhLXVpLyIsInNvdXJjZXMiOlsibGliL3dpZGdldHMvd2lkZ2V0cy1tYW5hZ2VyLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLDhCQUE4QixDQUFDO0FBQ3RDLE9BQU8sNEJBQTRCLENBQUM7QUFDcEMsT0FBTyx5QkFBeUIsQ0FBQztBQUNqQyxPQUFPLHVCQUF1QixDQUFDO0FBRS9CLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUd2RCxPQUFPLEVBQWlCLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxlQUFlLEVBQU8sTUFBTSw0QkFBNEIsQ0FBQztBQU1sRSxNQUFNLENBQU4sSUFBWSxtQkFLWDtBQUxELFdBQVksbUJBQW1CO0lBRTNCLHlGQUFrQixDQUFBO0lBQ2xCLHFGQUFnQixDQUFBO0lBQ2hCLDJGQUFtQixDQUFBO0FBQ3ZCLENBQUMsRUFMVyxtQkFBbUIsS0FBbkIsbUJBQW1CLFFBSzlCO0FBRUQ7SUFPQyw0QkFBWSxNQUFzQjtRQU52QixhQUFRLEdBQXdDLEVBQUUsQ0FBQztRQUNuRCxrQkFBYSxHQUFzQyxJQUFJLGVBQWUsQ0FBbUIsRUFBRSxDQUFDLENBQUM7UUFDN0YsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNwQixrQkFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUM7UUFJM0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUNoRixDQUFDO0lBRUUsc0JBQVcsNENBQVk7YUFBdkI7WUFDSSxPQUFP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LENBQUMsRUFBL0IsQ0FBK0IsQ0FBQyxDQUFDO1FBQ2pFLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxjQUFjLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLE9BQU8sVUFBVSxDQUFDLFFBQVEsT0FBbkIsVUFBVSxXQUFhLGNBQWMsR0FBRSxHQUFHLENBQUMsVUFBQSxTQUFTO2dCQUN2RCxPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBQSxRQUFRLElBQUksT0FBQSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQWpCLENBQWlCLENBQUMsSUFBSSxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBQztZQUM1RSxDQUFDLENBQUMsQ0FBQztTQUNOO2FBQU07WUFDSCxPQUFPLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztTQUN6QztJQUNMLENBQUM7SUFFRCx3Q0FBVyxHQUFYO1FBQ0ksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQSxNQUFNO1lBRXhCLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLG9EQUFvRCxDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBSUwseUJBQUM7QUFBRCxDQUFDLEFBOUtELElBOEtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCAncnhqcy9hZGQvb2JzZXJ2YWJsZS9mb3JrSm9pbic7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL21lcmdlTWFwJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3Ivc2hhcmUnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9tYXAnO1xuXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzL0JlaGF2aW9yU3ViamVjdCc7XG5pbXBvcnQgeyBXaWRnZXRCYXNlIH0gZnJvbSAnLi93aWRnZXQtYmFzZSc7XG5pbXBvcnQgeyBXaWRnZXRTdGF0ZSB9IGZyb20gJy4vd2lkZ2V0LXN0YXRlJztcbmltcG9ydCB7IEthbHR1cmFMb2dnZXIsIEVtcHR5TG9nZ2VyIH0gZnJvbSAnQGthbHR1cmEtbmcva2FsdHVyYS1jb21tb24nO1xuaW1wb3J0IHsgY2FuY2VsT25EZXN0cm95LCB0YWcgfSBmcm9tICdAa2FsdHVyYS1uZy9rYWx0dXJhLWNvbW1vbic7XG5cbmV4cG9ydCBkZWNsYXJlIHR5cGUgRm9ybVdpZGdldHNTdGF0ZSA9IHtcbiAgICBba2V5IDogbnVtYmVyXSA6IFdpZGdldFN0YXRlXG59XG5cbmV4cG9ydCBlbnVtIE9uRGF0YVNhdmluZ1JlYXNvbnNcbntcbiAgICBhdHRhY2hlZFdpZGdldEJ1c3ksXG4gICAgdmFsaWRhdGlvbkVycm9ycyxcbiAgICBidWlsZFJlcXVlc3RGYWlsdXJlXG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBXaWRnZXRzTWFuYWdlckJhc2U8VERhdGEsIFRSZXF1ZXN0PiBpbXBsZW1lbnRzIFdpZGdldHNNYW5hZ2VyQmFzZTxURGF0YSwgVFJlcXVlc3Q+LCBPbkRlc3Ryb3kge1xuICAgIHByaXZhdGUgX3dpZGdldHM6IFdpZGdldEJhc2U8dGhpcywgVERhdGEsIFRSZXF1ZXN0PltdID0gW107XG4gICAgcHJpdmF0ZSBfd2lkZ2V0c1N0YXRlOiBCZWhhdmlvclN1YmplY3Q8Rm9ybVdpZGdldHNTdGF0ZT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEZvcm1XaWRnZXRzU3RhdGU+KHt9KTtcbiAgICBwcml2YXRlIF9pc05ld0RhdGEgPSBmYWxzZTtcbiAgICBwdWJsaWMgd2lkZ2V0c1N0YXRlJCA9IHRoaXMuX3dpZGdldHNTdGF0ZS5hc09ic2VydmFibGUoKTtcblx0cHJvdGVjdGVkIF9sb2dnZXI6IEthbHR1cmFMb2dnZXI7XG5cblx0Y29uc3RydWN0b3IobG9nZ2VyPzogS2FsdHVyYUxvZ2dlcikge1xuXHRcdHRoaXMuX2xvZ2dlciA9IGxvZ2dlciA/IGxvZ2dlci5zdWJMb2dnZXIoYHdpZGdldHNNYW5hZ2VyYCkgOiBuZXcgRW1wdHlMb2dnZXIoKTtcblx0fVxuXG4gICAgcHVibGljIGdldCB3aWRnZXRzU3RhdGUoKTogRm9ybVdpZGdldHNTdGF0ZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl93aWRnZXRzU3RhdGUuZ2V0VmFsdWUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzTmV3RGF0YSgpOiBib29sZWFue1xuICAgICAgICByZXR1cm4gdGhpcy5faXNOZXdEYXRhO1xuICAgIH1cblxuICAgIHB1YmxpYyBfdXBkYXRlV2lkZ2V0U3RhdGUobmV3V2lkZ2V0U3RhdGUgOiBXaWRnZXRTdGF0ZSk6IHZvaWQge1xuICAgICAgICBjb25zdCBjdXJyZW50V2lkZ2V0c1N0YXRlID0gdGhpcy5fd2lkZ2V0c1N0YXRlLmdldFZhbHVlKCk7XG5cbiAgICAgICAgaWYgKCFuZXdXaWRnZXRTdGF0ZSB8fCAhbmV3V2lkZ2V0U3RhdGUua2V5KSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIud2FybignW3dpZGdldHMgbWFuYWdlcl0gY2Fubm90IHVwZGF0ZSB3aWRnZXQgc3RhdGUsIG1pc3Npbmcgd2lkZ2V0IGtleScpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRzIG1hbmFnZXJdIHdpZGdldCAnJHtuZXdXaWRnZXRTdGF0ZS5rZXl9JzogdXBkYXRlIHdpZGdldCBzdGF0ZWAsIG5ld1dpZGdldFN0YXRlKTtcbiAgICAgICAgICAgIGN1cnJlbnRXaWRnZXRzU3RhdGVbbmV3V2lkZ2V0U3RhdGUua2V5XSA9IG5ld1dpZGdldFN0YXRlO1xuICAgICAgICAgICAgdGhpcy5fd2lkZ2V0c1N0YXRlLm5leHQoY3VycmVudFdpZGdldHNTdGF0ZSk7XG5cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyByZWdpc3RlcldpZGdldHMod2lkZ2V0cyA6IFdpZGdldEJhc2U8dGhpcywgVERhdGEsVFJlcXVlc3Q+W10pXG4gICAge1xuICAgICAgICBpZiAod2lkZ2V0cylcbiAgICAgICAge1xuICAgICAgICAgICAgd2lkZ2V0cy5mb3JFYWNoKHdpZGdldCA9PlxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nUmVnaXN0ZXJlZFdpZGdldCA9IHRoaXMuX3dpZGdldHMuZmluZChyZWdpc3RlcmVkV2lkZ2V0ID0+IHJlZ2lzdGVyZWRXaWRnZXQgPT09IHdpZGdldCB8fCByZWdpc3RlcmVkV2lkZ2V0LmtleSA9PT0gd2lkZ2V0LmtleSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdSZWdpc3RlcmVkV2lkZ2V0KVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhIHdpZGdldCB3aXRoIGtleSAnJHt3aWRnZXQua2V5fScgaXMgYWxyZWFkeSByZWdpc3RlcmVkIChkaWQgeW91IHJlZ2lzdGVyZWQgdGhlIHNhbWUgd2lkZ2V0IHR3aWNlPylgKTtcbiAgICAgICAgICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBbd2lkZ2V0cyBtYW5hZ2VyXSB3aWRnZXQgJyR7d2lkZ2V0LmtleX0nOiByZWdpc3RlcmVkIHRvIGEgZm9ybSB3aWRnZXRzIG1hbmFnZXJgKTtcbiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0Ll9zZXRGb3JtKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl93aWRnZXRzLnB1c2god2lkZ2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgbm90aWZ5RGF0YUxvYWRpbmcoZGF0YUlkOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRzIG1hbmFnZXJdIG5vdGlmeSBkYXRhIGxvYWRpbmcuIGRhdGEgaWRlbnRpZmllciAnJHtkYXRhSWR9J2ApO1xuXG4gICAgICAgIHRoaXMuX3dpZGdldHMuZmlsdGVyKHdpZGdldCA9PiB3aWRnZXQuaXNBY3RpdmUpLmZvckVhY2god2lkZ2V0ID0+IHtcbiAgICAgICAgICAgIHdpZGdldC5fcmVzZXQoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fd2lkZ2V0cy5mb3JFYWNoKHdpZGdldCA9PiB7XG4gICAgICAgICAgICB3aWRnZXQuX2hhbmRsZURhdGFMb2FkaW5nKGRhdGFJZCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBub3RpZnlEYXRhTG9hZGVkKGRhdGE6IFREYXRhLCBzZXR0aW5nczogeyBpc05ld0RhdGE6IGJvb2xlYW4gfSkgOiB7IGVycm9ycz86IEVycm9yW10gfSB7XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRzIG1hbmFnZXJdIG5vdGlmeSBkYXRhIGxvYWRlZC5gKTtcbiAgICAgICAgY29uc3QgZXJyb3JzIDogRXJyb3JbXSA9IFtdO1xuICAgICAgICB0aGlzLl9pc05ld0RhdGEgPSBzZXR0aW5ncy5pc05ld0RhdGE7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBbd2lkZ2V0cyBtYW5hZ2VyXSB0cmVhdCBkYXRhIGFzICcke3RoaXMuX2lzTmV3RGF0YSA/ICduZXcnIDogJ2V4aXN0aW5nJ30gZGF0YScuYCk7XG4gICAgICAgIHRoaXMuX3dpZGdldHMuZm9yRWFjaCh3aWRnZXQgPT4ge1xuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHdpZGdldC5faGFuZGxlRGF0YUxvYWRlZChkYXRhKTtcbiAgICAgICAgICAgICAgICB3aWRnZXQuYWN0aXZhdGUoKTtcbiAgICAgICAgICAgIH1jYXRjaChlKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4geyBlcnJvcnMgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF93aWRnZXRzT25EYXRhU2F2aW5nKG5ld0RhdGE6IFREYXRhLCByZXF1ZXN0OiBUUmVxdWVzdCwgb3JpZ2luYWxEYXRhOiBURGF0YSk6IHsgZXJyb3JzPzogRXJyb3JbXSB9IHtcbiAgICAgICAgY29uc3QgZXJyb3JzOiBFcnJvcltdID0gW107XG4gICAgICAgIGNvbnN0IHdpZGdldHMgPSB0aGlzLl9pc05ld0RhdGEgPyB0aGlzLl93aWRnZXRzIDogdGhpcy5fd2lkZ2V0cy5maWx0ZXIod2lkZ2V0ID0+IHdpZGdldC5pc0FjdGl2ZSk7XG4gICAgICAgIHdpZGdldHMuZm9yRWFjaCh3aWRnZXQgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldHMgbWFuYWdlcl0gd2lkZ2V0ICcke3dpZGdldC5rZXl9JzogYnVpbGQgc2F2ZSByZXF1ZXN0IGNvbnRlbnRgKTtcbiAgICAgICAgICAgICAgICB3aWRnZXQuX2hhbmRsZURhdGFTYXZpbmcobmV3RGF0YSwgcmVxdWVzdCwgb3JpZ2luYWxEYXRhKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgW3dpZGdldHMgbWFuYWdlcl0gd2lkZ2V0ICcke3dpZGdldC5rZXl9JzogZmFpbGVkIHRvIHByZXBhcmUgZGF0YSBmb3Igc2F2ZS4gU2F2ZSBvcGVyYXRpb24gYWJvcnRlZC5gLCBlcnIpOyAvLyBrZWVwIGVycm9yXG4gICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHtlcnJvcnN9O1xuICAgIH1cblxuICAgIHB1YmxpYyBub3RpZnlEYXRhU2F2aW5nKG5ld0RhdGE6IFREYXRhLCByZXF1ZXN0OiBUUmVxdWVzdCwgb3JpZ2luYWxEYXRhOiBURGF0YSk6IE9ic2VydmFibGU8eyByZWFkeTogYm9vbGVhbiwgcmVhc29uPzogT25EYXRhU2F2aW5nUmVhc29ucywgZXJyb3JzPzogRXJyb3JbXSB9PiB7XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oYFt3aWRnZXRzIG1hbmFnZXJdIG5vdGlmeSBkYXRhIHNhdmluZy5gKTtcblxuICAgICAgICBjb25zdCBpc0F0dGFjaGVkV2lkZ2V0QnVzeSA9ICEhdGhpcy5fd2lkZ2V0cy5maW5kKHdpZGdldCA9PiB3aWRnZXQuaXNBdHRhY2hlZCAmJiB3aWRnZXQuaXNCdXN5KTtcblxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZihpc0F0dGFjaGVkV2lkZ2V0QnVzeSA/XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcmVhZHk6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJlYXNvbjogT25EYXRhU2F2aW5nUmVhc29ucy5hdHRhY2hlZFdpZGdldEJ1c3lcbiAgICAgICAgICAgIH0gOiB7cmVhZHk6IHRydWV9IClcbiAgICAgICAgICAgIC5waXBlKGNhbmNlbE9uRGVzdHJveSh0aGlzKSlcbiAgICAgICAgICAgIC5mbGF0TWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UucmVhZHkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRlV2lkZ2V0cygpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yLCBjYXVnaHQpID0+IE9ic2VydmFibGUub2Yoe2lzVmFsaWQ6IGZhbHNlfSkpXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKHJlc3BvbnNlID0+IHJlc3BvbnNlLmlzVmFsaWQgPyB7cmVhZHk6IHRydWV9IDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWR5OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFzb246IE9uRGF0YVNhdmluZ1JlYXNvbnMudmFsaWRhdGlvbkVycm9yc1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAubWFwKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UucmVhZHkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2F2ZUNvbnRlbnQgPSB0aGlzLl93aWRnZXRzT25EYXRhU2F2aW5nKG5ld0RhdGEsIHJlcXVlc3QsIG9yaWdpbmFsRGF0YSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHNhdmVDb250ZW50LmVycm9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7cmVhZHk6IHRydWUsIHJlYXNvbjogbnVsbH07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWR5OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFzb246IE9uRGF0YVNhdmluZ1JlYXNvbnMuYnVpbGRSZXF1ZXN0RmFpbHVyZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnM6IHNhdmVDb250ZW50LmVycm9yc1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF92YWxpZGF0ZVdpZGdldHMoKTogT2JzZXJ2YWJsZTx7IGlzVmFsaWQ6IGJvb2xlYW4gfT4ge1xuICAgICAgICBjb25zdCB3aWRnZXRzID0gdGhpcy5faXNOZXdEYXRhID8gdGhpcy5fd2lkZ2V0cyA6IHRoaXMuX3dpZGdldHMuZmlsdGVyKHdpZGdldCA9PiB3aWRnZXQuaXNBY3RpdmUpO1xuICAgICAgICBjb25zdCB3aWRnZXRzUmVzdWx0cyA9IHdpZGdldHMubWFwKHdpZGdldCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gd2lkZ2V0Ll92YWxpZGF0ZSgpXG4gICAgICAgICAgICAgICAgLnBpcGUoY2FuY2VsT25EZXN0cm95KHRoaXMpKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyLCBjYXVnaHQpID0+IE9ic2VydmFibGUub2Yoe2lzVmFsaWQ6IGZhbHNlfSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAod2lkZ2V0c1Jlc3VsdHMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mb3JrSm9pbiguLi53aWRnZXRzUmVzdWx0cykubWFwKHJlc3BvbnNlcyA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlcy5maW5kKHJlc3BvbnNlID0+ICFyZXNwb25zZS5pc1ZhbGlkKSB8fCB7aXNWYWxpZDogdHJ1ZX07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKHtpc1ZhbGlkOiB0cnVlfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5fd2lkZ2V0cy5mb3JFYWNoKHdpZGdldCA9PlxuICAgICAgICB7XG4gICAgICAgICAgICB3aWRnZXQuZGVzdG9yeSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9sb2dnZXIud2FybignW3dpZGdldHMgbWFuYWdlcl0gZm9ybSB3aWRnZXRzIG1hbmFnZXIgbmdPbkRlc3Ryb3knKTtcbiAgICAgICAgdGhpcy5fd2lkZ2V0c1N0YXRlLmNvbXBsZXRlKCk7XG4gICAgfVxuc1xuXG5cbn1cbiJdfQ==