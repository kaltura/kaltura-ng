import { Observable } from 'rxjs/Observable';
import { ReplaySubject } from 'rxjs/ReplaySubject';
import 'rxjs/add/observable/of';
import { Subject } from 'rxjs/Subject';
import 'rxjs/add/observable/of';
import 'rxjs/add/operator/catch';
import 'rxjs/add/operator/do';
import { EmptyLogger } from '@kaltura-ng/kaltura-common';
// DEVELOPER NOTE: Don't implement ngOnDestroy - the inheritor will probably override this without calling super()
var WidgetBase = /** @class */ (function () {
    function WidgetBase(_key, logger) {
        this._key = _key;
        // DEVELOPER NOTE: this class cannot use 'cancelOnDestroy' operation
        // because it must assume the inheriter will override it
        this._activateSubscription = null;
        this._dataSource = new ReplaySubject(1);
        this.data$ = this._dataSource.asObservable();
        this._widgetState = { key: this.key, isValid: true, isDirty: false, isAttached: false, isBusy: false, isActive: false, wasActivated: false };
        this._widgetReset = new Subject();
        this.widgetReset$ = this._widgetReset.asObservable();
        if (!_key) {
            throw new Error("Form widget key is required when constructing widget of type '" + typeof this);
        }
        this._logger = logger ? logger.subLogger("widgets." + _key) : new EmptyLogger();
    }
    Object.defineProperty(WidgetBase.prototype, "data", {
        get: function () {
            return this._data;
        },
        enumerable: true,
        configurable: true
    });
    WidgetBase.prototype.onDataSaving = function (newData, request, originalData) {
    };
    Object.defineProperty(WidgetBase.prototype, "wasActivated", {
        get: function () {
            return this._widgetState.wasActivated;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetBase.prototype, "isValid", {
        get: function () {
            return this._widgetState.isValid;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetBase.prototype, "isDirty", {
        get: function () {
            return this._widgetState.isDirty;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetBase.prototype, "isActive", {
        get: function () {
            return this._widgetState.isActive;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetBase.prototype, "isAttached", {
        get: function () {
            return this._widgetState.isAttached;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetBase.prototype, "isBusy", {
        get: function () {
            return this._widgetState.isBusy;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetBase.prototype, "key", {
        get: function () {
            return this._key;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(WidgetBase.prototype, "isNewData", {
        get: function () {
            return this.form.isNewData;
        },
        enumerable: true,
        configurable: true
    });
    WidgetBase.prototype.onValidate = function (wasActivated) {
        return Observable.of({ isValid: true });
    };
    WidgetBase.prototype.updateState = function (stateUpdate) {
        this._updateState(stateUpdate);
    };
    WidgetBase.prototype._updateState = function (stateUpdate) {
        var _this = this;
        this._verifyRegistered();
        var stateHasChanges = Object.keys(stateUpdate).reduce(function (result, propertyName) { return result || _this._widgetState[propertyName] !== stateUpdate[propertyName]; }, false);
        if (stateHasChanges) {
            Object.assign(this._widgetState, stateUpdate);
            if (this.form) {
                var newWidgetState = Object.assign({}, this._widgetState);
                this.form._updateWidgetState(newWidgetState);
            }
        }
    };
    WidgetBase.prototype.onDataLoaded = function (data) {
    };
    WidgetBase.prototype.onDataLoading = function (dataId) {
    };
    WidgetBase.prototype.onActivate = function (firstTimeActivating) {
    };
    WidgetBase.prototype._setForm = function (manager) {
        this.form = manager;
    };
    WidgetBase.prototype._handleDataLoading = function (dataId) {
        this._verifyRegistered();
        this._setData(null);
        this.onDataLoading(dataId);
    };
    WidgetBase.prototype._setData = function (data) {
        this._data = data;
        this._dataSource.next(data);
    };
    WidgetBase.prototype._handleDataLoaded = function (data) {
        this._verifyRegistered();
        this._setData(data);
        this.onDataLoaded(data);
    };
    WidgetBase.prototype._validate = function () {
        var _this = this;
        this._verifyRegistered();
        return this.onValidate(this.wasActivated)
            .do(function (response) {
            var updateState = (response.isValid !== _this._widgetState.isValid);
            if (updateState) {
                _this._logger.info("[widget] widget '" + _this.key + "': widget 'isValid' state doesn't match result of 'onValidate'. updating status to '" + (response.isValid ? 'valid' : 'invalid') + "'");
                _this.updateState({ isValid: response.isValid });
            }
        });
    };
    WidgetBase.prototype._handleDataSaving = function (newData, request, originalData) {
        this._verifyRegistered();
        this.onDataSaving(newData, request, originalData);
    };
    WidgetBase.prototype._reset = function () {
        this._verifyRegistered();
        this._logger.info("[widget] widget '" + this.key + "': reset widget");
        if (this._activateSubscription) {
            this._activateSubscription.unsubscribe();
            this._activateSubscription = null;
        }
        this._widgetReset.next('');
        this._updateState({ isValid: true, isDirty: false, isActive: false, isBusy: false });
        this.onReset();
    };
    WidgetBase.prototype._verifyRegistered = function () {
        if (!this.form) {
            this._logger.error("[widget] widget '" + this.key + "': cannot perform action, widget is not registered to a manager (did you forgot to register it in the main route component?)");
            throw new Error("[widget] cannot perform action. widget with key ''" + this.key + "'' is not registered to a manager");
        }
    };
    WidgetBase.prototype.activate = function () {
        var _this = this;
        this._verifyRegistered();
        if (this.data && this.isAttached && !this.isActive) {
            this._reset();
            var previousStatus_1 = {
                wasActivated: this.wasActivated
            };
            this._logger.info("[widget] widget '" + this.key + "': activating widget (first time = " + !previousStatus_1.wasActivated + ")");
            var activate$ = this.onActivate(!this.wasActivated);
            this._updateState({ isActive: true, wasActivated: true });
            if (activate$ instanceof Observable) {
                this._logger.info("[widget] widget '" + this.key + "': widget requested for async activation operation. executing async operation.");
                this._activateSubscription = activate$
                    .catch(function (error, caught) { return Observable.of({ failed: true, error: error }); })
                    .subscribe(function (response) {
                    if (response && response.failed) {
                        _this._logger.info("[widget] widget '" + _this.key + "': async widget activation failed. revert state to " + JSON.stringify(previousStatus_1) + ")");
                        _this._updateState({ isActive: false, wasActivated: previousStatus_1.wasActivated });
                    }
                    else {
                        _this._logger.info("[widget] widget '" + _this.key + "': async widget activation completed");
                    }
                }, function () {
                    _this._activateSubscription = null;
                }, function () {
                    _this._activateSubscription = null;
                });
            }
        }
    };
    WidgetBase.prototype.attachForm = function () {
        this._verifyRegistered();
        if (this.isAttached) {
            this._logger.warn("[widget] widget with key '" + this.key + "' is already attached (did you attached two components to the same widget? did you forgot to detach the widget upon ngOnDestroy?)");
        }
        else {
            this._logger.info("[widget] widget '" + this.key + "': attaching widget");
            this._updateState({ isAttached: true });
            this.activate();
        }
    };
    WidgetBase.prototype.detachForm = function () {
        this._verifyRegistered();
        if (!this.isAttached) {
            this._logger.warn("[widget] widget with key '" + this.key + "' is already detached (did you attached two components to the same widget? did you forgot to attach the widget upon ngOnInit?)");
        }
        else {
            this._logger.info("[widget] widget '" + this.key + "': detaching widget");
            this._updateState({ isAttached: false });
        }
    };
    WidgetBase.prototype.destory = function () {
        this._reset();
        this._widgetReset.complete();
    };
    return WidgetBase;
}());
export { WidgetBase };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LWJhc2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Aa2FsdHVyYS1uZy9rYWx0dXJhLXVpLyIsInNvdXJjZXMiOlsibGliL3dpZGdldHMvd2lkZ2V0LWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNuRCxPQUFPLHdCQUF3QixDQUFDO0FBQ2hDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDdkMsT0FBTyx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLHlCQUF5QixDQUFDO0FBQ2pDLE9BQU8sc0JBQXNCLENBQUM7QUFJOUIsT0FBTyxFQUFpQixXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV4RSxrSEFBa0g7QUFDbEg7SUFlSSxvQkFBb0IsSUFBYSxFQUFFLE1BQXNCO1FBQXJDLFNBQUksR0FBSixJQUFJLENBQVM7UUFUakMsb0VBQW9FO1FBQ3BFLHdEQUF3RDtRQUNoRCwwQkFBcUIsR0FBa0IsSUFBSSxDQUFDO1FBRzVDLGdCQUFXLEdBQXlCLElBQUksYUFBYSxDQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2pFLFVBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBYXZDLGlCQUFZLEdBQWlCLEVBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFHLEtBQUssRUFBRSxRQUFRLEVBQUcsS0FBSyxFQUFHLFlBQVksRUFBRyxLQUFLLEVBQUMsQ0FBQztRQVN4SixpQkFBWSxHQUFrQixJQUFJLE9BQU8sRUFBTyxDQUFDO1FBQ2xELGlCQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FB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LENBQUMsQ0FBQztTQUM1TDthQUFLO1lBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsc0JBQW9CLElBQUksQ0FBQyxHQUFHLHdCQUFxQixDQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO1NBQzFDO0lBQ0wsQ0FBQztJQUVELDRCQUFPLEdBQVA7UUFDSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFFTCxpQkFBQztBQUFELENBQUMsQUFqUEQsSUFpUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzL1JlcGxheVN1YmplY3QnO1xuaW1wb3J0ICdyeGpzL2FkZC9vYnNlcnZhYmxlL29mJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzL1N1YmplY3QnO1xuaW1wb3J0ICdyeGpzL2FkZC9vYnNlcnZhYmxlL29mJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvY2F0Y2gnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9kbyc7XG5pbXBvcnQgeyBXaWRnZXRzTWFuYWdlckJhc2UgfSBmcm9tICcuL3dpZGdldHMtbWFuYWdlci1iYXNlJztcbmltcG9ydCB7IElTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzL1N1YnNjcmlwdGlvbic7XG5pbXBvcnQgeyBXaWRnZXRTdGF0ZSwgV2lkZ2V0U3RhdGVEYXRhIH0gZnJvbSAnLi93aWRnZXQtc3RhdGUnO1xuaW1wb3J0IHsgS2FsdHVyYUxvZ2dlciwgRW1wdHlMb2dnZXIgfSBmcm9tICdAa2FsdHVyYS1uZy9rYWx0dXJhLWNvbW1vbic7XG5cbi8vIERFVkVMT1BFUiBOT1RFOiBEb24ndCBpbXBsZW1lbnQgbmdPbkRlc3Ryb3kgLSB0aGUgaW5oZXJpdG9yIHdpbGwgcHJvYmFibHkgb3ZlcnJpZGUgdGhpcyB3aXRob3V0IGNhbGxpbmcgc3VwZXIoKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFdpZGdldEJhc2U8VEZvcm0gZXh0ZW5kcyBXaWRnZXRzTWFuYWdlckJhc2U8VERhdGEsVFJlcXVlc3Q+LCBURGF0YSwgVFJlcXVlc3Q+XG57XG4gICAgcHVibGljIGdldCBkYXRhKCk6IFREYXRhIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7XG4gICAgfVxuXG4gICAgLy8gREVWRUxPUEVSIE5PVEU6IHRoaXMgY2xhc3MgY2Fubm90IHVzZSAnY2FuY2VsT25EZXN0cm95JyBvcGVyYXRpb25cbiAgICAvLyBiZWNhdXNlIGl0IG11c3QgYXNzdW1lIHRoZSBpbmhlcml0ZXIgd2lsbCBvdmVycmlkZSBpdFxuICAgIHByaXZhdGUgX2FjdGl2YXRlU3Vic2NyaXB0aW9uOiBJU3Vic2NyaXB0aW9uID0gbnVsbDtcblxuICAgIHByaXZhdGUgX2RhdGE6IFREYXRhO1xuICAgIHByaXZhdGUgX2RhdGFTb3VyY2U6IFJlcGxheVN1YmplY3Q8VERhdGE+ID0gbmV3IFJlcGxheVN1YmplY3Q8VERhdGE+KDEpO1xuICAgIHB1YmxpYyBkYXRhJCA9IHRoaXMuX2RhdGFTb3VyY2UuYXNPYnNlcnZhYmxlKCk7XG4gICAgcHJvdGVjdGVkIF9sb2dnZXI6IEthbHR1cmFMb2dnZXI7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9rZXkgOiBzdHJpbmcsIGxvZ2dlcj86IEthbHR1cmFMb2dnZXIpXG4gICAge1xuICAgICAgICBpZiAoIV9rZXkpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRm9ybSB3aWRnZXQga2V5IGlzIHJlcXVpcmVkIHdoZW4gY29uc3RydWN0aW5nIHdpZGdldCBvZiB0eXBlICcke3R5cGVvZiB0aGlzfWApO1xuICAgICAgICB9XG5cblx0ICAgIHRoaXMuX2xvZ2dlciA9IGxvZ2dlciA/IGxvZ2dlci5zdWJMb2dnZXIoYHdpZGdldHMuJHtfa2V5fWApIDogbmV3IEVtcHR5TG9nZ2VyKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfd2lkZ2V0U3RhdGUgOiBXaWRnZXRTdGF0ZSA9IHtrZXk6IHRoaXMua2V5LCBpc1ZhbGlkOiB0cnVlLCBpc0RpcnR5OiBmYWxzZSwgaXNBdHRhY2hlZDogZmFsc2UsIGlzQnVzeSA6IGZhbHNlLCBpc0FjdGl2ZSA6IGZhbHNlLCAgd2FzQWN0aXZhdGVkIDogZmFsc2V9O1xuXG4gICAgcHJvdGVjdGVkIG9uRGF0YVNhdmluZyhuZXdEYXRhOiBURGF0YSwgcmVxdWVzdDogVFJlcXVlc3QsIG9yaWdpbmFsRGF0YTogVERhdGEpOiB2b2lkO1xuICAgIHByb3RlY3RlZCBvbkRhdGFTYXZpbmcobmV3RGF0YTogVERhdGEsIHJlcXVlc3Q6IFRSZXF1ZXN0KTogdm9pZDtcbiAgICBwcm90ZWN0ZWQgb25EYXRhU2F2aW5nKG5ld0RhdGE6IFREYXRhLCByZXF1ZXN0OiBUUmVxdWVzdCwgb3JpZ2luYWxEYXRhPzogVERhdGEpOiB2b2lkIHtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZm9ybSA6IFRGb3JtO1xuXG4gICAgcHJpdmF0ZSBfd2lkZ2V0UmVzZXQgOiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gICAgcHVibGljIHdpZGdldFJlc2V0JCA9IHRoaXMuX3dpZGdldFJlc2V0LmFzT2JzZXJ2YWJsZSgpO1xuXG4gICAgcHVibGljIGdldCB3YXNBY3RpdmF0ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl93aWRnZXRTdGF0ZS53YXNBY3RpdmF0ZWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc1ZhbGlkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fd2lkZ2V0U3RhdGUuaXNWYWxpZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzRGlydHkoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl93aWRnZXRTdGF0ZS5pc0RpcnR5O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXNBY3RpdmUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl93aWRnZXRTdGF0ZS5pc0FjdGl2ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzQXR0YWNoZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl93aWRnZXRTdGF0ZS5pc0F0dGFjaGVkO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXNCdXN5KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fd2lkZ2V0U3RhdGUuaXNCdXN5O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQga2V5KCk6IHN0cmluZ1xuICAgIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2tleTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzTmV3RGF0YSgpOiBib29sZWFue1xuICAgICAgICByZXR1cm4gdGhpcy5mb3JtLmlzTmV3RGF0YTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25WYWxpZGF0ZSh3YXNBY3RpdmF0ZWQ6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPHtpc1ZhbGlkOiBib29sZWFufT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZih7aXNWYWxpZDogdHJ1ZX0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCB1cGRhdGVTdGF0ZShzdGF0ZVVwZGF0ZSA6IHtpc1ZhbGlkPyA6IGJvb2xlYW4sIGlzRGlydHk/IDogYm9vbGVhbiwgaXNCdXN5PyA6IGJvb2xlYW59KSA6IHZvaWQge1xuICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZShzdGF0ZVVwZGF0ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdXBkYXRlU3RhdGUoc3RhdGVVcGRhdGUgOiBQYXJ0aWFsPFdpZGdldFN0YXRlRGF0YT4pIDogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5fdmVyaWZ5UmVnaXN0ZXJlZCgpO1xuXG4gICAgICAgIGNvbnN0IHN0YXRlSGFzQ2hhbmdlcyA9IE9iamVjdC5rZXlzKHN0YXRlVXBkYXRlKS5yZWR1Y2UoKHJlc3VsdCwgcHJvcGVydHlOYW1lKSA9PiByZXN1bHQgfHwgdGhpcy5fd2lkZ2V0U3RhdGVbcHJvcGVydHlOYW1lXSAhPT0gc3RhdGVVcGRhdGVbcHJvcGVydHlOYW1lXSwgZmFsc2UpO1xuXG4gICAgICAgIGlmIChzdGF0ZUhhc0NoYW5nZXMpIHtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5fd2lkZ2V0U3RhdGUsIHN0YXRlVXBkYXRlKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuZm9ybSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1dpZGdldFN0YXRlID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5fd2lkZ2V0U3RhdGUpO1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybS5fdXBkYXRlV2lkZ2V0U3RhdGUobmV3V2lkZ2V0U3RhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG9uRGF0YUxvYWRlZChkYXRhOiBURGF0YSk6IHZvaWQge1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBvbkRhdGFMb2FkaW5nKGRhdGFJZDogYW55KTogdm9pZCB7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IG9uUmVzZXQoKTtcblxuICAgIHByb3RlY3RlZCBvbkFjdGl2YXRlKGZpcnN0VGltZUFjdGl2YXRpbmc6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPHtmYWlsZWQ6IGJvb2xlYW4sIGVycm9yPzogRXJyb3J9PiB8IHZvaWQge1xuICAgIH1cblxuICAgIHB1YmxpYyBfc2V0Rm9ybShtYW5hZ2VyIDogVEZvcm0pIDp2b2lkIHtcbiAgICAgICAgdGhpcy5mb3JtID0gbWFuYWdlcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgX2hhbmRsZURhdGFMb2FkaW5nKGRhdGFJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcbiAgICAgICAgdGhpcy5fc2V0RGF0YShudWxsKTtcbiAgICAgICAgdGhpcy5vbkRhdGFMb2FkaW5nKGRhdGFJZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2V0RGF0YShkYXRhOiBURGF0YSk6IHZvaWR7XG4gICAgICAgIHRoaXMuX2RhdGEgPSBkYXRhO1xuICAgICAgICB0aGlzLl9kYXRhU291cmNlLm5leHQoZGF0YSk7XG4gICAgfVxuXG4gICAgcHVibGljIF9oYW5kbGVEYXRhTG9hZGVkKGRhdGE6IFREYXRhKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcbiAgICAgICAgdGhpcy5fc2V0RGF0YShkYXRhKTtcbiAgICAgICAgdGhpcy5vbkRhdGFMb2FkZWQoZGF0YSk7XG4gICAgfVxuXG4gICAgcHVibGljIF92YWxpZGF0ZSgpOiBPYnNlcnZhYmxlPHtpc1ZhbGlkOiBib29sZWFufT4ge1xuXG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vblZhbGlkYXRlKHRoaXMud2FzQWN0aXZhdGVkKVxuICAgICAgICAgICAgLmRvKFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlU3RhdGUgPSAocmVzcG9uc2UuaXNWYWxpZCAhPT0gdGhpcy5fd2lkZ2V0U3RhdGUuaXNWYWxpZCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IHdpZGdldCAnaXNWYWxpZCcgc3RhdGUgZG9lc24ndCBtYXRjaCByZXN1bHQgb2YgJ29uVmFsaWRhdGUnLiB1cGRhdGluZyBzdGF0dXMgdG8gJyR7cmVzcG9uc2UuaXNWYWxpZCA/ICd2YWxpZCcgOiAnaW52YWxpZCd9J2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7aXNWYWxpZDogcmVzcG9uc2UuaXNWYWxpZH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgX2hhbmRsZURhdGFTYXZpbmcobmV3RGF0YTogVERhdGEsIHJlcXVlc3Q6IFRSZXF1ZXN0LCBvcmlnaW5hbERhdGE6IFREYXRhKTogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5fdmVyaWZ5UmVnaXN0ZXJlZCgpO1xuICAgICAgICB0aGlzLm9uRGF0YVNhdmluZyhuZXdEYXRhLCByZXF1ZXN0LCBvcmlnaW5hbERhdGEpO1xuICAgIH1cblxuICAgIHB1YmxpYyBfcmVzZXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcblxuICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IHJlc2V0IHdpZGdldGApO1xuXG4gICAgICAgIGlmICh0aGlzLl9hY3RpdmF0ZVN1YnNjcmlwdGlvbilcbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5fYWN0aXZhdGVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRlU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3dpZGdldFJlc2V0Lm5leHQoJycpO1xuICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSh7IGlzVmFsaWQ6IHRydWUsIGlzRGlydHk6IGZhbHNlLCBpc0FjdGl2ZSA6IGZhbHNlLCBpc0J1c3k6IGZhbHNlfSk7XG4gICAgICAgIHRoaXMub25SZXNldCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3ZlcmlmeVJlZ2lzdGVyZWQoKTogdm9pZHtcbiAgICAgICAgaWYoIXRoaXMuZm9ybSlcbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBbd2lkZ2V0XSB3aWRnZXQgJyR7dGhpcy5rZXl9JzogY2Fubm90IHBlcmZvcm0gYWN0aW9uLCB3aWRnZXQgaXMgbm90IHJlZ2lzdGVyZWQgdG8gYSBtYW5hZ2VyIChkaWQgeW91IGZvcmdvdCB0byByZWdpc3RlciBpdCBpbiB0aGUgbWFpbiByb3V0ZSBjb21wb25lbnQ/KWApO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbd2lkZ2V0XSBjYW5ub3QgcGVyZm9ybSBhY3Rpb24uIHdpZGdldCB3aXRoIGtleSBcXCcnJHt0aGlzLmtleX0nXFwnIGlzIG5vdCByZWdpc3RlcmVkIHRvIGEgbWFuYWdlcmApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFjdGl2YXRlKCk6IHZvaWQge1xuXG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcblxuICAgICAgICBpZiAodGhpcy5kYXRhICYmIHRoaXMuaXNBdHRhY2hlZCAmJiAhdGhpcy5pc0FjdGl2ZSkge1xuXG4gICAgICAgICAgICB0aGlzLl9yZXNldCgpO1xuXG4gICAgICAgICAgICBjb25zdCBwcmV2aW91c1N0YXR1cyA9IHtcbiAgICAgICAgICAgICAgd2FzQWN0aXZhdGVkIDogdGhpcy53YXNBY3RpdmF0ZWRcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBbd2lkZ2V0XSB3aWRnZXQgJyR7dGhpcy5rZXl9JzogYWN0aXZhdGluZyB3aWRnZXQgKGZpcnN0IHRpbWUgPSAkeyFwcmV2aW91c1N0YXR1cy53YXNBY3RpdmF0ZWR9KWApO1xuICAgICAgICAgICAgY29uc3QgYWN0aXZhdGUkID0gdGhpcy5vbkFjdGl2YXRlKCF0aGlzLndhc0FjdGl2YXRlZCk7XG4gICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSh7IGlzQWN0aXZlIDogdHJ1ZSwgd2FzQWN0aXZhdGVkIDogdHJ1ZX0pO1xuXG4gICAgICAgICAgICBpZiAoYWN0aXZhdGUkIGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBbd2lkZ2V0XSB3aWRnZXQgJyR7dGhpcy5rZXl9Jzogd2lkZ2V0IHJlcXVlc3RlZCBmb3IgYXN5bmMgYWN0aXZhdGlvbiBvcGVyYXRpb24uIGV4ZWN1dGluZyBhc3luYyBvcGVyYXRpb24uYCk7XG4gICAgICAgICAgICAgICAgdGhpcy5fYWN0aXZhdGVTdWJzY3JpcHRpb24gPSBhY3RpdmF0ZSRcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvciwgY2F1Z2h0KSA9PiBPYnNlcnZhYmxlLm9mKHtmYWlsZWQ6IHRydWUsIGVycm9yfSkpXG4gICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLmZhaWxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IGFzeW5jIHdpZGdldCBhY3RpdmF0aW9uIGZhaWxlZC4gcmV2ZXJ0IHN0YXRlIHRvICR7SlNPTi5zdHJpbmdpZnkocHJldmlvdXNTdGF0dXMpfSlgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUoeyBpc0FjdGl2ZSA6IGZhbHNlLCB3YXNBY3RpdmF0ZWQgOiBwcmV2aW91c1N0YXR1cy53YXNBY3RpdmF0ZWR9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBbd2lkZ2V0XSB3aWRnZXQgJyR7dGhpcy5rZXl9JzogYXN5bmMgd2lkZ2V0IGFjdGl2YXRpb24gY29tcGxldGVkYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY3RpdmF0ZVN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRlU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGF0dGFjaEZvcm0oKSA6IHZvaWR7XG4gICAgICAgIHRoaXMuX3ZlcmlmeVJlZ2lzdGVyZWQoKTtcblxuICAgICAgICBpZiAodGhpcy5pc0F0dGFjaGVkKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIud2FybihgW3dpZGdldF0gd2lkZ2V0IHdpdGgga2V5ICcke3RoaXMua2V5fScgaXMgYWxyZWFkeSBhdHRhY2hlZCAoZGlkIHlvdSBhdHRhY2hlZCB0d28gY29tcG9uZW50cyB0byB0aGUgc2FtZSB3aWRnZXQ/IGRpZCB5b3UgZm9yZ290IHRvIGRldGFjaCB0aGUgd2lkZ2V0IHVwb24gbmdPbkRlc3Ryb3k/KWApO1xuICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgW3dpZGdldF0gd2lkZ2V0ICcke3RoaXMua2V5fSc6IGF0dGFjaGluZyB3aWRnZXRgKTtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlKHtpc0F0dGFjaGVkOiB0cnVlfSk7XG4gICAgICAgICAgICB0aGlzLmFjdGl2YXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZGV0YWNoRm9ybSgpIDogdm9pZHtcblxuICAgICAgICB0aGlzLl92ZXJpZnlSZWdpc3RlcmVkKCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmlzQXR0YWNoZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci53YXJuKGBbd2lkZ2V0XSB3aWRnZXQgd2l0aCBrZXkgJyR7dGhpcy5rZXl9JyBpcyBhbHJlYWR5IGRldGFjaGVkIChkaWQgeW91IGF0dGFjaGVkIHR3byBjb21wb25lbnRzIHRvIHRoZSBzYW1lIHdpZGdldD8gZGlkIHlvdSBmb3Jnb3QgdG8gYXR0YWNoIHRoZSB3aWRnZXQgdXBvbiBuZ09uSW5pdD8pYCk7XG4gICAgICAgIH1lbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBbd2lkZ2V0XSB3aWRnZXQgJyR7dGhpcy5rZXl9JzogZGV0YWNoaW5nIHdpZGdldGApO1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUoe2lzQXR0YWNoZWQ6IGZhbHNlfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZXN0b3J5KCkge1xuICAgICAgICB0aGlzLl9yZXNldCgpO1xuICAgICAgICB0aGlzLl93aWRnZXRSZXNldC5jb21wbGV0ZSgpO1xuICAgIH1cblxufVxuIl19