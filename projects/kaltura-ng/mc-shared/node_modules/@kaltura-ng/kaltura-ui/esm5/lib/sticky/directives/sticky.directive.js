import { __decorate, __metadata } from "tslib";
import { Directive, Input, Renderer2, ElementRef, AfterViewInit, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';
import { StickyScrollService } from '../services/sticky-scroll.service';
import { cancelOnDestroy } from '@kaltura-ng/kaltura-common';
var StickyDirective = /** @class */ (function () {
    function StickyDirective(elementRef, renderer, _stickyScrollService) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this._stickyScrollService = _stickyScrollService;
        this.lastScroll = 0;
        this.isSticky = false;
        this._destroyed = false;
        this.onStickyEvent = new EventEmitter();
        this.onUnStickyEvent = new EventEmitter();
        this.scrollOffset = 0;
        this.stickyId = "";
        this.sticksTo = "";
        this.elementSelector = "";
        this._parentTop = null;
        this._parentOffset = null;
        this._stickyTop = null;
        this._stickyOffset = null;
    }
    StickyDirective.prototype._getStickyElement = function (elementRef) {
        return elementRef.nativeElement;
    };
    StickyDirective.prototype.ngAfterViewInit = function () {
        // console.log(`[${this.stickyId}] - ngAfterViewInit`);
        this._stickyElement = this._getStickyElement(this.elementRef);
        this.update();
    };
    StickyDirective.prototype.ngOnInit = function () {
        var _this = this;
        // console.log(`[${this.stickyId}] - attached`);
        if (this.stickyId) {
            this._stickyScrollService.attach(this.stickyId);
        }
        this._stickyScrollService.scrollStatus$.pipe(cancelOnDestroy(this)).subscribe(function (event) {
            // console.log(`[${this.stickyId}] - handle scroll`);
            _this._render();
        });
        this._stickyScrollService.resizeStatus$.pipe(cancelOnDestroy(this)).subscribe(function (event) {
            _this.onResize();
        });
        this._stickyScrollService.layoutSubject$.pipe(cancelOnDestroy(this)).subscribe(function (elements) {
            var data = _this.sticksTo ? elements[_this.sticksTo] : { height: 0, offset: 0 };
            if (data && (_this._parentTop !== data.height ||
                _this._parentOffset !== data.offset)) {
                _this._parentTop = data.height;
                _this._parentOffset = data.offset;
                _this.update();
            }
        });
    };
    StickyDirective.prototype.ngOnDestroy = function () {
        // console.log(`[${this.stickyId}] - destroyed`);
        this._destroyed = true;
        this._stickyScrollService.detach(this.stickyId);
    };
    StickyDirective.prototype.update = function () {
        var _this = this;
        if (this._parentTop !== null
            && this._parentOffset != null) {
            // console.log(`[${this.stickyId}] - handle layout update`);
            var stickyOffset = this._parentOffset + this.scrollOffset;
            if (this._stickyTop !== this._parentTop ||
                this._stickyOffset !== stickyOffset) {
                // console.log(`[${this.stickyId}] - update cached values`);
                this._stickyTop = this._parentTop;
                this._stickyOffset = stickyOffset;
                this._render();
            }
            if (this.stickyId && this._stickyElement) {
                // console.log(`[${this.stickyId}] - update service`);
                var elementHeight_1 = this._stickyElement.getBoundingClientRect()['height'];
                setTimeout(function () {
                    _this._stickyScrollService.update(_this.stickyId, elementHeight_1 + _this._stickyTop, _this._stickyOffset);
                }, 0);
            }
        }
    };
    StickyDirective.prototype._render = function () {
        if (!this._destroyed && this._stickyElement) {
            // console.log(`[${this.stickyId}] - _render`);
            if (this._stickyTop !== null
                && this._stickyOffset != null) {
                var scroll_1 = window.pageYOffset;
                if (scroll_1 > this.lastScroll && !this.isSticky && this._stickyElement.getBoundingClientRect()['top'] <= this._stickyTop) {
                    // console.log(`[${this.stickyId}] - _render (set sticky mode)`);
                    this.setSticky();
                }
                else if (scroll_1 < this.lastScroll && this.isSticky && scroll_1 <= this._stickyOffset) {
                    // console.log(`[${this.stickyId}] - _render (unset sticky mode)`);
                    this.unsetSticky();
                }
                else {
                    if (this.isSticky && scroll_1 === this.lastScroll) {
                        this.setStyle('top', this._stickyTop + 'px');
                        // console.log(`[${this.stickyId}] - _render (update sitcky values) - TODO!!!!!!`);
                    }
                }
                this.lastScroll = scroll_1;
            }
        }
    };
    StickyDirective.prototype.setSticky = function () {
        if (!this.isSticky) {
            this.isSticky = true;
            // console.log(`[${this.stickyId}] - top = ${this._stickyElement.clientTop}`);
            this.originalCss = {
                position: this._stickyElement.style.position,
                top: this._stickyElement.clientTop,
                marginTop: this._stickyElement.style.marginTop,
                left: this._stickyElement.clientLeft
            };
            this.setStyle('position', 'fixed');
            this.setStyle('top', this._stickyTop + 'px');
            if (this.appendTo) {
                this.setStyle('left', this.appendTo.getBoundingClientRect()['left'] + 'px');
            }
            this.setClass(true);
            this.onStickyEvent.emit();
            this._onSticky();
        }
    };
    StickyDirective.prototype._onSticky = function () {
        var _this = this;
        setTimeout(function () { _this.update(); }, 0);
    };
    StickyDirective.prototype.unsetSticky = function () {
        if (this.isSticky) {
            this.isSticky = false;
            this.setStyle('position', this.originalCss.position);
            this.setStyle('marginTop', this.originalCss.marginTop);
            this.setStyle('top', this.originalCss.top + 'px');
            if (this.appendTo) {
                this.setStyle('left', this.originalCss.left + 'px');
            }
            this.setClass(false);
            this.onUnStickyEvent.emit();
            this._onUnsetSticky();
        }
    };
    StickyDirective.prototype._onUnsetSticky = function () {
        var _this = this;
        setTimeout(function () { _this.update(); }, 0);
    };
    StickyDirective.prototype.onResize = function () { };
    ; // used by primeng directive to update table layout
    StickyDirective.prototype.setStyle = function (key, value) {
        this.renderer.setStyle(this._stickyElement, key, value);
    };
    StickyDirective.prototype.setClass = function (add) {
        if (add) {
            this.renderer.addClass(this._stickyElement, this.stickyClass);
        }
        else {
            this.renderer.removeClass(this._stickyElement, this.stickyClass);
        }
    };
    StickyDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 },
        { type: StickyScrollService }
    ]; };
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], StickyDirective.prototype, "onStickyEvent", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], StickyDirective.prototype, "onUnStickyEvent", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], StickyDirective.prototype, "stickyClass", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Number)
    ], StickyDirective.prototype, "scrollOffset", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], StickyDirective.prototype, "appendTo", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], StickyDirective.prototype, "stickyId", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], StickyDirective.prototype, "sticksTo", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], StickyDirective.prototype, "elementSelector", void 0);
    StickyDirective = __decorate([
        Directive({
            selector: '[kSticky]'
        }),
        __metadata("design:paramtypes", [ElementRef, Renderer2, StickyScrollService])
    ], StickyDirective);
    return StickyDirective;
}());
export { StickyDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RpY2t5LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtdWkvIiwic291cmNlcyI6WyJsaWIvc3RpY2t5L2RpcmVjdGl2ZXMvc3RpY2t5LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hJLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxlQUFlLEVBQU8sTUFBTSw0QkFBNEIsQ0FBQztBQU1sRTtJQXVCSSx5QkFBb0IsVUFBc0IsRUFBVSxRQUFtQixFQUFVLG9CQUF5QztRQUF0RyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBcUI7UUF0QmxILGVBQVUsR0FBVyxDQUFDLENBQUM7UUFDeEIsYUFBUSxHQUFZLEtBQUssQ0FBQztRQUV6QixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBRWpCLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN4QyxvQkFBZSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFHM0MsaUJBQVksR0FBVyxDQUFDLENBQUM7UUFFekIsYUFBUSxHQUFXLEVBQUUsQ0FBQztRQUN0QixhQUFRLEdBQVcsRUFBRSxDQUFDO1FBQ3RCLG9CQUFlLEdBQVcsRUFBRSxDQUFDO1FBRTlCLGVBQVUsR0FBVyxJQUFJLENBQUM7UUFDMUIsa0JBQWEsR0FBVyxJQUFJLENBQUM7UUFDN0IsZUFBVSxHQUFXLElBQUksQ0FBQztRQUMxQixrQkFBYSxHQUFXLElBQUksQ0FBQztJQU1yQyxDQUFDO0lBRVMsMkNBQWlCLEdBQTNCLFVB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LElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQy9EO2FBQU07WUFDTCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNsRTtJQUNILENBQUM7O2dCQW5LK0IsVUFBVTtnQkFBb0IsU0FBUztnQkFBZ0MsbUJBQW1COztJQWpCaEg7UUFBVCxNQUFNLEVBQUU7OzBEQUF5QztJQUN4QztRQUFULE1BQU0sRUFBRTs7NERBQTJDO0lBRTNDO1FBQVIsS0FBSyxFQUFFOzt3REFBcUI7SUFDcEI7UUFBUixLQUFLLEVBQUU7O3lEQUEwQjtJQUN6QjtRQUFSLEtBQUssRUFBRTs7cURBQWU7SUFDZDtRQUFSLEtBQUssRUFBRTs7cURBQXVCO0lBQ3RCO1FBQVIsS0FBSyxFQUFFOztxREFBdUI7SUFDdEI7UUFBUixLQUFLLEVBQUU7OzREQUE4QjtJQWQ3QixlQUFlO1FBSjNCLFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxXQUFXO1NBQ3hCLENBQUM7eUNBeUJrQyxVQUFVLEVBQW9CLFNBQVMsRUFBZ0MsbUJBQW1CO09BdkJqSCxlQUFlLENBNEwzQjtJQUFELHNCQUFDO0NBQUEsQUE1TEQsSUE0TEM7U0E1TFksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIFJlbmRlcmVyMiwgRWxlbWVudFJlZiwgQWZ0ZXJWaWV3SW5pdCwgT25Jbml0LCBPbkRlc3Ryb3ksIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdGlja3lTY3JvbGxTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc3RpY2t5LXNjcm9sbC5zZXJ2aWNlJztcbmltcG9ydCB7IGNhbmNlbE9uRGVzdHJveSwgdGFnIH0gZnJvbSAnQGthbHR1cmEtbmcva2FsdHVyYS1jb21tb24nO1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1trU3RpY2t5XSdcbn0pXG5cbmV4cG9ydCBjbGFzcyBTdGlja3lEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB7XG4gICAgcHJpdmF0ZSBsYXN0U2Nyb2xsOiBudW1iZXIgPSAwO1xuICAgIHB1YmxpYyBpc1N0aWNreTogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgb3JpZ2luYWxDc3M6IGFueTtcbiAgICBwcml2YXRlIF9kZXN0cm95ZWQgPSBmYWxzZTtcblxuICAgIEBPdXRwdXQoKSBvblN0aWNreUV2ZW50ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gICAgQE91dHB1dCgpIG9uVW5TdGlja3lFdmVudCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gICAgQElucHV0KCkgc3RpY2t5Q2xhc3M6IHN0cmluZztcbiAgICBASW5wdXQoKSBzY3JvbGxPZmZzZXQ6IG51bWJlciA9IDA7XG4gICAgQElucHV0KCkgYXBwZW5kVG86IGFueTtcbiAgICBASW5wdXQoKSBzdGlja3lJZDogc3RyaW5nID0gXCJcIjtcbiAgICBASW5wdXQoKSBzdGlja3NUbzogc3RyaW5nID0gXCJcIjtcbiAgICBASW5wdXQoKSBlbGVtZW50U2VsZWN0b3I6IHN0cmluZyA9IFwiXCI7XG5cbiAgICBwcml2YXRlIF9wYXJlbnRUb3A6IG51bWJlciA9IG51bGw7XG4gICAgcHJpdmF0ZSBfcGFyZW50T2Zmc2V0OiBudW1iZXIgPSBudWxsO1xuICAgIHByaXZhdGUgX3N0aWNreVRvcDogbnVtYmVyID0gbnVsbDtcbiAgICBwcml2YXRlIF9zdGlja3lPZmZzZXQ6IG51bWJlciA9IG51bGw7XG5cbiAgICBwcm90ZWN0ZWQgX3N0aWNreUVsZW1lbnQ6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIF9zdGlja3lTY3JvbGxTZXJ2aWNlOiBTdGlja3lTY3JvbGxTZXJ2aWNlKSB7XG5cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX2dldFN0aWNreUVsZW1lbnQoZWxlbWVudFJlZjogRWxlbWVudFJlZikgOmFueXtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcbiAgICB9XG5cbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSBuZ0FmdGVyVmlld0luaXRgKTtcbiAgICAgICAgdGhpcy5fc3RpY2t5RWxlbWVudCA9IHRoaXMuX2dldFN0aWNreUVsZW1lbnQodGhpcy5lbGVtZW50UmVmKTtcbiAgICAgICAgdGhpcy51cGRhdGUoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpe1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhgWyR7dGhpcy5zdGlja3lJZH1dIC0gYXR0YWNoZWRgKTtcbiAgICAgICAgaWYgKHRoaXMuc3RpY2t5SWQpIHtcbiAgICAgICAgICAgIHRoaXMuX3N0aWNreVNjcm9sbFNlcnZpY2UuYXR0YWNoKHRoaXMuc3RpY2t5SWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc3RpY2t5U2Nyb2xsU2VydmljZS5zY3JvbGxTdGF0dXMkLnBpcGUoY2FuY2VsT25EZXN0cm95KHRoaXMpKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICBldmVudCA9PiB7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIGhhbmRsZSBzY3JvbGxgKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXIoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLl9zdGlja3lTY3JvbGxTZXJ2aWNlLnJlc2l6ZVN0YXR1cyQucGlwZShjYW5jZWxPbkRlc3Ryb3kodGhpcykpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICBldmVudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25SZXNpemUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgIHRoaXMuX3N0aWNreVNjcm9sbFNlcnZpY2UubGF5b3V0U3ViamVjdCQucGlwZShjYW5jZWxPbkRlc3Ryb3kodGhpcykpLnN1YnNjcmliZShcbiAgICAgICAgICAgIGVsZW1lbnRzID0+e1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnN0aWNrc1RvID8gZWxlbWVudHNbdGhpcy5zdGlja3NUb10gOiB7aGVpZ2h0OiAwLCBvZmZzZXQ6IDB9O1xuICAgICAgICAgICAgICAgIGlmIChkYXRhICYmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudFRvcCAhPT0gZGF0YS5oZWlnaHQgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudE9mZnNldCAhPT0gZGF0YS5vZmZzZXRcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICl7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudFRvcCA9IGRhdGEuaGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJlbnRPZmZzZXQgPSBkYXRhLm9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKXtcbiAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIGRlc3Ryb3llZGApO1xuICAgICAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLl9zdGlja3lTY3JvbGxTZXJ2aWNlLmRldGFjaCh0aGlzLnN0aWNreUlkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlKCkgOiB2b2lke1xuICAgICAgICBpZiAodGhpcy5fcGFyZW50VG9wICE9PSBudWxsXG4gICAgICAgICAgICAmJiB0aGlzLl9wYXJlbnRPZmZzZXQgIT0gbnVsbClcbiAgICAgICAge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIGhhbmRsZSBsYXlvdXQgdXBkYXRlYCk7XG4gICAgICAgICAgICBjb25zdCBzdGlja3lPZmZzZXQgPSB0aGlzLl9wYXJlbnRPZmZzZXQgKyB0aGlzLnNjcm9sbE9mZnNldDtcbiAgICAgICAgICAgIGlmICh0aGlzLl9zdGlja3lUb3AgIT09IHRoaXMuX3BhcmVudFRvcCB8fFxuICAgICAgICAgICAgICAgIHRoaXMuX3N0aWNreU9mZnNldCAhPT0gc3RpY2t5T2Zmc2V0KVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSB1cGRhdGUgY2FjaGVkIHZhbHVlc2ApO1xuICAgICAgICAgICAgICAgIHRoaXMuX3N0aWNreVRvcCA9IHRoaXMuX3BhcmVudFRvcDtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGlja3lPZmZzZXQgPSBzdGlja3lPZmZzZXQ7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVyKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnN0aWNreUlkICYmIHRoaXMuX3N0aWNreUVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgWyR7dGhpcy5zdGlja3lJZH1dIC0gdXBkYXRlIHNlcnZpY2VgKTtcbiAgICAgICAgICAgICAgICBjb25zdCBlbGVtZW50SGVpZ2h0ID0gdGhpcy5fc3RpY2t5RWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVsnaGVpZ2h0J107XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9zdGlja3lTY3JvbGxTZXJ2aWNlLnVwZGF0ZSh0aGlzLnN0aWNreUlkLCBlbGVtZW50SGVpZ2h0ICsgdGhpcy5fc3RpY2t5VG9wLCB0aGlzLl9zdGlja3lPZmZzZXQpO1xuICAgICAgICAgICAgICAgIH0sIDApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVuZGVyKCkgOiB2b2lkXG4gICAge1xuICAgICAgICBpZiAoIXRoaXMuX2Rlc3Ryb3llZCAmJiB0aGlzLl9zdGlja3lFbGVtZW50KSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgWyR7dGhpcy5zdGlja3lJZH1dIC0gX3JlbmRlcmApO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5fc3RpY2t5VG9wICE9PSBudWxsXG4gICAgICAgICAgICAgICAgJiYgdGhpcy5fc3RpY2t5T2Zmc2V0ICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzY3JvbGwgPSB3aW5kb3cucGFnZVlPZmZzZXQ7XG4gICAgICAgICAgICAgICAgaWYgKHNjcm9sbCA+IHRoaXMubGFzdFNjcm9sbCAmJiAhdGhpcy5pc1N0aWNreSAmJiB0aGlzLl9zdGlja3lFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpWyd0b3AnXSA8PSB0aGlzLl9zdGlja3lUb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIF9yZW5kZXIgKHNldCBzdGlja3kgbW9kZSlgKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGlja3koKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNjcm9sbCA8IHRoaXMubGFzdFNjcm9sbCAmJiB0aGlzLmlzU3RpY2t5ICYmIHNjcm9sbCA8PSB0aGlzLl9zdGlja3lPZmZzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFske3RoaXMuc3RpY2t5SWR9XSAtIF9yZW5kZXIgKHVuc2V0IHN0aWNreSBtb2RlKWApO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc2V0U3RpY2t5KCk7XG4gICAgICAgICAgICAgICAgfWVsc2VcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzU3RpY2t5ICYmIHNjcm9sbCA9PT0gdGhpcy5sYXN0U2Nyb2xsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0eWxlKCd0b3AnLCB0aGlzLl9zdGlja3lUb3AgKyAncHgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSBfcmVuZGVyICh1cGRhdGUgc2l0Y2t5IHZhbHVlcykgLSBUT0RPISEhISEhYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0U2Nyb2xsID0gc2Nyb2xsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIHNldFN0aWNreSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzU3RpY2t5KSB7XG4gICAgICAgICAgICB0aGlzLmlzU3RpY2t5ID0gdHJ1ZTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBbJHt0aGlzLnN0aWNreUlkfV0gLSB0b3AgPSAke3RoaXMuX3N0aWNreUVsZW1lbnQuY2xpZW50VG9wfWApO1xuICAgICAgICAgICAgdGhpcy5vcmlnaW5hbENzcyA9IHtcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogdGhpcy5fc3RpY2t5RWxlbWVudC5zdHlsZS5wb3NpdGlvbixcbiAgICAgICAgICAgICAgICB0b3A6IHRoaXMuX3N0aWNreUVsZW1lbnQuY2xpZW50VG9wLFxuICAgICAgICAgICAgICAgIG1hcmdpblRvcDogdGhpcy5fc3RpY2t5RWxlbWVudC5zdHlsZS5tYXJnaW5Ub3AsXG4gICAgICAgICAgICAgICAgbGVmdDogdGhpcy5fc3RpY2t5RWxlbWVudC5jbGllbnRMZWZ0XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5zZXRTdHlsZSgncG9zaXRpb24nLCAnZml4ZWQnKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoJ3RvcCcsIHRoaXMuX3N0aWNreVRvcCArICdweCcpO1xuICAgICAgICAgICAgaWYgKHRoaXMuYXBwZW5kVG8pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFN0eWxlKCdsZWZ0JywgdGhpcy5hcHBlbmRUby5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVsnbGVmdCddICsgJ3B4Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldENsYXNzKHRydWUpO1xuICAgICAgICAgICAgdGhpcy5vblN0aWNreUV2ZW50LmVtaXQoKTtcbiAgICAgICAgICAgIHRoaXMuX29uU3RpY2t5KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgX29uU3RpY2t5KCk6dm9pZHtcbiAgICAgICAgc2V0VGltZW91dCgoKT0+IHt0aGlzLnVwZGF0ZSgpfSwwKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVuc2V0U3RpY2t5KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5pc1N0aWNreSkge1xuICAgICAgICAgICAgdGhpcy5pc1N0aWNreSA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5zZXRTdHlsZSgncG9zaXRpb24nLCB0aGlzLm9yaWdpbmFsQ3NzLnBvc2l0aW9uKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoJ21hcmdpblRvcCcsIHRoaXMub3JpZ2luYWxDc3MubWFyZ2luVG9wKTtcbiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoJ3RvcCcsIHRoaXMub3JpZ2luYWxDc3MudG9wICsgJ3B4Jyk7XG4gICAgICAgICAgICBpZiAodGhpcy5hcHBlbmRUbykge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoJ2xlZnQnLCB0aGlzLm9yaWdpbmFsQ3NzLmxlZnQgKyAncHgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0Q2xhc3MoZmFsc2UpO1xuICAgICAgICAgICAgdGhpcy5vblVuU3RpY2t5RXZlbnQuZW1pdCgpO1xuICAgICAgICAgICAgdGhpcy5fb25VbnNldFN0aWNreSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9vblVuc2V0U3RpY2t5KCk6dm9pZHtcbiAgICAgICAgc2V0VGltZW91dCgoKT0+IHt0aGlzLnVwZGF0ZSgpfSwwKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25SZXNpemUoKTp2b2lke307IC8vIHVzZWQgYnkgcHJpbWVuZyBkaXJlY3RpdmUgdG8gdXBkYXRlIHRhYmxlIGxheW91dFxuXG4gICAgcHJpdmF0ZSBzZXRTdHlsZShrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuX3N0aWNreUVsZW1lbnQsIGtleSwgdmFsdWUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0Q2xhc3MoYWRkOiBib29sZWFuKTogdm9pZCB7XG4gICAgICBpZiAoYWRkKSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5fc3RpY2t5RWxlbWVudCwgdGhpcy5zdGlja3lDbGFzcyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuX3N0aWNreUVsZW1lbnQsIHRoaXMuc3RpY2t5Q2xhc3MpO1xuICAgICAgfVxuICAgIH1cblxufVxuIl19