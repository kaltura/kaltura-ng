var KalturaLogger_1;
import { __decorate, __metadata, __param } from "tslib";
import { Injectable, SkipSelf, Optional, Self, Inject } from '@angular/core';
import { JL } from 'jsnlog';
import { InjectionToken } from '@angular/core';
import { KalturaLoggerRecordService } from './kaltura-logger-record.service';
export const KalturaLoggerName = new InjectionToken('kaltura-logger-name');
let randomLoggerNameNumber = 1;
let KalturaLogger = KalturaLogger_1 = class KalturaLogger {
    constructor(name, parentLogger, _loggerRecordInterceptor) {
        this._loggerRecordInterceptor = _loggerRecordInterceptor;
        KalturaLogger_1.resetDefaultJSNLog();
        if (!name) {
            name = 'logger' + randomLoggerNameNumber;
            randomLoggerNameNumber++;
        }
        name = name.replace(/[.]/g, '_');
        this._name = parentLogger ? `${parentLogger.name}.${name}` : name;
        this._logger = JL(this._name);
        this._logger.trace('logger created!');
    }
    static resetDefaultJSNLog() {
        if (!KalturaLogger_1.resetDefaultExecuted) {
            KalturaLogger_1.resetDefaultExecuted = true;
            const consoleAppender = JL.createConsoleAppender('consoleAppender');
            JL().setOptions({
                appenders: [consoleAppender]
            });
        }
    }
    static createLogger(loggerName) {
        return [
            KalturaLogger_1,
            {
                provide: KalturaLoggerName, useValue: loggerName
            }
        ];
    }
    get name() {
        return this._name;
    }
    _addLogToBuffer(logItem) {
        if (this._loggerRecordInterceptor) {
            this._loggerRecordInterceptor.addLogItemToBuffer(logItem);
        }
    }
    startRecordingLogs() {
        if (this._loggerRecordInterceptor) {
            this._loggerRecordInterceptor.startRecord();
        }
    }
    getRecordedLogs() {
        if (this._loggerRecordInterceptor) {
            return this._loggerRecordInterceptor.getRecordedLogs();
        }
    }
    isValidLogLevel(level) {
        const validLogLevels = ['All', 'Trace', 'Debug', 'Info', 'Warn', 'Error', 'Fatal', 'Off'];
        return validLogLevels.indexOf(level) !== -1;
    }
    setOptions(options) {
        let level = undefined;
        if (this.isValidLogLevel(options.level) && JL) {
            const getLevelValue = JL[`get${options.level}Level`];
            level = typeof getLevelValue === 'function' ? getLevelValue() : undefined;
        }
        JL().setOptions({ level: level });
    }
    subLogger(name) {
        return new KalturaLogger_1(name, this, this._loggerRecordInterceptor);
    }
    ngOnDestroy() {
        this._logger.debug('logger destroyed');
        delete this._logger;
    }
    _createLogObject(level, message, context) {
        this._addLogToBuffer({ level, message, context });
        return context ? Object.assign({ message, level }, context) : message;
    }
    trace(message, context) {
        if (context && typeof context === 'function') {
            this._logger.trace(() => this._createLogObject('trace', message, context()));
        }
        else {
            this._logger.trace(this._createLogObject('trace', message, context));
        }
    }
    debug(message, context) {
        if (context && typeof context === 'function') {
            this._logger.debug(() => this._createLogObject('debug', message, context()));
        }
        else {
            this._logger.debug(this._createLogObject('debug', message, context));
        }
    }
    info(message, context) {
        if (context && typeof context === 'function') {
            this._logger.info(() => this._createLogObject('info', message, context()));
        }
        else {
            this._logger.info(this._createLogObject('info', message, context));
        }
    }
    warn(message, context) {
        if (context && typeof context === 'function') {
            this._logger.warn(() => this._createLogObject('warn', message, context()));
        }
        else {
            this._logger.warn(this._createLogObject('warn', message, context));
        }
    }
    error(message, context) {
        this._logger.error(this._createLogObject('error', message, context));
    }
    fatal(message, context) {
        if (context && context instanceof Error) {
            this._logger.fatalException(message, context);
        }
        else {
            this._logger.fatal(this._createLogObject('fatal', message, context));
        }
    }
};
KalturaLogger.resetDefaultExecuted = false;
KalturaLogger.ctorParameters = () => [
    { type: String, decorators: [{ type: Inject, args: [KalturaLoggerName,] }, { type: Optional }, { type: Self }] },
    { type: KalturaLogger, decorators: [{ type: SkipSelf }, { type: Optional }] },
    { type: KalturaLoggerRecordService, decorators: [{ type: Optional }] }
];
KalturaLogger = KalturaLogger_1 = __decorate([
    Injectable(),
    __param(0, Inject(KalturaLoggerName)), __param(0, Optional()), __param(0, Self()),
    __param(1, SkipSelf()), __param(1, Optional()),
    __param(2, Optional()),
    __metadata("design:paramtypes", [String, KalturaLogger,
        KalturaLoggerRecordService])
], KalturaLogger);
export { KalturaLogger };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2FsdHVyYS1sb2dnZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtbG9nZ2VyLyIsInNvdXJjZXMiOlsibGliL2thbHR1cmEtbG9nZ2VyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBdUIsTUFBTSxlQUFlLENBQUM7QUFDbEcsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9DLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRTdFLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLElBQUksY0FBYyxDQUFTLHFCQUFxQixDQUFDLENBQUM7QUFNbkYsSUFBSSxzQkFBc0IsR0FBRyxDQUFDLENBQUM7QUFHL0IsSUFBYSxhQUFhLHFCQUExQixNQUFhLGFBQWE7SUFpQ3hCLFlBQTJELElBQVksRUFDbkMsWUFBMkIsRUFDL0Isd0JBQW9EO1FBQXBELDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBNEI7UUFFbEYsZUFBYSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFFbkMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULElBQUksR0FBRyxRQUFRLEdBQUcsc0JBQXNCLENBQUM7WUFDekMsc0JBQXNCLEVBQUUsQ0FBQztTQUMxQjtRQUVELElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVqQyxJQUFJLENBQUMsS0FBSyxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDbEUsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFF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aUJBQWlCLGNBQUcsUUFBUSxZQUFJLElBQUk7WUFDTixhQUFhLHVCQUFsRCxRQUFRLFlBQUksUUFBUTtZQUN5QiwwQkFBMEIsdUJBQXZFLFFBQVE7O0FBbkNWLGFBQWE7SUFEekIsVUFBVSxFQUFFO0lBa0NFLFdBQUEsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUEsRUFBRSxXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxJQUFJLEVBQUUsQ0FBQTtJQUM3QyxXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxRQUFRLEVBQUUsQ0FBQTtJQUN0QixXQUFBLFFBQVEsRUFBRSxDQUFBOzZDQUQyQixhQUFhO1FBQ0wsMEJBQTBCO0dBbkN6RSxhQUFhLENBMEp6QjtTQTFKWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgU2tpcFNlbGYsIE9wdGlvbmFsLCBTZWxmLCBJbmplY3QsIFByb3ZpZGVyLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEpMIH0gZnJvbSAnanNubG9nJztcbmltcG9ydCB7IEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBLYWx0dXJhTG9nZ2VyUmVjb3JkU2VydmljZSB9IGZyb20gJy4va2FsdHVyYS1sb2dnZXItcmVjb3JkLnNlcnZpY2UnO1xuXG5leHBvcnQgY29uc3QgS2FsdHVyYUxvZ2dlck5hbWUgPSBuZXcgSW5qZWN0aW9uVG9rZW48c3RyaW5nPigna2FsdHVyYS1sb2dnZXItbmFtZScpO1xuXG5leHBvcnQgdHlwZSBDb250ZXh0ID0geyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbmV4cG9ydCB0eXBlIERlZmZlcmVkQ29udGV4dCA9ICgpID0+IENvbnRleHQ7XG5leHBvcnQgdHlwZSBMb2dMZXZlbHMgPSAnQWxsJyB8ICdUcmFjZScgfCAnRGVidWcnIHwgJ0luZm8nIHwgJ1dhcm4nIHwgJ0Vycm9yJyB8ICdGYXRhbCcgfCAnT2ZmJztcblxubGV0IHJhbmRvbUxvZ2dlck5hbWVOdW1iZXIgPSAxO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgS2FsdHVyYUxvZ2dlciBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHN0YXRpYyByZXNldERlZmF1bHRFeGVjdXRlZCA9IGZhbHNlO1xuXG4gIHN0YXRpYyByZXNldERlZmF1bHRKU05Mb2coKSB7XG4gICAgaWYgKCFLYWx0dXJhTG9nZ2VyLnJlc2V0RGVmYXVsdEV4ZWN1dGVkKSB7XG4gICAgICBLYWx0dXJhTG9nZ2VyLnJlc2V0RGVmYXVsdEV4ZWN1dGVkID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGNvbnNvbGVBcHBlbmRlciA9IEpMLmNyZWF0ZUNvbnNvbGVBcHBlbmRlcignY29uc29sZUFwcGVuZGVyJyk7XG5cbiAgICAgIEpMKCkuc2V0T3B0aW9ucyh7XG4gICAgICAgIGFwcGVuZGVyczogW2NvbnNvbGVBcHBlbmRlcl1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG5cbiAgc3RhdGljIGNyZWF0ZUxvZ2dlcihsb2dnZXJOYW1lOiBzdHJpbmcpOiBQcm92aWRlcltdIHtcbiAgICByZXR1cm4gW1xuICAgICAgS2FsdHVyYUxvZ2dlcixcbiAgICAgIHtcbiAgICAgICAgcHJvdmlkZTogS2FsdHVyYUxvZ2dlck5hbWUsIHVzZVZhbHVlOiBsb2dnZXJOYW1lXG4gICAgICB9XG4gICAgXTtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBfbmFtZTogc3RyaW5nO1xuICBwcml2YXRlIF9sb2dnZXI6IEpMLkpTTkxvZ0xvZ2dlcjtcblxuICBwdWJsaWMgZ2V0IG5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fbmFtZTtcbiAgfVxuXG5cbiAgY29uc3RydWN0b3IoQEluamVjdChLYWx0dXJhTG9nZ2VyTmFtZSkgQE9wdGlvbmFsKCkgQFNlbGYoKSBuYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgIEBTa2lwU2VsZigpIEBPcHRpb25hbCgpIHBhcmVudExvZ2dlcjogS2FsdHVyYUxvZ2dlcixcbiAgICAgICAgICAgICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBfbG9nZ2VyUmVjb3JkSW50ZXJjZXB0b3I6IEthbHR1cmFMb2dnZXJSZWNvcmRTZXJ2aWNlKSB7XG5cbiAgICBLYWx0dXJhTG9nZ2VyLnJlc2V0RGVmYXVsdEpTTkxvZygpO1xuXG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICBuYW1lID0gJ2xvZ2dlcicgKyByYW5kb21Mb2dnZXJOYW1lTnVtYmVyO1xuICAgICAgcmFuZG9tTG9nZ2VyTmFtZU51bWJlcisrO1xuICAgIH1cblxuICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL1suXS9nLCAnXycpO1xuXG4gICAgdGhpcy5fbmFtZSA9IHBhcmVudExvZ2dlciA/IGAke3BhcmVudExvZ2dlci5uYW1lfS4ke25hbWV9YCA6IG5hbWU7XG4gICAgdGhpcy5fbG9nZ2VyID0gSkwodGhpcy5fbmFtZSk7XG4gICAgdGhpcy5fbG9nZ2VyLnRyYWNlKCdsb2dnZXIgY3JlYXRlZCEnKTtcbiAgfVxuXG4gIHByaXZhdGUgX2FkZExvZ1RvQnVmZmVyKGxvZ0l0ZW06IGFueSk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9sb2dnZXJSZWNvcmRJbnRlcmNlcHRvcikge1xuICAgICAgdGhpcy5fbG9nZ2VyUmVjb3JkSW50ZXJjZXB0b3IuYWRkTG9nSXRlbVRvQnVmZmVyKGxvZ0l0ZW0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzdGFydFJlY29yZGluZ0xvZ3MoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX2xvZ2dlclJlY29yZEludGVyY2VwdG9yKSB7XG4gICAgICB0aGlzLl9sb2dnZXJSZWNvcmRJbnRlcmNlcHRvci5zdGFydFJlY29yZCgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRSZWNvcmRlZExvZ3MoKTogYW55W10gfCB2b2lkIHtcbiAgICBpZiAodGhpcy5fbG9nZ2VyUmVjb3JkSW50ZXJjZXB0b3IpIHtcbiAgICAgIHJldHVybiB0aGlzLl9sb2dnZXJSZWNvcmRJbnRlcmNlcHRvci5nZXRSZWNvcmRlZExvZ3MoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaXNWYWxpZExvZ0xldmVsKGxldmVsOiBMb2dMZXZlbHMpOiBib29sZWFuIHtcbiAgICBjb25zdCB2YWxpZExvZ0xldmVscyA9IFsnQWxsJywgJ1RyYWNlJywgJ0RlYnVnJywgJ0luZm8nLCAnV2FybicsICdFcnJvcicsICdGYXRhbCcsICdPZmYnXTtcbiAgICByZXR1cm4gdmFsaWRMb2dMZXZlbHMuaW5kZXhPZihsZXZlbCkgIT09IC0xO1xuICB9XG5cbiAgcHVibGljIHNldE9wdGlvbnMob3B0aW9uczogeyBsZXZlbD86IExvZ0xldmVscyB9KTogdm9pZCB7XG4gICAgbGV0IGxldmVsOiBudW1iZXIgPSB1bmRlZmluZWQ7XG4gICAgaWYgKHRoaXMuaXNWYWxpZExvZ0xldmVsKG9wdGlvbnMubGV2ZWwpICYmIEpMKSB7XG4gICAgICBjb25zdCBnZXRMZXZlbFZhbHVlID0gSkxbYGdldCR7b3B0aW9ucy5sZXZlbH1MZXZlbGBdO1xuICAgICAgbGV2ZWwgPSB0eXBlb2YgZ2V0TGV2ZWxWYWx1ZSA9PT0gJ2Z1bmN0aW9uJyA/IGdldExldmVsVmFsdWUoKSA6IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBKTCgpLnNldE9wdGlvbnMoe2xldmVsOiBsZXZlbH0pO1xuICB9XG5cbiAgcHVibGljIHN1YkxvZ2dlcihuYW1lOiBzdHJpbmcpOiBLYWx0dXJhTG9nZ2VyIHtcbiAgICByZXR1cm4gbmV3IEthbHR1cmFMb2dnZXIobmFtZSwgdGhpcywgdGhpcy5fbG9nZ2VyUmVjb3JkSW50ZXJjZXB0b3IpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fbG9nZ2VyLmRlYnVnKCdsb2dnZXIgZGVzdHJveWVkJyk7XG4gICAgZGVsZXRlIHRoaXMuX2xvZ2dlcjtcblxuICB9XG5cbiAgcHJpdmF0ZSBfY3JlYXRlTG9nT2JqZWN0KGxldmVsOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZywgY29udGV4dDogQ29udGV4dCB8IEVycm9yKTogYW55IHtcbiAgICB0aGlzLl9hZGRMb2dUb0J1ZmZlcih7bGV2ZWwsIG1lc3NhZ2UsIGNvbnRleHR9KTtcbiAgICByZXR1cm4gY29udGV4dCA/IE9iamVjdC5hc3NpZ24oe21lc3NhZ2UsIGxldmVsfSwgY29udGV4dCkgOiBtZXNzYWdlO1xuICB9XG5cbiAgcHVibGljIHRyYWNlKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IENvbnRleHQpOiB2b2lkO1xuICBwdWJsaWMgdHJhY2UobWVzc2FnZTogc3RyaW5nLCBjb250ZXh0PzogRGVmZmVyZWRDb250ZXh0KTogdm9pZDtcbiAgcHVibGljIHRyYWNlKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IENvbnRleHQgfCBEZWZmZXJlZENvbnRleHQpOiB2b2lkIHtcbiAgICBpZiAoY29udGV4dCAmJiB0eXBlb2YgY29udGV4dCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5fbG9nZ2VyLnRyYWNlKCgpID0+IHRoaXMuX2NyZWF0ZUxvZ09iamVjdCgndHJhY2UnLCBtZXNzYWdlLCAoPEZ1bmN0aW9uPmNvbnRleHQpKCkpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbG9nZ2VyLnRyYWNlKHRoaXMuX2NyZWF0ZUxvZ09iamVjdCgndHJhY2UnLCBtZXNzYWdlLCA8Q29udGV4dD5jb250ZXh0KSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGRlYnVnKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IENvbnRleHQpOiB2b2lkO1xuICBwdWJsaWMgZGVidWcobWVzc2FnZTogc3RyaW5nLCBjb250ZXh0PzogRGVmZmVyZWRDb250ZXh0KTogdm9pZDtcbiAgcHVibGljIGRlYnVnKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IENvbnRleHQgfCBEZWZmZXJlZENvbnRleHQpOiB2b2lkIHtcbiAgICBpZiAoY29udGV4dCAmJiB0eXBlb2YgY29udGV4dCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKCgpID0+IHRoaXMuX2NyZWF0ZUxvZ09iamVjdCgnZGVidWcnLCBtZXNzYWdlLCAoPEZ1bmN0aW9uPmNvbnRleHQpKCkpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKHRoaXMuX2NyZWF0ZUxvZ09iamVjdCgnZGVidWcnLCBtZXNzYWdlLCA8Q29udGV4dD5jb250ZXh0KSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGluZm8obWVzc2FnZTogc3RyaW5nLCBjb250ZXh0PzogQ29udGV4dCk6IHZvaWQ7XG4gIHB1YmxpYyBpbmZvKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IERlZmZlcmVkQ29udGV4dCk6IHZvaWQ7XG4gIHB1YmxpYyBpbmZvKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IENvbnRleHQgfCBEZWZmZXJlZENvbnRleHQpOiB2b2lkIHtcbiAgICBpZiAoY29udGV4dCAmJiB0eXBlb2YgY29udGV4dCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oKCkgPT4gdGhpcy5fY3JlYXRlTG9nT2JqZWN0KCdpbmZvJywgbWVzc2FnZSwgKDxGdW5jdGlvbj5jb250ZXh0KSgpKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5pbmZvKHRoaXMuX2NyZWF0ZUxvZ09iamVjdCgnaW5mbycsIG1lc3NhZ2UsIDxDb250ZXh0PmNvbnRleHQpKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgd2FybihtZXNzYWdlOiBzdHJpbmcsIGNvbnRleHQ/OiBDb250ZXh0KTogdm9pZDtcbiAgcHVibGljIHdhcm4obWVzc2FnZTogc3RyaW5nLCBjb250ZXh0PzogRGVmZmVyZWRDb250ZXh0KTogdm9pZDtcbiAgcHVibGljIHdhcm4obWVzc2FnZTogc3RyaW5nLCBjb250ZXh0PzogQ29udGV4dCB8IERlZmZlcmVkQ29udGV4dCk6IHZvaWQge1xuICAgIGlmIChjb250ZXh0ICYmIHR5cGVvZiBjb250ZXh0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLl9sb2dnZXIud2FybigoKSA9PiB0aGlzLl9jcmVhdGVMb2dPYmplY3QoJ3dhcm4nLCBtZXNzYWdlLCAoPEZ1bmN0aW9uPmNvbnRleHQpKCkpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbG9nZ2VyLndhcm4odGhpcy5fY3JlYXRlTG9nT2JqZWN0KCd3YXJuJywgbWVzc2FnZSwgPENvbnRleHQ+Y29udGV4dCkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBlcnJvcihtZXNzYWdlOiBzdHJpbmcsIGNvbnRleHQ/OiBDb250ZXh0KTogdm9pZDtcbiAgcHVibGljIGVycm9yKG1lc3NhZ2U6IHN0cmluZywgZXJyb3I/OiBFcnJvcik6IHZvaWQ7XG4gIHB1YmxpYyBlcnJvcihtZXNzYWdlOiBzdHJpbmcsIGNvbnRleHQ/OiBFcnJvciB8IENvbnRleHQpOiB2b2lkIHtcbiAgICB0aGlzLl9sb2dnZXIuZXJyb3IodGhpcy5fY3JlYXRlTG9nT2JqZWN0KCdlcnJvcicsIG1lc3NhZ2UsIGNvbnRleHQpKTtcbiAgfVxuXG4gIHB1YmxpYyBmYXRhbChtZXNzYWdlOiBzdHJpbmcsIGNvbnRleHQ/OiBDb250ZXh0KTogdm9pZDtcbiAgcHVibGljIGZhdGFsKG1lc3NhZ2U6IHN0cmluZywgZXJyb3I/OiBFcnJvcik6IHZvaWQ7XG4gIHB1YmxpYyBmYXRhbChtZXNzYWdlOiBzdHJpbmcsIGNvbnRleHQ/OiBFcnJvciB8IENvbnRleHQpOiB2b2lkIHtcbiAgICBpZiAoY29udGV4dCAmJiBjb250ZXh0IGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5mYXRhbEV4Y2VwdGlvbihtZXNzYWdlLCBjb250ZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbG9nZ2VyLmZhdGFsKHRoaXMuX2NyZWF0ZUxvZ09iamVjdCgnZmF0YWwnLCBtZXNzYWdlLCBjb250ZXh0KSk7XG4gICAgfVxuICB9XG59XG4iXX0=