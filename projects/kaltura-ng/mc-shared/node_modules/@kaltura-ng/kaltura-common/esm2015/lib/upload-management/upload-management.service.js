import { __decorate, __metadata, __param } from "tslib";
import { Injectable, Inject, Optional, InjectionToken } from '@angular/core';
import { Subject } from 'rxjs';
import 'rxjs/add/operator/groupBy';
import { FriendlyHashId } from '../friendly-hash-id';
import { TrackedFile, TrackedFileStatuses } from './tracked-file';
import { cancelOnDestroy } from '../rxjs/operators';
export const UploadFileAdapterToken = new InjectionToken('upload-file-adapter');
let UploadManagement = class UploadManagement {
    constructor(_uploadFileAdapter) {
        this._uploadFileAdapter = _uploadFileAdapter;
        this._trackedFiles = {};
        this._onTrackedFileChanged = new Subject();
        this._maxUploadRequests = null;
        this.onTrackedFileChanged$ = this._onTrackedFileChanged.asObservable();
        this._tokenGenerator = new FriendlyHashId();
    }
    setMaxUploadRequests(maxUploads) {
        if (maxUploads === null || maxUploads > 0) {
            this._log('info', `limit max upload requests to ${maxUploads}`);
            this._maxUploadRequests = maxUploads;
        }
        else {
            this._log('info', `remove max upload limitation`);
            this._maxUploadRequests = null;
        }
    }
    // TODO [kmcng] replace this function with log library
    _log(level, message, fileId) {
        const messageContext = fileId ? `file '${fileId}'` : '';
        const origin = 'upload manager';
        const formattedMessage = `log: [${level}] [${origin}] ${messageContext}: ${message}`;
        switch (level) {
            case 'silly':
            case 'debug':
            case 'info':
                console.log(formattedMessage);
                break;
            case 'warn':
                console.warn(formattedMessage);
                break;
            case 'error':
                console.error(formattedMessage);
                break;
        }
    }
    getTrackedFiles() {
        return Object.keys(this._trackedFiles).map(fileId => this._trackedFiles[fileId].asData());
    }
    getTrackedFile(fileId) {
        const relevantFile = this._trackedFiles[fileId];
        return relevantFile ? relevantFile.asData() : null;
    }
    addFile(file) {
        const [newFileId] = this.addFiles([file]);
        return newFileId;
    }
    addFiles(files) {
        const result = [];
        files.forEach((fileData) => {
            const newUploadId = this._tokenGenerator.generateUnique(Object.keys(this._trackedFiles));
            this._log('info', `add new file '${fileData.getFileName()}' to queue with unique file id`, newUploadId);
            this._createTrackedFile(newUploadId, fileData);
            result.push({ id: newUploadId, data: fileData });
        });
        if (result.length) {
            this._syncUploadQueue();
        }
        return result;
    }
    cancelUploadWithError(id, reason) {
        this._log('info', `cancel file upload with custom reason '${reason}'`, id);
        const trackedFile = this._trackedFiles[id];
        if (trackedFile) {
            {
                if (trackedFile.canTransitionTo(TrackedFileStatuses.cancelled)) {
                    this.cancelUpload(id, false);
                    if (trackedFile.canTransitionTo(TrackedFileStatuses.failure)) {
                        this._updateTrackedFile(trackedFile, {
                            status: TrackedFileStatuses.failure,
                            failureReason: reason || 'unknown error',
                            failureType: 'manual_error'
                        });
                    }
                }
            }
        }
        else {
            this._log('warn', 'cannot cancel upload, failed to find file with provided id', id);
        }
    }
    resumeUpload(id) {
        this.resumeUploads([id]);
    }
    resumeUploads(files) {
        let syncUploadQueue = false;
        files.forEach(id => {
            this._log('info', `resume file upload.`, id);
            const trackedFile = this._trackedFiles[id];
            if (trackedFile) {
                if (trackedFile.wasInStatus(TrackedFileStatuses.prepared)) {
                    this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.pendingUpload
                    });
                }
                else {
                    this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.pendingPrepare
                    });
                }
            }
            else {
                this._log('warn', 'cannot resume upload, failed to find file with provided id', id);
            }
        });
        this._syncUploadQueue();
    }
    cancelUpload(id, purge = true) {
        this._log('info', `cancel file upload.`, id);
        const trackedFile = this._trackedFiles[id];
        if (trackedFile) {
            if (trackedFile.status !== TrackedFileStatuses.cancelled
                && trackedFile.canTransitionTo(TrackedFileStatuses.cancelled)) {
                if (trackedFile.uploadSubscription) {
                    trackedFile.uploadSubscription.unsubscribe();
                    trackedFile.uploadSubscription = null;
                }
                this._updateTrackedFile(trackedFile, {
                    status: TrackedFileStatuses.cancelled
                });
                if (purge) {
                    this.purgeUpload(id);
                }
                this._syncUploadQueue();
            }
        }
        else {
            this._log('warn', 'cannot cancel upload, failed to find file with provided id', id);
        }
    }
    purgeUpload(id) {
        this._log('info', `purge file from queue.`, id);
        const trackedFile = this._trackedFiles[id];
        if (trackedFile) {
            if (trackedFile.canTransitionTo(TrackedFileStatuses.purged)) {
                this.cancelUpload(id, false);
                this._updateTrackedFile(trackedFile, { status: TrackedFileStatuses.purged });
                this._removeTrackedFile(trackedFile);
            }
        }
        else {
            this._log('warn', 'cannot purge upload, failed to find file with provided id', id);
        }
    }
    _removeTrackedFile(trackedFile) {
        this._log('info', `remove tracked file from queue`, trackedFile.id);
        // Developer notice - this is a cleanup function just in case.
        if (trackedFile.uploadSubscription) {
            trackedFile.uploadSubscription.unsubscribe();
            trackedFile.uploadSubscription = null;
        }
        delete this._trackedFiles[trackedFile.id];
    }
    _syncUploadQueue() {
        if (this.syncUploadQueueTimeoutId) {
            clearTimeout(this.syncUploadQueueTimeoutId);
            this.syncUploadQueueTimeoutId = null;
        }
        // DEVELOPER NOTICE: This logic is delayed to the next event loop on purpose to prevent
        // collision between two sync requests
        this.syncUploadQueueTimeoutId = setTimeout(() => {
            this._log('info', `syncing upload queue`);
            this.syncUploadQueueTimeoutId = null;
            this._executePreparePhase();
            this._executeUploadPhase();
        }, 200);
    }
    _executePreparePhase() {
        const files = Object.keys(this._trackedFiles).map(fileId => this._trackedFiles[fileId]).filter(trackedFile => {
            return trackedFile.status === TrackedFileStatuses.pendingPrepare
                && trackedFile.canTransitionTo(TrackedFileStatuses.preparing);
        });
        if (files.length) {
            this._log('info', `handling ${files.length} files, waiting to be prepared`);
            const groupedFiles = files.reduce((acc, curr) => {
                const uploadAdapter = this._getUploadAdapter(curr.data) || null;
                const matchedItem = acc.find(item => item.adapter ? item.adapter.constructor === uploadAdapter.constructor : item.adapter === null);
                if (matchedItem) {
                    matchedItem.files.push(curr);
                }
                else {
                    acc.push({ adapter: uploadAdapter, files: [curr] });
                }
                return acc;
            }, []);
            groupedFiles.forEach(item => {
                if (item.adapter) {
                    this._log('debug', `executing prepare phase for ${item.files.length} files with adapter '${item.adapter.label}'`);
                    item.files.forEach(file => {
                        this._updateTrackedFile(file, { status: TrackedFileStatuses.preparing });
                    });
                    item.adapter.prepare(item.files)
                        .pipe(cancelOnDestroy(this))
                        .subscribe(preparedFiles => {
                        this._log('debug', `executing prepare phase succeeded for ${item.files.length} files with adapter '${item.adapter.label}'.`);
                        this._handlePrepareAdapterResponse(preparedFiles);
                        this._syncUploadQueue();
                    }, reason => {
                        this._log('error', `executing prepare phase failed for ${item.files.length} files with adapter '${item.adapter.label}'. error: ${reason.message}`);
                        this._handlePrepareAdapterResponse(item.files.map(file => ({ id: file.id, status: false })));
                        this._syncUploadQueue();
                    });
                }
                else {
                    item.files.forEach(file => {
                        this._updateTrackedFile(file, {
                            status: TrackedFileStatuses.failure,
                            failureReason: 'upload destination is not supported',
                            failureType: 'unknown_destination'
                        });
                    });
                }
            });
        }
    }
    _handlePrepareAdapterResponse(responseFiles) {
        responseFiles.forEach(responseFile => {
            const trackedFile = this._trackedFiles[responseFile.id];
            if (!trackedFile) {
                this._log('warn', `cannot handle prepare response for file '${responseFile.id}' since there is no tracking information for that file (did the user purge the file during the prepare execution?)`);
            }
            else if (trackedFile.status !== TrackedFileStatuses.preparing) {
                this._log('warn', `cannot handle file result from prepare action (did the user cancel the file upload during the prepare execution?)`, trackedFile.id);
            }
            else if (responseFile.status) {
                const changedStatusToPrepared = this._updateTrackedFile(trackedFile, {
                    status: TrackedFileStatuses.prepared
                });
                if (changedStatusToPrepared) {
                    this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.pendingUpload
                    });
                }
            }
            else {
                this._updateTrackedFile(trackedFile, {
                    status: TrackedFileStatuses.failure,
                    failureReason: 'failed to prepare upload',
                    failureType: 'preparation_failed'
                });
            }
        });
    }
    _executeUploadPhase() {
        const waitingForUploadsFiles = [];
        const activeUploadFiles = [];
        Object.keys(this._trackedFiles).forEach(fileId => {
            const trackedFile = this._trackedFiles[fileId];
            if (trackedFile.status === TrackedFileStatuses.uploading) {
                activeUploadFiles.push(trackedFile);
            }
            else if (trackedFile.status === TrackedFileStatuses.pendingUpload
                && trackedFile.canTransitionTo(TrackedFileStatuses.uploading)) {
                waitingForUploadsFiles.push(trackedFile);
            }
        });
        const activeUploadsCount = activeUploadFiles.length;
        const waitingFilesCount = waitingForUploadsFiles.length;
        if (waitingFilesCount > 0) {
            let nextUploadFiles = [];
            this._log('silly', `active uploads: ${activeUploadsCount} | pending files: ${waitingFilesCount}`);
            const availableUploadSlots = (this._maxUploadRequests && this._maxUploadRequests > 0) ? this._maxUploadRequests - activeUploadsCount : waitingFilesCount;
            if (availableUploadSlots > 0) {
                nextUploadFiles = [
                    ...waitingForUploadsFiles.sort(pendingFile => pendingFile.uploadOrder || 1000)
                ].slice(0, availableUploadSlots);
            }
            this._log('debug', `available upload slots to be used ${availableUploadSlots}`);
            nextUploadFiles.forEach(pendingFile => {
                this._initiateUpload(pendingFile);
            });
        }
    }
    _createTrackedFile(id, fileData) {
        const newTrackedFile = this._trackedFiles[id] = new TrackedFile(id, fileData);
        this._onTrackedFileChanged.next(newTrackedFile.asData());
        this._updateTrackedFile(newTrackedFile, { status: TrackedFileStatuses.pendingPrepare });
    }
    _updateTrackedFile(trackedFile, changes) {
        let result = true;
        if (changes.status && changes.status !== trackedFile.status) {
            if (trackedFile.canTransitionTo(changes.status)) {
                this._log('info', `notify file status changes from '${trackedFile.status}' to '${changes.status}'`, trackedFile.id);
                trackedFile.update(changes);
            }
            else {
                this._log('error', `cannot update file data from '${trackedFile.status}' to '${changes.status}. target status is not allowed. update to status 'failure' instead.`, trackedFile.id);
                trackedFile.update({
                    status: TrackedFileStatuses.failure,
                    failureReason: 'cannot change status',
                    failureType: 'change_not_allowed'
                });
                result = false;
            }
        }
        else {
            //this._log('info', `notify file data changes`,trackedFile.id);
            trackedFile.update(changes);
        }
        this._onTrackedFileChanged.next(trackedFile.asData());
        return result;
    }
    supportChunkUpload(uploadFileData) {
        const uploadAdapter = this._getUploadAdapter(uploadFileData);
        return uploadAdapter ? uploadAdapter.supportChunkUpload() : false;
    }
    _initiateUpload(trackedFile) {
        const { data, id } = trackedFile;
        const uploadAdapter = this._getUploadAdapter(data);
        this._log('info', `initiate new upload for file '${id}'`);
        if (!uploadAdapter) {
            this._log('warn', `cannot find destination adapter for requested file, failing upload request`);
            this._updateTrackedFile(trackedFile, {
                status: TrackedFileStatuses.failure,
                failureReason: 'upload destination is not supported',
                failureType: 'unknown_destination'
            });
            this._syncUploadQueue();
        }
        else if (trackedFile.canTransitionTo(TrackedFileStatuses.uploading)) {
            if (trackedFile.uploadSubscription) {
                this._log('warn', `an active upload was found while the status indicated no upload currently in progress. cancel previous upload`);
                trackedFile.uploadSubscription.unsubscribe();
                trackedFile.uploadSubscription = null;
            }
            this._updateTrackedFile(trackedFile, {
                status: TrackedFileStatuses.uploading,
                progress: 0,
                uploadStartAt: new Date(),
            });
            const canHandleResponse = (id, actionDescription) => {
                let result = false;
                const trackedFileStillExists = !!this._trackedFiles[id];
                if (!trackedFileStillExists) {
                    this._log('warn', `cannot handle file upload ${actionDescription}. There is no tracking file with the provided id (was the file purged?)`, id);
                }
                else if (trackedFile.status !== TrackedFileStatuses.uploading) {
                    this._log('warn', `cannot handle file upload ${actionDescription}. The file status it not 'uploading' (was the file upload cancelled?)`, id);
                }
                else {
                    result = true;
                }
                return result;
            };
            trackedFile.uploadSubscription = uploadAdapter.upload(id, data)
                .subscribe((uploadChanges) => {
                if (canHandleResponse(id, 'progress')) {
                    this._updateTrackedFile(trackedFile, {
                        progress: uploadChanges.progress
                    });
                }
            }, (error) => {
                trackedFile.uploadSubscription = null;
                if (canHandleResponse(id, 'failure')) {
                    const failureReason = error && error.message ? error.message : '';
                    this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.failure,
                        failureReason,
                        failureType: 'general_error'
                    });
                }
                this._syncUploadQueue();
            }, () => {
                trackedFile.uploadSubscription = null;
                if (canHandleResponse(id, 'completion')) {
                    this._updateTrackedFile(trackedFile, {
                        status: TrackedFileStatuses.uploadCompleted,
                        progress: 1,
                        uploadCompleteAt: new Date()
                    });
                    this._removeTrackedFile(trackedFile);
                    this._syncUploadQueue();
                }
            });
        }
    }
    _getUploadAdapter(fileData) {
        if (this._uploadFileAdapter) {
            return this._uploadFileAdapter.find(uploadFileAdapter => {
                return uploadFileAdapter.canHandle(fileData);
            });
        }
        else {
            return null;
        }
    }
    ngOnDestroy() {
        Object.keys(this._trackedFiles).forEach(id => {
            this.purgeUpload(id);
        });
    }
};
UploadManagement.ctorParameters = () => [
    { type: Array, decorators: [{ type: Inject, args: [UploadFileAdapterToken,] }, { type: Optional }] }
];
UploadManagement = __decorate([
    Injectable(),
    __param(0, Inject(UploadFileAdapterToken)), __param(0, Optional()),
    __metadata("design:paramtypes", [Array])
], UploadManagement);
export { UploadManagement };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLW1hbmFnZW1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BrYWx0dXJhLW5nL2thbHR1cmEtY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3VwbG9hZC1tYW5hZ2VtZW50L3VwbG9hZC1tYW5hZ2VtZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBYSxVQUFVLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHeEYsT0FBTyxFQUFFLE9BQU8sRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLDJCQUEyQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsV0FBVyxFQUF1QyxtQkFBbUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQU1wRCxNQUFNLENBQUMsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLGNBQWMsQ0FBUyxxQkFBcUIsQ0FBQyxDQUFDO0FBR3hGLElBQWEsZ0JBQWdCLEdBQTdCLE1BQWEsZ0JBQWdCO0lBUXpCLFlBQWdFLGtCQUE0QztRQUE1Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTBCO1FBUHBHLGtCQUFhLEdBQWlCLEVBQUUsQ0FBQztRQUNqQywwQkFBcUIsR0FBRyxJQUFJLE9BQU8sRUFBbUIsQ0FBQztRQUN2RCx1QkFBa0IsR0FBVyxJQUFJLENBQUM7UUFDbkMsMEJBQXFCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2pFLG9CQUFlLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztJQUsvQyxDQUFDO0lBRU0sb0JBQW9CLENBQUMsVUFBbUI7UUFDM0MsSUFBSSxVQUFVLEtBQUssSUFBSSxJQUFJLFVBQVUsR0FBRyxDQUFDLEVBQUU7WUFDdkMsSUFBSSxD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a0IsQ0FBQyxXQUFXLEVBQy9CO3dCQUNJLE1BQU0sRUFBRSxtQkFBbUIsQ0FBQyxlQUFlO3dCQUMzQyxRQUFRLEVBQUUsQ0FBQzt3QkFDWCxnQkFBZ0IsRUFBRSxJQUFJLElBQUksRUFBRTtxQkFDL0IsQ0FBQyxDQUFDO29CQUVQLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztvQkFDckMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7aUJBQzNCO1lBQ0wsQ0FBQyxDQUNKLENBQUM7U0FDVDtJQUNMLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxRQUF3QjtRQUU5QyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUN6QixPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRTtnQkFDcEQsT0FBTyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakQsQ0FBQyxDQUFDLENBQUM7U0FDTjthQUFNO1lBQ0gsT0FBTyxJQUFJLENBQUM7U0FDZjtJQUNMLENBQUM7SUFFRCxXQUFXO1FBQ1AsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBRXpDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0osQ0FBQTs7d0NBbGdCZ0IsTUFBTSxTQUFDLHNCQUFzQixjQUFHLFFBQVE7O0FBUjVDLGdCQUFnQjtJQUQ1QixVQUFVLEVBQUU7SUFTSSxXQUFBLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBLEVBQUUsV0FBQSxRQUFRLEVBQUUsQ0FBQTs7R0FSOUMsZ0JBQWdCLENBMGdCNUI7U0ExZ0JZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9uRGVzdHJveSwgSW5qZWN0YWJsZSwgSW5qZWN0LCBPcHRpb25hbCwgSW5qZWN0aW9uVG9rZW4gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFVwbG9hZEZpbGVEYXRhIH0gZnJvbSAnLi91cGxvYWQtZmlsZS1kYXRhJztcbmltcG9ydCB7IFVwbG9hZEZpbGVBZGFwdGVyIH0gZnJvbSAnLi91cGxvYWQtZmlsZS1hZGFwdGVyJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvZ3JvdXBCeSc7XG5pbXBvcnQgeyBGcmllbmRseUhhc2hJZCB9IGZyb20gJy4uL2ZyaWVuZGx5LWhhc2gtaWQnO1xuaW1wb3J0IHsgVHJhY2tlZEZpbGUsIFRyYWNrZWRGaWxlQ2hhbmdlcywgVHJhY2tlZEZpbGVEYXRhLCBUcmFja2VkRmlsZVN0YXR1c2VzIH0gZnJvbSAnLi90cmFja2VkLWZpbGUnO1xuaW1wb3J0IHsgY2FuY2VsT25EZXN0cm95IH0gZnJvbSAnLi4vcnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRyYWNrZWRGaWxlcyB7XG4gICAgW2lkOiBzdHJpbmddOiBUcmFja2VkRmlsZVxufVxuXG5leHBvcnQgY29uc3QgVXBsb2FkRmlsZUFkYXB0ZXJUb2tlbiA9IG5ldyBJbmplY3Rpb25Ub2tlbjxzdHJpbmc+KCd1cGxvYWQtZmlsZS1hZGFwdGVyJyk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBVcGxvYWRNYW5hZ2VtZW50IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBwcml2YXRlIF90cmFja2VkRmlsZXM6IFRyYWNrZWRGaWxlcyA9IHt9O1xuICAgIHByaXZhdGUgX29uVHJhY2tlZEZpbGVDaGFuZ2VkID0gbmV3IFN1YmplY3Q8VHJhY2tlZEZpbGVEYXRhPigpO1xuICAgIHByaXZhdGUgX21heFVwbG9hZFJlcXVlc3RzOiBudW1iZXIgPSBudWxsO1xuICAgIHB1YmxpYyBvblRyYWNrZWRGaWxlQ2hhbmdlZCQgPSB0aGlzLl9vblRyYWNrZWRGaWxlQ2hhbmdlZC5hc09ic2VydmFibGUoKTtcbiAgICBwcml2YXRlIF90b2tlbkdlbmVyYXRvciA9IG5ldyBGcmllbmRseUhhc2hJZCgpO1xuICAgIHN5bmNVcGxvYWRRdWV1ZVRpbWVvdXRJZCA6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoVXBsb2FkRmlsZUFkYXB0ZXJUb2tlbikgQE9wdGlvbmFsKCkgcHJpdmF0ZSBfdXBsb2FkRmlsZUFkYXB0ZXI6IFVwbG9hZEZpbGVBZGFwdGVyPGFueT5bXSkge1xuXG4gICAgfVxuXG4gICAgcHVibGljIHNldE1heFVwbG9hZFJlcXVlc3RzKG1heFVwbG9hZHM/OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgaWYgKG1heFVwbG9hZHMgPT09IG51bGwgfHwgbWF4VXBsb2FkcyA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGBsaW1pdCBtYXggdXBsb2FkIHJlcXVlc3RzIHRvICR7bWF4VXBsb2Fkc31gKTtcbiAgICAgICAgICAgIHRoaXMuX21heFVwbG9hZFJlcXVlc3RzID0gbWF4VXBsb2FkcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGByZW1vdmUgbWF4IHVwbG9hZCBsaW1pdGF0aW9uYCk7XG4gICAgICAgICAgICB0aGlzLl9tYXhVcGxvYWRSZXF1ZXN0cyA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBUT0RPIFtrbWNuZ10gcmVwbGFjZSB0aGlzIGZ1bmN0aW9uIHdpdGggbG9nIGxpYnJhcnlcbiAgICBwcml2YXRlIF9sb2cobGV2ZWw6ICdzaWxseScgfCAnZGVidWcnIHwgJ2luZm8nIHwgJ3dhcm4nIHwgJ2Vycm9yJywgbWVzc2FnZTogc3RyaW5nLCBmaWxlSWQ/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZUNvbnRleHQgPSBmaWxlSWQgPyBgZmlsZSAnJHtmaWxlSWR9J2AgOiAnJztcbiAgICAgICAgY29uc3Qgb3JpZ2luID0gJ3VwbG9hZCBtYW5hZ2VyJztcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkTWVzc2FnZSA9IGBsb2c6IFske2xldmVsfV0gWyR7b3JpZ2lufV0gJHttZXNzYWdlQ29udGV4dH06ICR7bWVzc2FnZX1gO1xuICAgICAgICBzd2l0Y2ggKGxldmVsKSB7XG4gICAgICAgICAgICBjYXNlICdzaWxseSc6XG4gICAgICAgICAgICBjYXNlICdkZWJ1Zyc6XG4gICAgICAgICAgICBjYXNlICdpbmZvJzpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhmb3JtYXR0ZWRNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3dhcm4nOlxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybihmb3JtYXR0ZWRNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2Vycm9yJzpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGZvcm1hdHRlZE1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldFRyYWNrZWRGaWxlcygpOiBUcmFja2VkRmlsZURhdGFbXVxuICAgIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX3RyYWNrZWRGaWxlcykubWFwKGZpbGVJZCA9PiB0aGlzLl90cmFja2VkRmlsZXNbZmlsZUlkXS5hc0RhdGEoKSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFRyYWNrZWRGaWxlKGZpbGVJZDogc3RyaW5nKTogVHJhY2tlZEZpbGVEYXRhXG4gICAge1xuICAgICAgICBjb25zdCByZWxldmFudEZpbGUgPSB0aGlzLl90cmFja2VkRmlsZXNbZmlsZUlkXTtcbiAgICAgICAgcmV0dXJuIHJlbGV2YW50RmlsZT8gcmVsZXZhbnRGaWxlLmFzRGF0YSgpIDogbnVsbDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkRmlsZShmaWxlOiBVcGxvYWRGaWxlRGF0YSk6IHsgaWQ6IHN0cmluZyB9IHtcbiAgICAgICAgY29uc3QgW25ld0ZpbGVJZF0gPSB0aGlzLmFkZEZpbGVzKFtmaWxlXSk7XG4gICAgICAgIHJldHVybiBuZXdGaWxlSWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZEZpbGVzKGZpbGVzOiBVcGxvYWRGaWxlRGF0YVtdKTogeyBpZDogc3RyaW5nLCBkYXRhOiBVcGxvYWRGaWxlRGF0YSB9W10ge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogeyBpZDogc3RyaW5nLCBkYXRhOiBVcGxvYWRGaWxlRGF0YSB9W10gPSBbXTtcblxuICAgICAgICBmaWxlcy5mb3JFYWNoKChmaWxlRGF0YSkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBuZXdVcGxvYWRJZCA9IHRoaXMuX3Rva2VuR2VuZXJhdG9yLmdlbmVyYXRlVW5pcXVlKE9iamVjdC5rZXlzKHRoaXMuX3RyYWNrZWRGaWxlcykpO1xuXG4gICAgICAgICAgICB0aGlzLl9sb2coJ2luZm8nLCBgYWRkIG5ldyBmaWxlICcke2ZpbGVEYXRhLmdldEZpbGVOYW1lKCl9JyB0byBxdWV1ZSB3aXRoIHVuaXF1ZSBmaWxlIGlkYCxuZXdVcGxvYWRJZCk7XG4gICAgICAgICAgICB0aGlzLl9jcmVhdGVUcmFja2VkRmlsZShuZXdVcGxvYWRJZCwgZmlsZURhdGEpO1xuXG4gICAgICAgICAgICByZXN1bHQucHVzaCh7aWQ6IG5ld1VwbG9hZElkLCBkYXRhOiBmaWxlRGF0YX0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aClcbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5fc3luY1VwbG9hZFF1ZXVlKCk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHVibGljIGNhbmNlbFVwbG9hZFdpdGhFcnJvcihpZDogc3RyaW5nLCByZWFzb246IHN0cmluZykgOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYGNhbmNlbCBmaWxlIHVwbG9hZCB3aXRoIGN1c3RvbSByZWFzb24gJyR7cmVhc29ufSdgLGlkKTtcblxuICAgICAgICBjb25zdCB0cmFja2VkRmlsZSA9IHRoaXMuX3RyYWNrZWRGaWxlc1tpZF07XG5cbiAgICAgICAgaWYgKHRyYWNrZWRGaWxlKSB7XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWYgKHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhUcmFja2VkRmlsZVN0YXR1c2VzLmNhbmNlbGxlZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5jZWxVcGxvYWQoaWQsIGZhbHNlKTtcblxuICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhUcmFja2VkRmlsZVN0YXR1c2VzLmZhaWx1cmUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLFxuICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5mYWlsdXJlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVJlYXNvbjogcmVhc29uIHx8ICd1bmtub3duIGVycm9yJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVUeXBlOiAnbWFudWFsX2Vycm9yJ1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1lbHNlXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsJ2Nhbm5vdCBjYW5jZWwgdXBsb2FkLCBmYWlsZWQgdG8gZmluZCBmaWxlIHdpdGggcHJvdmlkZWQgaWQnLGlkKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcHVibGljIHJlc3VtZVVwbG9hZChpZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICB0aGlzLnJlc3VtZVVwbG9hZHMoW2lkXSk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc3VtZVVwbG9hZHMoZmlsZXM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgICAgIGxldCBzeW5jVXBsb2FkUXVldWUgPSBmYWxzZTtcblxuICAgICAgICBmaWxlcy5mb3JFYWNoKGlkID0+IHtcbiAgICAgICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGByZXN1bWUgZmlsZSB1cGxvYWQuYCwgaWQpO1xuICAgICAgICAgICAgY29uc3QgdHJhY2tlZEZpbGUgPSB0aGlzLl90cmFja2VkRmlsZXNbaWRdO1xuXG4gICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUpIHtcbiAgICAgICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUud2FzSW5TdGF0dXMoVHJhY2tlZEZpbGVTdGF0dXNlcy5wcmVwYXJlZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5wZW5kaW5nVXBsb2FkXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1ByZXBhcmVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCAnY2Fubm90IHJlc3VtZSB1cGxvYWQsIGZhaWxlZCB0byBmaW5kIGZpbGUgd2l0aCBwcm92aWRlZCBpZCcsIGlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fc3luY1VwbG9hZFF1ZXVlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNhbmNlbFVwbG9hZChpZDogc3RyaW5nLCBwdXJnZTogYm9vbGVhbj0gdHJ1ZSk6IHZvaWQge1xuICAgICAgICB0aGlzLl9sb2coJ2luZm8nLCBgY2FuY2VsIGZpbGUgdXBsb2FkLmAsIGlkKTtcblxuICAgICAgICBjb25zdCB0cmFja2VkRmlsZSA9IHRoaXMuX3RyYWNrZWRGaWxlc1tpZF07XG5cbiAgICAgICAgaWYgKHRyYWNrZWRGaWxlKSB7XG4gICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUuc3RhdHVzICE9PSBUcmFja2VkRmlsZVN0YXR1c2VzLmNhbmNlbGxlZFxuICAgICAgICAgICAgICAgICYmIHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhUcmFja2VkRmlsZVN0YXR1c2VzLmNhbmNlbGxlZCkpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWYgKHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICAgICAgdHJhY2tlZEZpbGUudXBsb2FkU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLmNhbmNlbGxlZFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGlmIChwdXJnZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnB1cmdlVXBsb2FkKGlkKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9zeW5jVXBsb2FkUXVldWUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfWVsc2VcbiAgICAgICAge1xuICAgICAgICAgICAgdGhpcy5fbG9nKCd3YXJuJywgJ2Nhbm5vdCBjYW5jZWwgdXBsb2FkLCBmYWlsZWQgdG8gZmluZCBmaWxlIHdpdGggcHJvdmlkZWQgaWQnLCBpZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcHVyZ2VVcGxvYWQoaWQ6IHN0cmluZyk6IHZvaWQge1xuXG4gICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGBwdXJnZSBmaWxlIGZyb20gcXVldWUuYCwgaWQpO1xuXG4gICAgICAgIGNvbnN0IHRyYWNrZWRGaWxlID0gdGhpcy5fdHJhY2tlZEZpbGVzW2lkXTtcblxuICAgICAgICBpZiAodHJhY2tlZEZpbGUpXG4gICAgICAgIHtcbiAgICAgICAgICAgIGlmICh0cmFja2VkRmlsZS5jYW5UcmFuc2l0aW9uVG8oVHJhY2tlZEZpbGVTdGF0dXNlcy5wdXJnZWQpKSB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbFVwbG9hZChpZCwgZmFsc2UpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsIHtzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMucHVyZ2VkfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1lbHNlXG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZygnd2FybicsICdjYW5ub3QgcHVyZ2UgdXBsb2FkLCBmYWlsZWQgdG8gZmluZCBmaWxlIHdpdGggcHJvdmlkZWQgaWQnLCBpZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZW1vdmVUcmFja2VkRmlsZSh0cmFja2VkRmlsZTogVHJhY2tlZEZpbGUpIHtcbiAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYHJlbW92ZSB0cmFja2VkIGZpbGUgZnJvbSBxdWV1ZWAsIHRyYWNrZWRGaWxlLmlkKTtcblxuICAgICAgICAvLyBEZXZlbG9wZXIgbm90aWNlIC0gdGhpcyBpcyBhIGNsZWFudXAgZnVuY3Rpb24ganVzdCBpbiBjYXNlLlxuICAgICAgICBpZiAodHJhY2tlZEZpbGUudXBsb2FkU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICB0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5fdHJhY2tlZEZpbGVzW3RyYWNrZWRGaWxlLmlkXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zeW5jVXBsb2FkUXVldWUoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnN5bmNVcGxvYWRRdWV1ZVRpbWVvdXRJZCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc3luY1VwbG9hZFF1ZXVlVGltZW91dElkKTtcbiAgICAgICAgICAgIHRoaXMuc3luY1VwbG9hZFF1ZXVlVGltZW91dElkID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERFVkVMT1BFUiBOT1RJQ0U6IFRoaXMgbG9naWMgaXMgZGVsYXllZCB0byB0aGUgbmV4dCBldmVudCBsb29wIG9uIHB1cnBvc2UgdG8gcHJldmVudFxuICAgICAgICAvLyBjb2xsaXNpb24gYmV0d2VlbiB0d28gc3luYyByZXF1ZXN0c1xuICAgICAgICB0aGlzLnN5bmNVcGxvYWRRdWV1ZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbG9nKCdpbmZvJywgYHN5bmNpbmcgdXBsb2FkIHF1ZXVlYCk7XG4gICAgICAgICAgICB0aGlzLnN5bmNVcGxvYWRRdWV1ZVRpbWVvdXRJZCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLl9leGVjdXRlUHJlcGFyZVBoYXNlKCk7XG4gICAgICAgICAgICB0aGlzLl9leGVjdXRlVXBsb2FkUGhhc2UoKTtcbiAgICAgICAgfSwgMjAwKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9leGVjdXRlUHJlcGFyZVBoYXNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBmaWxlcyA9IE9iamVjdC5rZXlzKHRoaXMuX3RyYWNrZWRGaWxlcykubWFwKGZpbGVJZCA9PiB0aGlzLl90cmFja2VkRmlsZXNbZmlsZUlkXSkuZmlsdGVyKHRyYWNrZWRGaWxlID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0cmFja2VkRmlsZS5zdGF0dXMgPT09IFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1ByZXBhcmVcbiAgICAgICAgICAgICAgICAmJiB0cmFja2VkRmlsZS5jYW5UcmFuc2l0aW9uVG8oVHJhY2tlZEZpbGVTdGF0dXNlcy5wcmVwYXJpbmcpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZmlsZXMubGVuZ3RoKVxuICAgICAgICB7XG4gICAgICAgICAgICB0aGlzLl9sb2coJ2luZm8nLGBoYW5kbGluZyAke2ZpbGVzLmxlbmd0aH0gZmlsZXMsIHdhaXRpbmcgdG8gYmUgcHJlcGFyZWRgKTtcblxuICAgICAgICAgICAgY29uc3QgZ3JvdXBlZEZpbGVzID0gZmlsZXMucmVkdWNlKChhY2M6IHsgYWRhcHRlcjogVXBsb2FkRmlsZUFkYXB0ZXI8YW55PiwgZmlsZXM6IFRyYWNrZWRGaWxlW10gfVtdLCBjdXJyIDogVHJhY2tlZEZpbGUpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB1cGxvYWRBZGFwdGVyID0gdGhpcy5fZ2V0VXBsb2FkQWRhcHRlcihjdXJyLmRhdGEpIHx8IG51bGw7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaGVkSXRlbSA9IGFjYy5maW5kKGl0ZW0gPT4gaXRlbS5hZGFwdGVyID8gaXRlbS5hZGFwdGVyLmNvbnN0cnVjdG9yID09PSB1cGxvYWRBZGFwdGVyLmNvbnN0cnVjdG9yIDogaXRlbS5hZGFwdGVyID09PSBudWxsKTtcblxuICAgICAgICAgICAgICAgIGlmIChtYXRjaGVkSXRlbSkge1xuICAgICAgICAgICAgICAgICAgICBtYXRjaGVkSXRlbS5maWxlcy5wdXNoKGN1cnIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFjYy5wdXNoKHthZGFwdGVyOiB1cGxvYWRBZGFwdGVyLCBmaWxlczogW2N1cnJdfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgICAgIH0sIFtdKTtcblxuICAgICAgICAgICAgZ3JvdXBlZEZpbGVzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0uYWRhcHRlcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2coJ2RlYnVnJywgYGV4ZWN1dGluZyBwcmVwYXJlIHBoYXNlIGZvciAke2l0ZW0uZmlsZXMubGVuZ3RofSBmaWxlcyB3aXRoIGFkYXB0ZXIgJyR7aXRlbS5hZGFwdGVyLmxhYmVsfSdgKTtcblxuICAgICAgICAgICAgICAgICAgICBpdGVtLmZpbGVzLmZvckVhY2goZmlsZSA9PlxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZShmaWxlLHsgc3RhdHVzIDogVHJhY2tlZEZpbGVTdGF0dXNlcy5wcmVwYXJpbmd9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaXRlbS5hZGFwdGVyLnByZXBhcmUoaXRlbS5maWxlcylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGNhbmNlbE9uRGVzdHJveSh0aGlzKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlcGFyZWRGaWxlcyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnZGVidWcnLCBgZXhlY3V0aW5nIHByZXBhcmUgcGhhc2Ugc3VjY2VlZGVkIGZvciAke2l0ZW0uZmlsZXMubGVuZ3RofSBmaWxlcyB3aXRoIGFkYXB0ZXIgJyR7aXRlbS5hZGFwdGVyLmxhYmVsfScuYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZVByZXBhcmVBZGFwdGVyUmVzcG9uc2UocHJlcGFyZWRGaWxlcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3luY1VwbG9hZFF1ZXVlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFzb24gPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnZXJyb3InLCBgZXhlY3V0aW5nIHByZXBhcmUgcGhhc2UgZmFpbGVkIGZvciAke2l0ZW0uZmlsZXMubGVuZ3RofSBmaWxlcyB3aXRoIGFkYXB0ZXIgJyR7aXRlbS5hZGFwdGVyLmxhYmVsfScuIGVycm9yOiAke3JlYXNvbi5tZXNzYWdlfWApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZVByZXBhcmVBZGFwdGVyUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmZpbGVzLm1hcChmaWxlID0+KHsgaWQ6IGZpbGUuaWQsIHN0YXR1czpmYWxzZX0pKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3N5bmNVcGxvYWRRdWV1ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpdGVtLmZpbGVzLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZShmaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLmZhaWx1cmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVSZWFzb246ICd1cGxvYWQgZGVzdGluYXRpb24gaXMgbm90IHN1cHBvcnRlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVUeXBlOiAndW5rbm93bl9kZXN0aW5hdGlvbidcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFuZGxlUHJlcGFyZUFkYXB0ZXJSZXNwb25zZShyZXNwb25zZUZpbGVzIDogeyBpZDogc3RyaW5nLCBzdGF0dXM6Ym9vbGVhbn1bXSkgOiB2b2lkIHtcbiAgICAgICAgcmVzcG9uc2VGaWxlcy5mb3JFYWNoKFxuICAgICAgICAgICAgcmVzcG9uc2VGaWxlID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB0cmFja2VkRmlsZSA9IHRoaXMuX3RyYWNrZWRGaWxlc1tyZXNwb25zZUZpbGUuaWRdO1xuXG4gICAgICAgICAgICAgICAgaWYgKCF0cmFja2VkRmlsZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCBgY2Fubm90IGhhbmRsZSBwcmVwYXJlIHJlc3BvbnNlIGZvciBmaWxlICcke3Jlc3BvbnNlRmlsZS5pZH0nIHNpbmNlIHRoZXJlIGlzIG5vIHRyYWNraW5nIGluZm9ybWF0aW9uIGZvciB0aGF0IGZpbGUgKGRpZCB0aGUgdXNlciBwdXJnZSB0aGUgZmlsZSBkdXJpbmcgdGhlIHByZXBhcmUgZXhlY3V0aW9uPylgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodHJhY2tlZEZpbGUuc3RhdHVzICE9PSBUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmluZykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCBgY2Fubm90IGhhbmRsZSBmaWxlIHJlc3VsdCBmcm9tIHByZXBhcmUgYWN0aW9uIChkaWQgdGhlIHVzZXIgY2FuY2VsIHRoZSBmaWxlIHVwbG9hZCBkdXJpbmcgdGhlIHByZXBhcmUgZXhlY3V0aW9uPylgLCB0cmFja2VkRmlsZS5pZCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZUZpbGUuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZWRTdGF0dXNUb1ByZXBhcmVkID0gdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLnByZXBhcmVkXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoY2hhbmdlZFN0YXR1c1RvUHJlcGFyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLnBlbmRpbmdVcGxvYWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy5mYWlsdXJlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVSZWFzb246ICdmYWlsZWQgdG8gcHJlcGFyZSB1cGxvYWQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVUeXBlOiAncHJlcGFyYXRpb25fZmFpbGVkJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZXhlY3V0ZVVwbG9hZFBoYXNlKCk6IHZvaWQge1xuICAgICAgICBjb25zdCB3YWl0aW5nRm9yVXBsb2Fkc0ZpbGVzID0gW107XG4gICAgICAgIGNvbnN0IGFjdGl2ZVVwbG9hZEZpbGVzID0gW107XG5cbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5fdHJhY2tlZEZpbGVzKS5mb3JFYWNoKGZpbGVJZCA9PlxuICAgICAgICB7XG4gICAgICAgICAgICBjb25zdCB0cmFja2VkRmlsZSA9IHRoaXMuX3RyYWNrZWRGaWxlc1tmaWxlSWRdO1xuXG4gICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUuc3RhdHVzID09PSBUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZGluZylcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBhY3RpdmVVcGxvYWRGaWxlcy5wdXNoKHRyYWNrZWRGaWxlKTtcbiAgICAgICAgICAgIH1lbHNlIGlmICh0cmFja2VkRmlsZS5zdGF0dXMgPT09IFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1VwbG9hZFxuICAgICAgICAgICAgICAgICYmIHRyYWNrZWRGaWxlLmNhblRyYW5zaXRpb25UbyhUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZGluZykpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgd2FpdGluZ0ZvclVwbG9hZHNGaWxlcy5wdXNoKHRyYWNrZWRGaWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgYWN0aXZlVXBsb2Fkc0NvdW50ID0gYWN0aXZlVXBsb2FkRmlsZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCB3YWl0aW5nRmlsZXNDb3VudCA9IHdhaXRpbmdGb3JVcGxvYWRzRmlsZXMubGVuZ3RoO1xuXG4gICAgICAgIGlmICh3YWl0aW5nRmlsZXNDb3VudCA+IDApIHtcbiAgICAgICAgICAgIGxldCBuZXh0VXBsb2FkRmlsZXM6IFRyYWNrZWRGaWxlW10gPSBbXTtcblxuICAgICAgICAgICAgdGhpcy5fbG9nKCdzaWxseScsIGBhY3RpdmUgdXBsb2FkczogJHthY3RpdmVVcGxvYWRzQ291bnR9IHwgcGVuZGluZyBmaWxlczogJHt3YWl0aW5nRmlsZXNDb3VudH1gKTtcblxuICAgICAgICAgICAgY29uc3QgYXZhaWxhYmxlVXBsb2FkU2xvdHMgPSAodGhpcy5fbWF4VXBsb2FkUmVxdWVzdHMgJiYgdGhpcy5fbWF4VXBsb2FkUmVxdWVzdHMgPiAwKSA/IHRoaXMuX21heFVwbG9hZFJlcXVlc3RzIC0gYWN0aXZlVXBsb2Fkc0NvdW50IDogd2FpdGluZ0ZpbGVzQ291bnQ7XG5cbiAgICAgICAgICAgIGlmIChhdmFpbGFibGVVcGxvYWRTbG90cyA+IDApIHtcbiAgICAgICAgICAgICAgICBuZXh0VXBsb2FkRmlsZXMgPSBbXG4gICAgICAgICAgICAgICAgICAgIC4uLndhaXRpbmdGb3JVcGxvYWRzRmlsZXMuc29ydChwZW5kaW5nRmlsZSA9PiBwZW5kaW5nRmlsZS51cGxvYWRPcmRlciB8fCAxMDAwKVxuICAgICAgICAgICAgICAgIF0uc2xpY2UoMCwgYXZhaWxhYmxlVXBsb2FkU2xvdHMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLl9sb2coJ2RlYnVnJywgYGF2YWlsYWJsZSB1cGxvYWQgc2xvdHMgdG8gYmUgdXNlZCAke2F2YWlsYWJsZVVwbG9hZFNsb3RzfWApO1xuXG5cbiAgICAgICAgICAgIG5leHRVcGxvYWRGaWxlcy5mb3JFYWNoKHBlbmRpbmdGaWxlID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pbml0aWF0ZVVwbG9hZChwZW5kaW5nRmlsZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZVRyYWNrZWRGaWxlKGlkOiBzdHJpbmcsIGZpbGVEYXRhOiBVcGxvYWRGaWxlRGF0YSk6IHZvaWQge1xuICAgICAgICBjb25zdCBuZXdUcmFja2VkRmlsZSA9IHRoaXMuX3RyYWNrZWRGaWxlc1tpZF0gPSBuZXcgVHJhY2tlZEZpbGUoaWQsIGZpbGVEYXRhKTtcblxuICAgICAgICB0aGlzLl9vblRyYWNrZWRGaWxlQ2hhbmdlZC5uZXh0KG5ld1RyYWNrZWRGaWxlLmFzRGF0YSgpKTtcblxuICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZShuZXdUcmFja2VkRmlsZSxcbiAgICAgICAgICAgIHtzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMucGVuZGluZ1ByZXBhcmV9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGU6IFRyYWNrZWRGaWxlLCBjaGFuZ2VzOiBUcmFja2VkRmlsZUNoYW5nZXMpOiBib29sZWFuIHtcblxuICAgICAgICBsZXQgcmVzdWx0ID0gdHJ1ZTtcblxuICAgICAgICBpZiAoY2hhbmdlcy5zdGF0dXMgJiYgY2hhbmdlcy5zdGF0dXMgIT09IHRyYWNrZWRGaWxlLnN0YXR1cykge1xuXG5cbiAgICAgICAgICAgIGlmICh0cmFja2VkRmlsZS5jYW5UcmFuc2l0aW9uVG8oY2hhbmdlcy5zdGF0dXMpKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnaW5mbycsIGBub3RpZnkgZmlsZSBzdGF0dXMgY2hhbmdlcyBmcm9tICcke3RyYWNrZWRGaWxlLnN0YXR1c30nIHRvICcke2NoYW5nZXMuc3RhdHVzfSdgLHRyYWNrZWRGaWxlLmlkKTtcbiAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGRhdGUoY2hhbmdlcyk7XG4gICAgICAgICAgICB9ZWxzZVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvZygnZXJyb3InLCBgY2Fubm90IHVwZGF0ZSBmaWxlIGRhdGEgZnJvbSAnJHt0cmFja2VkRmlsZS5zdGF0dXN9JyB0byAnJHtjaGFuZ2VzLnN0YXR1c30uIHRhcmdldCBzdGF0dXMgaXMgbm90IGFsbG93ZWQuIHVwZGF0ZSB0byBzdGF0dXMgJ2ZhaWx1cmUnIGluc3RlYWQuYCx0cmFja2VkRmlsZS5pZCk7XG5cbiAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGRhdGUoe1xuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMuZmFpbHVyZSxcbiAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVJlYXNvbjogJ2Nhbm5vdCBjaGFuZ2Ugc3RhdHVzJyxcbiAgICAgICAgICAgICAgICAgICAgZmFpbHVyZVR5cGU6ICdjaGFuZ2Vfbm90X2FsbG93ZWQnXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICByZXN1bHQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfWVsc2VcbiAgICAgICAge1xuICAgICAgICAgICAgLy90aGlzLl9sb2coJ2luZm8nLCBgbm90aWZ5IGZpbGUgZGF0YSBjaGFuZ2VzYCx0cmFja2VkRmlsZS5pZCk7XG4gICAgICAgICAgICB0cmFja2VkRmlsZS51cGRhdGUoY2hhbmdlcylcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX29uVHJhY2tlZEZpbGVDaGFuZ2VkLm5leHQodHJhY2tlZEZpbGUuYXNEYXRhKCkpO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHVibGljIHN1cHBvcnRDaHVua1VwbG9hZCh1cGxvYWRGaWxlRGF0YTogVXBsb2FkRmlsZURhdGEpIDogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHVwbG9hZEFkYXB0ZXI6IFVwbG9hZEZpbGVBZGFwdGVyPGFueT4gPSB0aGlzLl9nZXRVcGxvYWRBZGFwdGVyKHVwbG9hZEZpbGVEYXRhKTtcbiAgICAgICAgcmV0dXJuIHVwbG9hZEFkYXB0ZXIgPyB1cGxvYWRBZGFwdGVyLnN1cHBvcnRDaHVua1VwbG9hZCgpIDogZmFsc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaW5pdGlhdGVVcGxvYWQodHJhY2tlZEZpbGU6IFRyYWNrZWRGaWxlKTogdm9pZCB7XG5cbiAgICAgICAgY29uc3Qge2RhdGEsIGlkfSA9IHRyYWNrZWRGaWxlO1xuICAgICAgICBjb25zdCB1cGxvYWRBZGFwdGVyOiBVcGxvYWRGaWxlQWRhcHRlcjxhbnk+ID0gdGhpcy5fZ2V0VXBsb2FkQWRhcHRlcihkYXRhKTtcblxuICAgICAgICB0aGlzLl9sb2coJ2luZm8nLCBgaW5pdGlhdGUgbmV3IHVwbG9hZCBmb3IgZmlsZSAnJHtpZH0nYCk7XG5cbiAgICAgICAgaWYgKCF1cGxvYWRBZGFwdGVyKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCBgY2Fubm90IGZpbmQgZGVzdGluYXRpb24gYWRhcHRlciBmb3IgcmVxdWVzdGVkIGZpbGUsIGZhaWxpbmcgdXBsb2FkIHJlcXVlc3RgKTtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBUcmFja2VkRmlsZVN0YXR1c2VzLmZhaWx1cmUsXG4gICAgICAgICAgICAgICAgICAgIGZhaWx1cmVSZWFzb246ICd1cGxvYWQgZGVzdGluYXRpb24gaXMgbm90IHN1cHBvcnRlZCcsXG4gICAgICAgICAgICAgICAgICAgIGZhaWx1cmVUeXBlOiAndW5rbm93bl9kZXN0aW5hdGlvbidcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5fc3luY1VwbG9hZFF1ZXVlKCk7XG5cbiAgICAgICAgfSBlbHNlIGlmICh0cmFja2VkRmlsZS5jYW5UcmFuc2l0aW9uVG8oVHJhY2tlZEZpbGVTdGF0dXNlcy51cGxvYWRpbmcpKSB7XG4gICAgICAgICAgICBpZiAodHJhY2tlZEZpbGUudXBsb2FkU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9nKCd3YXJuJywgYGFuIGFjdGl2ZSB1cGxvYWQgd2FzIGZvdW5kIHdoaWxlIHRoZSBzdGF0dXMgaW5kaWNhdGVkIG5vIHVwbG9hZCBjdXJyZW50bHkgaW4gcHJvZ3Jlc3MuIGNhbmNlbCBwcmV2aW91cyB1cGxvYWRgKTtcbiAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLl91cGRhdGVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSwge1xuICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy51cGxvYWRpbmcsXG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3M6IDAsXG4gICAgICAgICAgICAgICAgdXBsb2FkU3RhcnRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBjYW5IYW5kbGVSZXNwb25zZSA9IChpZDogc3RyaW5nLCBhY3Rpb25EZXNjcmlwdGlvbjogc3RyaW5nKSA6IGJvb2xlYW4gPT5cbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY29uc3QgdHJhY2tlZEZpbGVTdGlsbEV4aXN0cyA9ICEhdGhpcy5fdHJhY2tlZEZpbGVzW2lkXTtcblxuICAgICAgICAgICAgICAgIGlmICghdHJhY2tlZEZpbGVTdGlsbEV4aXN0cykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCBgY2Fubm90IGhhbmRsZSBmaWxlIHVwbG9hZCAke2FjdGlvbkRlc2NyaXB0aW9ufS4gVGhlcmUgaXMgbm8gdHJhY2tpbmcgZmlsZSB3aXRoIHRoZSBwcm92aWRlZCBpZCAod2FzIHRoZSBmaWxlIHB1cmdlZD8pYCwgaWQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHJhY2tlZEZpbGUuc3RhdHVzICE9PSBUcmFja2VkRmlsZVN0YXR1c2VzLnVwbG9hZGluZykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2coJ3dhcm4nLCBgY2Fubm90IGhhbmRsZSBmaWxlIHVwbG9hZCAke2FjdGlvbkRlc2NyaXB0aW9ufS4gVGhlIGZpbGUgc3RhdHVzIGl0IG5vdCAndXBsb2FkaW5nJyAod2FzIHRoZSBmaWxlIHVwbG9hZCBjYW5jZWxsZWQ/KWAsIGlkKTtcbiAgICAgICAgICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHRyYWNrZWRGaWxlLnVwbG9hZFN1YnNjcmlwdGlvbiA9IHVwbG9hZEFkYXB0ZXIudXBsb2FkKGlkLCBkYXRhKVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICh1cGxvYWRDaGFuZ2VzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FuSGFuZGxlUmVzcG9uc2UoaWQsICdwcm9ncmVzcycpKVxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogdXBsb2FkQ2hhbmdlcy5wcm9ncmVzc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFja2VkRmlsZS51cGxvYWRTdWJzY3JpcHRpb24gPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FuSGFuZGxlUmVzcG9uc2UoaWQsICdmYWlsdXJlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmYWlsdXJlUmVhc29uID0gZXJyb3IgJiYgZXJyb3IubWVzc2FnZSA/IGVycm9yLm1lc3NhZ2UgOiAnJztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVRyYWNrZWRGaWxlKHRyYWNrZWRGaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IFRyYWNrZWRGaWxlU3RhdHVzZXMuZmFpbHVyZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVSZWFzb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsdXJlVHlwZTogJ2dlbmVyYWxfZXJyb3InXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zeW5jVXBsb2FkUXVldWUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tlZEZpbGUudXBsb2FkU3Vic2NyaXB0aW9uID0gbnVsbDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbkhhbmRsZVJlc3BvbnNlKGlkLCAnY29tcGxldGlvbicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlVHJhY2tlZEZpbGUodHJhY2tlZEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogVHJhY2tlZEZpbGVTdGF0dXNlcy51cGxvYWRDb21wbGV0ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzczogMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZENvbXBsZXRlQXQ6IG5ldyBEYXRlKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVUcmFja2VkRmlsZSh0cmFja2VkRmlsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3luY1VwbG9hZFF1ZXVlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0VXBsb2FkQWRhcHRlcihmaWxlRGF0YTogVXBsb2FkRmlsZURhdGEpOiBVcGxvYWRGaWxlQWRhcHRlcjxhbnk+IHtcblxuICAgICAgICBpZiAodGhpcy5fdXBsb2FkRmlsZUFkYXB0ZXIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl91cGxvYWRGaWxlQWRhcHRlci5maW5kKHVwbG9hZEZpbGVBZGFwdGVyID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXBsb2FkRmlsZUFkYXB0ZXIuY2FuSGFuZGxlKGZpbGVEYXRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5fdHJhY2tlZEZpbGVzKS5mb3JFYWNoKGlkID0+XG4gICAgICAgIHtcbiAgICAgICAgICAgIHRoaXMucHVyZ2VVcGxvYWQoaWQpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=